

<!DOCTYPE html>
<html lang="ko-KR" data-default-color-scheme="&#34;auto&#34;">



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico">
  <link rel="icon" type="image/png" href="/img/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="&lt;p&gt;&amp;#xC548;&amp;#xB155;&amp;#xD558;&amp;#xC138;&amp;#xC694;, L0ch&amp;#xC785;&amp;#xB2C8;&amp;#xB2E4;!  &amp;#xC9C0;&amp;#xB09C; &amp;#xBC88; &amp;#xAE00; &amp;#xC774;&amp;#xD6C4;&amp;#xB85C; &amp;#xC624;&amp;#xB79C;&amp;#xB9CC;&amp;#xC5D0; &amp;#xB3CC;&amp;#xC544;&amp;#xC654;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;&lt;/p&gt;
&lt;p&gt;&amp;#xC9C0;&amp;#xB09C; &amp;#xC8FC;&amp;#xC81C;&amp;#xB294; &lt;a href=&#34;https://hackyboiz.github.io/2025/04/13/l0ch/bypassing-kernel-mitigation-part0/ko/&#34;&gt;[Research] Bypassing Windows Kernel Mitigations: Part0 - Deep Dive into KASLR Leaks Restriction&lt;/a&gt; &amp;#xC600;&amp;#xC5C8;&amp;#xB294;&amp;#xB370;&amp;#xC694;, KASLR &amp;#xC6B0;&amp;#xD68C; PoC&amp;#xC758; &amp;#xB3D9;&amp;#xC791; &amp;#xC870;&amp;#xAC74; &amp;#xC911; &amp;#xD558;&amp;#xB098;&amp;#xAC00; KVA Shadow &amp;#xBE44;&amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xB2E4;! &amp;#xB77C;&amp;#xB294; &amp;#xC774;&amp;#xC57C;&amp;#xAE30;&amp;#xB97C; &amp;#xD588;&amp;#xC5C8;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;p&gt;&amp;#xC791;&amp;#xC131; &amp;#xB2F9;&amp;#xC2DC;&amp;#xC5D0;&amp;#xB294; &amp;#xCD5C;&amp;#xC2E0; Windows 11&amp;#xC5D0;&amp;#xC11C;&amp;#xB294; KVAS&amp;#xAC00; &amp;#xAE30;&amp;#xBCF8;&amp;#xC801;&amp;#xC73C;&amp;#xB85C; &amp;#xBE44;&amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xB418;&amp;#xC5B4; &amp;#xC788;&amp;#xB2E4;&amp;#xACE0; &amp;#xCD94;&amp;#xCE21;&amp;#xD588;&amp;#xC5C8;&amp;#xB294;&amp;#xB370;, &amp;#xD53C;&amp;#xB4DC;&amp;#xBC31;&amp;#xC744; &amp;#xD1B5;&amp;#xD574; KVAS&amp;#xB294; Windows &amp;#xBC84;&amp;#xC804; &amp;#xAE30;&amp;#xC900;&amp;#xC774; &amp;#xC544;&amp;#xB2CC; CPU &amp;#xBAA8;&amp;#xB378;&amp;#xACFC; &amp;#xD2B9;&amp;#xC815; &amp;#xCDE8;&amp;#xC57D;&amp;#xC810;&amp;#xC5D0; &amp;#xC601;&amp;#xD5A5;&amp;#xC744; &amp;#xBC1B;&amp;#xB294;&amp;#xC9C0; &amp;#xD655;&amp;#xC778;&amp;#xD558;&amp;#xACE0; &amp;#xB3D9;&amp;#xC801;&amp;#xC73C;&amp;#xB85C; &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xB41C;&amp;#xB2E4;&amp;#xB294; &amp;#xAC83;&amp;#xC744; &amp;#xC54C;&amp;#xC558;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;h1 id=&#34;SpeculationControl-PowerShell-script&#34;&gt;&lt;a href=&#34;#SpeculationControl-PowerShell-script&#34; class=&#34;headerlink&#34; title=&#34;SpeculationControl PowerShell script&#34;&gt;&lt;/a&gt;&lt;strong&gt;SpeculationControl PowerShell script&lt;/strong&gt;&lt;/h1&gt;&lt;p&gt;KVAS&amp;#xB294; Meltdown, Spectre&amp;#xB85C; &amp;#xB300;&amp;#xD45C;&amp;#xB418;&amp;#xB294; &amp;#xB2E4;&amp;#xC591;&amp;#xD55C; &amp;#xCD94;&amp;#xCE21; &amp;#xC2E4;&amp;#xD589; &amp;#xAE30;&amp;#xBC18; &amp;#xC0AC;&amp;#xC774;&amp;#xB4DC;&amp;#xCC44;&amp;#xB110; &amp;#xCDE8;&amp;#xC57D;&amp;#xC810;&amp;#xACFC; &amp;#xBC00;&amp;#xC811;&amp;#xD55C; &amp;#xAD00;&amp;#xB828;&amp;#xC774; &amp;#xC788;&amp;#xB294; &amp;#xB9CC;&amp;#xD07C;, &amp;#xAD00;&amp;#xB828; MS&amp;#xC758; &amp;#xC9C0;&amp;#xC6D0; &amp;#xC815;&amp;#xBCF4;&amp;#xB97C; &amp;#xC27D;&amp;#xAC8C; &amp;#xD655;&amp;#xC778;&amp;#xD560; &amp;#xC218; &amp;#xC788;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://support.microsoft.com/en-us/topic/kb4074629-understanding-speculationcontrol-powershell-script-output-fd70a80a-a63f-e539-cda5-5be4c9e67c04&#34;&gt;https://support.microsoft.com/en-us/topic/kb4074629-understanding-speculationcontrol-powershell-script-output-fd70a80a-a63f-e539-cda5-5be4c9e67c04&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&amp;#xC81C; &amp;#xCEF4;&amp;#xD4E8;&amp;#xD130;&amp;#xC778; 12&amp;#xC138;&amp;#xB300; Intel CPU&amp;#xB85C; &amp;#xD14C;&amp;#xC2A4;&amp;#xD2B8;&amp;#xD55C; &amp;#xACB0;&amp;#xACFC;&amp;#xB97C; &amp;#xC815;&amp;#xB9AC;&amp;#xD558;&amp;#xBA74; &amp;#xB2E4;&amp;#xC74C;&amp;#xACFC; &amp;#xAC19;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;.&lt;br&gt;&lt;pre&gt;&lt;code class=&#34;hljs powershell&#34;&gt;&lt;span class=&#34;hljs-comment&#34;&gt;# Windwos 11 24H2 - Intel 12th i7-12700&lt;/span&gt;

&lt;span class=&#34;hljs-built_in&#34;&gt;PS&lt;/span&gt; C:\WINDOWS\system32&amp;gt; &lt;span class=&#34;hljs-built_in&#34;&gt;Install-Module&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;-Name&lt;/span&gt; SpeculationControl                                                                                                                                                                                 &amp;#xACC4;&amp;#xC18D;&amp;#xD558;&amp;#xB824;&amp;#xBA74; NuGet &amp;#xACF5;&amp;#xAE09;&amp;#xC790;&amp;#xAC00; &amp;#xD544;&amp;#xC694;&amp;#xD569;&amp;#xB2C8;&amp;#xB2E4;.

&lt;span class=&#34;hljs-built_in&#34;&gt;PS&lt;/span&gt; C:\WINDOWS\system32&amp;gt; &lt;span class=&#34;hljs-built_in&#34;&gt;Get-SpeculationControlSettings&lt;/span&gt;

BTIHardwarePresent                  : True
BTIWindowsSupportPresent            : True
BTIWindowsSupportEnabled            : True
BTIDisabledBySystemPolicy           : False
BTIDisabledByNoHardwareSupport      : False
BTIKernelRetpolineEnabled           : False
BTIKernelImportOptimizationEnabled  : True
RdclHardwareProtectedReported       : True
RdclHardwareProtected               : True
KVAShadowRequired                   : False
KVAShadowWindowsSupportPresent      : True
KVAShadowWindowsSupportEnabled      : False
KVAShadowPcidEnabled                : False
SSBDWindowsSupportPresent           : True
SSBDHardwareVulnerable              : True
SSBDHardwarePresent                 : True
SSBDWindowsSupportEnabledSystemWide : False
L1TFHardwareVulnerable              : False
L1TFWindowsSupportPresent           : True
L1TFWindowsSupportEnabled           : False
L1TFInvalidPteBit                   : &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;
L1DFlushSupported                   : True
HvL1tfStatusAvailable               : True
HvL1tfProcessorNotAffected          : True
MDSWindowsSupportPresent            : True
MDSHardwareVulnerable               : False
MDSWindowsSupportEnabled            : False
FBClearWindowsSupportPresent        : True
SBDRSSDPHardwareVulnerable          : False
FBSDPHardwareVulnerable             : False
PSDPHardwareVulnerable              : False
FBClearWindowsSupportEnabled        : False
&lt;/code&gt;&lt;/pre&gt;&lt;/p&gt;
&lt;div class=&#34;table-container&#34;&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Hardware requires kernel VA shadowing&lt;/th&gt;
&lt;th&gt;Maps to KVAShadowRequired. This line tells you whether your system requires kernel VA shadowing to mitigate a vulnerability.&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Windows OS support for rogue data cache load mitigation is present&lt;/td&gt;
&lt;td&gt;Maps to KVAShadowWindowsSupportPresent. This line tells you whether Windows operating system support for the kernel VA shadow feature is present.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Windows OS support for kernel VA shadow is present&lt;/td&gt;
&lt;td&gt;Maps to KVAShadowWindowsSupportPresent. This line tells you whether Windows operating system support for the kernel VA shadow feature is present. If it is True, the January 2018 update is installed on the device, and kernel VA shadow is supported. If it is False, the January 2018 update is not installed, and kernel VA shadow support does not exist.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Windows OS support for rogue data cache load mitigation is enabled&lt;/td&gt;
&lt;td&gt;Maps to KVAShadowWindowsSupportEnabled. This line tells you whether the kernel VA shadow feature is enabled. If it is True, the hardware is believed to be vulnerable to CVE-2017-5754, Windows operating system support is present, and the feature is enabled.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Windows OS support for kernel VA shadow is enabled&lt;/td&gt;
&lt;td&gt;Maps to KVAShadowWindowsSupportEnabled. This line tells you whether the kernel VA shadow feature is enabled. If it is True, Windows operating system support is present, and the feature is enabled. The Kernel VA shadow feature is currently enabled by default on client versions of Windows and is disabled by default on versions of Windows Server. If it is False, either Windows operating system support is not present, or the feature is not enabled.&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;pre&gt;&lt;code class=&#34;hljs cpp&#34;&gt;Windows&amp;#xC5D0; KVA Shadow &amp;#xAE30;&amp;#xB2A5;&amp;#xC740; &amp;#xC874;&amp;#xC7AC;&amp;#xD558;&amp;#xB098;(KVAShadowWindowsSupportPresent: True) &amp;#xD544;&amp;#xC694;&amp;#xD558;&amp;#xC9C0; &amp;#xC54A;&amp;#xC544;&amp;#xC11C;(KVAShadowRequired: False) &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xB418;&amp;#xC9C0;&amp;#xB294; &amp;#xC54A;&amp;#xC740; &amp;#xC0C1;&amp;#xD0DC; (KVAShadowWindowsSupportEnabled: False)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;KVAS&amp;#xAC00; &amp;#xBE44;&amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xB41C; &amp;#xAC78; &amp;#xC54C; &amp;#xC218; &amp;#xC788;&amp;#xB294;&amp;#xB370;, &amp;#xC774;&amp;#xB294; &amp;#xB2E4;&amp;#xC2DC; &amp;#xB9D0;&amp;#xD558;&amp;#xBA74; &amp;#xBBF8;&amp;#xD2F0;&amp;#xAC8C;&amp;#xC774;&amp;#xC158; &amp;#xAE30;&amp;#xB2A5;&amp;#xC774; &amp;#xC874;&amp;#xC7AC;&amp;#xD558;&amp;#xC9C0;&amp;#xB9CC; &lt;strong&gt;&amp;#xD558;&amp;#xB4DC;&amp;#xC6E8;&amp;#xC5B4;(CPU)&amp;#xAC00; &amp;#xCDE8;&amp;#xC57D;&amp;#xD558;&amp;#xC9C0; &amp;#xC54A;&amp;#xC544;&amp;#xC11C; &amp;#xBBF8;&amp;#xD2F0;&amp;#xAC8C;&amp;#xC774;&amp;#xC158; &amp;#xAE30;&amp;#xB2A5;&amp;#xC774; &amp;#xBE44;&amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xB418;&amp;#xC5C8;&amp;#xB2E4;&lt;/strong&gt;&amp;#xACE0; &amp;#xB9D0;&amp;#xD560; &amp;#xC218; &amp;#xC788;&amp;#xACA0;&amp;#xB124;&amp;#xC694;. &lt;/p&gt;
&lt;p&gt;&amp;#xADF8;&amp;#xB807;&amp;#xB2E4;&amp;#xBA74; Windows&amp;#xB294; &amp;#xC5B4;&amp;#xB514;&amp;#xC11C;, &amp;#xC5B4;&amp;#xB5BB;&amp;#xAC8C; &amp;#xCDE8;&amp;#xC57D;&amp;#xD55C; CPU&amp;#xB97C; &amp;#xC2DD;&amp;#xBCC4;&amp;#xD558;&amp;#xACE0; KVAS &amp;#xD65C;&amp;#xC131;&amp;#xD654; &amp;#xC5EC;&amp;#xBD80;&amp;#xB97C; &amp;#xD310;&amp;#xB2E8;&amp;#xD560;&amp;#xAE4C;&amp;#xC694;?&lt;/p&gt;
&lt;h1 id=&#34;Background-Knowledge-CPU-Identification&#34;&gt;&lt;a href=&#34;#Background-Knowledge-CPU-Identification&#34; class=&#34;headerlink&#34; title=&#34;Background Knowledge - CPU Identification&#34;&gt;&lt;/a&gt;Background Knowledge - CPU Identification&lt;/h1&gt;&lt;p&gt;Windows&amp;#xB294; &amp;#xC790;&amp;#xCCB4;&amp;#xC801;&amp;#xC73C;&amp;#xB85C; CPU&amp;#xC758; &amp;#xBCA4;&amp;#xB354;&amp;#xB97C; &amp;#xC2DD;&amp;#xBCC4;&amp;#xD569;&amp;#xB2C8;&amp;#xB2E4;. &lt;a href=&#34;https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/amd64_x/cpu_vendors.htm&#34;&gt;CPU_VENDORS&lt;/a&gt; Enum&amp;#xC5D0; &amp;#xC815;&amp;#xC758;&amp;#xB418;&amp;#xC5B4; &amp;#xC788;&amp;#xB4EF;&amp;#xC774;, &amp;#xC54C; &amp;#xC218; &amp;#xC5C6;&amp;#xB294; &amp;#xC81C;&amp;#xC870;&amp;#xC0AC;&amp;#xB294; 0, AMD&amp;#xB294; 1, Intel&amp;#xC740; 2&amp;#xB85C; &amp;#xC815;&amp;#xC758;&amp;#xB418;&amp;#xC5B4; &amp;#xC788;&amp;#xC8E0;.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs jsx&#34;&gt;typedef enum
{
    CPU_UNKNOWN,   &lt;span class=&#34;hljs-comment&#34;&gt;// 0&lt;/span&gt;
    CPU_AMD,       &lt;span class=&#34;hljs-comment&#34;&gt;// 1&lt;/span&gt;
    CPU_INTEL,     &lt;span class=&#34;hljs-comment&#34;&gt;// 2&lt;/span&gt;
    CPU_VIA        &lt;span class=&#34;hljs-comment&#34;&gt;// 3&lt;/span&gt;
} CPU_VENDORS;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&amp;#xBCA4;&amp;#xB354;&amp;#xBFD0;&amp;#xB9CC; &amp;#xC544;&amp;#xB2C8;&amp;#xB77C; Faily ID, Model ID &amp;#xC640; &amp;#xAC19;&amp;#xC740; CPU &amp;#xC815;&amp;#xBCF4;&amp;#xB4E4;&amp;#xC740; &lt;a href=&#34;https://www.vergiliusproject.com/kernels/x64/windows-11/24h2/_KPRCB&#34;&gt;KPRCB&lt;/a&gt; &amp;#xAD6C;&amp;#xC870;&amp;#xCCB4;&amp;#xC5D0; &amp;#xC800;&amp;#xC7A5;&amp;#xB429;&amp;#xB2C8;&amp;#xB2E4;. &lt;/p&gt;
&lt;p&gt;&amp;#xC774;&amp;#xB7EC;&amp;#xD55C; ID&amp;#xB4E4;&amp;#xC740; &amp;#xAC01; CPU &amp;#xBCA4;&amp;#xB354;&amp;#xC0AC;&amp;#xAC00; &amp;#xC815;&amp;#xC758;&amp;#xD569;&amp;#xB2C8;&amp;#xB2E4;. Intel&amp;#xC758; &amp;#xACBD;&amp;#xC6B0; Intel CPU &amp;#xC81C;&amp;#xD488;&amp;#xC758; Family ID, Model ID, &amp;#xC138;&amp;#xB300; &amp;#xC815;&amp;#xBCF4;&amp;#xB97C; &lt;a href=&#34;https://www.intel.com/content/www/us/en/content-details/782158/intel-64-and-ia-32-architectures-software-developer-s-manual-combined-volumes-1-2a-2b-2c-2d-3a-3b-3c-3d-and-4.html&#34;&gt;Intel Developer Manual&lt;/a&gt; &amp;#xC5D0;&amp;#xC11C; &amp;#xD655;&amp;#xC778;&amp;#xD560; &amp;#xC218; &amp;#xC788;&amp;#xB294;&amp;#xB370;&amp;#xC694;, 5000&amp;#xC7A5;&amp;#xC774; &amp;#xB118;&amp;#xB294; &amp;#xB9E4;&amp;#xB274;&amp;#xC5BC;&amp;#xC744; &amp;#xC804;&amp;#xBD80; &amp;#xBCFC; &amp;#xC218;&amp;#xB294; &amp;#xC5C6;&amp;#xC73C;&amp;#xB2C8;.. gemini &amp;#xC2DC;&amp;#xCF1C;&amp;#xC11C; &amp;#xC544;&amp;#xB798; &amp;#xD45C;&amp;#xB85C; &amp;#xC815;&amp;#xB9AC;&amp;#xD588;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;. &lt;/p&gt;
&lt;div class=&#34;table-container&#34;&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;strong&gt;&amp;#xB9C8;&amp;#xC774;&amp;#xD06C;&amp;#xB85C;&amp;#xC544;&amp;#xD0A4;&amp;#xD14D;&amp;#xCC98; (&amp;#xC138;&amp;#xB300;)&lt;/strong&gt;&lt;/th&gt;
&lt;th&gt;&lt;strong&gt;&amp;#xD504;&amp;#xB85C;&amp;#xC138;&amp;#xC11C; &amp;#xC81C;&amp;#xD488;&amp;#xAD70;&lt;/strong&gt;&lt;/th&gt;
&lt;th&gt;&lt;strong&gt;Family ID (Hex)&lt;/strong&gt;&lt;/th&gt;
&lt;th&gt;&lt;strong&gt;Model ID (Hex)&lt;/strong&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Raptor Lake (13&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;B7H, BFH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Alder Lake (12&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;97H, 9AH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Tiger Lake (11&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;8CH, 8DH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Rocket Lake (11&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;A7H&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Ice Lake (10&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;7DH, 7EH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Comet Lake (10&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;A5H, A6H&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Amber Lake Y (8&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;8EH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Whiskey Lake U (8&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;8EH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Coffee Lake (8, 9&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;9EH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Kaby Lake (7&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;8EH, 9EH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Skylake (6&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;4EH, 5EH, 55H&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Broadwell (5&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;3DH, 47H, 4FH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Haswell (4&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;3CH, 45H, 46H, 3FH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Ivy Bridge (3&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;3AH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Sandy Bridge (2&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;2AH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Westmere (2010)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;25H, 2CH, 2FH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Nehalem (1&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;1AH, 1EH, 1FH, 2EH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Penryn&lt;/td&gt;
&lt;td&gt;Core 2 Duo/Quad&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;17H, 1DH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Merom&lt;/td&gt;
&lt;td&gt;Core 2 Duo&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;0FH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Yonah&lt;/td&gt;
&lt;td&gt;Core Duo/Solo&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;0EH&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;p&gt;AMD&amp;#xB098; &amp;#xB2E4;&amp;#xB978; &amp;#xBCA4;&amp;#xB354;&amp;#xB4E4;&amp;#xC758; ID &amp;#xB9AC;&amp;#xC2A4;&amp;#xD2B8;&amp;#xB3C4; &amp;#xBAA8;&amp;#xB450; &amp;#xC815;&amp;#xB9AC;&amp;#xD558;&amp;#xACE0; &amp;#xBD84;&amp;#xC11D;&amp;#xC744; &amp;#xC9C4;&amp;#xD589;&amp;#xD588;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;h1 id=&#34;Analysis-of-KVAS-Activation-Logic&#34;&gt;&lt;a href=&#34;#Analysis-of-KVAS-Activation-Logic&#34; class=&#34;headerlink&#34; title=&#34;Analysis of KVAS Activation Logic&#34;&gt;&lt;/a&gt;Analysis of KVAS Activation Logic&lt;/h1&gt;&lt;p&gt;&amp;#xBD84;&amp;#xC11D; &amp;#xD658;&amp;#xACBD;: Windows 24H2 64bit 10.0.26100.1742 &lt;/p&gt;
&lt;p&gt;&amp;#xB2E4;&amp;#xC2DC; &amp;#xB3CC;&amp;#xC544;&amp;#xC640;&amp;#xC11C;, &amp;#xBBF8;&amp;#xD2F0;&amp;#xAC8C;&amp;#xC774;&amp;#xC158; &amp;#xCD08;&amp;#xAE30;&amp;#xD654; &amp;#xB85C;&amp;#xC9C1;&amp;#xC744; &amp;#xBD84;&amp;#xC11D;&amp;#xD558;&amp;#xAE30; &amp;#xC704;&amp;#xD574;&amp;#xC11C;&amp;#xB294; Windows &amp;#xBD80;&amp;#xD305; &amp;#xC2DC; &amp;#xCEE4;&amp;#xB110;&amp;#xC744; &amp;#xCD08;&amp;#xAE30;&amp;#xD654;&amp;#xD558;&amp;#xB294; &amp;#xBD80;&amp;#xBD84;&amp;#xAE4C;&amp;#xC9C0; &amp;#xB4E4;&amp;#xC5B4;&amp;#xAC00;&amp;#xC57C; &amp;#xD569;&amp;#xB2C8;&amp;#xB2E4;.  &lt;/p&gt;
&lt;p&gt;Windows &amp;#xCEE4;&amp;#xB110; &amp;#xC774;&amp;#xBBF8;&amp;#xC9C0; &lt;code&gt;ntoskrnl.exe&lt;/code&gt;&amp;#xC758; Entry Point&amp;#xB294; &lt;code&gt;KiSystemStartup&lt;/code&gt; &amp;#xC73C;&amp;#xB85C;, CPU &amp;#xCD08;&amp;#xAE30;&amp;#xD654;&amp;#xBD80;&amp;#xD130; &amp;#xBBF8;&amp;#xD2F0;&amp;#xAC8C;&amp;#xC774;&amp;#xC158; &amp;#xAD00;&amp;#xB828;&amp;#xB41C; Feature &amp;#xC138;&amp;#xD305; &amp;#xC218;&amp;#xD589;, &amp;#xCEE4;&amp;#xB110; &amp;#xB514;&amp;#xBC84;&amp;#xAC70; &amp;#xCD08;&amp;#xAE30;&amp;#xD654; &amp;#xB4F1; &amp;#xB2E4;&amp;#xC591;&amp;#xD55C; &amp;#xC5ED;&amp;#xD560;&amp;#xC744; &amp;#xC218;&amp;#xD589;&amp;#xD569;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;p&gt;KVAS &amp;#xD65C;&amp;#xC131;&amp;#xD654; &amp;#xC5EC;&amp;#xBD80;&amp;#xB97C; &amp;#xACB0;&amp;#xC815;&amp;#xD558;&amp;#xB294; &amp;#xD568;&amp;#xC218;&amp;#xB294; &amp;#xC758;&amp;#xC678;&amp;#xB85C; &amp;#xAE08;&amp;#xBC29; &amp;#xCC3E;&amp;#xC744; &amp;#xC218; &amp;#xC788;&amp;#xC5C8;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;KiSystemStartup &amp;#x2192; KiInitializeBootStructures &amp;#x2192; KiSetFeatureBits &amp;#x2192; KiDetectKvaLeakage&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&#34;hljs cpp&#34;&gt;&lt;span class=&#34;hljs-function&#34;&gt;NTSTATUS __stdcall __noreturn &lt;span class=&#34;hljs-title&#34;&gt;KiSystemStartup&lt;/span&gt;&lt;span class=&#34;hljs-params&#34;&gt;(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;hljs-function&#34;&gt;&lt;/span&gt;{
&lt;span class=&#34;hljs-comment&#34;&gt;//...&lt;/span&gt;
  KeLoaderBlock_0 = (__int64)DriverObject;
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( !*((_DWORD *)DriverObject-&amp;gt;MajorFunction[&lt;span class=&#34;hljs-number&#34;&gt;3&lt;/span&gt;] + &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;) )
    KasanInitSystem(DriverObject, &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64);
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( !*(_DWORD *)(*(_QWORD *)(KeLoaderBlock_0 + &lt;span class=&#34;hljs-number&#34;&gt;136&lt;/span&gt;) + &lt;span class=&#34;hljs-number&#34;&gt;36&lt;/span&gt;i64) )
    KdInitSystem(&lt;span class=&#34;hljs-number&#34;&gt;0xFFFFFFFF&lt;/span&gt;i64, KeLoaderBlock_0);
  v2 = *(&lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; **)(KeLoaderBlock_0 + &lt;span class=&#34;hljs-number&#34;&gt;136&lt;/span&gt;);

&lt;span class=&#34;hljs-comment&#34;&gt;//...&lt;/span&gt;

  KiInitializeBootStructures(KeLoaderBlock_0);  &lt;span class=&#34;hljs-comment&#34;&gt;// Initialize Boot Structures&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( !*MK_FP(&lt;span class=&#34;hljs-number&#34;&gt;43&lt;/span&gt;, *MK_FP(&lt;span class=&#34;hljs-number&#34;&gt;43&lt;/span&gt;, KeLoaderBlock_0 + &lt;span class=&#34;hljs-number&#34;&gt;136&lt;/span&gt;) + &lt;span class=&#34;hljs-number&#34;&gt;36&lt;/span&gt;i64) )
    KdInitSystem(&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64, KeLoaderBlock_0);
&lt;span class=&#34;hljs-comment&#34;&gt;//...&lt;/span&gt;

}

&lt;span class=&#34;hljs-function&#34;&gt;__int64 __fastcall &lt;span class=&#34;hljs-title&#34;&gt;KiInitializeBootStructures&lt;/span&gt;&lt;span class=&#34;hljs-params&#34;&gt;(__int64 a1)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;hljs-function&#34;&gt;&lt;/span&gt;{
  KPCR *Pcr; &lt;span class=&#34;hljs-comment&#34;&gt;// r14&lt;/span&gt;
  _KPROCESS **v2; &lt;span class=&#34;hljs-comment&#34;&gt;// rbx&lt;/span&gt;
  &lt;span class=&#34;hljs-class&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;struct&lt;/span&gt; _&lt;span class=&#34;hljs-title&#34;&gt;KPRCB&lt;/span&gt; *&lt;span class=&#34;hljs-title&#34;&gt;CurrentPrcb&lt;/span&gt;;&lt;/span&gt; &lt;span class=&#34;hljs-comment&#34;&gt;// rdi&lt;/span&gt;
&lt;span class=&#34;hljs-comment&#34;&gt;//...&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( !KeGetPcr()-&amp;gt;Prcb.Number )
    KiInitializeNxSupportDiscard(v19, v18, v20);
  HalInitializeProcessor(Number, a1, v20);
  KiSetFeatureBits(CurrentPrcb);                &lt;span class=&#34;hljs-comment&#34;&gt;// Set Prcb Feature Bits&lt;/span&gt;
  CurrentPCB_Number = CurrentPrcb-&amp;gt;Number;
  v27 = KiSystemCall32;
  v28 = KiSystemCall64;
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( !CurrentPCB_Number )
  {
    KiEnableKvaShadowing(CurrentPrcb);              &lt;span class=&#34;hljs-comment&#34;&gt;// KVA Shadow &amp;#xD65C;&amp;#xC131;&amp;#xD654; &amp;#xC5EC;&amp;#xBD80;&amp;#xB97C; &amp;#xACB0;&amp;#xC815;&lt;/span&gt;
    CurrentPCB_Number = CurrentPrcb-&amp;gt;Number;
  }
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( KiKvaShadow )                             &lt;span class=&#34;hljs-comment&#34;&gt;// KVA Shadow &amp;#xD50C;&amp;#xB798;&amp;#xADF8;&amp;#xAC00; &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xB418;&amp;#xBA74;&lt;/span&gt;
  {
    v27 = KiSystemCall32Shadow;                 &lt;span class=&#34;hljs-comment&#34;&gt;// KiSystemCall32/KiSystemCall64 &amp;#xB300;&amp;#xC2E0; &lt;/span&gt;
    v28 = KiSystemCall64Shadow;                 &lt;span class=&#34;hljs-comment&#34;&gt;// KiSystemCall32Shadow/KiSystemCall64Shadow &amp;#xC0AC;&amp;#xC6A9;&lt;/span&gt;
  }
  
&lt;span class=&#34;hljs-comment&#34;&gt;//...&lt;/span&gt;
}

&lt;span class=&#34;hljs-function&#34;&gt;__int64 __fastcall &lt;span class=&#34;hljs-title&#34;&gt;KiSetFeatureBits&lt;/span&gt;&lt;span class=&#34;hljs-params&#34;&gt;(_KPRCB *CurrentPRCB)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;hljs-function&#34;&gt;&lt;/span&gt;{
  &lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt; CpuType; &lt;span class=&#34;hljs-comment&#34;&gt;// bl&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; CpuModel; &lt;span class=&#34;hljs-comment&#34;&gt;// ecx&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int8 CpuVendor; &lt;span class=&#34;hljs-comment&#34;&gt;// dl&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; ProcessorSignature; &lt;span class=&#34;hljs-comment&#34;&gt;// eax&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int8 CpuStepping; &lt;span class=&#34;hljs-comment&#34;&gt;// cl&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int8 v57; &lt;span class=&#34;hljs-comment&#34;&gt;// al&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int64 v58; &lt;span class=&#34;hljs-comment&#34;&gt;// rcx&lt;/span&gt;
&lt;span class=&#34;hljs-comment&#34;&gt;//...&lt;/span&gt;

  CpuType = CurrentPRCB-&amp;gt;CpuType_Family;        &lt;span class=&#34;hljs-comment&#34;&gt;// CpuType = Processor Family&lt;/span&gt;
  CpuModel = CurrentPRCB-&amp;gt;CpuModel;
  CpuVendor = CurrentPRCB-&amp;gt;CpuVendor;
  v123 = (CpuVendor - &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;) &amp;lt;= &lt;span class=&#34;hljs-number&#34;&gt;1u&lt;/span&gt;;
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( CurrentPRCB-&amp;gt;Number )
  {
    ProcessorSignature = KiGetProcessorSignature(&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64, &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64, &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64, &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64);
    KiSetProcessorSignature(CurrentPRCB, ProcessorSignature);
    &lt;span class=&#34;hljs-keyword&#34;&gt;goto&lt;/span&gt; LABEL_40;
  }

&lt;span class=&#34;hljs-comment&#34;&gt;//... &lt;/span&gt;
  KiDetectKvaLeakage(CurrentPRCB);      &lt;span class=&#34;hljs-comment&#34;&gt;// Detect - KVA needs to be activated&lt;/span&gt;
  _m_prefetchw(CurrentPRCB);
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( CurrentPRCB-&amp;gt;CpuVendor == &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt; )
  {
    v52 |= &lt;span class=&#34;hljs-number&#34;&gt;0x100000&lt;/span&gt;u;
    HIDWORD(v134) = v52;
  }
&lt;span class=&#34;hljs-comment&#34;&gt;//...&lt;/span&gt;
}&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&#34;KVAS-Activation-for-Meltdown&#34;&gt;&lt;a href=&#34;#KVAS-Activation-for-Meltdown&#34; class=&#34;headerlink&#34; title=&#34;KVAS Activation for Meltdown&#34;&gt;&lt;/a&gt;KVAS Activation for Meltdown&lt;/h2&gt;&lt;p&gt;&amp;#xC704; &amp;#xD638;&amp;#xCD9C; &amp;#xCCB4;&amp;#xC778;&amp;#xC5D0;&amp;#xC11C; &lt;code&gt;KiDetectKvaLeakage&lt;/code&gt; &amp;#xD568;&amp;#xC218;&amp;#xAC00; &amp;#xBC14;&amp;#xB85C; KVA &amp;#xD65C;&amp;#xC131;&amp;#xD654; &amp;#xC5EC;&amp;#xBD80;&amp;#xB97C; &amp;#xACB0;&amp;#xC815;&amp;#xD558;&amp;#xB294; &amp;#xCF54;&amp;#xC5B4; &amp;#xD568;&amp;#xC218;&amp;#xC785;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs cpp&#34;&gt;&lt;span class=&#34;hljs-function&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; __fastcall &lt;span class=&#34;hljs-title&#34;&gt;KiDetectKvaLeakage&lt;/span&gt;&lt;span class=&#34;hljs-params&#34;&gt;(_KPRCB *a1)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;hljs-function&#34;&gt;&lt;/span&gt;{
  __int64 p_CpuVendor; &lt;span class=&#34;hljs-comment&#34;&gt;// rsi&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int64 _RAX; &lt;span class=&#34;hljs-comment&#34;&gt;// rax&lt;/span&gt;
  __int64 v4; &lt;span class=&#34;hljs-comment&#34;&gt;// rcx&lt;/span&gt;
  __int64 _RAX; &lt;span class=&#34;hljs-comment&#34;&gt;// rax&lt;/span&gt;
  __int64 _RAX; &lt;span class=&#34;hljs-comment&#34;&gt;// rax&lt;/span&gt;
  __int64 _RDX; &lt;span class=&#34;hljs-comment&#34;&gt;// rdx&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int64 v13; &lt;span class=&#34;hljs-comment&#34;&gt;// rdx&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;bool&lt;/span&gt; v14; &lt;span class=&#34;hljs-comment&#34;&gt;// zf&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; *v15; &lt;span class=&#34;hljs-comment&#34;&gt;// rdx&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; v16; &lt;span class=&#34;hljs-comment&#34;&gt;// ecx&lt;/span&gt;
  __int64 v17; &lt;span class=&#34;hljs-comment&#34;&gt;// rbx&lt;/span&gt;
  __int64 _RAX; &lt;span class=&#34;hljs-comment&#34;&gt;// rax&lt;/span&gt;
  __int64 _RAX; &lt;span class=&#34;hljs-comment&#34;&gt;// rax&lt;/span&gt;
  __int64 _RAX; &lt;span class=&#34;hljs-comment&#34;&gt;// rax&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; Number; &lt;span class=&#34;hljs-comment&#34;&gt;// edx&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; v29[&lt;span class=&#34;hljs-number&#34;&gt;6&lt;/span&gt;]; &lt;span class=&#34;hljs-comment&#34;&gt;// [rsp+30h] [rbp-20h] BYREF&lt;/span&gt;

  v29[&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;] = &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;;
  p_CpuVendor = &amp;amp;a1-&amp;gt;CpuVendor;
  
  &lt;span class=&#34;hljs-comment&#34;&gt;// Check 1&lt;/span&gt;
  LODWORD(_RAX) = KiIsKvaShadowNeededForBranchConfusion(a1);
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( _RAX )
    &lt;span class=&#34;hljs-keyword&#34;&gt;goto&lt;/span&gt; ENABLE_KVAS_BRANCH_CONFUSION;
  LODWORD(_RAX) = *p_CpuVendor;
  
  &lt;span class=&#34;hljs-comment&#34;&gt;// Check 2&lt;/span&gt;
  &lt;span class=&#34;hljs-comment&#34;&gt;// Intel - Check with bitmask&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( *p_CpuVendor == &lt;span class=&#34;hljs-number&#34;&gt;2&lt;/span&gt; )
  {
    _RAX = a1-&amp;gt;CpuModel;
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( a1-&amp;gt;CpuType == &lt;span class=&#34;hljs-number&#34;&gt;6&lt;/span&gt; &amp;amp;&amp;amp; _RAX &amp;lt;= &lt;span class=&#34;hljs-number&#34;&gt;0x36&lt;/span&gt;u )
    {
      v4 = &lt;span class=&#34;hljs-number&#34;&gt;0x6000C010000000&lt;/span&gt;i64;
      &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( _bittest64(&amp;amp;v4, _RAX) )
        &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; _RAX;
    }
  }
  &lt;span class=&#34;hljs-comment&#34;&gt;// Others - disable KVAS&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( _RAX != &lt;span class=&#34;hljs-number&#34;&gt;3&lt;/span&gt; || a1-&amp;gt;CpuType == &lt;span class=&#34;hljs-number&#34;&gt;6&lt;/span&gt; &amp;amp;&amp;amp; a1-&amp;gt;CpuModel == &lt;span class=&#34;hljs-number&#34;&gt;13&lt;/span&gt;)
  {
    &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; _RAX;
  }
	
	&lt;span class=&#34;hljs-comment&#34;&gt;// Check 3&lt;/span&gt;
	&lt;span class=&#34;hljs-comment&#34;&gt;// IA32_ARCH_CAPABILITIES support query&lt;/span&gt;
  _RAX = &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64;
  __asm { cpuid }
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( _RAX &amp;lt; &lt;span class=&#34;hljs-number&#34;&gt;7&lt;/span&gt; )
    &lt;span class=&#34;hljs-keyword&#34;&gt;goto&lt;/span&gt; ENABLE_KVAS;
  _RAX = &lt;span class=&#34;hljs-number&#34;&gt;7&lt;/span&gt;i64;
  __asm { cpuid }
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( (_RDX &amp;amp; &lt;span class=&#34;hljs-number&#34;&gt;0x20000000&lt;/span&gt;) == &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt; )
    &lt;span class=&#34;hljs-keyword&#34;&gt;goto&lt;/span&gt; ENABLE_KVAS;

	&lt;span class=&#34;hljs-comment&#34;&gt;// Check 3&lt;/span&gt;
	&lt;span class=&#34;hljs-comment&#34;&gt;// msr address 0x10A - IA32_ARCH_CAPABILITIES&lt;/span&gt;
  _RAX = __readmsr(&lt;span class=&#34;hljs-number&#34;&gt;0x10A&lt;/span&gt;u);
  &lt;span class=&#34;hljs-comment&#34;&gt;//IA32_ARCH_CAPABILITIES bit 0 : RDCL_NO&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( (_RAX &amp;amp; &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;) == &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt; )
    &lt;span class=&#34;hljs-keyword&#34;&gt;goto&lt;/span&gt; ENABLE_KVAS;
 
  KiMicrocodeTrackerEnabled = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;
  LODWORD(_RAX) = &lt;span class=&#34;hljs-number&#34;&gt;3670016&lt;/span&gt;;
  LOBYTE(v13) = (KeFeatureBits2 &amp;amp; &lt;span class=&#34;hljs-number&#34;&gt;0x28&lt;/span&gt;) == &lt;span class=&#34;hljs-number&#34;&gt;8&lt;/span&gt;;
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( (KeFeatureBits2 &amp;amp; &lt;span class=&#34;hljs-number&#34;&gt;0x380000&lt;/span&gt;) != &lt;span class=&#34;hljs-number&#34;&gt;3670016&lt;/span&gt; )
  {
    LODWORD(_RAX) = KiIsFbClearSupported(KeFeatureBits2 &amp;amp; &lt;span class=&#34;hljs-number&#34;&gt;0x380000&lt;/span&gt;, v13);
    LOBYTE(v13) = _RAX | v13;
  }
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( v13 )
  {
ENABLE_KVAS:
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( a1-&amp;gt;Number &amp;amp;&amp;amp; !KiKvaLeakage )
      KeBugCheckEx(&lt;span class=&#34;hljs-number&#34;&gt;0x5D&lt;/span&gt;u, &lt;span class=&#34;hljs-number&#34;&gt;0x4B56414C&lt;/span&gt;ui64, &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64, &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64, &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64);
ENABLE_KVAS_BRANCH_CONFUSION:
    v14 = *p_CpuVendor == &lt;span class=&#34;hljs-number&#34;&gt;2&lt;/span&gt;;
    **KiKvaLeakage = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;**
&lt;span class=&#34;hljs-comment&#34;&gt;//... for enable KVA&lt;/span&gt;
  }
  &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; _RAX;
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;KiDetectKvaLeakage&lt;/code&gt; &amp;#xD568;&amp;#xC218;&amp;#xB294; KPRCB&amp;#xC5D0; &amp;#xD3EC;&amp;#xD568;&amp;#xB41C; CPU &amp;#xBCA4;&amp;#xB354; &amp;#xBC0F; &amp;#xBAA8;&amp;#xB378; &amp;#xC815;&amp;#xBCF4;&amp;#xC640;, MSR&amp;#xC744; &amp;#xC77D;&amp;#xC5B4; &amp;#xD655;&amp;#xC778;&amp;#xD560; &amp;#xC218; &amp;#xC788;&amp;#xB294; &amp;#xC815;&amp;#xBCF4;&amp;#xB97C; &amp;#xD1B5;&amp;#xD574; KVAS &amp;#xD65C;&amp;#xC131;&amp;#xD654; &amp;#xC5EC;&amp;#xBD80;&amp;#xB97C; &amp;#xACB0;&amp;#xC815;&amp;#xD569;&amp;#xB2C8;&amp;#xB2E4;. &amp;#xD655;&amp;#xC778;&amp;#xD558;&amp;#xB294; &amp;#xB8E8;&amp;#xD2F4;&amp;#xC740; &amp;#xD06C;&amp;#xAC8C; &amp;#xC138; &amp;#xAC00;&amp;#xC9C0;&amp;#xB85C; &amp;#xB098;&amp;#xB20C; &amp;#xC218; &amp;#xC788;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;h3 id=&#34;Check-1&#34;&gt;&lt;a href=&#34;#Check-1&#34; class=&#34;headerlink&#34; title=&#34;Check 1&#34;&gt;&lt;/a&gt;Check 1&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;KiIsKvaShadowNeededForBranchConfusion&lt;/code&gt;&amp;#xD568;&amp;#xC218;&amp;#xB97C; &amp;#xD1B5;&amp;#xD574; Branch Confusion &amp;#xCDE8;&amp;#xC57D;&amp;#xC810;&amp;#xC5D0; &amp;#xC601;&amp;#xD5A5;&amp;#xBC1B;&amp;#xB294;&amp;#xC9C0; &amp;#xD655;&amp;#xC778;&lt;/li&gt;
&lt;li&gt;&amp;#xD574;&amp;#xB2F9; &amp;#xD568;&amp;#xC218;&amp;#xC758; &amp;#xD638;&amp;#xCD9C; &amp;#xACB0;&amp;#xACFC; Branch Confusion &amp;#xCDE8;&amp;#xC57D;&amp;#xC810; &amp;#xC601;&amp;#xD5A5;&amp;#xC744; &amp;#xBC1B;&amp;#xB294; &amp;#xACBD;&amp;#xC6B0; KVAS&amp;#xB97C; &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xD558;&amp;#xB294; &lt;code&gt;ENABLE_KVAS_BRANCH_CONFUSION&lt;/code&gt; &amp;#xBD84;&amp;#xAE30;&amp;#xB85C; &amp;#xC9C4;&amp;#xD589;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;Check-2&#34;&gt;&lt;a href=&#34;#Check-2&#34; class=&#34;headerlink&#34; title=&#34;Check 2&#34;&gt;&lt;/a&gt;Check 2&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Meltdown&amp;#xC5D0; &amp;#xC601;&amp;#xD5A5;&amp;#xBC1B;&amp;#xC9C0; &amp;#xC54A;&amp;#xC544; KVAS &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xAC00; &amp;#xD544;&amp;#xC694; &amp;#xC5C6;&amp;#xB294; &amp;#xAD6C;&amp;#xD615; CPU&amp;#xB97C; bitmask&amp;#xB97C; &amp;#xD1B5;&amp;#xD574; &amp;#xD544;&amp;#xD130;&amp;#xB9C1;&amp;#xD558;&amp;#xACE0; KVAS&amp;#xB97C; &amp;#xBE44;&amp;#xD65C;&amp;#xC131;&amp;#xD654;&lt;/li&gt;
&lt;li&gt;&amp;#xB610;&amp;#xD55C;, Meltdown&amp;#xC740; Intel &amp;#xD504;&amp;#xB85C;&amp;#xC138;&amp;#xC11C; &amp;#xC544;&amp;#xD0A4;&amp;#xD14D;&amp;#xCCD0;&amp;#xC5D0;&amp;#xB9CC; &amp;#xC601;&amp;#xD5A5;&amp;#xC744; &amp;#xC8FC;&amp;#xB294; &amp;#xCDE8;&amp;#xC57D;&amp;#xC810;&amp;#xC774;&amp;#xBBC0;&amp;#xB85C; &amp;#xB54C;&amp;#xBB38;&amp;#xC5D0; &amp;#xADF8; &amp;#xC678; &amp;#xBCA4;&amp;#xB354;&amp;#xC5D0; &amp;#xB300;&amp;#xD574;&amp;#xC11C;&amp;#xB3C4; KVAS&amp;#xB97C; &amp;#xBE44;&amp;#xD65C;&amp;#xC131;&amp;#xD654;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;Check-3&#34;&gt;&lt;a href=&#34;#Check-3&#34; class=&#34;headerlink&#34; title=&#34;Check 3&#34;&gt;&lt;/a&gt;Check 3&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&amp;#xBA3C;&amp;#xC800; CPU&amp;#xAC00; MSR(Model Specific Register) &amp;#xAE30;&amp;#xB2A5;&amp;#xC744; &amp;#xC9C0;&amp;#xC6D0;&amp;#xD558;&amp;#xB294;&amp;#xC9C0; &amp;#xD655;&amp;#xC778;&lt;ul&gt;
&lt;li&gt;MSR&amp;#xC744; &amp;#xC9C0;&amp;#xC6D0;&amp;#xD558;&amp;#xC9C0; &amp;#xC54A;&amp;#xC73C;&amp;#xBA74; Meltdown&amp;#xC5D0; &amp;#xC601;&amp;#xD5A5;&amp;#xC744; &amp;#xBC1B;&amp;#xB294; &amp;#xAD6C;&amp;#xD615; CPU&amp;#xC774;&amp;#xBBC0;&amp;#xB85C; KVAS &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xD558;&amp;#xB294; &lt;code&gt;ENABLE_KVAS&lt;/code&gt; &amp;#xBD84;&amp;#xAE30;&amp;#xB85C; &amp;#xC9C4;&amp;#xD589;&lt;/li&gt;
&lt;li&gt;MSR&amp;#xC744; &amp;#xC9C0;&amp;#xC6D0;&amp;#xD558;&amp;#xC9C0; &amp;#xC54A;&amp;#xC9C0;&amp;#xB9CC; &amp;#xC601;&amp;#xD5A5;&amp;#xC744; &amp;#xBC1B;&amp;#xC9C0; &amp;#xC54A;&amp;#xB294; &amp;#xBAA8;&amp;#xB378;&amp;#xC740; Check 2 &amp;#xB8E8;&amp;#xD2F4;&amp;#xC5D0;&amp;#xC11C; bitmask&amp;#xB97C; &amp;#xD1B5;&amp;#xD574; &amp;#xBA3C;&amp;#xC800; &amp;#xD544;&amp;#xD130;&amp;#xB9C1;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;__readmsr&lt;/code&gt;&amp;#xC744; &amp;#xD1B5;&amp;#xD574; MSR &amp;#xC8FC;&amp;#xC18C; &lt;code&gt;0x10A&lt;/code&gt; &amp;#xC77D;&amp;#xAE30; - &lt;a href=&#34;https://www.intel.com/content/www/us/en/developer/articles/technical/software-security-guidance/technical-documentation/cpuid-enumeration-and-architectural-msrs.html&#34;&gt;IA32_ARCH_CAPABILITIES&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&amp;#xACB0;&amp;#xACFC;(&lt;code&gt;_RAX&lt;/code&gt;)&amp;#xC758; &amp;#xD544;&amp;#xB4DC; 0 (&lt;code&gt;RDCL_NO&lt;/code&gt;) &amp;#xAC00; &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xB418;&amp;#xC9C0; &amp;#xC54A;&amp;#xC558;&amp;#xC73C;&amp;#xBA74; KVAS &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xD558;&amp;#xB294; &lt;code&gt;ENABLE_KVAS&lt;/code&gt;&amp;#xBD84;&amp;#xAE30;&amp;#xB85C; &amp;#xC9C4;&amp;#xD589;&lt;/li&gt;
&lt;li&gt;RDCL_NO: Rogue Data Cache Load(Meltdown) &amp;#xC5D0; &amp;#xCDE8;&amp;#xC57D;&amp;#xD558;&amp;#xC9C0; &amp;#xC54A;&amp;#xC74C;&amp;#xC744; &amp;#xB098;&amp;#xD0C0;&amp;#xB0B4;&amp;#xB294; &amp;#xBE44;&amp;#xD2B8; &amp;#xD50C;&amp;#xB798;&amp;#xADF8;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&amp;#xC704; &amp;#xD655;&amp;#xC778; &amp;#xACFC;&amp;#xC815;&amp;#xC744; &amp;#xD1B5;&amp;#xD574; KVAS&amp;#xAC00; &amp;#xD544;&amp;#xC694;&amp;#xD558;&amp;#xB2E4;&amp;#xACE0; &amp;#xD310;&amp;#xB2E8;&amp;#xB418;&amp;#xBA74; &lt;code&gt;KiKvaLeakage&lt;/code&gt;&amp;#xB97C; 1&amp;#xB85C; &amp;#xC124;&amp;#xC815;&amp;#xD569;&amp;#xB2C8;&amp;#xB2E4;. &lt;/p&gt;
&lt;p&gt;&amp;#xD574;&amp;#xB2F9; &amp;#xD568;&amp;#xC218;&amp;#xC758; &amp;#xC8FC;&amp;#xC694; &amp;#xAE30;&amp;#xB2A5;&amp;#xC740; Check 2&amp;#xC640; Chekc3&amp;#xC758; Meltdown &amp;#xCDE8;&amp;#xC57D;&amp;#xC810;&amp;#xC5D0; &amp;#xC601;&amp;#xD5A5;&amp;#xBC1B;&amp;#xB294; Intel &amp;#xD504;&amp;#xB85C;&amp;#xC138;&amp;#xC11C;&amp;#xB97C; &amp;#xC2DD;&amp;#xBCC4;&amp;#xD558;&amp;#xACE0; KVAS &amp;#xD65C;&amp;#xC131;&amp;#xD654; &amp;#xD50C;&amp;#xB798;&amp;#xADF8;&amp;#xB97C; &amp;#xC124;&amp;#xC815;&amp;#xD558;&amp;#xB294; &amp;#xAC83;&amp;#xC73C;&amp;#xB85C; &amp;#xC694;&amp;#xC57D;&amp;#xD560; &amp;#xC218; &amp;#xC788;&amp;#xACA0;&amp;#xB124;&amp;#xC694;. Check 1&amp;#xC740; &amp;#xC544;&amp;#xB798;&amp;#xC5D0;&amp;#xC11C; &amp;#xB354; &amp;#xC790;&amp;#xC138;&amp;#xD558;&amp;#xAC8C; &amp;#xC124;&amp;#xBA85;&amp;#xD558;&amp;#xACA0;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;h2 id=&#34;KVAS-Activation-for-Branch-Confusion&#34;&gt;&lt;a href=&#34;#KVAS-Activation-for-Branch-Confusion&#34; class=&#34;headerlink&#34; title=&#34;KVAS Activation for Branch Confusion&#34;&gt;&lt;/a&gt;KVAS Activation for Branch Confusion&lt;/h2&gt;&lt;p&gt;KVAS&amp;#xB294; Meltdown&amp;#xB9CC; &amp;#xC801;&amp;#xC6A9;&amp;#xB418;&amp;#xB294; &amp;#xBBF8;&amp;#xD2F0;&amp;#xAC8C;&amp;#xC774;&amp;#xC158;&amp;#xC740; &amp;#xC544;&amp;#xB2D9;&amp;#xB2C8;&amp;#xB2E4;. &amp;#xADF8;&amp;#xAC78; &amp;#xD655;&amp;#xC778;&amp;#xD560; &amp;#xC218; &amp;#xC788;&amp;#xB294; &amp;#xD568;&amp;#xC218;&amp;#xAC00; Check 1 &amp;#xB8E8;&amp;#xD2F4;&amp;#xC5D0;&amp;#xC11C; &amp;#xD638;&amp;#xCD9C;&amp;#xD558;&amp;#xB294; &lt;code&gt;KiIsKvaShadowNeededForBranchConfusion&lt;/code&gt; &amp;#xC778;&amp;#xB370;&amp;#xC694;.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs powershell&#34;&gt;__int64 __fastcall KiIsKvaShadowNeededForBranchConfusion(__int64 a1)
{
  unsigned int v2; // ebx
  __int128 v4; // [&lt;span class=&#34;hljs-type&#34;&gt;rsp&lt;/span&gt;+&lt;span class=&#34;hljs-number&#34;&gt;20&lt;/span&gt;&lt;span class=&#34;hljs-type&#34;&gt;h&lt;/span&gt;] [&lt;span class=&#34;hljs-type&#34;&gt;rbp&lt;/span&gt;-&lt;span class=&#34;hljs-number&#34;&gt;28&lt;/span&gt;&lt;span class=&#34;hljs-type&#34;&gt;h&lt;/span&gt;] BYREF
  __int64 v5; // [&lt;span class=&#34;hljs-type&#34;&gt;rsp&lt;/span&gt;+&lt;span class=&#34;hljs-number&#34;&gt;30&lt;/span&gt;&lt;span class=&#34;hljs-type&#34;&gt;h&lt;/span&gt;] [&lt;span class=&#34;hljs-type&#34;&gt;rbp&lt;/span&gt;-&lt;span class=&#34;hljs-number&#34;&gt;18&lt;/span&gt;&lt;span class=&#34;hljs-type&#34;&gt;h&lt;/span&gt;]

  v5 = &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64;
  v4 = &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64;
  KiDetectHardwareSpecControlFeatures(a1, &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64, (__int64)&amp;amp;v4, &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64);
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( (v4 &amp;amp; &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;x8000) == &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt; )
    &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64;
  v2 = &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;;
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( !(unsigned int)KiIsBranchConfusionMitigationDesired(a1, &amp;amp;v4) )
    &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64;
  LOBYTE(v2) = (unsigned int)KiIsBranchConfusionMitigationSupported(a1, &amp;amp;v4) != &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;;
  &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; v2;
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&amp;#xD568;&amp;#xC218;&amp;#xBA85;&amp;#xC5D0;&amp;#xC11C;&amp;#xB3C4; &amp;#xC54C; &amp;#xC218; &amp;#xC788;&amp;#xB4EF;, Branch Confusion &amp;#xCDE8;&amp;#xC57D;&amp;#xC810;&amp;#xC758; &amp;#xC601;&amp;#xD5A5;&amp;#xC744; &amp;#xBC1B;&amp;#xB294; CPU&amp;#xC778;&amp;#xC9C0; &amp;#xD655;&amp;#xC778;&amp;#xD558;&amp;#xACE0; KVA Shadow &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xAC00; &amp;#xD544;&amp;#xC694;&amp;#xD55C;&amp;#xC9C0; &amp;#xACB0;&amp;#xC815;&amp;#xD558;&amp;#xB294; &amp;#xD568;&amp;#xC218;&amp;#xC785;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;KiDetectHardwareSpecControlFeatures&lt;/code&gt; &amp;#xD568;&amp;#xC218; &amp;#xD638;&amp;#xCD9C; &amp;#xACB0;&amp;#xACFC;&amp;#xC778; &lt;code&gt;v4&lt;/code&gt; &amp;#xC758; &lt;code&gt;0x8000&lt;/code&gt; &amp;#xBE44;&amp;#xD2B8;&amp;#xAC00; 1&amp;#xC774;&amp;#xBA74; Branch Confusion&amp;#xC758; &amp;#xC601;&amp;#xD5A5;&amp;#xC744; &amp;#xBC1B;&amp;#xC74C;&lt;/li&gt;
&lt;li&gt;&amp;#xC774;&amp;#xD6C4; &amp;#xAD00;&amp;#xB828; Mitigation&amp;#xC774; &amp;#xC9C0;&amp;#xC6D0;&amp;#xB418;&amp;#xBA74; True &amp;#xBC18;&amp;#xD658; - &lt;code&gt;KiDetectKvaLeakage&lt;/code&gt; &amp;#xD568;&amp;#xC218;&amp;#xC5D0;&amp;#xC11C; KVAS &amp;#xD65C;&amp;#xC131;&amp;#xD654; &amp;#xB8E8;&amp;#xD2F4;&amp;#xC73C;&amp;#xB85C; &amp;#xC9C4;&amp;#xC785;&amp;#xD568;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;KiDetectHardwareSpecControlFeatures&lt;/code&gt; &amp;#xD568;&amp;#xC218;&amp;#xC5D0;&amp;#xC11C; &amp;#xC880; &amp;#xB354; &amp;#xC790;&amp;#xC138;&amp;#xD788; &amp;#xC0B4;&amp;#xD3B4;&amp;#xBCF4;&amp;#xB3C4;&amp;#xB85D; &amp;#xD558;&amp;#xC8E0;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs cpp&#34;&gt;&lt;span class=&#34;hljs-function&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt; *__fastcall &lt;span class=&#34;hljs-title&#34;&gt;KiDetectHardwareSpecControlFeatures&lt;/span&gt;&lt;span class=&#34;hljs-params&#34;&gt;(_KPRCB *PRCB, __int64 _zero, __int64 result2, &lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt; *__zero)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;hljs-function&#34;&gt;&lt;/span&gt;{
  &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; CpuModel_1; &lt;span class=&#34;hljs-comment&#34;&gt;// r14d&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int8 CpuVendor; &lt;span class=&#34;hljs-comment&#34;&gt;// al&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt; CpuType_Family; &lt;span class=&#34;hljs-comment&#34;&gt;// r12&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;bool&lt;/span&gt; IsAnyHypervisorPresent; &lt;span class=&#34;hljs-comment&#34;&gt;// r9&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt; CpuVendor_2; &lt;span class=&#34;hljs-comment&#34;&gt;// bl&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; ProcessorFlags; &lt;span class=&#34;hljs-comment&#34;&gt;// ecx&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int8 CpuModel; &lt;span class=&#34;hljs-comment&#34;&gt;// cl&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int8 CpuStepping; &lt;span class=&#34;hljs-comment&#34;&gt;// al&lt;/span&gt;
&lt;span class=&#34;hljs-comment&#34;&gt;//...&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt; *result; &lt;span class=&#34;hljs-comment&#34;&gt;// rax&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int8 CpuVendor_1; &lt;span class=&#34;hljs-comment&#34;&gt;// [rsp+20h] [rbp-60h]&lt;/span&gt;
  
  
  CpuVendor = PRCB-&amp;gt;CpuVendor;
  CpuType_Family = PRCB-&amp;gt;CpuType_Family;
  LOBYTE(CpuModel_1) = PRCB-&amp;gt;CpuModel;
&lt;span class=&#34;hljs-comment&#34;&gt;//...&lt;/span&gt;
  CpuVendor_1 = CpuVendor;
  v48 = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;
  
  &lt;span class=&#34;hljs-comment&#34;&gt;// Hypervisor check&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( HviIsHypervisorMicrosoftCompatible() )
  {
    HviGetEnlightenmentInformation(&amp;amp;v54);
    v53 = &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64;
    HviGetHypervisorFeatures(&amp;amp;v53);
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( (v53 &amp;amp; &lt;span class=&#34;hljs-number&#34;&gt;0x100000000000&lt;/span&gt;i64) == &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt; || (v54 &amp;amp; &lt;span class=&#34;hljs-number&#34;&gt;0x1000&lt;/span&gt;) != &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt; )
    {
      IsAnyHypervisorPresent = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;
    }
    &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
    {
      IsAnyHypervisorPresent = &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;;
      v48 = &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;;
    }
  }
  &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
  {
    IsAnyHypervisorPresent = HviIsAnyHypervisorPresent();
    v48 = IsAnyHypervisorPresent;
  }
  v11 = result1;

  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( KiIsBranchConfusionPresent(PRCB) )
  {
    v11 |= &lt;span class=&#34;hljs-number&#34;&gt;0x8000&lt;/span&gt;ui64;
    *&amp;amp;result1 = v11;
  }
&lt;span class=&#34;hljs-comment&#34;&gt;//...&lt;/span&gt;
  *result2 = result1;
  *(result2 + &lt;span class=&#34;hljs-number&#34;&gt;16&lt;/span&gt;) = &lt;span class=&#34;hljs-number&#34;&gt;4&lt;/span&gt;i64;
  result = __zero;
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( __zero )
    *__zero = v8;
  &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; result;
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&amp;#xD574;&amp;#xB2F9; &amp;#xD568;&amp;#xC218;&amp;#xC5D0;&amp;#xB294; &amp;#xB2E4;&amp;#xC591;&amp;#xD55C; &amp;#xCD94;&amp;#xCE21; &amp;#xC2E4;&amp;#xD589; &amp;#xAE30;&amp;#xBC18; side-channel &amp;#xCDE8;&amp;#xC57D;&amp;#xC810;&amp;#xC5D0; &amp;#xC601;&amp;#xD5A5;&amp;#xC744; &amp;#xBC1B;&amp;#xB294;&amp;#xC9C0; &amp;#xD655;&amp;#xC778;&amp;#xD558;&amp;#xB294; &amp;#xB85C;&amp;#xC9C1;&amp;#xC774; &amp;#xC788;&amp;#xC9C0;&amp;#xB9CC;, &amp;#xCF54;&amp;#xB4DC;&amp;#xB97C; &amp;#xB2E4; &amp;#xC4F0;&amp;#xAE30;&amp;#xC5D0;&amp;#xB294; &amp;#xB108;&amp;#xBB34; &amp;#xAE30;&amp;#xB2C8;&amp;#xAE4C; KVAS &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xB97C; &amp;#xACB0;&amp;#xC815;&amp;#xD558;&amp;#xB294; &lt;code&gt;0x8000&lt;/code&gt; &amp;#xBE44;&amp;#xD2B8;&amp;#xB97C; &amp;#xC124;&amp;#xC815;&amp;#xD558;&amp;#xB294; &amp;#xCF54;&amp;#xB4DC;&amp;#xB9CC; &amp;#xBCF4;&amp;#xACA0;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&amp;#xCD94;&amp;#xCE21; &amp;#xC2E4;&amp;#xD589; &amp;#xAD00;&amp;#xB828; &amp;#xCDE8;&amp;#xC57D;&amp;#xC810; &amp;#xBAA9;&amp;#xB85D;&amp;#xC740; &lt;a href=&#34;https://support.microsoft.com/en-us/topic/kb4073119-windows-client-guidance-for-it-pros-to-protect-against-silicon-based-microarchitectural-and-speculative-execution-side-channel-vulnerabilities-35820a8a-ae13-1299-88cc-357f104f5b11&#34;&gt;MS &amp;#xD074;&amp;#xB77C;&amp;#xC774;&amp;#xC5B8;&amp;#xB4DC; &amp;#xAC00;&amp;#xC774;&amp;#xB358;&amp;#xC2A4;&lt;/a&gt; &amp;#xCC38;&amp;#xACE0;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;KiIsBranchConfusionPresent&lt;/code&gt; &amp;#xD568;&amp;#xC218; &amp;#xBC18;&amp;#xD658;&amp;#xAC12;&amp;#xC774; True&amp;#xBA74; &lt;code&gt;0x8000&lt;/code&gt; &amp;#xBE44;&amp;#xD2B8;&amp;#xB97C; &amp;#xC124;&amp;#xC815;&amp;#xD558;&amp;#xB124;&amp;#xC694;.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;KiIsBranchConfusionPresent&lt;/code&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs jsx&#34;&gt;__int64 __fastcall KiIsBranchConfusionPresent(_KPRCB *a1)
{
  bool IsAnyHypervisorPresent; &lt;span class=&#34;hljs-comment&#34;&gt;// al&lt;/span&gt;
  unsigned int v3; &lt;span class=&#34;hljs-comment&#34;&gt;// edx&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( a1-&amp;gt;CpuVendor != &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt; || (KeFeatureBits2 &amp;amp; &lt;span class=&#34;hljs-number&#34;&gt;0x1000000&lt;/span&gt;) != &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt; )
    &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64;
  IsAnyHypervisorPresent = HviIsAnyHypervisorPresent();
  v3 = &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;;
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( IsAnyHypervisorPresent )
    &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;i64;
  LOBYTE(v3) = a1-&amp;gt;CpuType_Family != &lt;span class=&#34;hljs-number&#34;&gt;25&lt;/span&gt;;
  &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; v3;
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&amp;#xD568;&amp;#xC218; &amp;#xB85C;&amp;#xC9C1;&amp;#xC744; &amp;#xBD84;&amp;#xC11D;&amp;#xD558;&amp;#xBA74; &amp;#xB2E4;&amp;#xC74C;&amp;#xACFC; &amp;#xAC19;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;CpuVendor&amp;#xAC00; AMD&amp;#xAC00; &amp;#xC544;&amp;#xB2C8;&amp;#xBA74; False &amp;#xBC18;&amp;#xD658;&lt;ul&gt;
&lt;li&gt;Branch Confusion&amp;#xC740; AMD CPU&amp;#xC5D0;&amp;#xB9CC; &amp;#xC601;&amp;#xD5A5;&amp;#xC744; &amp;#xC8FC;&amp;#xB294; &amp;#xCDE8;&amp;#xC57D;&amp;#xC810;(&lt;a href=&#34;https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-23825&#34;&gt;CVE-2022-23825&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;HviIsAnyHypervisorPresent&lt;/code&gt;&amp;#xD568;&amp;#xC218;&amp;#xB97C; &amp;#xD1B5;&amp;#xD574; Hypervisor&amp;#xAC00; &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xB418;&amp;#xC5B4; &amp;#xC788;&amp;#xC73C;&amp;#xBA74; True &amp;#xBC18;&amp;#xD658;&lt;ul&gt;
&lt;li&gt;CVE-2022-23825&amp;#xB294; &amp;#xAC00;&amp;#xC0C1;&amp;#xD654; &amp;#xD658;&amp;#xACBD;&amp;#xC5D0; &amp;#xC601;&amp;#xD5A5;&amp;#xC744; &amp;#xC8FC;&amp;#xB294; &amp;#xCDE8;&amp;#xC57D;&amp;#xC810;&amp;#xC774;&amp;#xBBC0;&amp;#xB85C; Hyperviosr&amp;#xAC00; &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xB41C; &amp;#xACBD;&amp;#xC6B0;&amp;#xC5D0;&amp;#xB9CC; KVAS&amp;#xB97C; &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xD558;&amp;#xB3C4;&amp;#xB85D; &amp;#xAD6C;&amp;#xD604;&amp;#xB428;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Family Number&amp;#xAC00; Zen 3 / Zen 3+ / Zen 4 &amp;#xC778; 25 &amp;#xC778; &amp;#xACBD;&amp;#xC6B0;&amp;#xC5D0;&amp;#xB9CC; True &amp;#xBC18;&amp;#xD658;&lt;ul&gt;
&lt;li&gt;&amp;#xADF8; &amp;#xC678; &amp;#xC544;&amp;#xD0A4;&amp;#xD14D;&amp;#xCC98;&amp;#xB294; &amp;#xC601;&amp;#xD5A5;&amp;#xBC1B;&amp;#xC9C0; &amp;#xC54A;&amp;#xC74C;&amp;#xC744; &amp;#xC54C; &amp;#xC218; &amp;#xC788;&amp;#xC74C;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&amp;#xC774;&amp;#xD6C4; &lt;code&gt;KiEnableKvaShadowing&lt;/code&gt; &amp;#xC5D0;&amp;#xC11C; KVAS &amp;#xD65C;&amp;#xC131;&amp;#xD654; &amp;#xC804; &amp;#xB9C8;&amp;#xC9C0;&amp;#xB9C9; &amp;#xAC80;&amp;#xC0AC;&amp;#xAC00; &amp;#xC874;&amp;#xC7AC;&amp;#xD569;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs cpp&#34;&gt;&lt;span class=&#34;hljs-function&#34;&gt;__int64 __fastcall &lt;span class=&#34;hljs-title&#34;&gt;KiEnableKvaShadowing&lt;/span&gt;&lt;span class=&#34;hljs-params&#34;&gt;(_KPRCB *a1)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;hljs-function&#34;&gt;&lt;/span&gt;{
  __int64 v2; &lt;span class=&#34;hljs-comment&#34;&gt;// rdx&lt;/span&gt;
  __int64 v3; &lt;span class=&#34;hljs-comment&#34;&gt;// rcx&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt; v4; &lt;span class=&#34;hljs-comment&#34;&gt;// cl&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int64 v5; &lt;span class=&#34;hljs-comment&#34;&gt;// rax&lt;/span&gt;
  __int64 v6; &lt;span class=&#34;hljs-comment&#34;&gt;// rdx&lt;/span&gt;
  __int64 v7; &lt;span class=&#34;hljs-comment&#34;&gt;// r11&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int8 v8; &lt;span class=&#34;hljs-comment&#34;&gt;// cf&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int64 v9; &lt;span class=&#34;hljs-comment&#34;&gt;// rax&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int64 v10; &lt;span class=&#34;hljs-comment&#34;&gt;// rax&lt;/span&gt;
  __int64 result; &lt;span class=&#34;hljs-comment&#34;&gt;// rax&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int16 v12; &lt;span class=&#34;hljs-comment&#34;&gt;// cx&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( KiIsKvaShadowDisabled() )
  {
    KiIsKvaShadowConfigDisabled = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;
  }
  &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
  {
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( (KeFeatureBits2 &amp;amp; &lt;span class=&#34;hljs-number&#34;&gt;0x18000&lt;/span&gt;) == &lt;span class=&#34;hljs-number&#34;&gt;0x8000&lt;/span&gt; )
      *(_QWORD *)(v3 + &lt;span class=&#34;hljs-number&#34;&gt;11520&lt;/span&gt;) = &lt;span class=&#34;hljs-number&#34;&gt;3&lt;/span&gt;i64;
    v4 = KiKernelCetEnabled;
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( !(_BYTE)KiKernelCetEnabled &amp;amp;&amp;amp; (&lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int8)KiIsKvaLeakSimulated() )
      KiKvaLeakageSimulate = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;
    
    &lt;span class=&#34;hljs-comment&#34;&gt;// Enable KVAS&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( KiKvaLeakage || KiKvaLeakageSimulate )
    {
      &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( v4 )
        KeBugCheckEx(&lt;span class=&#34;hljs-number&#34;&gt;0x5D&lt;/span&gt;u, &lt;span class=&#34;hljs-number&#34;&gt;0x4B766120&lt;/span&gt;ui64, &lt;span class=&#34;hljs-number&#34;&gt;0x4B434554&lt;/span&gt;ui64, &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64, &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64);
      v5 = __readcr3();
      a1-&amp;gt;KernelDirectoryTableBase = v5;
      *(_QWORD *)(v2 + &lt;span class=&#34;hljs-number&#34;&gt;4216&lt;/span&gt;) = *(_QWORD *)(v2 + &lt;span class=&#34;hljs-number&#34;&gt;4100&lt;/span&gt;);
      KiInitializeDescriptorIst(a1);
      *(_QWORD *)(v7 + &lt;span class=&#34;hljs-number&#34;&gt;4100&lt;/span&gt;) = v7 + &lt;span class=&#34;hljs-number&#34;&gt;16896&lt;/span&gt;;
      &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( a1-&amp;gt;Number )
      {
        result = KiShadowProcessorAllocation(a1, v7);
        &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( !(_DWORD)result )
          &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; result;
        v12 = *(_WORD *)(KeGetPrcb(&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64) + &lt;span class=&#34;hljs-number&#34;&gt;44714&lt;/span&gt;);
        a1-&amp;gt;ShadowFlags |= &lt;span class=&#34;hljs-number&#34;&gt;2u&lt;/span&gt;;
        a1-&amp;gt;VerwSelector = v12;
      }
      &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
      {
        LOBYTE(v6) = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;
        KiInitializeIdt(v7, v6);
        KeGetCurrentThread()-&amp;gt;ApcState.Process-&amp;gt;AddressPolicy = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;
        byte_140FCE0E0 = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;
        _InterlockedOr(dword_140FCE57C, &lt;span class=&#34;hljs-number&#34;&gt;0x4000&lt;/span&gt;u);
        KiSetAddressPolicy(&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;i64);
        v8 = _bittest64((&lt;span class=&#34;hljs-keyword&#34;&gt;const&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;signed&lt;/span&gt; __int64 *)&amp;amp;a1-&amp;gt;FeatureBits, &lt;span class=&#34;hljs-number&#34;&gt;0x2A&lt;/span&gt;u);
        a1-&amp;gt;VerwSelector = &lt;span class=&#34;hljs-number&#34;&gt;24&lt;/span&gt;;
        &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( v8 )
        {
          v9 = __readcr4();
          __writecr4(v9 &amp;amp; &lt;span class=&#34;hljs-number&#34;&gt;0xFFFFFFFFFFFDFF7F&lt;/span&gt;ui64 | &lt;span class=&#34;hljs-number&#34;&gt;0x20000&lt;/span&gt;);
          v10 = __readcr3();
          __writecr3(v10 | &lt;span class=&#34;hljs-number&#34;&gt;2&lt;/span&gt;);
          KiFlushPcid |= &lt;span class=&#34;hljs-number&#34;&gt;1u&lt;/span&gt;;
        }
        &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( (a1-&amp;gt;FeatureBits &amp;amp; &lt;span class=&#34;hljs-number&#34;&gt;0x240000000000&lt;/span&gt;i64) == &lt;span class=&#34;hljs-number&#34;&gt;0x240000000000&lt;/span&gt;i64 )
          KiFlushPcid |= &lt;span class=&#34;hljs-number&#34;&gt;2u&lt;/span&gt;;
        HvlRescindEnlightenments();
        KiKvaShadow = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;
        KiKvaShadowMode = &lt;span class=&#34;hljs-number&#34;&gt;2&lt;/span&gt; - (KiFlushPcid != &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;);
      }
      &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( KiFlushPcid )
        _interlockedbittestandset64((&lt;span class=&#34;hljs-keyword&#34;&gt;volatile&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;signed&lt;/span&gt; __int32 *)&amp;amp;a1-&amp;gt;KernelDirectoryTableBase, &lt;span class=&#34;hljs-number&#34;&gt;0x3F&lt;/span&gt;ui64);
    }
  }
  &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;i64;
}&lt;/code&gt;&lt;/pre&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;if ( KiKvaLeakage || KiKvaLeakageSimulate )&lt;/code&gt;  &amp;#xBD84;&amp;#xAE30;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;KiDetectKvaLeakage&lt;/code&gt; &amp;#xD568;&amp;#xC218;&amp;#xC5D0;&amp;#xC11C; &amp;#xC124;&amp;#xC815;&amp;#xD55C; &amp;#xC804;&amp;#xC5ED;&amp;#xBCC0;&amp;#xC218;&lt;code&gt;KiKvaLeakage&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&amp;#xC218;&amp;#xB3D9; &amp;#xC124;&amp;#xC815;&amp;#xAC12;(&amp;#xB514;&amp;#xBC84;&amp;#xAE45; &amp;#xBC0F; &amp;#xD14C;&amp;#xC2A4;&amp;#xD2B8;&amp;#xC6A9;)&amp;#xC744; &amp;#xD1B5;&amp;#xD574; &amp;#xACB0;&amp;#xC815;&amp;#xB418;&amp;#xB294; &amp;#xAC83;&amp;#xC73C;&amp;#xB85C; &amp;#xCD94;&amp;#xC815;&amp;#xB418;&amp;#xB294; &amp;#xC804;&amp;#xC5ED;&amp;#xBCC0;&amp;#xC218; &lt;code&gt;KiKvaLeakageSimulate&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&amp;#xB450; &amp;#xC804;&amp;#xC5ED;&amp;#xBCC0;&amp;#xC218; &amp;#xAC12; &amp;#xC911; &amp;#xD558;&amp;#xB098;&amp;#xB77C;&amp;#xB3C4; &amp;#xC124;&amp;#xC815;&amp;#xB418;&amp;#xC5B4; &amp;#xC788;&amp;#xC73C;&amp;#xBA74; KVAS&amp;#xB97C; &amp;#xD65C;&amp;#xC131;&amp;#xD654;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&#34;&amp;#xC138;&amp;#xC904;&amp;#xC694;&amp;#xC57D;&#34;&gt;&lt;a href=&#34;#&amp;#xC138;&amp;#xC904;&amp;#xC694;&amp;#xC57D;&#34; class=&#34;headerlink&#34; title=&#34;&amp;#xC138;&amp;#xC904;&amp;#xC694;&amp;#xC57D;&#34;&gt;&lt;/a&gt;&amp;#xC138;&amp;#xC904;&amp;#xC694;&amp;#xC57D;&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;Windows Kernel&amp;#xC740; &amp;#xCD08;&amp;#xAE30;&amp;#xD654; &amp;#xC2DC; CPU&amp;#xC5D0; &amp;#xB530;&amp;#xB77C; KVAS(&amp;#xBC0F; &amp;#xB2E4;&amp;#xB978; &amp;#xBBF8;&amp;#xD2F0;&amp;#xAC8C;&amp;#xC774;&amp;#xC158;)&amp;#xC744; &amp;#xB3D9;&amp;#xC801;&amp;#xC73C;&amp;#xB85C; &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xD568;.&lt;/li&gt;
&lt;li&gt;KVAS &amp;#xD65C;&amp;#xC131;&amp;#xD654; &amp;#xC5EC;&amp;#xBD80;&amp;#xB97C; &amp;#xACB0;&amp;#xC815;&amp;#xD558;&amp;#xB294; &amp;#xAE30;&amp;#xC900;&amp;#xC740; &amp;#xD06C;&amp;#xAC8C; &amp;#xB450; &amp;#xAC00;&amp;#xC9C0;&lt;ul&gt;
&lt;li&gt;Intel: Rogue Data Cache Load(Meltdown)&lt;/li&gt;
&lt;li&gt;AMD: Branch Confusion&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;CPU&amp;#xAC00; MSR&amp;#xC744; &amp;#xD1B5;&amp;#xD574; &amp;#xC81C;&amp;#xACF5;&amp;#xD558;&amp;#xB294; &amp;#xD558;&amp;#xB4DC;&amp;#xC6E8;&amp;#xC5B4; &amp;#xBBF8;&amp;#xD2F0;&amp;#xAC8C;&amp;#xC774;&amp;#xC158; &amp;#xC801;&amp;#xC6A9; &amp;#xC5EC;&amp;#xBD80;&amp;#xB97C; &amp;#xD655;&amp;#xC778;&amp;#xD558;&amp;#xACE0;, MSR &amp;#xAE30;&amp;#xB2A5;&amp;#xC774; &amp;#xC5C6;&amp;#xC73C;&amp;#xBA74; &amp;#xB808;&amp;#xAC70;&amp;#xC2DC; &amp;#xCCB4;&amp;#xD06C; (bitmask, &amp;#xBAA8;&amp;#xB378;&amp;#xB118;&amp;#xBC84; &amp;#xC815;&amp;#xBCF4; &amp;#xB4F1;)&amp;#xB97C; &amp;#xD1B5;&amp;#xD574; KVAS &amp;#xD65C;&amp;#xC131;&amp;#xD654; &amp;#xC5EC;&amp;#xBD80;&amp;#xB97C; &amp;#xACB0;&amp;#xC815;&amp;#xD568;.&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&#34;&amp;#xB9C8;&amp;#xBB34;&amp;#xB9AC;&amp;#xD558;&amp;#xBA70;&#34;&gt;&lt;a href=&#34;#&amp;#xB9C8;&amp;#xBB34;&amp;#xB9AC;&amp;#xD558;&amp;#xBA70;&#34; class=&#34;headerlink&#34; title=&#34;&amp;#xB9C8;&amp;#xBB34;&amp;#xB9AC;&amp;#xD558;&amp;#xBA70;&#34;&gt;&lt;/a&gt;&amp;#xB9C8;&amp;#xBB34;&amp;#xB9AC;&amp;#xD558;&amp;#xBA70;&lt;/h1&gt;&lt;p&gt;&lt;img src=&#34;/2025/08/10/l0ch/deep-dive-into-kva/ko/image1.jpg&#34; alt=&#34;Untitled&#34;&gt;&lt;/p&gt;
&lt;p&gt;&amp;#xC0AC;&amp;#xC2E4; &amp;#xC608;&amp;#xC804;&amp;#xC5D0; &amp;#xD55C;&amp;#xCC3D; &amp;#xCD94;&amp;#xCE21; &amp;#xC2E4;&amp;#xD589; &amp;#xAE30;&amp;#xBC18;&amp;#xC758; &amp;#xC0AC;&amp;#xC774;&amp;#xB4DC;&amp;#xCC44;&amp;#xB110; &amp;#xCDE8;&amp;#xC57D;&amp;#xC810;&amp;#xC774; &amp;#xC774;&amp;#xC288;&amp;#xB420; &amp;#xB54C; &amp;#xAD6D;&amp;#xBC29;&amp;#xC758; &amp;#xC758;&amp;#xBB34;&amp;#xB97C; &amp;#xC218;&amp;#xD589;&amp;#xD558;&amp;#xB290;&amp;#xB77C; &amp;#xC81C;&amp;#xB300;&amp;#xB85C; &amp;#xD30C;&amp;#xBCF4;&amp;#xC9C8; &amp;#xBABB;&amp;#xD588;&amp;#xB294;&amp;#xB370;&amp;#xC694;, &amp;#xC800;&amp;#xBC88; KASLR bypass&amp;#xC640; &amp;#xC774;&amp;#xBC88; &amp;#xAE00;&amp;#xC744; &amp;#xC791;&amp;#xC131;&amp;#xD558;&amp;#xBA74;&amp;#xC11C; &amp;#xC790;&amp;#xC138;&amp;#xD788; &amp;#xD30C;&amp;#xBCFC; &amp;#xAE30;&amp;#xD68C;&amp;#xAC00; &amp;#xB41C; &amp;#xAC83; &amp;#xAC19;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;. &amp;#xACFC;&amp;#xAC70;&amp;#xC758; &amp;#xC774;&amp;#xC288;&amp;#xB97C; &amp;#xC81C;&amp;#xB300;&amp;#xB85C; &amp;#xD30C;&amp;#xC545;&amp;#xD558;&amp;#xB294; &amp;#xAC8C; &amp;#xD604;&amp;#xC7AC;&amp;#xC758; &amp;#xD2B8;&amp;#xB80C;&amp;#xB4DC;&amp;#xB97C; &amp;#xB530;&amp;#xB77C;&amp;#xAC00;&amp;#xB294; &amp;#xAC83; &amp;#xB9CC;&amp;#xD07C;&amp;#xC774;&amp;#xB098; &amp;#xC911;&amp;#xC694;&amp;#xD558;&amp;#xB2E4;&amp;#xB294; &amp;#xAC83;&amp;#xC744; &amp;#xB2E4;&amp;#xC2DC; &amp;#xD55C; &amp;#xBC88; &amp;#xB290;&amp;#xB07C;&amp;#xBA74;&amp;#xC11C;,  &lt;del&gt;&amp;#xC774;&amp;#xC81C; Windows Internals &amp;#xC644;&amp;#xB3C5;&amp;#xC744; &amp;#xB2E4;&amp;#xC2DC; &amp;#xC2DC;&amp;#xB3C4;&amp;#xD558;&amp;#xB294; &amp;#xAC78;&amp;#xB85C;..&lt;/del&gt;&lt;/p&gt;
&lt;p&gt;&amp;#xB2E4;&amp;#xC74C;&amp;#xC5D0;&amp;#xB3C4; &amp;#xC7AC;&amp;#xBC0C;&amp;#xB294; &amp;#xC5F0;&amp;#xAD6C; &amp;#xC8FC;&amp;#xC81C; &amp;#xB4E4;&amp;#xACE0; &amp;#xC624;&amp;#xB3C4;&amp;#xB85D; &amp;#xD558;&amp;#xACA0;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;~&lt;/p&gt;
&lt;h1 id=&#34;Reference&#34;&gt;&lt;a href=&#34;#Reference&#34; class=&#34;headerlink&#34; title=&#34;Reference&#34;&gt;&lt;/a&gt;Reference&lt;/h1&gt;&lt;p&gt;&lt;a href=&#34;https://support.microsoft.com/en-us/topic/kb4073119-windows-client-guidance-for-it-pros-to-protect-against-silicon-based-microarchitectural-and-speculative-execution-side-channel-vulnerabilities-35820a8a-ae13-1299-88cc-357f104f5b11&#34;&gt;https://support.microsoft.com/en-us/topic/kb4073119-windows-client-guidance-for-it-pros-to-protect-against-silicon-based-microarchitectural-and-speculative-execution-side-channel-vulnerabilities-35820a8a-ae13-1299-88cc-357f104f5b11&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-23825&#34;&gt;https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-23825&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.intel.com/content/www/us/en/developer/articles/technical/software-security-guidance/technical-documentation/cpuid-enumeration-and-architectural-msrs.html&#34;&gt;https://www.intel.com/content/www/us/en/developer/articles/technical/software-security-guidance/technical-documentation/cpuid-enumeration-and-architectural-msrs.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/amd64_x/cpu_vendors.htm&#34;&gt;https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/amd64_x/cpu_vendors.htm&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://support.microsoft.com/en-us/topic/kb4074629-understanding-speculationcontrol-powershell-script-output-fd70a80a-a63f-e539-cda5-5be4c9e67c04&#34;&gt;https://support.microsoft.com/en-us/topic/kb4074629-understanding-speculationcontrol-powershell-script-output-fd70a80a-a63f-e539-cda5-5be4c9e67c04&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.intel.com/content/www/us/en/content-details/782158/intel-64-and-ia-32-architectures-software-developer-s-manual-combined-volumes-1-2a-2b-2c-2d-3a-3b-3c-3d-and-4.html&#34;&gt;https://www.intel.com/content/www/us/en/content-details/782158/intel-64-and-ia-32-architectures-software-developer-s-manual-combined-volumes-1-2a-2b-2c-2d-3a-3b-3c-3d-and-4.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.vergiliusproject.com/kernels/x64/windows-11/24h2/_KPRCB&#34;&gt;https://www.vergiliusproject.com/kernels/x64/windows-11/24h2/_KPRCB&lt;/a&gt;&lt;/p&gt;
 - hack &amp; life">
  <meta name="author" content="j0dev, y2sman">
  <meta name="keywords" content>
  <meta name="google-site-verification" content="DXkyiaX95-ws53Tyt0m91_umRf4gfV2qJIQZ5zQDIO4">
  <meta name="naver-site-verification" content="0b4fea742ed293b82621684e466d9f26c3ccee06">


  <meta property="og:type" content="website"> 
  <meta property="og:title" content="[Research] Deep Dive into KVA Shadow&#39;s Dynamic Activation Mechanism(Ko) - hackyboiz">
  <meta property="og:description" content="&lt;p&gt;&amp;#xC548;&amp;#xB155;&amp;#xD558;&amp;#xC138;&amp;#xC694;, L0ch&amp;#xC785;&amp;#xB2C8;&amp;#xB2E4;!  &amp;#xC9C0;&amp;#xB09C; &amp;#xBC88; &amp;#xAE00; &amp;#xC774;&amp;#xD6C4;&amp;#xB85C; &amp;#xC624;&amp;#xB79C;&amp;#xB9CC;&amp;#xC5D0; &amp;#xB3CC;&amp;#xC544;&amp;#xC654;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;&lt;/p&gt;
&lt;p&gt;&amp;#xC9C0;&amp;#xB09C; &amp;#xC8FC;&amp;#xC81C;&amp;#xB294; &lt;a href=&#34;https://hackyboiz.github.io/2025/04/13/l0ch/bypassing-kernel-mitigation-part0/ko/&#34;&gt;[Research] Bypassing Windows Kernel Mitigations: Part0 - Deep Dive into KASLR Leaks Restriction&lt;/a&gt; &amp;#xC600;&amp;#xC5C8;&amp;#xB294;&amp;#xB370;&amp;#xC694;, KASLR &amp;#xC6B0;&amp;#xD68C; PoC&amp;#xC758; &amp;#xB3D9;&amp;#xC791; &amp;#xC870;&amp;#xAC74; &amp;#xC911; &amp;#xD558;&amp;#xB098;&amp;#xAC00; KVA Shadow &amp;#xBE44;&amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xB2E4;! &amp;#xB77C;&amp;#xB294; &amp;#xC774;&amp;#xC57C;&amp;#xAE30;&amp;#xB97C; &amp;#xD588;&amp;#xC5C8;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;p&gt;&amp;#xC791;&amp;#xC131; &amp;#xB2F9;&amp;#xC2DC;&amp;#xC5D0;&amp;#xB294; &amp;#xCD5C;&amp;#xC2E0; Windows 11&amp;#xC5D0;&amp;#xC11C;&amp;#xB294; KVAS&amp;#xAC00; &amp;#xAE30;&amp;#xBCF8;&amp;#xC801;&amp;#xC73C;&amp;#xB85C; &amp;#xBE44;&amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xB418;&amp;#xC5B4; &amp;#xC788;&amp;#xB2E4;&amp;#xACE0; &amp;#xCD94;&amp;#xCE21;&amp;#xD588;&amp;#xC5C8;&amp;#xB294;&amp;#xB370;, &amp;#xD53C;&amp;#xB4DC;&amp;#xBC31;&amp;#xC744; &amp;#xD1B5;&amp;#xD574; KVAS&amp;#xB294; Windows &amp;#xBC84;&amp;#xC804; &amp;#xAE30;&amp;#xC900;&amp;#xC774; &amp;#xC544;&amp;#xB2CC; CPU &amp;#xBAA8;&amp;#xB378;&amp;#xACFC; &amp;#xD2B9;&amp;#xC815; &amp;#xCDE8;&amp;#xC57D;&amp;#xC810;&amp;#xC5D0; &amp;#xC601;&amp;#xD5A5;&amp;#xC744; &amp;#xBC1B;&amp;#xB294;&amp;#xC9C0; &amp;#xD655;&amp;#xC778;&amp;#xD558;&amp;#xACE0; &amp;#xB3D9;&amp;#xC801;&amp;#xC73C;&amp;#xB85C; &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xB41C;&amp;#xB2E4;&amp;#xB294; &amp;#xAC83;&amp;#xC744; &amp;#xC54C;&amp;#xC558;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;h1 id=&#34;SpeculationControl-PowerShell-script&#34;&gt;&lt;a href=&#34;#SpeculationControl-PowerShell-script&#34; class=&#34;headerlink&#34; title=&#34;SpeculationControl PowerShell script&#34;&gt;&lt;/a&gt;&lt;strong&gt;SpeculationControl PowerShell script&lt;/strong&gt;&lt;/h1&gt;&lt;p&gt;KVAS&amp;#xB294; Meltdown, Spectre&amp;#xB85C; &amp;#xB300;&amp;#xD45C;&amp;#xB418;&amp;#xB294; &amp;#xB2E4;&amp;#xC591;&amp;#xD55C; &amp;#xCD94;&amp;#xCE21; &amp;#xC2E4;&amp;#xD589; &amp;#xAE30;&amp;#xBC18; &amp;#xC0AC;&amp;#xC774;&amp;#xB4DC;&amp;#xCC44;&amp;#xB110; &amp;#xCDE8;&amp;#xC57D;&amp;#xC810;&amp;#xACFC; &amp;#xBC00;&amp;#xC811;&amp;#xD55C; &amp;#xAD00;&amp;#xB828;&amp;#xC774; &amp;#xC788;&amp;#xB294; &amp;#xB9CC;&amp;#xD07C;, &amp;#xAD00;&amp;#xB828; MS&amp;#xC758; &amp;#xC9C0;&amp;#xC6D0; &amp;#xC815;&amp;#xBCF4;&amp;#xB97C; &amp;#xC27D;&amp;#xAC8C; &amp;#xD655;&amp;#xC778;&amp;#xD560; &amp;#xC218; &amp;#xC788;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://support.microsoft.com/en-us/topic/kb4074629-understanding-speculationcontrol-powershell-script-output-fd70a80a-a63f-e539-cda5-5be4c9e67c04&#34;&gt;https://support.microsoft.com/en-us/topic/kb4074629-understanding-speculationcontrol-powershell-script-output-fd70a80a-a63f-e539-cda5-5be4c9e67c04&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&amp;#xC81C; &amp;#xCEF4;&amp;#xD4E8;&amp;#xD130;&amp;#xC778; 12&amp;#xC138;&amp;#xB300; Intel CPU&amp;#xB85C; &amp;#xD14C;&amp;#xC2A4;&amp;#xD2B8;&amp;#xD55C; &amp;#xACB0;&amp;#xACFC;&amp;#xB97C; &amp;#xC815;&amp;#xB9AC;&amp;#xD558;&amp;#xBA74; &amp;#xB2E4;&amp;#xC74C;&amp;#xACFC; &amp;#xAC19;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;.&lt;br&gt;&lt;pre&gt;&lt;code class=&#34;hljs powershell&#34;&gt;&lt;span class=&#34;hljs-comment&#34;&gt;# Windwos 11 24H2 - Intel 12th i7-12700&lt;/span&gt;

&lt;span class=&#34;hljs-built_in&#34;&gt;PS&lt;/span&gt; C:\WINDOWS\system32&amp;gt; &lt;span class=&#34;hljs-built_in&#34;&gt;Install-Module&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;-Name&lt;/span&gt; SpeculationControl                                                                                                                                                                                 &amp;#xACC4;&amp;#xC18D;&amp;#xD558;&amp;#xB824;&amp;#xBA74; NuGet &amp;#xACF5;&amp;#xAE09;&amp;#xC790;&amp;#xAC00; &amp;#xD544;&amp;#xC694;&amp;#xD569;&amp;#xB2C8;&amp;#xB2E4;.

&lt;span class=&#34;hljs-built_in&#34;&gt;PS&lt;/span&gt; C:\WINDOWS\system32&amp;gt; &lt;span class=&#34;hljs-built_in&#34;&gt;Get-SpeculationControlSettings&lt;/span&gt;

BTIHardwarePresent                  : True
BTIWindowsSupportPresent            : True
BTIWindowsSupportEnabled            : True
BTIDisabledBySystemPolicy           : False
BTIDisabledByNoHardwareSupport      : False
BTIKernelRetpolineEnabled           : False
BTIKernelImportOptimizationEnabled  : True
RdclHardwareProtectedReported       : True
RdclHardwareProtected               : True
KVAShadowRequired                   : False
KVAShadowWindowsSupportPresent      : True
KVAShadowWindowsSupportEnabled      : False
KVAShadowPcidEnabled                : False
SSBDWindowsSupportPresent           : True
SSBDHardwareVulnerable              : True
SSBDHardwarePresent                 : True
SSBDWindowsSupportEnabledSystemWide : False
L1TFHardwareVulnerable              : False
L1TFWindowsSupportPresent           : True
L1TFWindowsSupportEnabled           : False
L1TFInvalidPteBit                   : &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;
L1DFlushSupported                   : True
HvL1tfStatusAvailable               : True
HvL1tfProcessorNotAffected          : True
MDSWindowsSupportPresent            : True
MDSHardwareVulnerable               : False
MDSWindowsSupportEnabled            : False
FBClearWindowsSupportPresent        : True
SBDRSSDPHardwareVulnerable          : False
FBSDPHardwareVulnerable             : False
PSDPHardwareVulnerable              : False
FBClearWindowsSupportEnabled        : False
&lt;/code&gt;&lt;/pre&gt;&lt;/p&gt;
&lt;div class=&#34;table-container&#34;&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Hardware requires kernel VA shadowing&lt;/th&gt;
&lt;th&gt;Maps to KVAShadowRequired. This line tells you whether your system requires kernel VA shadowing to mitigate a vulnerability.&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Windows OS support for rogue data cache load mitigation is present&lt;/td&gt;
&lt;td&gt;Maps to KVAShadowWindowsSupportPresent. This line tells you whether Windows operating system support for the kernel VA shadow feature is present.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Windows OS support for kernel VA shadow is present&lt;/td&gt;
&lt;td&gt;Maps to KVAShadowWindowsSupportPresent. This line tells you whether Windows operating system support for the kernel VA shadow feature is present. If it is True, the January 2018 update is installed on the device, and kernel VA shadow is supported. If it is False, the January 2018 update is not installed, and kernel VA shadow support does not exist.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Windows OS support for rogue data cache load mitigation is enabled&lt;/td&gt;
&lt;td&gt;Maps to KVAShadowWindowsSupportEnabled. This line tells you whether the kernel VA shadow feature is enabled. If it is True, the hardware is believed to be vulnerable to CVE-2017-5754, Windows operating system support is present, and the feature is enabled.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Windows OS support for kernel VA shadow is enabled&lt;/td&gt;
&lt;td&gt;Maps to KVAShadowWindowsSupportEnabled. This line tells you whether the kernel VA shadow feature is enabled. If it is True, Windows operating system support is present, and the feature is enabled. The Kernel VA shadow feature is currently enabled by default on client versions of Windows and is disabled by default on versions of Windows Server. If it is False, either Windows operating system support is not present, or the feature is not enabled.&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;pre&gt;&lt;code class=&#34;hljs cpp&#34;&gt;Windows&amp;#xC5D0; KVA Shadow &amp;#xAE30;&amp;#xB2A5;&amp;#xC740; &amp;#xC874;&amp;#xC7AC;&amp;#xD558;&amp;#xB098;(KVAShadowWindowsSupportPresent: True) &amp;#xD544;&amp;#xC694;&amp;#xD558;&amp;#xC9C0; &amp;#xC54A;&amp;#xC544;&amp;#xC11C;(KVAShadowRequired: False) &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xB418;&amp;#xC9C0;&amp;#xB294; &amp;#xC54A;&amp;#xC740; &amp;#xC0C1;&amp;#xD0DC; (KVAShadowWindowsSupportEnabled: False)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;KVAS&amp;#xAC00; &amp;#xBE44;&amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xB41C; &amp;#xAC78; &amp;#xC54C; &amp;#xC218; &amp;#xC788;&amp;#xB294;&amp;#xB370;, &amp;#xC774;&amp;#xB294; &amp;#xB2E4;&amp;#xC2DC; &amp;#xB9D0;&amp;#xD558;&amp;#xBA74; &amp;#xBBF8;&amp;#xD2F0;&amp;#xAC8C;&amp;#xC774;&amp;#xC158; &amp;#xAE30;&amp;#xB2A5;&amp;#xC774; &amp;#xC874;&amp;#xC7AC;&amp;#xD558;&amp;#xC9C0;&amp;#xB9CC; &lt;strong&gt;&amp;#xD558;&amp;#xB4DC;&amp;#xC6E8;&amp;#xC5B4;(CPU)&amp;#xAC00; &amp;#xCDE8;&amp;#xC57D;&amp;#xD558;&amp;#xC9C0; &amp;#xC54A;&amp;#xC544;&amp;#xC11C; &amp;#xBBF8;&amp;#xD2F0;&amp;#xAC8C;&amp;#xC774;&amp;#xC158; &amp;#xAE30;&amp;#xB2A5;&amp;#xC774; &amp;#xBE44;&amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xB418;&amp;#xC5C8;&amp;#xB2E4;&lt;/strong&gt;&amp;#xACE0; &amp;#xB9D0;&amp;#xD560; &amp;#xC218; &amp;#xC788;&amp;#xACA0;&amp;#xB124;&amp;#xC694;. &lt;/p&gt;
&lt;p&gt;&amp;#xADF8;&amp;#xB807;&amp;#xB2E4;&amp;#xBA74; Windows&amp;#xB294; &amp;#xC5B4;&amp;#xB514;&amp;#xC11C;, &amp;#xC5B4;&amp;#xB5BB;&amp;#xAC8C; &amp;#xCDE8;&amp;#xC57D;&amp;#xD55C; CPU&amp;#xB97C; &amp;#xC2DD;&amp;#xBCC4;&amp;#xD558;&amp;#xACE0; KVAS &amp;#xD65C;&amp;#xC131;&amp;#xD654; &amp;#xC5EC;&amp;#xBD80;&amp;#xB97C; &amp;#xD310;&amp;#xB2E8;&amp;#xD560;&amp;#xAE4C;&amp;#xC694;?&lt;/p&gt;
&lt;h1 id=&#34;Background-Knowledge-CPU-Identification&#34;&gt;&lt;a href=&#34;#Background-Knowledge-CPU-Identification&#34; class=&#34;headerlink&#34; title=&#34;Background Knowledge - CPU Identification&#34;&gt;&lt;/a&gt;Background Knowledge - CPU Identification&lt;/h1&gt;&lt;p&gt;Windows&amp;#xB294; &amp;#xC790;&amp;#xCCB4;&amp;#xC801;&amp;#xC73C;&amp;#xB85C; CPU&amp;#xC758; &amp;#xBCA4;&amp;#xB354;&amp;#xB97C; &amp;#xC2DD;&amp;#xBCC4;&amp;#xD569;&amp;#xB2C8;&amp;#xB2E4;. &lt;a href=&#34;https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/amd64_x/cpu_vendors.htm&#34;&gt;CPU_VENDORS&lt;/a&gt; Enum&amp;#xC5D0; &amp;#xC815;&amp;#xC758;&amp;#xB418;&amp;#xC5B4; &amp;#xC788;&amp;#xB4EF;&amp;#xC774;, &amp;#xC54C; &amp;#xC218; &amp;#xC5C6;&amp;#xB294; &amp;#xC81C;&amp;#xC870;&amp;#xC0AC;&amp;#xB294; 0, AMD&amp;#xB294; 1, Intel&amp;#xC740; 2&amp;#xB85C; &amp;#xC815;&amp;#xC758;&amp;#xB418;&amp;#xC5B4; &amp;#xC788;&amp;#xC8E0;.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs jsx&#34;&gt;typedef enum
{
    CPU_UNKNOWN,   &lt;span class=&#34;hljs-comment&#34;&gt;// 0&lt;/span&gt;
    CPU_AMD,       &lt;span class=&#34;hljs-comment&#34;&gt;// 1&lt;/span&gt;
    CPU_INTEL,     &lt;span class=&#34;hljs-comment&#34;&gt;// 2&lt;/span&gt;
    CPU_VIA        &lt;span class=&#34;hljs-comment&#34;&gt;// 3&lt;/span&gt;
} CPU_VENDORS;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&amp;#xBCA4;&amp;#xB354;&amp;#xBFD0;&amp;#xB9CC; &amp;#xC544;&amp;#xB2C8;&amp;#xB77C; Faily ID, Model ID &amp;#xC640; &amp;#xAC19;&amp;#xC740; CPU &amp;#xC815;&amp;#xBCF4;&amp;#xB4E4;&amp;#xC740; &lt;a href=&#34;https://www.vergiliusproject.com/kernels/x64/windows-11/24h2/_KPRCB&#34;&gt;KPRCB&lt;/a&gt; &amp;#xAD6C;&amp;#xC870;&amp;#xCCB4;&amp;#xC5D0; &amp;#xC800;&amp;#xC7A5;&amp;#xB429;&amp;#xB2C8;&amp;#xB2E4;. &lt;/p&gt;
&lt;p&gt;&amp;#xC774;&amp;#xB7EC;&amp;#xD55C; ID&amp;#xB4E4;&amp;#xC740; &amp;#xAC01; CPU &amp;#xBCA4;&amp;#xB354;&amp;#xC0AC;&amp;#xAC00; &amp;#xC815;&amp;#xC758;&amp;#xD569;&amp;#xB2C8;&amp;#xB2E4;. Intel&amp;#xC758; &amp;#xACBD;&amp;#xC6B0; Intel CPU &amp;#xC81C;&amp;#xD488;&amp;#xC758; Family ID, Model ID, &amp;#xC138;&amp;#xB300; &amp;#xC815;&amp;#xBCF4;&amp;#xB97C; &lt;a href=&#34;https://www.intel.com/content/www/us/en/content-details/782158/intel-64-and-ia-32-architectures-software-developer-s-manual-combined-volumes-1-2a-2b-2c-2d-3a-3b-3c-3d-and-4.html&#34;&gt;Intel Developer Manual&lt;/a&gt; &amp;#xC5D0;&amp;#xC11C; &amp;#xD655;&amp;#xC778;&amp;#xD560; &amp;#xC218; &amp;#xC788;&amp;#xB294;&amp;#xB370;&amp;#xC694;, 5000&amp;#xC7A5;&amp;#xC774; &amp;#xB118;&amp;#xB294; &amp;#xB9E4;&amp;#xB274;&amp;#xC5BC;&amp;#xC744; &amp;#xC804;&amp;#xBD80; &amp;#xBCFC; &amp;#xC218;&amp;#xB294; &amp;#xC5C6;&amp;#xC73C;&amp;#xB2C8;.. gemini &amp;#xC2DC;&amp;#xCF1C;&amp;#xC11C; &amp;#xC544;&amp;#xB798; &amp;#xD45C;&amp;#xB85C; &amp;#xC815;&amp;#xB9AC;&amp;#xD588;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;. &lt;/p&gt;
&lt;div class=&#34;table-container&#34;&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;strong&gt;&amp;#xB9C8;&amp;#xC774;&amp;#xD06C;&amp;#xB85C;&amp;#xC544;&amp;#xD0A4;&amp;#xD14D;&amp;#xCC98; (&amp;#xC138;&amp;#xB300;)&lt;/strong&gt;&lt;/th&gt;
&lt;th&gt;&lt;strong&gt;&amp;#xD504;&amp;#xB85C;&amp;#xC138;&amp;#xC11C; &amp;#xC81C;&amp;#xD488;&amp;#xAD70;&lt;/strong&gt;&lt;/th&gt;
&lt;th&gt;&lt;strong&gt;Family ID (Hex)&lt;/strong&gt;&lt;/th&gt;
&lt;th&gt;&lt;strong&gt;Model ID (Hex)&lt;/strong&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Raptor Lake (13&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;B7H, BFH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Alder Lake (12&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;97H, 9AH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Tiger Lake (11&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;8CH, 8DH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Rocket Lake (11&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;A7H&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Ice Lake (10&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;7DH, 7EH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Comet Lake (10&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;A5H, A6H&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Amber Lake Y (8&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;8EH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Whiskey Lake U (8&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;8EH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Coffee Lake (8, 9&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;9EH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Kaby Lake (7&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;8EH, 9EH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Skylake (6&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;4EH, 5EH, 55H&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Broadwell (5&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;3DH, 47H, 4FH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Haswell (4&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;3CH, 45H, 46H, 3FH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Ivy Bridge (3&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;3AH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Sandy Bridge (2&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;2AH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Westmere (2010)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;25H, 2CH, 2FH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Nehalem (1&amp;#xC138;&amp;#xB300;)&lt;/td&gt;
&lt;td&gt;Intel Core&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;1AH, 1EH, 1FH, 2EH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Penryn&lt;/td&gt;
&lt;td&gt;Core 2 Duo/Quad&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;17H, 1DH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Merom&lt;/td&gt;
&lt;td&gt;Core 2 Duo&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;0FH&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Yonah&lt;/td&gt;
&lt;td&gt;Core Duo/Solo&lt;/td&gt;
&lt;td&gt;06H&lt;/td&gt;
&lt;td&gt;0EH&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;p&gt;AMD&amp;#xB098; &amp;#xB2E4;&amp;#xB978; &amp;#xBCA4;&amp;#xB354;&amp;#xB4E4;&amp;#xC758; ID &amp;#xB9AC;&amp;#xC2A4;&amp;#xD2B8;&amp;#xB3C4; &amp;#xBAA8;&amp;#xB450; &amp;#xC815;&amp;#xB9AC;&amp;#xD558;&amp;#xACE0; &amp;#xBD84;&amp;#xC11D;&amp;#xC744; &amp;#xC9C4;&amp;#xD589;&amp;#xD588;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;h1 id=&#34;Analysis-of-KVAS-Activation-Logic&#34;&gt;&lt;a href=&#34;#Analysis-of-KVAS-Activation-Logic&#34; class=&#34;headerlink&#34; title=&#34;Analysis of KVAS Activation Logic&#34;&gt;&lt;/a&gt;Analysis of KVAS Activation Logic&lt;/h1&gt;&lt;p&gt;&amp;#xBD84;&amp;#xC11D; &amp;#xD658;&amp;#xACBD;: Windows 24H2 64bit 10.0.26100.1742 &lt;/p&gt;
&lt;p&gt;&amp;#xB2E4;&amp;#xC2DC; &amp;#xB3CC;&amp;#xC544;&amp;#xC640;&amp;#xC11C;, &amp;#xBBF8;&amp;#xD2F0;&amp;#xAC8C;&amp;#xC774;&amp;#xC158; &amp;#xCD08;&amp;#xAE30;&amp;#xD654; &amp;#xB85C;&amp;#xC9C1;&amp;#xC744; &amp;#xBD84;&amp;#xC11D;&amp;#xD558;&amp;#xAE30; &amp;#xC704;&amp;#xD574;&amp;#xC11C;&amp;#xB294; Windows &amp;#xBD80;&amp;#xD305; &amp;#xC2DC; &amp;#xCEE4;&amp;#xB110;&amp;#xC744; &amp;#xCD08;&amp;#xAE30;&amp;#xD654;&amp;#xD558;&amp;#xB294; &amp;#xBD80;&amp;#xBD84;&amp;#xAE4C;&amp;#xC9C0; &amp;#xB4E4;&amp;#xC5B4;&amp;#xAC00;&amp;#xC57C; &amp;#xD569;&amp;#xB2C8;&amp;#xB2E4;.  &lt;/p&gt;
&lt;p&gt;Windows &amp;#xCEE4;&amp;#xB110; &amp;#xC774;&amp;#xBBF8;&amp;#xC9C0; &lt;code&gt;ntoskrnl.exe&lt;/code&gt;&amp;#xC758; Entry Point&amp;#xB294; &lt;code&gt;KiSystemStartup&lt;/code&gt; &amp;#xC73C;&amp;#xB85C;, CPU &amp;#xCD08;&amp;#xAE30;&amp;#xD654;&amp;#xBD80;&amp;#xD130; &amp;#xBBF8;&amp;#xD2F0;&amp;#xAC8C;&amp;#xC774;&amp;#xC158; &amp;#xAD00;&amp;#xB828;&amp;#xB41C; Feature &amp;#xC138;&amp;#xD305; &amp;#xC218;&amp;#xD589;, &amp;#xCEE4;&amp;#xB110; &amp;#xB514;&amp;#xBC84;&amp;#xAC70; &amp;#xCD08;&amp;#xAE30;&amp;#xD654; &amp;#xB4F1; &amp;#xB2E4;&amp;#xC591;&amp;#xD55C; &amp;#xC5ED;&amp;#xD560;&amp;#xC744; &amp;#xC218;&amp;#xD589;&amp;#xD569;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;p&gt;KVAS &amp;#xD65C;&amp;#xC131;&amp;#xD654; &amp;#xC5EC;&amp;#xBD80;&amp;#xB97C; &amp;#xACB0;&amp;#xC815;&amp;#xD558;&amp;#xB294; &amp;#xD568;&amp;#xC218;&amp;#xB294; &amp;#xC758;&amp;#xC678;&amp;#xB85C; &amp;#xAE08;&amp;#xBC29; &amp;#xCC3E;&amp;#xC744; &amp;#xC218; &amp;#xC788;&amp;#xC5C8;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;KiSystemStartup &amp;#x2192; KiInitializeBootStructures &amp;#x2192; KiSetFeatureBits &amp;#x2192; KiDetectKvaLeakage&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&#34;hljs cpp&#34;&gt;&lt;span class=&#34;hljs-function&#34;&gt;NTSTATUS __stdcall __noreturn &lt;span class=&#34;hljs-title&#34;&gt;KiSystemStartup&lt;/span&gt;&lt;span class=&#34;hljs-params&#34;&gt;(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;hljs-function&#34;&gt;&lt;/span&gt;{
&lt;span class=&#34;hljs-comment&#34;&gt;//...&lt;/span&gt;
  KeLoaderBlock_0 = (__int64)DriverObject;
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( !*((_DWORD *)DriverObject-&amp;gt;MajorFunction[&lt;span class=&#34;hljs-number&#34;&gt;3&lt;/span&gt;] + &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;) )
    KasanInitSystem(DriverObject, &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64);
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( !*(_DWORD *)(*(_QWORD *)(KeLoaderBlock_0 + &lt;span class=&#34;hljs-number&#34;&gt;136&lt;/span&gt;) + &lt;span class=&#34;hljs-number&#34;&gt;36&lt;/span&gt;i64) )
    KdInitSystem(&lt;span class=&#34;hljs-number&#34;&gt;0xFFFFFFFF&lt;/span&gt;i64, KeLoaderBlock_0);
  v2 = *(&lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; **)(KeLoaderBlock_0 + &lt;span class=&#34;hljs-number&#34;&gt;136&lt;/span&gt;);

&lt;span class=&#34;hljs-comment&#34;&gt;//...&lt;/span&gt;

  KiInitializeBootStructures(KeLoaderBlock_0);  &lt;span class=&#34;hljs-comment&#34;&gt;// Initialize Boot Structures&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( !*MK_FP(&lt;span class=&#34;hljs-number&#34;&gt;43&lt;/span&gt;, *MK_FP(&lt;span class=&#34;hljs-number&#34;&gt;43&lt;/span&gt;, KeLoaderBlock_0 + &lt;span class=&#34;hljs-number&#34;&gt;136&lt;/span&gt;) + &lt;span class=&#34;hljs-number&#34;&gt;36&lt;/span&gt;i64) )
    KdInitSystem(&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64, KeLoaderBlock_0);
&lt;span class=&#34;hljs-comment&#34;&gt;//...&lt;/span&gt;

}

&lt;span class=&#34;hljs-function&#34;&gt;__int64 __fastcall &lt;span class=&#34;hljs-title&#34;&gt;KiInitializeBootStructures&lt;/span&gt;&lt;span class=&#34;hljs-params&#34;&gt;(__int64 a1)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;hljs-function&#34;&gt;&lt;/span&gt;{
  KPCR *Pcr; &lt;span class=&#34;hljs-comment&#34;&gt;// r14&lt;/span&gt;
  _KPROCESS **v2; &lt;span class=&#34;hljs-comment&#34;&gt;// rbx&lt;/span&gt;
  &lt;span class=&#34;hljs-class&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;struct&lt;/span&gt; _&lt;span class=&#34;hljs-title&#34;&gt;KPRCB&lt;/span&gt; *&lt;span class=&#34;hljs-title&#34;&gt;CurrentPrcb&lt;/span&gt;;&lt;/span&gt; &lt;span class=&#34;hljs-comment&#34;&gt;// rdi&lt;/span&gt;
&lt;span class=&#34;hljs-comment&#34;&gt;//...&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( !KeGetPcr()-&amp;gt;Prcb.Number )
    KiInitializeNxSupportDiscard(v19, v18, v20);
  HalInitializeProcessor(Number, a1, v20);
  KiSetFeatureBits(CurrentPrcb);                &lt;span class=&#34;hljs-comment&#34;&gt;// Set Prcb Feature Bits&lt;/span&gt;
  CurrentPCB_Number = CurrentPrcb-&amp;gt;Number;
  v27 = KiSystemCall32;
  v28 = KiSystemCall64;
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( !CurrentPCB_Number )
  {
    KiEnableKvaShadowing(CurrentPrcb);              &lt;span class=&#34;hljs-comment&#34;&gt;// KVA Shadow &amp;#xD65C;&amp;#xC131;&amp;#xD654; &amp;#xC5EC;&amp;#xBD80;&amp;#xB97C; &amp;#xACB0;&amp;#xC815;&lt;/span&gt;
    CurrentPCB_Number = CurrentPrcb-&amp;gt;Number;
  }
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( KiKvaShadow )                             &lt;span class=&#34;hljs-comment&#34;&gt;// KVA Shadow &amp;#xD50C;&amp;#xB798;&amp;#xADF8;&amp;#xAC00; &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xB418;&amp;#xBA74;&lt;/span&gt;
  {
    v27 = KiSystemCall32Shadow;                 &lt;span class=&#34;hljs-comment&#34;&gt;// KiSystemCall32/KiSystemCall64 &amp;#xB300;&amp;#xC2E0; &lt;/span&gt;
    v28 = KiSystemCall64Shadow;                 &lt;span class=&#34;hljs-comment&#34;&gt;// KiSystemCall32Shadow/KiSystemCall64Shadow &amp;#xC0AC;&amp;#xC6A9;&lt;/span&gt;
  }
  
&lt;span class=&#34;hljs-comment&#34;&gt;//...&lt;/span&gt;
}

&lt;span class=&#34;hljs-function&#34;&gt;__int64 __fastcall &lt;span class=&#34;hljs-title&#34;&gt;KiSetFeatureBits&lt;/span&gt;&lt;span class=&#34;hljs-params&#34;&gt;(_KPRCB *CurrentPRCB)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;hljs-function&#34;&gt;&lt;/span&gt;{
  &lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt; CpuType; &lt;span class=&#34;hljs-comment&#34;&gt;// bl&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; CpuModel; &lt;span class=&#34;hljs-comment&#34;&gt;// ecx&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int8 CpuVendor; &lt;span class=&#34;hljs-comment&#34;&gt;// dl&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; ProcessorSignature; &lt;span class=&#34;hljs-comment&#34;&gt;// eax&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int8 CpuStepping; &lt;span class=&#34;hljs-comment&#34;&gt;// cl&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int8 v57; &lt;span class=&#34;hljs-comment&#34;&gt;// al&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int64 v58; &lt;span class=&#34;hljs-comment&#34;&gt;// rcx&lt;/span&gt;
&lt;span class=&#34;hljs-comment&#34;&gt;//...&lt;/span&gt;

  CpuType = CurrentPRCB-&amp;gt;CpuType_Family;        &lt;span class=&#34;hljs-comment&#34;&gt;// CpuType = Processor Family&lt;/span&gt;
  CpuModel = CurrentPRCB-&amp;gt;CpuModel;
  CpuVendor = CurrentPRCB-&amp;gt;CpuVendor;
  v123 = (CpuVendor - &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;) &amp;lt;= &lt;span class=&#34;hljs-number&#34;&gt;1u&lt;/span&gt;;
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( CurrentPRCB-&amp;gt;Number )
  {
    ProcessorSignature = KiGetProcessorSignature(&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64, &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64, &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64, &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64);
    KiSetProcessorSignature(CurrentPRCB, ProcessorSignature);
    &lt;span class=&#34;hljs-keyword&#34;&gt;goto&lt;/span&gt; LABEL_40;
  }

&lt;span class=&#34;hljs-comment&#34;&gt;//... &lt;/span&gt;
  KiDetectKvaLeakage(CurrentPRCB);      &lt;span class=&#34;hljs-comment&#34;&gt;// Detect - KVA needs to be activated&lt;/span&gt;
  _m_prefetchw(CurrentPRCB);
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( CurrentPRCB-&amp;gt;CpuVendor == &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt; )
  {
    v52 |= &lt;span class=&#34;hljs-number&#34;&gt;0x100000&lt;/span&gt;u;
    HIDWORD(v134) = v52;
  }
&lt;span class=&#34;hljs-comment&#34;&gt;//...&lt;/span&gt;
}&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&#34;KVAS-Activation-for-Meltdown&#34;&gt;&lt;a href=&#34;#KVAS-Activation-for-Meltdown&#34; class=&#34;headerlink&#34; title=&#34;KVAS Activation for Meltdown&#34;&gt;&lt;/a&gt;KVAS Activation for Meltdown&lt;/h2&gt;&lt;p&gt;&amp;#xC704; &amp;#xD638;&amp;#xCD9C; &amp;#xCCB4;&amp;#xC778;&amp;#xC5D0;&amp;#xC11C; &lt;code&gt;KiDetectKvaLeakage&lt;/code&gt; &amp;#xD568;&amp;#xC218;&amp;#xAC00; &amp;#xBC14;&amp;#xB85C; KVA &amp;#xD65C;&amp;#xC131;&amp;#xD654; &amp;#xC5EC;&amp;#xBD80;&amp;#xB97C; &amp;#xACB0;&amp;#xC815;&amp;#xD558;&amp;#xB294; &amp;#xCF54;&amp;#xC5B4; &amp;#xD568;&amp;#xC218;&amp;#xC785;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs cpp&#34;&gt;&lt;span class=&#34;hljs-function&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; __fastcall &lt;span class=&#34;hljs-title&#34;&gt;KiDetectKvaLeakage&lt;/span&gt;&lt;span class=&#34;hljs-params&#34;&gt;(_KPRCB *a1)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;hljs-function&#34;&gt;&lt;/span&gt;{
  __int64 p_CpuVendor; &lt;span class=&#34;hljs-comment&#34;&gt;// rsi&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int64 _RAX; &lt;span class=&#34;hljs-comment&#34;&gt;// rax&lt;/span&gt;
  __int64 v4; &lt;span class=&#34;hljs-comment&#34;&gt;// rcx&lt;/span&gt;
  __int64 _RAX; &lt;span class=&#34;hljs-comment&#34;&gt;// rax&lt;/span&gt;
  __int64 _RAX; &lt;span class=&#34;hljs-comment&#34;&gt;// rax&lt;/span&gt;
  __int64 _RDX; &lt;span class=&#34;hljs-comment&#34;&gt;// rdx&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int64 v13; &lt;span class=&#34;hljs-comment&#34;&gt;// rdx&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;bool&lt;/span&gt; v14; &lt;span class=&#34;hljs-comment&#34;&gt;// zf&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; *v15; &lt;span class=&#34;hljs-comment&#34;&gt;// rdx&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; v16; &lt;span class=&#34;hljs-comment&#34;&gt;// ecx&lt;/span&gt;
  __int64 v17; &lt;span class=&#34;hljs-comment&#34;&gt;// rbx&lt;/span&gt;
  __int64 _RAX; &lt;span class=&#34;hljs-comment&#34;&gt;// rax&lt;/span&gt;
  __int64 _RAX; &lt;span class=&#34;hljs-comment&#34;&gt;// rax&lt;/span&gt;
  __int64 _RAX; &lt;span class=&#34;hljs-comment&#34;&gt;// rax&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; Number; &lt;span class=&#34;hljs-comment&#34;&gt;// edx&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; v29[&lt;span class=&#34;hljs-number&#34;&gt;6&lt;/span&gt;]; &lt;span class=&#34;hljs-comment&#34;&gt;// [rsp+30h] [rbp-20h] BYREF&lt;/span&gt;

  v29[&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;] = &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;;
  p_CpuVendor = &amp;amp;a1-&amp;gt;CpuVendor;
  
  &lt;span class=&#34;hljs-comment&#34;&gt;// Check 1&lt;/span&gt;
  LODWORD(_RAX) = KiIsKvaShadowNeededForBranchConfusion(a1);
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( _RAX )
    &lt;span class=&#34;hljs-keyword&#34;&gt;goto&lt;/span&gt; ENABLE_KVAS_BRANCH_CONFUSION;
  LODWORD(_RAX) = *p_CpuVendor;
  
  &lt;span class=&#34;hljs-comment&#34;&gt;// Check 2&lt;/span&gt;
  &lt;span class=&#34;hljs-comment&#34;&gt;// Intel - Check with bitmask&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( *p_CpuVendor == &lt;span class=&#34;hljs-number&#34;&gt;2&lt;/span&gt; )
  {
    _RAX = a1-&amp;gt;CpuModel;
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( a1-&amp;gt;CpuType == &lt;span class=&#34;hljs-number&#34;&gt;6&lt;/span&gt; &amp;amp;&amp;amp; _RAX &amp;lt;= &lt;span class=&#34;hljs-number&#34;&gt;0x36&lt;/span&gt;u )
    {
      v4 = &lt;span class=&#34;hljs-number&#34;&gt;0x6000C010000000&lt;/span&gt;i64;
      &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( _bittest64(&amp;amp;v4, _RAX) )
        &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; _RAX;
    }
  }
  &lt;span class=&#34;hljs-comment&#34;&gt;// Others - disable KVAS&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( _RAX != &lt;span class=&#34;hljs-number&#34;&gt;3&lt;/span&gt; || a1-&amp;gt;CpuType == &lt;span class=&#34;hljs-number&#34;&gt;6&lt;/span&gt; &amp;amp;&amp;amp; a1-&amp;gt;CpuModel == &lt;span class=&#34;hljs-number&#34;&gt;13&lt;/span&gt;)
  {
    &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; _RAX;
  }
	
	&lt;span class=&#34;hljs-comment&#34;&gt;// Check 3&lt;/span&gt;
	&lt;span class=&#34;hljs-comment&#34;&gt;// IA32_ARCH_CAPABILITIES support query&lt;/span&gt;
  _RAX = &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64;
  __asm { cpuid }
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( _RAX &amp;lt; &lt;span class=&#34;hljs-number&#34;&gt;7&lt;/span&gt; )
    &lt;span class=&#34;hljs-keyword&#34;&gt;goto&lt;/span&gt; ENABLE_KVAS;
  _RAX = &lt;span class=&#34;hljs-number&#34;&gt;7&lt;/span&gt;i64;
  __asm { cpuid }
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( (_RDX &amp;amp; &lt;span class=&#34;hljs-number&#34;&gt;0x20000000&lt;/span&gt;) == &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt; )
    &lt;span class=&#34;hljs-keyword&#34;&gt;goto&lt;/span&gt; ENABLE_KVAS;

	&lt;span class=&#34;hljs-comment&#34;&gt;// Check 3&lt;/span&gt;
	&lt;span class=&#34;hljs-comment&#34;&gt;// msr address 0x10A - IA32_ARCH_CAPABILITIES&lt;/span&gt;
  _RAX = __readmsr(&lt;span class=&#34;hljs-number&#34;&gt;0x10A&lt;/span&gt;u);
  &lt;span class=&#34;hljs-comment&#34;&gt;//IA32_ARCH_CAPABILITIES bit 0 : RDCL_NO&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( (_RAX &amp;amp; &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;) == &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt; )
    &lt;span class=&#34;hljs-keyword&#34;&gt;goto&lt;/span&gt; ENABLE_KVAS;
 
  KiMicrocodeTrackerEnabled = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;
  LODWORD(_RAX) = &lt;span class=&#34;hljs-number&#34;&gt;3670016&lt;/span&gt;;
  LOBYTE(v13) = (KeFeatureBits2 &amp;amp; &lt;span class=&#34;hljs-number&#34;&gt;0x28&lt;/span&gt;) == &lt;span class=&#34;hljs-number&#34;&gt;8&lt;/span&gt;;
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( (KeFeatureBits2 &amp;amp; &lt;span class=&#34;hljs-number&#34;&gt;0x380000&lt;/span&gt;) != &lt;span class=&#34;hljs-number&#34;&gt;3670016&lt;/span&gt; )
  {
    LODWORD(_RAX) = KiIsFbClearSupported(KeFeatureBits2 &amp;amp; &lt;span class=&#34;hljs-number&#34;&gt;0x380000&lt;/span&gt;, v13);
    LOBYTE(v13) = _RAX | v13;
  }
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( v13 )
  {
ENABLE_KVAS:
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( a1-&amp;gt;Number &amp;amp;&amp;amp; !KiKvaLeakage )
      KeBugCheckEx(&lt;span class=&#34;hljs-number&#34;&gt;0x5D&lt;/span&gt;u, &lt;span class=&#34;hljs-number&#34;&gt;0x4B56414C&lt;/span&gt;ui64, &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64, &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64, &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64);
ENABLE_KVAS_BRANCH_CONFUSION:
    v14 = *p_CpuVendor == &lt;span class=&#34;hljs-number&#34;&gt;2&lt;/span&gt;;
    **KiKvaLeakage = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;**
&lt;span class=&#34;hljs-comment&#34;&gt;//... for enable KVA&lt;/span&gt;
  }
  &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; _RAX;
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;KiDetectKvaLeakage&lt;/code&gt; &amp;#xD568;&amp;#xC218;&amp;#xB294; KPRCB&amp;#xC5D0; &amp;#xD3EC;&amp;#xD568;&amp;#xB41C; CPU &amp;#xBCA4;&amp;#xB354; &amp;#xBC0F; &amp;#xBAA8;&amp;#xB378; &amp;#xC815;&amp;#xBCF4;&amp;#xC640;, MSR&amp;#xC744; &amp;#xC77D;&amp;#xC5B4; &amp;#xD655;&amp;#xC778;&amp;#xD560; &amp;#xC218; &amp;#xC788;&amp;#xB294; &amp;#xC815;&amp;#xBCF4;&amp;#xB97C; &amp;#xD1B5;&amp;#xD574; KVAS &amp;#xD65C;&amp;#xC131;&amp;#xD654; &amp;#xC5EC;&amp;#xBD80;&amp;#xB97C; &amp;#xACB0;&amp;#xC815;&amp;#xD569;&amp;#xB2C8;&amp;#xB2E4;. &amp;#xD655;&amp;#xC778;&amp;#xD558;&amp;#xB294; &amp;#xB8E8;&amp;#xD2F4;&amp;#xC740; &amp;#xD06C;&amp;#xAC8C; &amp;#xC138; &amp;#xAC00;&amp;#xC9C0;&amp;#xB85C; &amp;#xB098;&amp;#xB20C; &amp;#xC218; &amp;#xC788;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;h3 id=&#34;Check-1&#34;&gt;&lt;a href=&#34;#Check-1&#34; class=&#34;headerlink&#34; title=&#34;Check 1&#34;&gt;&lt;/a&gt;Check 1&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;KiIsKvaShadowNeededForBranchConfusion&lt;/code&gt;&amp;#xD568;&amp;#xC218;&amp;#xB97C; &amp;#xD1B5;&amp;#xD574; Branch Confusion &amp;#xCDE8;&amp;#xC57D;&amp;#xC810;&amp;#xC5D0; &amp;#xC601;&amp;#xD5A5;&amp;#xBC1B;&amp;#xB294;&amp;#xC9C0; &amp;#xD655;&amp;#xC778;&lt;/li&gt;
&lt;li&gt;&amp;#xD574;&amp;#xB2F9; &amp;#xD568;&amp;#xC218;&amp;#xC758; &amp;#xD638;&amp;#xCD9C; &amp;#xACB0;&amp;#xACFC; Branch Confusion &amp;#xCDE8;&amp;#xC57D;&amp;#xC810; &amp;#xC601;&amp;#xD5A5;&amp;#xC744; &amp;#xBC1B;&amp;#xB294; &amp;#xACBD;&amp;#xC6B0; KVAS&amp;#xB97C; &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xD558;&amp;#xB294; &lt;code&gt;ENABLE_KVAS_BRANCH_CONFUSION&lt;/code&gt; &amp;#xBD84;&amp;#xAE30;&amp;#xB85C; &amp;#xC9C4;&amp;#xD589;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;Check-2&#34;&gt;&lt;a href=&#34;#Check-2&#34; class=&#34;headerlink&#34; title=&#34;Check 2&#34;&gt;&lt;/a&gt;Check 2&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Meltdown&amp;#xC5D0; &amp;#xC601;&amp;#xD5A5;&amp;#xBC1B;&amp;#xC9C0; &amp;#xC54A;&amp;#xC544; KVAS &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xAC00; &amp;#xD544;&amp;#xC694; &amp;#xC5C6;&amp;#xB294; &amp;#xAD6C;&amp;#xD615; CPU&amp;#xB97C; bitmask&amp;#xB97C; &amp;#xD1B5;&amp;#xD574; &amp;#xD544;&amp;#xD130;&amp;#xB9C1;&amp;#xD558;&amp;#xACE0; KVAS&amp;#xB97C; &amp;#xBE44;&amp;#xD65C;&amp;#xC131;&amp;#xD654;&lt;/li&gt;
&lt;li&gt;&amp;#xB610;&amp;#xD55C;, Meltdown&amp;#xC740; Intel &amp;#xD504;&amp;#xB85C;&amp;#xC138;&amp;#xC11C; &amp;#xC544;&amp;#xD0A4;&amp;#xD14D;&amp;#xCCD0;&amp;#xC5D0;&amp;#xB9CC; &amp;#xC601;&amp;#xD5A5;&amp;#xC744; &amp;#xC8FC;&amp;#xB294; &amp;#xCDE8;&amp;#xC57D;&amp;#xC810;&amp;#xC774;&amp;#xBBC0;&amp;#xB85C; &amp;#xB54C;&amp;#xBB38;&amp;#xC5D0; &amp;#xADF8; &amp;#xC678; &amp;#xBCA4;&amp;#xB354;&amp;#xC5D0; &amp;#xB300;&amp;#xD574;&amp;#xC11C;&amp;#xB3C4; KVAS&amp;#xB97C; &amp;#xBE44;&amp;#xD65C;&amp;#xC131;&amp;#xD654;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;Check-3&#34;&gt;&lt;a href=&#34;#Check-3&#34; class=&#34;headerlink&#34; title=&#34;Check 3&#34;&gt;&lt;/a&gt;Check 3&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&amp;#xBA3C;&amp;#xC800; CPU&amp;#xAC00; MSR(Model Specific Register) &amp;#xAE30;&amp;#xB2A5;&amp;#xC744; &amp;#xC9C0;&amp;#xC6D0;&amp;#xD558;&amp;#xB294;&amp;#xC9C0; &amp;#xD655;&amp;#xC778;&lt;ul&gt;
&lt;li&gt;MSR&amp;#xC744; &amp;#xC9C0;&amp;#xC6D0;&amp;#xD558;&amp;#xC9C0; &amp;#xC54A;&amp;#xC73C;&amp;#xBA74; Meltdown&amp;#xC5D0; &amp;#xC601;&amp;#xD5A5;&amp;#xC744; &amp;#xBC1B;&amp;#xB294; &amp;#xAD6C;&amp;#xD615; CPU&amp;#xC774;&amp;#xBBC0;&amp;#xB85C; KVAS &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xD558;&amp;#xB294; &lt;code&gt;ENABLE_KVAS&lt;/code&gt; &amp;#xBD84;&amp;#xAE30;&amp;#xB85C; &amp;#xC9C4;&amp;#xD589;&lt;/li&gt;
&lt;li&gt;MSR&amp;#xC744; &amp;#xC9C0;&amp;#xC6D0;&amp;#xD558;&amp;#xC9C0; &amp;#xC54A;&amp;#xC9C0;&amp;#xB9CC; &amp;#xC601;&amp;#xD5A5;&amp;#xC744; &amp;#xBC1B;&amp;#xC9C0; &amp;#xC54A;&amp;#xB294; &amp;#xBAA8;&amp;#xB378;&amp;#xC740; Check 2 &amp;#xB8E8;&amp;#xD2F4;&amp;#xC5D0;&amp;#xC11C; bitmask&amp;#xB97C; &amp;#xD1B5;&amp;#xD574; &amp;#xBA3C;&amp;#xC800; &amp;#xD544;&amp;#xD130;&amp;#xB9C1;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;__readmsr&lt;/code&gt;&amp;#xC744; &amp;#xD1B5;&amp;#xD574; MSR &amp;#xC8FC;&amp;#xC18C; &lt;code&gt;0x10A&lt;/code&gt; &amp;#xC77D;&amp;#xAE30; - &lt;a href=&#34;https://www.intel.com/content/www/us/en/developer/articles/technical/software-security-guidance/technical-documentation/cpuid-enumeration-and-architectural-msrs.html&#34;&gt;IA32_ARCH_CAPABILITIES&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&amp;#xACB0;&amp;#xACFC;(&lt;code&gt;_RAX&lt;/code&gt;)&amp;#xC758; &amp;#xD544;&amp;#xB4DC; 0 (&lt;code&gt;RDCL_NO&lt;/code&gt;) &amp;#xAC00; &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xB418;&amp;#xC9C0; &amp;#xC54A;&amp;#xC558;&amp;#xC73C;&amp;#xBA74; KVAS &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xD558;&amp;#xB294; &lt;code&gt;ENABLE_KVAS&lt;/code&gt;&amp;#xBD84;&amp;#xAE30;&amp;#xB85C; &amp;#xC9C4;&amp;#xD589;&lt;/li&gt;
&lt;li&gt;RDCL_NO: Rogue Data Cache Load(Meltdown) &amp;#xC5D0; &amp;#xCDE8;&amp;#xC57D;&amp;#xD558;&amp;#xC9C0; &amp;#xC54A;&amp;#xC74C;&amp;#xC744; &amp;#xB098;&amp;#xD0C0;&amp;#xB0B4;&amp;#xB294; &amp;#xBE44;&amp;#xD2B8; &amp;#xD50C;&amp;#xB798;&amp;#xADF8;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&amp;#xC704; &amp;#xD655;&amp;#xC778; &amp;#xACFC;&amp;#xC815;&amp;#xC744; &amp;#xD1B5;&amp;#xD574; KVAS&amp;#xAC00; &amp;#xD544;&amp;#xC694;&amp;#xD558;&amp;#xB2E4;&amp;#xACE0; &amp;#xD310;&amp;#xB2E8;&amp;#xB418;&amp;#xBA74; &lt;code&gt;KiKvaLeakage&lt;/code&gt;&amp;#xB97C; 1&amp;#xB85C; &amp;#xC124;&amp;#xC815;&amp;#xD569;&amp;#xB2C8;&amp;#xB2E4;. &lt;/p&gt;
&lt;p&gt;&amp;#xD574;&amp;#xB2F9; &amp;#xD568;&amp;#xC218;&amp;#xC758; &amp;#xC8FC;&amp;#xC694; &amp;#xAE30;&amp;#xB2A5;&amp;#xC740; Check 2&amp;#xC640; Chekc3&amp;#xC758; Meltdown &amp;#xCDE8;&amp;#xC57D;&amp;#xC810;&amp;#xC5D0; &amp;#xC601;&amp;#xD5A5;&amp;#xBC1B;&amp;#xB294; Intel &amp;#xD504;&amp;#xB85C;&amp;#xC138;&amp;#xC11C;&amp;#xB97C; &amp;#xC2DD;&amp;#xBCC4;&amp;#xD558;&amp;#xACE0; KVAS &amp;#xD65C;&amp;#xC131;&amp;#xD654; &amp;#xD50C;&amp;#xB798;&amp;#xADF8;&amp;#xB97C; &amp;#xC124;&amp;#xC815;&amp;#xD558;&amp;#xB294; &amp;#xAC83;&amp;#xC73C;&amp;#xB85C; &amp;#xC694;&amp;#xC57D;&amp;#xD560; &amp;#xC218; &amp;#xC788;&amp;#xACA0;&amp;#xB124;&amp;#xC694;. Check 1&amp;#xC740; &amp;#xC544;&amp;#xB798;&amp;#xC5D0;&amp;#xC11C; &amp;#xB354; &amp;#xC790;&amp;#xC138;&amp;#xD558;&amp;#xAC8C; &amp;#xC124;&amp;#xBA85;&amp;#xD558;&amp;#xACA0;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;h2 id=&#34;KVAS-Activation-for-Branch-Confusion&#34;&gt;&lt;a href=&#34;#KVAS-Activation-for-Branch-Confusion&#34; class=&#34;headerlink&#34; title=&#34;KVAS Activation for Branch Confusion&#34;&gt;&lt;/a&gt;KVAS Activation for Branch Confusion&lt;/h2&gt;&lt;p&gt;KVAS&amp;#xB294; Meltdown&amp;#xB9CC; &amp;#xC801;&amp;#xC6A9;&amp;#xB418;&amp;#xB294; &amp;#xBBF8;&amp;#xD2F0;&amp;#xAC8C;&amp;#xC774;&amp;#xC158;&amp;#xC740; &amp;#xC544;&amp;#xB2D9;&amp;#xB2C8;&amp;#xB2E4;. &amp;#xADF8;&amp;#xAC78; &amp;#xD655;&amp;#xC778;&amp;#xD560; &amp;#xC218; &amp;#xC788;&amp;#xB294; &amp;#xD568;&amp;#xC218;&amp;#xAC00; Check 1 &amp;#xB8E8;&amp;#xD2F4;&amp;#xC5D0;&amp;#xC11C; &amp;#xD638;&amp;#xCD9C;&amp;#xD558;&amp;#xB294; &lt;code&gt;KiIsKvaShadowNeededForBranchConfusion&lt;/code&gt; &amp;#xC778;&amp;#xB370;&amp;#xC694;.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs powershell&#34;&gt;__int64 __fastcall KiIsKvaShadowNeededForBranchConfusion(__int64 a1)
{
  unsigned int v2; // ebx
  __int128 v4; // [&lt;span class=&#34;hljs-type&#34;&gt;rsp&lt;/span&gt;+&lt;span class=&#34;hljs-number&#34;&gt;20&lt;/span&gt;&lt;span class=&#34;hljs-type&#34;&gt;h&lt;/span&gt;] [&lt;span class=&#34;hljs-type&#34;&gt;rbp&lt;/span&gt;-&lt;span class=&#34;hljs-number&#34;&gt;28&lt;/span&gt;&lt;span class=&#34;hljs-type&#34;&gt;h&lt;/span&gt;] BYREF
  __int64 v5; // [&lt;span class=&#34;hljs-type&#34;&gt;rsp&lt;/span&gt;+&lt;span class=&#34;hljs-number&#34;&gt;30&lt;/span&gt;&lt;span class=&#34;hljs-type&#34;&gt;h&lt;/span&gt;] [&lt;span class=&#34;hljs-type&#34;&gt;rbp&lt;/span&gt;-&lt;span class=&#34;hljs-number&#34;&gt;18&lt;/span&gt;&lt;span class=&#34;hljs-type&#34;&gt;h&lt;/span&gt;]

  v5 = &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64;
  v4 = &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64;
  KiDetectHardwareSpecControlFeatures(a1, &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64, (__int64)&amp;amp;v4, &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64);
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( (v4 &amp;amp; &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;x8000) == &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt; )
    &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64;
  v2 = &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;;
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( !(unsigned int)KiIsBranchConfusionMitigationDesired(a1, &amp;amp;v4) )
    &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64;
  LOBYTE(v2) = (unsigned int)KiIsBranchConfusionMitigationSupported(a1, &amp;amp;v4) != &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;;
  &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; v2;
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&amp;#xD568;&amp;#xC218;&amp;#xBA85;&amp;#xC5D0;&amp;#xC11C;&amp;#xB3C4; &amp;#xC54C; &amp;#xC218; &amp;#xC788;&amp;#xB4EF;, Branch Confusion &amp;#xCDE8;&amp;#xC57D;&amp;#xC810;&amp;#xC758; &amp;#xC601;&amp;#xD5A5;&amp;#xC744; &amp;#xBC1B;&amp;#xB294; CPU&amp;#xC778;&amp;#xC9C0; &amp;#xD655;&amp;#xC778;&amp;#xD558;&amp;#xACE0; KVA Shadow &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xAC00; &amp;#xD544;&amp;#xC694;&amp;#xD55C;&amp;#xC9C0; &amp;#xACB0;&amp;#xC815;&amp;#xD558;&amp;#xB294; &amp;#xD568;&amp;#xC218;&amp;#xC785;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;KiDetectHardwareSpecControlFeatures&lt;/code&gt; &amp;#xD568;&amp;#xC218; &amp;#xD638;&amp;#xCD9C; &amp;#xACB0;&amp;#xACFC;&amp;#xC778; &lt;code&gt;v4&lt;/code&gt; &amp;#xC758; &lt;code&gt;0x8000&lt;/code&gt; &amp;#xBE44;&amp;#xD2B8;&amp;#xAC00; 1&amp;#xC774;&amp;#xBA74; Branch Confusion&amp;#xC758; &amp;#xC601;&amp;#xD5A5;&amp;#xC744; &amp;#xBC1B;&amp;#xC74C;&lt;/li&gt;
&lt;li&gt;&amp;#xC774;&amp;#xD6C4; &amp;#xAD00;&amp;#xB828; Mitigation&amp;#xC774; &amp;#xC9C0;&amp;#xC6D0;&amp;#xB418;&amp;#xBA74; True &amp;#xBC18;&amp;#xD658; - &lt;code&gt;KiDetectKvaLeakage&lt;/code&gt; &amp;#xD568;&amp;#xC218;&amp;#xC5D0;&amp;#xC11C; KVAS &amp;#xD65C;&amp;#xC131;&amp;#xD654; &amp;#xB8E8;&amp;#xD2F4;&amp;#xC73C;&amp;#xB85C; &amp;#xC9C4;&amp;#xC785;&amp;#xD568;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;KiDetectHardwareSpecControlFeatures&lt;/code&gt; &amp;#xD568;&amp;#xC218;&amp;#xC5D0;&amp;#xC11C; &amp;#xC880; &amp;#xB354; &amp;#xC790;&amp;#xC138;&amp;#xD788; &amp;#xC0B4;&amp;#xD3B4;&amp;#xBCF4;&amp;#xB3C4;&amp;#xB85D; &amp;#xD558;&amp;#xC8E0;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs cpp&#34;&gt;&lt;span class=&#34;hljs-function&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt; *__fastcall &lt;span class=&#34;hljs-title&#34;&gt;KiDetectHardwareSpecControlFeatures&lt;/span&gt;&lt;span class=&#34;hljs-params&#34;&gt;(_KPRCB *PRCB, __int64 _zero, __int64 result2, &lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt; *__zero)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;hljs-function&#34;&gt;&lt;/span&gt;{
  &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; CpuModel_1; &lt;span class=&#34;hljs-comment&#34;&gt;// r14d&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int8 CpuVendor; &lt;span class=&#34;hljs-comment&#34;&gt;// al&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt; CpuType_Family; &lt;span class=&#34;hljs-comment&#34;&gt;// r12&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;bool&lt;/span&gt; IsAnyHypervisorPresent; &lt;span class=&#34;hljs-comment&#34;&gt;// r9&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt; CpuVendor_2; &lt;span class=&#34;hljs-comment&#34;&gt;// bl&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; ProcessorFlags; &lt;span class=&#34;hljs-comment&#34;&gt;// ecx&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int8 CpuModel; &lt;span class=&#34;hljs-comment&#34;&gt;// cl&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int8 CpuStepping; &lt;span class=&#34;hljs-comment&#34;&gt;// al&lt;/span&gt;
&lt;span class=&#34;hljs-comment&#34;&gt;//...&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt; *result; &lt;span class=&#34;hljs-comment&#34;&gt;// rax&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int8 CpuVendor_1; &lt;span class=&#34;hljs-comment&#34;&gt;// [rsp+20h] [rbp-60h]&lt;/span&gt;
  
  
  CpuVendor = PRCB-&amp;gt;CpuVendor;
  CpuType_Family = PRCB-&amp;gt;CpuType_Family;
  LOBYTE(CpuModel_1) = PRCB-&amp;gt;CpuModel;
&lt;span class=&#34;hljs-comment&#34;&gt;//...&lt;/span&gt;
  CpuVendor_1 = CpuVendor;
  v48 = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;
  
  &lt;span class=&#34;hljs-comment&#34;&gt;// Hypervisor check&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( HviIsHypervisorMicrosoftCompatible() )
  {
    HviGetEnlightenmentInformation(&amp;amp;v54);
    v53 = &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64;
    HviGetHypervisorFeatures(&amp;amp;v53);
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( (v53 &amp;amp; &lt;span class=&#34;hljs-number&#34;&gt;0x100000000000&lt;/span&gt;i64) == &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt; || (v54 &amp;amp; &lt;span class=&#34;hljs-number&#34;&gt;0x1000&lt;/span&gt;) != &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt; )
    {
      IsAnyHypervisorPresent = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;
    }
    &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
    {
      IsAnyHypervisorPresent = &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;;
      v48 = &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;;
    }
  }
  &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
  {
    IsAnyHypervisorPresent = HviIsAnyHypervisorPresent();
    v48 = IsAnyHypervisorPresent;
  }
  v11 = result1;

  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( KiIsBranchConfusionPresent(PRCB) )
  {
    v11 |= &lt;span class=&#34;hljs-number&#34;&gt;0x8000&lt;/span&gt;ui64;
    *&amp;amp;result1 = v11;
  }
&lt;span class=&#34;hljs-comment&#34;&gt;//...&lt;/span&gt;
  *result2 = result1;
  *(result2 + &lt;span class=&#34;hljs-number&#34;&gt;16&lt;/span&gt;) = &lt;span class=&#34;hljs-number&#34;&gt;4&lt;/span&gt;i64;
  result = __zero;
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( __zero )
    *__zero = v8;
  &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; result;
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&amp;#xD574;&amp;#xB2F9; &amp;#xD568;&amp;#xC218;&amp;#xC5D0;&amp;#xB294; &amp;#xB2E4;&amp;#xC591;&amp;#xD55C; &amp;#xCD94;&amp;#xCE21; &amp;#xC2E4;&amp;#xD589; &amp;#xAE30;&amp;#xBC18; side-channel &amp;#xCDE8;&amp;#xC57D;&amp;#xC810;&amp;#xC5D0; &amp;#xC601;&amp;#xD5A5;&amp;#xC744; &amp;#xBC1B;&amp;#xB294;&amp;#xC9C0; &amp;#xD655;&amp;#xC778;&amp;#xD558;&amp;#xB294; &amp;#xB85C;&amp;#xC9C1;&amp;#xC774; &amp;#xC788;&amp;#xC9C0;&amp;#xB9CC;, &amp;#xCF54;&amp;#xB4DC;&amp;#xB97C; &amp;#xB2E4; &amp;#xC4F0;&amp;#xAE30;&amp;#xC5D0;&amp;#xB294; &amp;#xB108;&amp;#xBB34; &amp;#xAE30;&amp;#xB2C8;&amp;#xAE4C; KVAS &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xB97C; &amp;#xACB0;&amp;#xC815;&amp;#xD558;&amp;#xB294; &lt;code&gt;0x8000&lt;/code&gt; &amp;#xBE44;&amp;#xD2B8;&amp;#xB97C; &amp;#xC124;&amp;#xC815;&amp;#xD558;&amp;#xB294; &amp;#xCF54;&amp;#xB4DC;&amp;#xB9CC; &amp;#xBCF4;&amp;#xACA0;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&amp;#xCD94;&amp;#xCE21; &amp;#xC2E4;&amp;#xD589; &amp;#xAD00;&amp;#xB828; &amp;#xCDE8;&amp;#xC57D;&amp;#xC810; &amp;#xBAA9;&amp;#xB85D;&amp;#xC740; &lt;a href=&#34;https://support.microsoft.com/en-us/topic/kb4073119-windows-client-guidance-for-it-pros-to-protect-against-silicon-based-microarchitectural-and-speculative-execution-side-channel-vulnerabilities-35820a8a-ae13-1299-88cc-357f104f5b11&#34;&gt;MS &amp;#xD074;&amp;#xB77C;&amp;#xC774;&amp;#xC5B8;&amp;#xB4DC; &amp;#xAC00;&amp;#xC774;&amp;#xB358;&amp;#xC2A4;&lt;/a&gt; &amp;#xCC38;&amp;#xACE0;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;KiIsBranchConfusionPresent&lt;/code&gt; &amp;#xD568;&amp;#xC218; &amp;#xBC18;&amp;#xD658;&amp;#xAC12;&amp;#xC774; True&amp;#xBA74; &lt;code&gt;0x8000&lt;/code&gt; &amp;#xBE44;&amp;#xD2B8;&amp;#xB97C; &amp;#xC124;&amp;#xC815;&amp;#xD558;&amp;#xB124;&amp;#xC694;.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;KiIsBranchConfusionPresent&lt;/code&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs jsx&#34;&gt;__int64 __fastcall KiIsBranchConfusionPresent(_KPRCB *a1)
{
  bool IsAnyHypervisorPresent; &lt;span class=&#34;hljs-comment&#34;&gt;// al&lt;/span&gt;
  unsigned int v3; &lt;span class=&#34;hljs-comment&#34;&gt;// edx&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( a1-&amp;gt;CpuVendor != &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt; || (KeFeatureBits2 &amp;amp; &lt;span class=&#34;hljs-number&#34;&gt;0x1000000&lt;/span&gt;) != &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt; )
    &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64;
  IsAnyHypervisorPresent = HviIsAnyHypervisorPresent();
  v3 = &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;;
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( IsAnyHypervisorPresent )
    &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;i64;
  LOBYTE(v3) = a1-&amp;gt;CpuType_Family != &lt;span class=&#34;hljs-number&#34;&gt;25&lt;/span&gt;;
  &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; v3;
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&amp;#xD568;&amp;#xC218; &amp;#xB85C;&amp;#xC9C1;&amp;#xC744; &amp;#xBD84;&amp;#xC11D;&amp;#xD558;&amp;#xBA74; &amp;#xB2E4;&amp;#xC74C;&amp;#xACFC; &amp;#xAC19;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;CpuVendor&amp;#xAC00; AMD&amp;#xAC00; &amp;#xC544;&amp;#xB2C8;&amp;#xBA74; False &amp;#xBC18;&amp;#xD658;&lt;ul&gt;
&lt;li&gt;Branch Confusion&amp;#xC740; AMD CPU&amp;#xC5D0;&amp;#xB9CC; &amp;#xC601;&amp;#xD5A5;&amp;#xC744; &amp;#xC8FC;&amp;#xB294; &amp;#xCDE8;&amp;#xC57D;&amp;#xC810;(&lt;a href=&#34;https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-23825&#34;&gt;CVE-2022-23825&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;HviIsAnyHypervisorPresent&lt;/code&gt;&amp;#xD568;&amp;#xC218;&amp;#xB97C; &amp;#xD1B5;&amp;#xD574; Hypervisor&amp;#xAC00; &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xB418;&amp;#xC5B4; &amp;#xC788;&amp;#xC73C;&amp;#xBA74; True &amp;#xBC18;&amp;#xD658;&lt;ul&gt;
&lt;li&gt;CVE-2022-23825&amp;#xB294; &amp;#xAC00;&amp;#xC0C1;&amp;#xD654; &amp;#xD658;&amp;#xACBD;&amp;#xC5D0; &amp;#xC601;&amp;#xD5A5;&amp;#xC744; &amp;#xC8FC;&amp;#xB294; &amp;#xCDE8;&amp;#xC57D;&amp;#xC810;&amp;#xC774;&amp;#xBBC0;&amp;#xB85C; Hyperviosr&amp;#xAC00; &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xB41C; &amp;#xACBD;&amp;#xC6B0;&amp;#xC5D0;&amp;#xB9CC; KVAS&amp;#xB97C; &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xD558;&amp;#xB3C4;&amp;#xB85D; &amp;#xAD6C;&amp;#xD604;&amp;#xB428;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Family Number&amp;#xAC00; Zen 3 / Zen 3+ / Zen 4 &amp;#xC778; 25 &amp;#xC778; &amp;#xACBD;&amp;#xC6B0;&amp;#xC5D0;&amp;#xB9CC; True &amp;#xBC18;&amp;#xD658;&lt;ul&gt;
&lt;li&gt;&amp;#xADF8; &amp;#xC678; &amp;#xC544;&amp;#xD0A4;&amp;#xD14D;&amp;#xCC98;&amp;#xB294; &amp;#xC601;&amp;#xD5A5;&amp;#xBC1B;&amp;#xC9C0; &amp;#xC54A;&amp;#xC74C;&amp;#xC744; &amp;#xC54C; &amp;#xC218; &amp;#xC788;&amp;#xC74C;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&amp;#xC774;&amp;#xD6C4; &lt;code&gt;KiEnableKvaShadowing&lt;/code&gt; &amp;#xC5D0;&amp;#xC11C; KVAS &amp;#xD65C;&amp;#xC131;&amp;#xD654; &amp;#xC804; &amp;#xB9C8;&amp;#xC9C0;&amp;#xB9C9; &amp;#xAC80;&amp;#xC0AC;&amp;#xAC00; &amp;#xC874;&amp;#xC7AC;&amp;#xD569;&amp;#xB2C8;&amp;#xB2E4;.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs cpp&#34;&gt;&lt;span class=&#34;hljs-function&#34;&gt;__int64 __fastcall &lt;span class=&#34;hljs-title&#34;&gt;KiEnableKvaShadowing&lt;/span&gt;&lt;span class=&#34;hljs-params&#34;&gt;(_KPRCB *a1)&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;hljs-function&#34;&gt;&lt;/span&gt;{
  __int64 v2; &lt;span class=&#34;hljs-comment&#34;&gt;// rdx&lt;/span&gt;
  __int64 v3; &lt;span class=&#34;hljs-comment&#34;&gt;// rcx&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt; v4; &lt;span class=&#34;hljs-comment&#34;&gt;// cl&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int64 v5; &lt;span class=&#34;hljs-comment&#34;&gt;// rax&lt;/span&gt;
  __int64 v6; &lt;span class=&#34;hljs-comment&#34;&gt;// rdx&lt;/span&gt;
  __int64 v7; &lt;span class=&#34;hljs-comment&#34;&gt;// r11&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int8 v8; &lt;span class=&#34;hljs-comment&#34;&gt;// cf&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int64 v9; &lt;span class=&#34;hljs-comment&#34;&gt;// rax&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int64 v10; &lt;span class=&#34;hljs-comment&#34;&gt;// rax&lt;/span&gt;
  __int64 result; &lt;span class=&#34;hljs-comment&#34;&gt;// rax&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int16 v12; &lt;span class=&#34;hljs-comment&#34;&gt;// cx&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( KiIsKvaShadowDisabled() )
  {
    KiIsKvaShadowConfigDisabled = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;
  }
  &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
  {
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( (KeFeatureBits2 &amp;amp; &lt;span class=&#34;hljs-number&#34;&gt;0x18000&lt;/span&gt;) == &lt;span class=&#34;hljs-number&#34;&gt;0x8000&lt;/span&gt; )
      *(_QWORD *)(v3 + &lt;span class=&#34;hljs-number&#34;&gt;11520&lt;/span&gt;) = &lt;span class=&#34;hljs-number&#34;&gt;3&lt;/span&gt;i64;
    v4 = KiKernelCetEnabled;
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( !(_BYTE)KiKernelCetEnabled &amp;amp;&amp;amp; (&lt;span class=&#34;hljs-keyword&#34;&gt;unsigned&lt;/span&gt; __int8)KiIsKvaLeakSimulated() )
      KiKvaLeakageSimulate = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;
    
    &lt;span class=&#34;hljs-comment&#34;&gt;// Enable KVAS&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( KiKvaLeakage || KiKvaLeakageSimulate )
    {
      &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( v4 )
        KeBugCheckEx(&lt;span class=&#34;hljs-number&#34;&gt;0x5D&lt;/span&gt;u, &lt;span class=&#34;hljs-number&#34;&gt;0x4B766120&lt;/span&gt;ui64, &lt;span class=&#34;hljs-number&#34;&gt;0x4B434554&lt;/span&gt;ui64, &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64, &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64);
      v5 = __readcr3();
      a1-&amp;gt;KernelDirectoryTableBase = v5;
      *(_QWORD *)(v2 + &lt;span class=&#34;hljs-number&#34;&gt;4216&lt;/span&gt;) = *(_QWORD *)(v2 + &lt;span class=&#34;hljs-number&#34;&gt;4100&lt;/span&gt;);
      KiInitializeDescriptorIst(a1);
      *(_QWORD *)(v7 + &lt;span class=&#34;hljs-number&#34;&gt;4100&lt;/span&gt;) = v7 + &lt;span class=&#34;hljs-number&#34;&gt;16896&lt;/span&gt;;
      &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( a1-&amp;gt;Number )
      {
        result = KiShadowProcessorAllocation(a1, v7);
        &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( !(_DWORD)result )
          &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; result;
        v12 = *(_WORD *)(KeGetPrcb(&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;i64) + &lt;span class=&#34;hljs-number&#34;&gt;44714&lt;/span&gt;);
        a1-&amp;gt;ShadowFlags |= &lt;span class=&#34;hljs-number&#34;&gt;2u&lt;/span&gt;;
        a1-&amp;gt;VerwSelector = v12;
      }
      &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
      {
        LOBYTE(v6) = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;
        KiInitializeIdt(v7, v6);
        KeGetCurrentThread()-&amp;gt;ApcState.Process-&amp;gt;AddressPolicy = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;
        byte_140FCE0E0 = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;
        _InterlockedOr(dword_140FCE57C, &lt;span class=&#34;hljs-number&#34;&gt;0x4000&lt;/span&gt;u);
        KiSetAddressPolicy(&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;i64);
        v8 = _bittest64((&lt;span class=&#34;hljs-keyword&#34;&gt;const&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;signed&lt;/span&gt; __int64 *)&amp;amp;a1-&amp;gt;FeatureBits, &lt;span class=&#34;hljs-number&#34;&gt;0x2A&lt;/span&gt;u);
        a1-&amp;gt;VerwSelector = &lt;span class=&#34;hljs-number&#34;&gt;24&lt;/span&gt;;
        &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( v8 )
        {
          v9 = __readcr4();
          __writecr4(v9 &amp;amp; &lt;span class=&#34;hljs-number&#34;&gt;0xFFFFFFFFFFFDFF7F&lt;/span&gt;ui64 | &lt;span class=&#34;hljs-number&#34;&gt;0x20000&lt;/span&gt;);
          v10 = __readcr3();
          __writecr3(v10 | &lt;span class=&#34;hljs-number&#34;&gt;2&lt;/span&gt;);
          KiFlushPcid |= &lt;span class=&#34;hljs-number&#34;&gt;1u&lt;/span&gt;;
        }
        &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( (a1-&amp;gt;FeatureBits &amp;amp; &lt;span class=&#34;hljs-number&#34;&gt;0x240000000000&lt;/span&gt;i64) == &lt;span class=&#34;hljs-number&#34;&gt;0x240000000000&lt;/span&gt;i64 )
          KiFlushPcid |= &lt;span class=&#34;hljs-number&#34;&gt;2u&lt;/span&gt;;
        HvlRescindEnlightenments();
        KiKvaShadow = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;
        KiKvaShadowMode = &lt;span class=&#34;hljs-number&#34;&gt;2&lt;/span&gt; - (KiFlushPcid != &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;);
      }
      &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ( KiFlushPcid )
        _interlockedbittestandset64((&lt;span class=&#34;hljs-keyword&#34;&gt;volatile&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;signed&lt;/span&gt; __int32 *)&amp;amp;a1-&amp;gt;KernelDirectoryTableBase, &lt;span class=&#34;hljs-number&#34;&gt;0x3F&lt;/span&gt;ui64);
    }
  }
  &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;i64;
}&lt;/code&gt;&lt;/pre&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;if ( KiKvaLeakage || KiKvaLeakageSimulate )&lt;/code&gt;  &amp;#xBD84;&amp;#xAE30;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;KiDetectKvaLeakage&lt;/code&gt; &amp;#xD568;&amp;#xC218;&amp;#xC5D0;&amp;#xC11C; &amp;#xC124;&amp;#xC815;&amp;#xD55C; &amp;#xC804;&amp;#xC5ED;&amp;#xBCC0;&amp;#xC218;&lt;code&gt;KiKvaLeakage&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&amp;#xC218;&amp;#xB3D9; &amp;#xC124;&amp;#xC815;&amp;#xAC12;(&amp;#xB514;&amp;#xBC84;&amp;#xAE45; &amp;#xBC0F; &amp;#xD14C;&amp;#xC2A4;&amp;#xD2B8;&amp;#xC6A9;)&amp;#xC744; &amp;#xD1B5;&amp;#xD574; &amp;#xACB0;&amp;#xC815;&amp;#xB418;&amp;#xB294; &amp;#xAC83;&amp;#xC73C;&amp;#xB85C; &amp;#xCD94;&amp;#xC815;&amp;#xB418;&amp;#xB294; &amp;#xC804;&amp;#xC5ED;&amp;#xBCC0;&amp;#xC218; &lt;code&gt;KiKvaLeakageSimulate&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&amp;#xB450; &amp;#xC804;&amp;#xC5ED;&amp;#xBCC0;&amp;#xC218; &amp;#xAC12; &amp;#xC911; &amp;#xD558;&amp;#xB098;&amp;#xB77C;&amp;#xB3C4; &amp;#xC124;&amp;#xC815;&amp;#xB418;&amp;#xC5B4; &amp;#xC788;&amp;#xC73C;&amp;#xBA74; KVAS&amp;#xB97C; &amp;#xD65C;&amp;#xC131;&amp;#xD654;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&#34;&amp;#xC138;&amp;#xC904;&amp;#xC694;&amp;#xC57D;&#34;&gt;&lt;a href=&#34;#&amp;#xC138;&amp;#xC904;&amp;#xC694;&amp;#xC57D;&#34; class=&#34;headerlink&#34; title=&#34;&amp;#xC138;&amp;#xC904;&amp;#xC694;&amp;#xC57D;&#34;&gt;&lt;/a&gt;&amp;#xC138;&amp;#xC904;&amp;#xC694;&amp;#xC57D;&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;Windows Kernel&amp;#xC740; &amp;#xCD08;&amp;#xAE30;&amp;#xD654; &amp;#xC2DC; CPU&amp;#xC5D0; &amp;#xB530;&amp;#xB77C; KVAS(&amp;#xBC0F; &amp;#xB2E4;&amp;#xB978; &amp;#xBBF8;&amp;#xD2F0;&amp;#xAC8C;&amp;#xC774;&amp;#xC158;)&amp;#xC744; &amp;#xB3D9;&amp;#xC801;&amp;#xC73C;&amp;#xB85C; &amp;#xD65C;&amp;#xC131;&amp;#xD654;&amp;#xD568;.&lt;/li&gt;
&lt;li&gt;KVAS &amp;#xD65C;&amp;#xC131;&amp;#xD654; &amp;#xC5EC;&amp;#xBD80;&amp;#xB97C; &amp;#xACB0;&amp;#xC815;&amp;#xD558;&amp;#xB294; &amp;#xAE30;&amp;#xC900;&amp;#xC740; &amp;#xD06C;&amp;#xAC8C; &amp;#xB450; &amp;#xAC00;&amp;#xC9C0;&lt;ul&gt;
&lt;li&gt;Intel: Rogue Data Cache Load(Meltdown)&lt;/li&gt;
&lt;li&gt;AMD: Branch Confusion&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;CPU&amp;#xAC00; MSR&amp;#xC744; &amp;#xD1B5;&amp;#xD574; &amp;#xC81C;&amp;#xACF5;&amp;#xD558;&amp;#xB294; &amp;#xD558;&amp;#xB4DC;&amp;#xC6E8;&amp;#xC5B4; &amp;#xBBF8;&amp;#xD2F0;&amp;#xAC8C;&amp;#xC774;&amp;#xC158; &amp;#xC801;&amp;#xC6A9; &amp;#xC5EC;&amp;#xBD80;&amp;#xB97C; &amp;#xD655;&amp;#xC778;&amp;#xD558;&amp;#xACE0;, MSR &amp;#xAE30;&amp;#xB2A5;&amp;#xC774; &amp;#xC5C6;&amp;#xC73C;&amp;#xBA74; &amp;#xB808;&amp;#xAC70;&amp;#xC2DC; &amp;#xCCB4;&amp;#xD06C; (bitmask, &amp;#xBAA8;&amp;#xB378;&amp;#xB118;&amp;#xBC84; &amp;#xC815;&amp;#xBCF4; &amp;#xB4F1;)&amp;#xB97C; &amp;#xD1B5;&amp;#xD574; KVAS &amp;#xD65C;&amp;#xC131;&amp;#xD654; &amp;#xC5EC;&amp;#xBD80;&amp;#xB97C; &amp;#xACB0;&amp;#xC815;&amp;#xD568;.&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&#34;&amp;#xB9C8;&amp;#xBB34;&amp;#xB9AC;&amp;#xD558;&amp;#xBA70;&#34;&gt;&lt;a href=&#34;#&amp;#xB9C8;&amp;#xBB34;&amp;#xB9AC;&amp;#xD558;&amp;#xBA70;&#34; class=&#34;headerlink&#34; title=&#34;&amp;#xB9C8;&amp;#xBB34;&amp;#xB9AC;&amp;#xD558;&amp;#xBA70;&#34;&gt;&lt;/a&gt;&amp;#xB9C8;&amp;#xBB34;&amp;#xB9AC;&amp;#xD558;&amp;#xBA70;&lt;/h1&gt;&lt;p&gt;&lt;img src=&#34;/2025/08/10/l0ch/deep-dive-into-kva/ko/image1.jpg&#34; alt=&#34;Untitled&#34;&gt;&lt;/p&gt;
&lt;p&gt;&amp;#xC0AC;&amp;#xC2E4; &amp;#xC608;&amp;#xC804;&amp;#xC5D0; &amp;#xD55C;&amp;#xCC3D; &amp;#xCD94;&amp;#xCE21; &amp;#xC2E4;&amp;#xD589; &amp;#xAE30;&amp;#xBC18;&amp;#xC758; &amp;#xC0AC;&amp;#xC774;&amp;#xB4DC;&amp;#xCC44;&amp;#xB110; &amp;#xCDE8;&amp;#xC57D;&amp;#xC810;&amp;#xC774; &amp;#xC774;&amp;#xC288;&amp;#xB420; &amp;#xB54C; &amp;#xAD6D;&amp;#xBC29;&amp;#xC758; &amp;#xC758;&amp;#xBB34;&amp;#xB97C; &amp;#xC218;&amp;#xD589;&amp;#xD558;&amp;#xB290;&amp;#xB77C; &amp;#xC81C;&amp;#xB300;&amp;#xB85C; &amp;#xD30C;&amp;#xBCF4;&amp;#xC9C8; &amp;#xBABB;&amp;#xD588;&amp;#xB294;&amp;#xB370;&amp;#xC694;, &amp;#xC800;&amp;#xBC88; KASLR bypass&amp;#xC640; &amp;#xC774;&amp;#xBC88; &amp;#xAE00;&amp;#xC744; &amp;#xC791;&amp;#xC131;&amp;#xD558;&amp;#xBA74;&amp;#xC11C; &amp;#xC790;&amp;#xC138;&amp;#xD788; &amp;#xD30C;&amp;#xBCFC; &amp;#xAE30;&amp;#xD68C;&amp;#xAC00; &amp;#xB41C; &amp;#xAC83; &amp;#xAC19;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;. &amp;#xACFC;&amp;#xAC70;&amp;#xC758; &amp;#xC774;&amp;#xC288;&amp;#xB97C; &amp;#xC81C;&amp;#xB300;&amp;#xB85C; &amp;#xD30C;&amp;#xC545;&amp;#xD558;&amp;#xB294; &amp;#xAC8C; &amp;#xD604;&amp;#xC7AC;&amp;#xC758; &amp;#xD2B8;&amp;#xB80C;&amp;#xB4DC;&amp;#xB97C; &amp;#xB530;&amp;#xB77C;&amp;#xAC00;&amp;#xB294; &amp;#xAC83; &amp;#xB9CC;&amp;#xD07C;&amp;#xC774;&amp;#xB098; &amp;#xC911;&amp;#xC694;&amp;#xD558;&amp;#xB2E4;&amp;#xB294; &amp;#xAC83;&amp;#xC744; &amp;#xB2E4;&amp;#xC2DC; &amp;#xD55C; &amp;#xBC88; &amp;#xB290;&amp;#xB07C;&amp;#xBA74;&amp;#xC11C;,  &lt;del&gt;&amp;#xC774;&amp;#xC81C; Windows Internals &amp;#xC644;&amp;#xB3C5;&amp;#xC744; &amp;#xB2E4;&amp;#xC2DC; &amp;#xC2DC;&amp;#xB3C4;&amp;#xD558;&amp;#xB294; &amp;#xAC78;&amp;#xB85C;..&lt;/del&gt;&lt;/p&gt;
&lt;p&gt;&amp;#xB2E4;&amp;#xC74C;&amp;#xC5D0;&amp;#xB3C4; &amp;#xC7AC;&amp;#xBC0C;&amp;#xB294; &amp;#xC5F0;&amp;#xAD6C; &amp;#xC8FC;&amp;#xC81C; &amp;#xB4E4;&amp;#xACE0; &amp;#xC624;&amp;#xB3C4;&amp;#xB85D; &amp;#xD558;&amp;#xACA0;&amp;#xC2B5;&amp;#xB2C8;&amp;#xB2E4;~&lt;/p&gt;
&lt;h1 id=&#34;Reference&#34;&gt;&lt;a href=&#34;#Reference&#34; class=&#34;headerlink&#34; title=&#34;Reference&#34;&gt;&lt;/a&gt;Reference&lt;/h1&gt;&lt;p&gt;&lt;a href=&#34;https://support.microsoft.com/en-us/topic/kb4073119-windows-client-guidance-for-it-pros-to-protect-against-silicon-based-microarchitectural-and-speculative-execution-side-channel-vulnerabilities-35820a8a-ae13-1299-88cc-357f104f5b11&#34;&gt;https://support.microsoft.com/en-us/topic/kb4073119-windows-client-guidance-for-it-pros-to-protect-against-silicon-based-microarchitectural-and-speculative-execution-side-channel-vulnerabilities-35820a8a-ae13-1299-88cc-357f104f5b11&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-23825&#34;&gt;https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-23825&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.intel.com/content/www/us/en/developer/articles/technical/software-security-guidance/technical-documentation/cpuid-enumeration-and-architectural-msrs.html&#34;&gt;https://www.intel.com/content/www/us/en/developer/articles/technical/software-security-guidance/technical-documentation/cpuid-enumeration-and-architectural-msrs.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/amd64_x/cpu_vendors.htm&#34;&gt;https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/amd64_x/cpu_vendors.htm&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://support.microsoft.com/en-us/topic/kb4074629-understanding-speculationcontrol-powershell-script-output-fd70a80a-a63f-e539-cda5-5be4c9e67c04&#34;&gt;https://support.microsoft.com/en-us/topic/kb4074629-understanding-speculationcontrol-powershell-script-output-fd70a80a-a63f-e539-cda5-5be4c9e67c04&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.intel.com/content/www/us/en/content-details/782158/intel-64-and-ia-32-architectures-software-developer-s-manual-combined-volumes-1-2a-2b-2c-2d-3a-3b-3c-3d-and-4.html&#34;&gt;https://www.intel.com/content/www/us/en/content-details/782158/intel-64-and-ia-32-architectures-software-developer-s-manual-combined-volumes-1-2a-2b-2c-2d-3a-3b-3c-3d-and-4.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.vergiliusproject.com/kernels/x64/windows-11/24h2/_KPRCB&#34;&gt;https://www.vergiliusproject.com/kernels/x64/windows-11/24h2/_KPRCB&lt;/a&gt;&lt;/p&gt;
 - hack &amp; life">
  <meta property="og:image" content="https://hackyboiz.github.io2025/08/10/l0ch/deep-dive-into-kva/ko/thumbnail.png">
  <meta property="og:url" content="https://hackyboiz.github.io/">

  <link rel="canonical" href="https://hackyboiz.github.io/2025/08/10/l0ch/deep-dive-into-kva/ko/">

  <title>[Research] Deep Dive into KVA Shadow&#39;s Dynamic Activation Mechanism(Ko) - hackyboiz</title>

  <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css">


  <link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css">
  <link rel="stylesheet" href="/lib/hint/hint.min.css">

  
    
    <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css">
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_6peoq002giu.css">
<link rel="stylesheet" href="/.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">
<link rel="stylesheet" href="/.css">


<link rel="stylesheet" href="/css/main.css">

<!-- 自定义样式保持在最底部 -->


  <script src="/js/utils.js"></script>
  <script src="/js/color-schema.js"></script>

<meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/rss2.xml" title="hackyboiz" type="application/rss+xml">
</head>


<body>
  <header style="height: 40vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">&nbsp;<strong>Hackyboiz</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-addrcard"></i>
                About
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/author/">
                <i class="iconfont icon-user-fill"></i>
                Author
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax="true" style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2025-08-10 21:00" pubdate>
      2025년 8월 10일 오후
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      3.6k 자
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      72
       분
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2">
      <!--<script data-ad-client="ca-pub-3672652207808168" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>-->
    </div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">[Research] Deep Dive into KVA Shadow&#39;s Dynamic Activation Mechanism(Ko)</h1>
                       
            <div class="markdown-body" id="post-body">
              <!-- <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>-->
              <!-- hackyboiz_horizen_index -->
              <!--
              <ins class="adsbygoogle"
                   style="display:block"
                   data-ad-client="ca-pub-3672652207808168"
                   data-ad-slot="8887862313"
                   data-ad-format="auto"
                   data-full-width-responsive="true"></ins>
              <script>
                   (adsbygoogle = window.adsbygoogle || []).push({});
              </script>
              -->
              <p>&#xC548;&#xB155;&#xD558;&#xC138;&#xC694;, L0ch&#xC785;&#xB2C8;&#xB2E4;!  &#xC9C0;&#xB09C; &#xBC88; &#xAE00; &#xC774;&#xD6C4;&#xB85C; &#xC624;&#xB79C;&#xB9CC;&#xC5D0; &#xB3CC;&#xC544;&#xC654;&#xC2B5;&#xB2C8;&#xB2E4;</p>
<p>&#xC9C0;&#xB09C; &#xC8FC;&#xC81C;&#xB294; <a href="https://hackyboiz.github.io/2025/04/13/l0ch/bypassing-kernel-mitigation-part0/ko/">[Research] Bypassing Windows Kernel Mitigations: Part0 - Deep Dive into KASLR Leaks Restriction</a> &#xC600;&#xC5C8;&#xB294;&#xB370;&#xC694;, KASLR &#xC6B0;&#xD68C; PoC&#xC758; &#xB3D9;&#xC791; &#xC870;&#xAC74; &#xC911; &#xD558;&#xB098;&#xAC00; KVA Shadow &#xBE44;&#xD65C;&#xC131;&#xD654;&#xB2E4;! &#xB77C;&#xB294; &#xC774;&#xC57C;&#xAE30;&#xB97C; &#xD588;&#xC5C8;&#xC2B5;&#xB2C8;&#xB2E4;.</p>
<p>&#xC791;&#xC131; &#xB2F9;&#xC2DC;&#xC5D0;&#xB294; &#xCD5C;&#xC2E0; Windows 11&#xC5D0;&#xC11C;&#xB294; KVAS&#xAC00; &#xAE30;&#xBCF8;&#xC801;&#xC73C;&#xB85C; &#xBE44;&#xD65C;&#xC131;&#xD654;&#xB418;&#xC5B4; &#xC788;&#xB2E4;&#xACE0; &#xCD94;&#xCE21;&#xD588;&#xC5C8;&#xB294;&#xB370;, &#xD53C;&#xB4DC;&#xBC31;&#xC744; &#xD1B5;&#xD574; KVAS&#xB294; Windows &#xBC84;&#xC804; &#xAE30;&#xC900;&#xC774; &#xC544;&#xB2CC; CPU &#xBAA8;&#xB378;&#xACFC; &#xD2B9;&#xC815; &#xCDE8;&#xC57D;&#xC810;&#xC5D0; &#xC601;&#xD5A5;&#xC744; &#xBC1B;&#xB294;&#xC9C0; &#xD655;&#xC778;&#xD558;&#xACE0; &#xB3D9;&#xC801;&#xC73C;&#xB85C; &#xD65C;&#xC131;&#xD654;&#xB41C;&#xB2E4;&#xB294; &#xAC83;&#xC744; &#xC54C;&#xC558;&#xC2B5;&#xB2C8;&#xB2E4;.</p>
<h1 id="SpeculationControl-PowerShell-script"><a href="#SpeculationControl-PowerShell-script" class="headerlink" title="SpeculationControl PowerShell script"></a><strong>SpeculationControl PowerShell script</strong></h1><p>KVAS&#xB294; Meltdown, Spectre&#xB85C; &#xB300;&#xD45C;&#xB418;&#xB294; &#xB2E4;&#xC591;&#xD55C; &#xCD94;&#xCE21; &#xC2E4;&#xD589; &#xAE30;&#xBC18; &#xC0AC;&#xC774;&#xB4DC;&#xCC44;&#xB110; &#xCDE8;&#xC57D;&#xC810;&#xACFC; &#xBC00;&#xC811;&#xD55C; &#xAD00;&#xB828;&#xC774; &#xC788;&#xB294; &#xB9CC;&#xD07C;, &#xAD00;&#xB828; MS&#xC758; &#xC9C0;&#xC6D0; &#xC815;&#xBCF4;&#xB97C; &#xC27D;&#xAC8C; &#xD655;&#xC778;&#xD560; &#xC218; &#xC788;&#xC2B5;&#xB2C8;&#xB2E4;.</p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://support.microsoft.com/en-us/topic/kb4074629-understanding-speculationcontrol-powershell-script-output-fd70a80a-a63f-e539-cda5-5be4c9e67c04">https://support.microsoft.com/en-us/topic/kb4074629-understanding-speculationcontrol-powershell-script-output-fd70a80a-a63f-e539-cda5-5be4c9e67c04</a></p>
<p>&#xC81C; &#xCEF4;&#xD4E8;&#xD130;&#xC778; 12&#xC138;&#xB300; Intel CPU&#xB85C; &#xD14C;&#xC2A4;&#xD2B8;&#xD55C; &#xACB0;&#xACFC;&#xB97C; &#xC815;&#xB9AC;&#xD558;&#xBA74; &#xB2E4;&#xC74C;&#xACFC; &#xAC19;&#xC2B5;&#xB2C8;&#xB2E4;.<br><pre><code class="hljs powershell"><span class="hljs-comment"># Windwos 11 24H2 - Intel 12th i7-12700</span>

<span class="hljs-built_in">PS</span> C:\WINDOWS\system32&gt; <span class="hljs-built_in">Install-Module</span> <span class="hljs-literal">-Name</span> SpeculationControl                                                                                                                                                                                 &#xACC4;&#xC18D;&#xD558;&#xB824;&#xBA74; NuGet &#xACF5;&#xAE09;&#xC790;&#xAC00; &#xD544;&#xC694;&#xD569;&#xB2C8;&#xB2E4;.

<span class="hljs-built_in">PS</span> C:\WINDOWS\system32&gt; <span class="hljs-built_in">Get-SpeculationControlSettings</span>

BTIHardwarePresent                  : True
BTIWindowsSupportPresent            : True
BTIWindowsSupportEnabled            : True
BTIDisabledBySystemPolicy           : False
BTIDisabledByNoHardwareSupport      : False
BTIKernelRetpolineEnabled           : False
BTIKernelImportOptimizationEnabled  : True
RdclHardwareProtectedReported       : True
RdclHardwareProtected               : True
KVAShadowRequired                   : False
KVAShadowWindowsSupportPresent      : True
KVAShadowWindowsSupportEnabled      : False
KVAShadowPcidEnabled                : False
SSBDWindowsSupportPresent           : True
SSBDHardwareVulnerable              : True
SSBDHardwarePresent                 : True
SSBDWindowsSupportEnabledSystemWide : False
L1TFHardwareVulnerable              : False
L1TFWindowsSupportPresent           : True
L1TFWindowsSupportEnabled           : False
L1TFInvalidPteBit                   : <span class="hljs-number">0</span>
L1DFlushSupported                   : True
HvL1tfStatusAvailable               : True
HvL1tfProcessorNotAffected          : True
MDSWindowsSupportPresent            : True
MDSHardwareVulnerable               : False
MDSWindowsSupportEnabled            : False
FBClearWindowsSupportPresent        : True
SBDRSSDPHardwareVulnerable          : False
FBSDPHardwareVulnerable             : False
PSDPHardwareVulnerable              : False
FBClearWindowsSupportEnabled        : False
</code></pre></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Hardware requires kernel VA shadowing</th>
<th>Maps to KVAShadowRequired. This line tells you whether your system requires kernel VA shadowing to mitigate a vulnerability.</th>
</tr>
</thead>
<tbody>
<tr>
<td>Windows OS support for rogue data cache load mitigation is present</td>
<td>Maps to KVAShadowWindowsSupportPresent. This line tells you whether Windows operating system support for the kernel VA shadow feature is present.</td>
</tr>
<tr>
<td>Windows OS support for kernel VA shadow is present</td>
<td>Maps to KVAShadowWindowsSupportPresent. This line tells you whether Windows operating system support for the kernel VA shadow feature is present. If it is True, the January 2018 update is installed on the device, and kernel VA shadow is supported. If it is False, the January 2018 update is not installed, and kernel VA shadow support does not exist.</td>
</tr>
<tr>
<td>Windows OS support for rogue data cache load mitigation is enabled</td>
<td>Maps to KVAShadowWindowsSupportEnabled. This line tells you whether the kernel VA shadow feature is enabled. If it is True, the hardware is believed to be vulnerable to CVE-2017-5754, Windows operating system support is present, and the feature is enabled.</td>
</tr>
<tr>
<td>Windows OS support for kernel VA shadow is enabled</td>
<td>Maps to KVAShadowWindowsSupportEnabled. This line tells you whether the kernel VA shadow feature is enabled. If it is True, Windows operating system support is present, and the feature is enabled. The Kernel VA shadow feature is currently enabled by default on client versions of Windows and is disabled by default on versions of Windows Server. If it is False, either Windows operating system support is not present, or the feature is not enabled.</td>
</tr>
</tbody>
</table>
</div>
<pre><code class="hljs cpp">Windows&#xC5D0; KVA Shadow &#xAE30;&#xB2A5;&#xC740; &#xC874;&#xC7AC;&#xD558;&#xB098;(KVAShadowWindowsSupportPresent: True) &#xD544;&#xC694;&#xD558;&#xC9C0; &#xC54A;&#xC544;&#xC11C;(KVAShadowRequired: False) &#xD65C;&#xC131;&#xD654;&#xB418;&#xC9C0;&#xB294; &#xC54A;&#xC740; &#xC0C1;&#xD0DC; (KVAShadowWindowsSupportEnabled: False)</code></pre>
<p>KVAS&#xAC00; &#xBE44;&#xD65C;&#xC131;&#xD654;&#xB41C; &#xAC78; &#xC54C; &#xC218; &#xC788;&#xB294;&#xB370;, &#xC774;&#xB294; &#xB2E4;&#xC2DC; &#xB9D0;&#xD558;&#xBA74; &#xBBF8;&#xD2F0;&#xAC8C;&#xC774;&#xC158; &#xAE30;&#xB2A5;&#xC774; &#xC874;&#xC7AC;&#xD558;&#xC9C0;&#xB9CC; <strong>&#xD558;&#xB4DC;&#xC6E8;&#xC5B4;(CPU)&#xAC00; &#xCDE8;&#xC57D;&#xD558;&#xC9C0; &#xC54A;&#xC544;&#xC11C; &#xBBF8;&#xD2F0;&#xAC8C;&#xC774;&#xC158; &#xAE30;&#xB2A5;&#xC774; &#xBE44;&#xD65C;&#xC131;&#xD654;&#xB418;&#xC5C8;&#xB2E4;</strong>&#xACE0; &#xB9D0;&#xD560; &#xC218; &#xC788;&#xACA0;&#xB124;&#xC694;. </p>
<p>&#xADF8;&#xB807;&#xB2E4;&#xBA74; Windows&#xB294; &#xC5B4;&#xB514;&#xC11C;, &#xC5B4;&#xB5BB;&#xAC8C; &#xCDE8;&#xC57D;&#xD55C; CPU&#xB97C; &#xC2DD;&#xBCC4;&#xD558;&#xACE0; KVAS &#xD65C;&#xC131;&#xD654; &#xC5EC;&#xBD80;&#xB97C; &#xD310;&#xB2E8;&#xD560;&#xAE4C;&#xC694;?</p>
<h1 id="Background-Knowledge-CPU-Identification"><a href="#Background-Knowledge-CPU-Identification" class="headerlink" title="Background Knowledge - CPU Identification"></a>Background Knowledge - CPU Identification</h1><p>Windows&#xB294; &#xC790;&#xCCB4;&#xC801;&#xC73C;&#xB85C; CPU&#xC758; &#xBCA4;&#xB354;&#xB97C; &#xC2DD;&#xBCC4;&#xD569;&#xB2C8;&#xB2E4;. <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/amd64_x/cpu_vendors.htm">CPU_VENDORS</a> Enum&#xC5D0; &#xC815;&#xC758;&#xB418;&#xC5B4; &#xC788;&#xB4EF;&#xC774;, &#xC54C; &#xC218; &#xC5C6;&#xB294; &#xC81C;&#xC870;&#xC0AC;&#xB294; 0, AMD&#xB294; 1, Intel&#xC740; 2&#xB85C; &#xC815;&#xC758;&#xB418;&#xC5B4; &#xC788;&#xC8E0;.</p>
<pre><code class="hljs jsx">typedef enum
{
    CPU_UNKNOWN,   <span class="hljs-comment">// 0</span>
    CPU_AMD,       <span class="hljs-comment">// 1</span>
    CPU_INTEL,     <span class="hljs-comment">// 2</span>
    CPU_VIA        <span class="hljs-comment">// 3</span>
} CPU_VENDORS;</code></pre>
<p>&#xBCA4;&#xB354;&#xBFD0;&#xB9CC; &#xC544;&#xB2C8;&#xB77C; Faily ID, Model ID &#xC640; &#xAC19;&#xC740; CPU &#xC815;&#xBCF4;&#xB4E4;&#xC740; <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.vergiliusproject.com/kernels/x64/windows-11/24h2/_KPRCB">KPRCB</a> &#xAD6C;&#xC870;&#xCCB4;&#xC5D0; &#xC800;&#xC7A5;&#xB429;&#xB2C8;&#xB2E4;. </p>
<p>&#xC774;&#xB7EC;&#xD55C; ID&#xB4E4;&#xC740; &#xAC01; CPU &#xBCA4;&#xB354;&#xC0AC;&#xAC00; &#xC815;&#xC758;&#xD569;&#xB2C8;&#xB2E4;. Intel&#xC758; &#xACBD;&#xC6B0; Intel CPU &#xC81C;&#xD488;&#xC758; Family ID, Model ID, &#xC138;&#xB300; &#xC815;&#xBCF4;&#xB97C; <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.intel.com/content/www/us/en/content-details/782158/intel-64-and-ia-32-architectures-software-developer-s-manual-combined-volumes-1-2a-2b-2c-2d-3a-3b-3c-3d-and-4.html">Intel Developer Manual</a> &#xC5D0;&#xC11C; &#xD655;&#xC778;&#xD560; &#xC218; &#xC788;&#xB294;&#xB370;&#xC694;, 5000&#xC7A5;&#xC774; &#xB118;&#xB294; &#xB9E4;&#xB274;&#xC5BC;&#xC744; &#xC804;&#xBD80; &#xBCFC; &#xC218;&#xB294; &#xC5C6;&#xC73C;&#xB2C8;.. gemini &#xC2DC;&#xCF1C;&#xC11C; &#xC544;&#xB798; &#xD45C;&#xB85C; &#xC815;&#xB9AC;&#xD588;&#xC2B5;&#xB2C8;&#xB2E4;. </p>
<div class="table-container">
<table>
<thead>
<tr>
<th><strong>&#xB9C8;&#xC774;&#xD06C;&#xB85C;&#xC544;&#xD0A4;&#xD14D;&#xCC98; (&#xC138;&#xB300;)</strong></th>
<th><strong>&#xD504;&#xB85C;&#xC138;&#xC11C; &#xC81C;&#xD488;&#xAD70;</strong></th>
<th><strong>Family ID (Hex)</strong></th>
<th><strong>Model ID (Hex)</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Raptor Lake (13&#xC138;&#xB300;)</td>
<td>Intel Core</td>
<td>06H</td>
<td>B7H, BFH</td>
</tr>
<tr>
<td>Alder Lake (12&#xC138;&#xB300;)</td>
<td>Intel Core</td>
<td>06H</td>
<td>97H, 9AH</td>
</tr>
<tr>
<td>Tiger Lake (11&#xC138;&#xB300;)</td>
<td>Intel Core</td>
<td>06H</td>
<td>8CH, 8DH</td>
</tr>
<tr>
<td>Rocket Lake (11&#xC138;&#xB300;)</td>
<td>Intel Core</td>
<td>06H</td>
<td>A7H</td>
</tr>
<tr>
<td>Ice Lake (10&#xC138;&#xB300;)</td>
<td>Intel Core</td>
<td>06H</td>
<td>7DH, 7EH</td>
</tr>
<tr>
<td>Comet Lake (10&#xC138;&#xB300;)</td>
<td>Intel Core</td>
<td>06H</td>
<td>A5H, A6H</td>
</tr>
<tr>
<td>Amber Lake Y (8&#xC138;&#xB300;)</td>
<td>Intel Core</td>
<td>06H</td>
<td>8EH</td>
</tr>
<tr>
<td>Whiskey Lake U (8&#xC138;&#xB300;)</td>
<td>Intel Core</td>
<td>06H</td>
<td>8EH</td>
</tr>
<tr>
<td>Coffee Lake (8, 9&#xC138;&#xB300;)</td>
<td>Intel Core</td>
<td>06H</td>
<td>9EH</td>
</tr>
<tr>
<td>Kaby Lake (7&#xC138;&#xB300;)</td>
<td>Intel Core</td>
<td>06H</td>
<td>8EH, 9EH</td>
</tr>
<tr>
<td>Skylake (6&#xC138;&#xB300;)</td>
<td>Intel Core</td>
<td>06H</td>
<td>4EH, 5EH, 55H</td>
</tr>
<tr>
<td>Broadwell (5&#xC138;&#xB300;)</td>
<td>Intel Core</td>
<td>06H</td>
<td>3DH, 47H, 4FH</td>
</tr>
<tr>
<td>Haswell (4&#xC138;&#xB300;)</td>
<td>Intel Core</td>
<td>06H</td>
<td>3CH, 45H, 46H, 3FH</td>
</tr>
<tr>
<td>Ivy Bridge (3&#xC138;&#xB300;)</td>
<td>Intel Core</td>
<td>06H</td>
<td>3AH</td>
</tr>
<tr>
<td>Sandy Bridge (2&#xC138;&#xB300;)</td>
<td>Intel Core</td>
<td>06H</td>
<td>2AH</td>
</tr>
<tr>
<td>Westmere (2010)</td>
<td>Intel Core</td>
<td>06H</td>
<td>25H, 2CH, 2FH</td>
</tr>
<tr>
<td>Nehalem (1&#xC138;&#xB300;)</td>
<td>Intel Core</td>
<td>06H</td>
<td>1AH, 1EH, 1FH, 2EH</td>
</tr>
<tr>
<td>Penryn</td>
<td>Core 2 Duo/Quad</td>
<td>06H</td>
<td>17H, 1DH</td>
</tr>
<tr>
<td>Merom</td>
<td>Core 2 Duo</td>
<td>06H</td>
<td>0FH</td>
</tr>
<tr>
<td>Yonah</td>
<td>Core Duo/Solo</td>
<td>06H</td>
<td>0EH</td>
</tr>
</tbody>
</table>
</div>
<p>AMD&#xB098; &#xB2E4;&#xB978; &#xBCA4;&#xB354;&#xB4E4;&#xC758; ID &#xB9AC;&#xC2A4;&#xD2B8;&#xB3C4; &#xBAA8;&#xB450; &#xC815;&#xB9AC;&#xD558;&#xACE0; &#xBD84;&#xC11D;&#xC744; &#xC9C4;&#xD589;&#xD588;&#xC2B5;&#xB2C8;&#xB2E4;.</p>
<h1 id="Analysis-of-KVAS-Activation-Logic"><a href="#Analysis-of-KVAS-Activation-Logic" class="headerlink" title="Analysis of KVAS Activation Logic"></a>Analysis of KVAS Activation Logic</h1><p>&#xBD84;&#xC11D; &#xD658;&#xACBD;: Windows 24H2 64bit 10.0.26100.1742 </p>
<p>&#xB2E4;&#xC2DC; &#xB3CC;&#xC544;&#xC640;&#xC11C;, &#xBBF8;&#xD2F0;&#xAC8C;&#xC774;&#xC158; &#xCD08;&#xAE30;&#xD654; &#xB85C;&#xC9C1;&#xC744; &#xBD84;&#xC11D;&#xD558;&#xAE30; &#xC704;&#xD574;&#xC11C;&#xB294; Windows &#xBD80;&#xD305; &#xC2DC; &#xCEE4;&#xB110;&#xC744; &#xCD08;&#xAE30;&#xD654;&#xD558;&#xB294; &#xBD80;&#xBD84;&#xAE4C;&#xC9C0; &#xB4E4;&#xC5B4;&#xAC00;&#xC57C; &#xD569;&#xB2C8;&#xB2E4;.  </p>
<p>Windows &#xCEE4;&#xB110; &#xC774;&#xBBF8;&#xC9C0; <code>ntoskrnl.exe</code>&#xC758; Entry Point&#xB294; <code>KiSystemStartup</code> &#xC73C;&#xB85C;, CPU &#xCD08;&#xAE30;&#xD654;&#xBD80;&#xD130; &#xBBF8;&#xD2F0;&#xAC8C;&#xC774;&#xC158; &#xAD00;&#xB828;&#xB41C; Feature &#xC138;&#xD305; &#xC218;&#xD589;, &#xCEE4;&#xB110; &#xB514;&#xBC84;&#xAC70; &#xCD08;&#xAE30;&#xD654; &#xB4F1; &#xB2E4;&#xC591;&#xD55C; &#xC5ED;&#xD560;&#xC744; &#xC218;&#xD589;&#xD569;&#xB2C8;&#xB2E4;.</p>
<p>KVAS &#xD65C;&#xC131;&#xD654; &#xC5EC;&#xBD80;&#xB97C; &#xACB0;&#xC815;&#xD558;&#xB294; &#xD568;&#xC218;&#xB294; &#xC758;&#xC678;&#xB85C; &#xAE08;&#xBC29; &#xCC3E;&#xC744; &#xC218; &#xC788;&#xC5C8;&#xC2B5;&#xB2C8;&#xB2E4;.</p>
<ul>
<li>KiSystemStartup &#x2192; KiInitializeBootStructures &#x2192; KiSetFeatureBits &#x2192; KiDetectKvaLeakage</li>
</ul>
<pre><code class="hljs cpp"><span class="hljs-function">NTSTATUS __stdcall __noreturn <span class="hljs-title">KiSystemStartup</span><span class="hljs-params">(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)</span></span>
<span class="hljs-function"></span>{
<span class="hljs-comment">//...</span>
  KeLoaderBlock_0 = (__int64)DriverObject;
  <span class="hljs-keyword">if</span> ( !*((_DWORD *)DriverObject-&gt;MajorFunction[<span class="hljs-number">3</span>] + <span class="hljs-number">9</span>) )
    KasanInitSystem(DriverObject, <span class="hljs-number">0</span>i64);
  <span class="hljs-keyword">if</span> ( !*(_DWORD *)(*(_QWORD *)(KeLoaderBlock_0 + <span class="hljs-number">136</span>) + <span class="hljs-number">36</span>i64) )
    KdInitSystem(<span class="hljs-number">0xFFFFFFFF</span>i64, KeLoaderBlock_0);
  v2 = *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> **)(KeLoaderBlock_0 + <span class="hljs-number">136</span>);

<span class="hljs-comment">//...</span>

  KiInitializeBootStructures(KeLoaderBlock_0);  <span class="hljs-comment">// Initialize Boot Structures</span>
  <span class="hljs-keyword">if</span> ( !*MK_FP(<span class="hljs-number">43</span>, *MK_FP(<span class="hljs-number">43</span>, KeLoaderBlock_0 + <span class="hljs-number">136</span>) + <span class="hljs-number">36</span>i64) )
    KdInitSystem(<span class="hljs-number">0</span>i64, KeLoaderBlock_0);
<span class="hljs-comment">//...</span>

}

<span class="hljs-function">__int64 __fastcall <span class="hljs-title">KiInitializeBootStructures</span><span class="hljs-params">(__int64 a1)</span></span>
<span class="hljs-function"></span>{
  KPCR *Pcr; <span class="hljs-comment">// r14</span>
  _KPROCESS **v2; <span class="hljs-comment">// rbx</span>
  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">KPRCB</span> *<span class="hljs-title">CurrentPrcb</span>;</span> <span class="hljs-comment">// rdi</span>
<span class="hljs-comment">//...</span>

  <span class="hljs-keyword">if</span> ( !KeGetPcr()-&gt;Prcb.Number )
    KiInitializeNxSupportDiscard(v19, v18, v20);
  HalInitializeProcessor(Number, a1, v20);
  KiSetFeatureBits(CurrentPrcb);                <span class="hljs-comment">// Set Prcb Feature Bits</span>
  CurrentPCB_Number = CurrentPrcb-&gt;Number;
  v27 = KiSystemCall32;
  v28 = KiSystemCall64;
  <span class="hljs-keyword">if</span> ( !CurrentPCB_Number )
  {
    KiEnableKvaShadowing(CurrentPrcb);              <span class="hljs-comment">// KVA Shadow &#xD65C;&#xC131;&#xD654; &#xC5EC;&#xBD80;&#xB97C; &#xACB0;&#xC815;</span>
    CurrentPCB_Number = CurrentPrcb-&gt;Number;
  }
  <span class="hljs-keyword">if</span> ( KiKvaShadow )                             <span class="hljs-comment">// KVA Shadow &#xD50C;&#xB798;&#xADF8;&#xAC00; &#xD65C;&#xC131;&#xD654;&#xB418;&#xBA74;</span>
  {
    v27 = KiSystemCall32Shadow;                 <span class="hljs-comment">// KiSystemCall32/KiSystemCall64 &#xB300;&#xC2E0; </span>
    v28 = KiSystemCall64Shadow;                 <span class="hljs-comment">// KiSystemCall32Shadow/KiSystemCall64Shadow &#xC0AC;&#xC6A9;</span>
  }
  
<span class="hljs-comment">//...</span>
}

<span class="hljs-function">__int64 __fastcall <span class="hljs-title">KiSetFeatureBits</span><span class="hljs-params">(_KPRCB *CurrentPRCB)</span></span>
<span class="hljs-function"></span>{
  <span class="hljs-keyword">char</span> CpuType; <span class="hljs-comment">// bl</span>
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> CpuModel; <span class="hljs-comment">// ecx</span>
  <span class="hljs-keyword">unsigned</span> __int8 CpuVendor; <span class="hljs-comment">// dl</span>
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> ProcessorSignature; <span class="hljs-comment">// eax</span>
  <span class="hljs-keyword">unsigned</span> __int8 CpuStepping; <span class="hljs-comment">// cl</span>
  <span class="hljs-keyword">unsigned</span> __int8 v57; <span class="hljs-comment">// al</span>
  <span class="hljs-keyword">unsigned</span> __int64 v58; <span class="hljs-comment">// rcx</span>
<span class="hljs-comment">//...</span>

  CpuType = CurrentPRCB-&gt;CpuType_Family;        <span class="hljs-comment">// CpuType = Processor Family</span>
  CpuModel = CurrentPRCB-&gt;CpuModel;
  CpuVendor = CurrentPRCB-&gt;CpuVendor;
  v123 = (CpuVendor - <span class="hljs-number">1</span>) &lt;= <span class="hljs-number">1u</span>;
  <span class="hljs-keyword">if</span> ( CurrentPRCB-&gt;Number )
  {
    ProcessorSignature = KiGetProcessorSignature(<span class="hljs-number">0</span>i64, <span class="hljs-number">0</span>i64, <span class="hljs-number">0</span>i64, <span class="hljs-number">0</span>i64);
    KiSetProcessorSignature(CurrentPRCB, ProcessorSignature);
    <span class="hljs-keyword">goto</span> LABEL_40;
  }

<span class="hljs-comment">//... </span>
  KiDetectKvaLeakage(CurrentPRCB);      <span class="hljs-comment">// Detect - KVA needs to be activated</span>
  _m_prefetchw(CurrentPRCB);
  <span class="hljs-keyword">if</span> ( CurrentPRCB-&gt;CpuVendor == <span class="hljs-number">1</span> )
  {
    v52 |= <span class="hljs-number">0x100000</span>u;
    HIDWORD(v134) = v52;
  }
<span class="hljs-comment">//...</span>
}</code></pre>
<h2 id="KVAS-Activation-for-Meltdown"><a href="#KVAS-Activation-for-Meltdown" class="headerlink" title="KVAS Activation for Meltdown"></a>KVAS Activation for Meltdown</h2><p>&#xC704; &#xD638;&#xCD9C; &#xCCB4;&#xC778;&#xC5D0;&#xC11C; <code>KiDetectKvaLeakage</code> &#xD568;&#xC218;&#xAC00; &#xBC14;&#xB85C; KVA &#xD65C;&#xC131;&#xD654; &#xC5EC;&#xBD80;&#xB97C; &#xACB0;&#xC815;&#xD558;&#xB294; &#xCF54;&#xC5B4; &#xD568;&#xC218;&#xC785;&#xB2C8;&#xB2E4;.</p>
<pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">int</span> __fastcall <span class="hljs-title">KiDetectKvaLeakage</span><span class="hljs-params">(_KPRCB *a1)</span></span>
<span class="hljs-function"></span>{
  __int64 p_CpuVendor; <span class="hljs-comment">// rsi</span>
  <span class="hljs-keyword">unsigned</span> __int64 _RAX; <span class="hljs-comment">// rax</span>
  __int64 v4; <span class="hljs-comment">// rcx</span>
  __int64 _RAX; <span class="hljs-comment">// rax</span>
  __int64 _RAX; <span class="hljs-comment">// rax</span>
  __int64 _RDX; <span class="hljs-comment">// rdx</span>
  <span class="hljs-keyword">unsigned</span> __int64 v13; <span class="hljs-comment">// rdx</span>
  <span class="hljs-keyword">bool</span> v14; <span class="hljs-comment">// zf</span>
  <span class="hljs-keyword">int</span> *v15; <span class="hljs-comment">// rdx</span>
  <span class="hljs-keyword">int</span> v16; <span class="hljs-comment">// ecx</span>
  __int64 v17; <span class="hljs-comment">// rbx</span>
  __int64 _RAX; <span class="hljs-comment">// rax</span>
  __int64 _RAX; <span class="hljs-comment">// rax</span>
  __int64 _RAX; <span class="hljs-comment">// rax</span>
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> Number; <span class="hljs-comment">// edx</span>
  <span class="hljs-keyword">int</span> v29[<span class="hljs-number">6</span>]; <span class="hljs-comment">// [rsp+30h] [rbp-20h] BYREF</span>

  v29[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;
  p_CpuVendor = &amp;a1-&gt;CpuVendor;
  
  <span class="hljs-comment">// Check 1</span>
  LODWORD(_RAX) = KiIsKvaShadowNeededForBranchConfusion(a1);
  <span class="hljs-keyword">if</span> ( _RAX )
    <span class="hljs-keyword">goto</span> ENABLE_KVAS_BRANCH_CONFUSION;
  LODWORD(_RAX) = *p_CpuVendor;
  
  <span class="hljs-comment">// Check 2</span>
  <span class="hljs-comment">// Intel - Check with bitmask</span>
  <span class="hljs-keyword">if</span> ( *p_CpuVendor == <span class="hljs-number">2</span> )
  {
    _RAX = a1-&gt;CpuModel;
    <span class="hljs-keyword">if</span> ( a1-&gt;CpuType == <span class="hljs-number">6</span> &amp;&amp; _RAX &lt;= <span class="hljs-number">0x36</span>u )
    {
      v4 = <span class="hljs-number">0x6000C010000000</span>i64;
      <span class="hljs-keyword">if</span> ( _bittest64(&amp;v4, _RAX) )
        <span class="hljs-keyword">return</span> _RAX;
    }
  }
  <span class="hljs-comment">// Others - disable KVAS</span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( _RAX != <span class="hljs-number">3</span> || a1-&gt;CpuType == <span class="hljs-number">6</span> &amp;&amp; a1-&gt;CpuModel == <span class="hljs-number">13</span>)
  {
    <span class="hljs-keyword">return</span> _RAX;
  }
	
	<span class="hljs-comment">// Check 3</span>
	<span class="hljs-comment">// IA32_ARCH_CAPABILITIES support query</span>
  _RAX = <span class="hljs-number">0</span>i64;
  __asm { cpuid }
  <span class="hljs-keyword">if</span> ( _RAX &lt; <span class="hljs-number">7</span> )
    <span class="hljs-keyword">goto</span> ENABLE_KVAS;
  _RAX = <span class="hljs-number">7</span>i64;
  __asm { cpuid }
  <span class="hljs-keyword">if</span> ( (_RDX &amp; <span class="hljs-number">0x20000000</span>) == <span class="hljs-number">0</span> )
    <span class="hljs-keyword">goto</span> ENABLE_KVAS;

	<span class="hljs-comment">// Check 3</span>
	<span class="hljs-comment">// msr address 0x10A - IA32_ARCH_CAPABILITIES</span>
  _RAX = __readmsr(<span class="hljs-number">0x10A</span>u);
  <span class="hljs-comment">//IA32_ARCH_CAPABILITIES bit 0 : RDCL_NO</span>
  <span class="hljs-keyword">if</span> ( (_RAX &amp; <span class="hljs-number">1</span>) == <span class="hljs-number">0</span> )
    <span class="hljs-keyword">goto</span> ENABLE_KVAS;
 
  KiMicrocodeTrackerEnabled = <span class="hljs-number">1</span>;
  LODWORD(_RAX) = <span class="hljs-number">3670016</span>;
  LOBYTE(v13) = (KeFeatureBits2 &amp; <span class="hljs-number">0x28</span>) == <span class="hljs-number">8</span>;
  <span class="hljs-keyword">if</span> ( (KeFeatureBits2 &amp; <span class="hljs-number">0x380000</span>) != <span class="hljs-number">3670016</span> )
  {
    LODWORD(_RAX) = KiIsFbClearSupported(KeFeatureBits2 &amp; <span class="hljs-number">0x380000</span>, v13);
    LOBYTE(v13) = _RAX | v13;
  }
  <span class="hljs-keyword">if</span> ( v13 )
  {
ENABLE_KVAS:
    <span class="hljs-keyword">if</span> ( a1-&gt;Number &amp;&amp; !KiKvaLeakage )
      KeBugCheckEx(<span class="hljs-number">0x5D</span>u, <span class="hljs-number">0x4B56414C</span>ui64, <span class="hljs-number">0</span>i64, <span class="hljs-number">0</span>i64, <span class="hljs-number">0</span>i64);
ENABLE_KVAS_BRANCH_CONFUSION:
    v14 = *p_CpuVendor == <span class="hljs-number">2</span>;
    **KiKvaLeakage = <span class="hljs-number">1</span>;**
<span class="hljs-comment">//... for enable KVA</span>
  }
  <span class="hljs-keyword">return</span> _RAX;
}</code></pre>
<p><code>KiDetectKvaLeakage</code> &#xD568;&#xC218;&#xB294; KPRCB&#xC5D0; &#xD3EC;&#xD568;&#xB41C; CPU &#xBCA4;&#xB354; &#xBC0F; &#xBAA8;&#xB378; &#xC815;&#xBCF4;&#xC640;, MSR&#xC744; &#xC77D;&#xC5B4; &#xD655;&#xC778;&#xD560; &#xC218; &#xC788;&#xB294; &#xC815;&#xBCF4;&#xB97C; &#xD1B5;&#xD574; KVAS &#xD65C;&#xC131;&#xD654; &#xC5EC;&#xBD80;&#xB97C; &#xACB0;&#xC815;&#xD569;&#xB2C8;&#xB2E4;. &#xD655;&#xC778;&#xD558;&#xB294; &#xB8E8;&#xD2F4;&#xC740; &#xD06C;&#xAC8C; &#xC138; &#xAC00;&#xC9C0;&#xB85C; &#xB098;&#xB20C; &#xC218; &#xC788;&#xC2B5;&#xB2C8;&#xB2E4;.</p>
<h3 id="Check-1"><a href="#Check-1" class="headerlink" title="Check 1"></a>Check 1</h3><ul>
<li><code>KiIsKvaShadowNeededForBranchConfusion</code>&#xD568;&#xC218;&#xB97C; &#xD1B5;&#xD574; Branch Confusion &#xCDE8;&#xC57D;&#xC810;&#xC5D0; &#xC601;&#xD5A5;&#xBC1B;&#xB294;&#xC9C0; &#xD655;&#xC778;</li>
<li>&#xD574;&#xB2F9; &#xD568;&#xC218;&#xC758; &#xD638;&#xCD9C; &#xACB0;&#xACFC; Branch Confusion &#xCDE8;&#xC57D;&#xC810; &#xC601;&#xD5A5;&#xC744; &#xBC1B;&#xB294; &#xACBD;&#xC6B0; KVAS&#xB97C; &#xD65C;&#xC131;&#xD654;&#xD558;&#xB294; <code>ENABLE_KVAS_BRANCH_CONFUSION</code> &#xBD84;&#xAE30;&#xB85C; &#xC9C4;&#xD589;</li>
</ul>
<h3 id="Check-2"><a href="#Check-2" class="headerlink" title="Check 2"></a>Check 2</h3><ul>
<li>Meltdown&#xC5D0; &#xC601;&#xD5A5;&#xBC1B;&#xC9C0; &#xC54A;&#xC544; KVAS &#xD65C;&#xC131;&#xD654;&#xAC00; &#xD544;&#xC694; &#xC5C6;&#xB294; &#xAD6C;&#xD615; CPU&#xB97C; bitmask&#xB97C; &#xD1B5;&#xD574; &#xD544;&#xD130;&#xB9C1;&#xD558;&#xACE0; KVAS&#xB97C; &#xBE44;&#xD65C;&#xC131;&#xD654;</li>
<li>&#xB610;&#xD55C;, Meltdown&#xC740; Intel &#xD504;&#xB85C;&#xC138;&#xC11C; &#xC544;&#xD0A4;&#xD14D;&#xCCD0;&#xC5D0;&#xB9CC; &#xC601;&#xD5A5;&#xC744; &#xC8FC;&#xB294; &#xCDE8;&#xC57D;&#xC810;&#xC774;&#xBBC0;&#xB85C; &#xB54C;&#xBB38;&#xC5D0; &#xADF8; &#xC678; &#xBCA4;&#xB354;&#xC5D0; &#xB300;&#xD574;&#xC11C;&#xB3C4; KVAS&#xB97C; &#xBE44;&#xD65C;&#xC131;&#xD654;</li>
</ul>
<h3 id="Check-3"><a href="#Check-3" class="headerlink" title="Check 3"></a>Check 3</h3><ul>
<li>&#xBA3C;&#xC800; CPU&#xAC00; MSR(Model Specific Register) &#xAE30;&#xB2A5;&#xC744; &#xC9C0;&#xC6D0;&#xD558;&#xB294;&#xC9C0; &#xD655;&#xC778;<ul>
<li>MSR&#xC744; &#xC9C0;&#xC6D0;&#xD558;&#xC9C0; &#xC54A;&#xC73C;&#xBA74; Meltdown&#xC5D0; &#xC601;&#xD5A5;&#xC744; &#xBC1B;&#xB294; &#xAD6C;&#xD615; CPU&#xC774;&#xBBC0;&#xB85C; KVAS &#xD65C;&#xC131;&#xD654;&#xD558;&#xB294; <code>ENABLE_KVAS</code> &#xBD84;&#xAE30;&#xB85C; &#xC9C4;&#xD589;</li>
<li>MSR&#xC744; &#xC9C0;&#xC6D0;&#xD558;&#xC9C0; &#xC54A;&#xC9C0;&#xB9CC; &#xC601;&#xD5A5;&#xC744; &#xBC1B;&#xC9C0; &#xC54A;&#xB294; &#xBAA8;&#xB378;&#xC740; Check 2 &#xB8E8;&#xD2F4;&#xC5D0;&#xC11C; bitmask&#xB97C; &#xD1B5;&#xD574; &#xBA3C;&#xC800; &#xD544;&#xD130;&#xB9C1;</li>
</ul>
</li>
<li><code>__readmsr</code>&#xC744; &#xD1B5;&#xD574; MSR &#xC8FC;&#xC18C; <code>0x10A</code> &#xC77D;&#xAE30; - <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.intel.com/content/www/us/en/developer/articles/technical/software-security-guidance/technical-documentation/cpuid-enumeration-and-architectural-msrs.html">IA32_ARCH_CAPABILITIES</a><ul>
<li>&#xACB0;&#xACFC;(<code>_RAX</code>)&#xC758; &#xD544;&#xB4DC; 0 (<code>RDCL_NO</code>) &#xAC00; &#xD65C;&#xC131;&#xD654;&#xB418;&#xC9C0; &#xC54A;&#xC558;&#xC73C;&#xBA74; KVAS &#xD65C;&#xC131;&#xD654;&#xD558;&#xB294; <code>ENABLE_KVAS</code>&#xBD84;&#xAE30;&#xB85C; &#xC9C4;&#xD589;</li>
<li>RDCL_NO: Rogue Data Cache Load(Meltdown) &#xC5D0; &#xCDE8;&#xC57D;&#xD558;&#xC9C0; &#xC54A;&#xC74C;&#xC744; &#xB098;&#xD0C0;&#xB0B4;&#xB294; &#xBE44;&#xD2B8; &#xD50C;&#xB798;&#xADF8;</li>
</ul>
</li>
</ul>
<p>&#xC704; &#xD655;&#xC778; &#xACFC;&#xC815;&#xC744; &#xD1B5;&#xD574; KVAS&#xAC00; &#xD544;&#xC694;&#xD558;&#xB2E4;&#xACE0; &#xD310;&#xB2E8;&#xB418;&#xBA74; <code>KiKvaLeakage</code>&#xB97C; 1&#xB85C; &#xC124;&#xC815;&#xD569;&#xB2C8;&#xB2E4;. </p>
<p>&#xD574;&#xB2F9; &#xD568;&#xC218;&#xC758; &#xC8FC;&#xC694; &#xAE30;&#xB2A5;&#xC740; Check 2&#xC640; Chekc3&#xC758; Meltdown &#xCDE8;&#xC57D;&#xC810;&#xC5D0; &#xC601;&#xD5A5;&#xBC1B;&#xB294; Intel &#xD504;&#xB85C;&#xC138;&#xC11C;&#xB97C; &#xC2DD;&#xBCC4;&#xD558;&#xACE0; KVAS &#xD65C;&#xC131;&#xD654; &#xD50C;&#xB798;&#xADF8;&#xB97C; &#xC124;&#xC815;&#xD558;&#xB294; &#xAC83;&#xC73C;&#xB85C; &#xC694;&#xC57D;&#xD560; &#xC218; &#xC788;&#xACA0;&#xB124;&#xC694;. Check 1&#xC740; &#xC544;&#xB798;&#xC5D0;&#xC11C; &#xB354; &#xC790;&#xC138;&#xD558;&#xAC8C; &#xC124;&#xBA85;&#xD558;&#xACA0;&#xC2B5;&#xB2C8;&#xB2E4;.</p>
<h2 id="KVAS-Activation-for-Branch-Confusion"><a href="#KVAS-Activation-for-Branch-Confusion" class="headerlink" title="KVAS Activation for Branch Confusion"></a>KVAS Activation for Branch Confusion</h2><p>KVAS&#xB294; Meltdown&#xB9CC; &#xC801;&#xC6A9;&#xB418;&#xB294; &#xBBF8;&#xD2F0;&#xAC8C;&#xC774;&#xC158;&#xC740; &#xC544;&#xB2D9;&#xB2C8;&#xB2E4;. &#xADF8;&#xAC78; &#xD655;&#xC778;&#xD560; &#xC218; &#xC788;&#xB294; &#xD568;&#xC218;&#xAC00; Check 1 &#xB8E8;&#xD2F4;&#xC5D0;&#xC11C; &#xD638;&#xCD9C;&#xD558;&#xB294; <code>KiIsKvaShadowNeededForBranchConfusion</code> &#xC778;&#xB370;&#xC694;.</p>
<pre><code class="hljs powershell">__int64 __fastcall KiIsKvaShadowNeededForBranchConfusion(__int64 a1)
{
  unsigned int v2; // ebx
  __int128 v4; // [<span class="hljs-type">rsp</span>+<span class="hljs-number">20</span><span class="hljs-type">h</span>] [<span class="hljs-type">rbp</span>-<span class="hljs-number">28</span><span class="hljs-type">h</span>] BYREF
  __int64 v5; // [<span class="hljs-type">rsp</span>+<span class="hljs-number">30</span><span class="hljs-type">h</span>] [<span class="hljs-type">rbp</span>-<span class="hljs-number">18</span><span class="hljs-type">h</span>]

  v5 = <span class="hljs-number">0</span>i64;
  v4 = <span class="hljs-number">0</span>i64;
  KiDetectHardwareSpecControlFeatures(a1, <span class="hljs-number">0</span>i64, (__int64)&amp;v4, <span class="hljs-number">0</span>i64);
  <span class="hljs-keyword">if</span> ( (v4 &amp; <span class="hljs-number">0</span>x8000) == <span class="hljs-number">0</span> )
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>i64;
  v2 = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">if</span> ( !(unsigned int)KiIsBranchConfusionMitigationDesired(a1, &amp;v4) )
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>i64;
  LOBYTE(v2) = (unsigned int)KiIsBranchConfusionMitigationSupported(a1, &amp;v4) != <span class="hljs-number">0</span>;
  <span class="hljs-keyword">return</span> v2;
}</code></pre>
<p>&#xD568;&#xC218;&#xBA85;&#xC5D0;&#xC11C;&#xB3C4; &#xC54C; &#xC218; &#xC788;&#xB4EF;, Branch Confusion &#xCDE8;&#xC57D;&#xC810;&#xC758; &#xC601;&#xD5A5;&#xC744; &#xBC1B;&#xB294; CPU&#xC778;&#xC9C0; &#xD655;&#xC778;&#xD558;&#xACE0; KVA Shadow &#xD65C;&#xC131;&#xD654;&#xAC00; &#xD544;&#xC694;&#xD55C;&#xC9C0; &#xACB0;&#xC815;&#xD558;&#xB294; &#xD568;&#xC218;&#xC785;&#xB2C8;&#xB2E4;.</p>
<ul>
<li><code>KiDetectHardwareSpecControlFeatures</code> &#xD568;&#xC218; &#xD638;&#xCD9C; &#xACB0;&#xACFC;&#xC778; <code>v4</code> &#xC758; <code>0x8000</code> &#xBE44;&#xD2B8;&#xAC00; 1&#xC774;&#xBA74; Branch Confusion&#xC758; &#xC601;&#xD5A5;&#xC744; &#xBC1B;&#xC74C;</li>
<li>&#xC774;&#xD6C4; &#xAD00;&#xB828; Mitigation&#xC774; &#xC9C0;&#xC6D0;&#xB418;&#xBA74; True &#xBC18;&#xD658; - <code>KiDetectKvaLeakage</code> &#xD568;&#xC218;&#xC5D0;&#xC11C; KVAS &#xD65C;&#xC131;&#xD654; &#xB8E8;&#xD2F4;&#xC73C;&#xB85C; &#xC9C4;&#xC785;&#xD568;</li>
</ul>
<p><code>KiDetectHardwareSpecControlFeatures</code> &#xD568;&#xC218;&#xC5D0;&#xC11C; &#xC880; &#xB354; &#xC790;&#xC138;&#xD788; &#xC0B4;&#xD3B4;&#xBCF4;&#xB3C4;&#xB85D; &#xD558;&#xC8E0;</p>
<pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">char</span> *__fastcall <span class="hljs-title">KiDetectHardwareSpecControlFeatures</span><span class="hljs-params">(_KPRCB *PRCB, __int64 _zero, __int64 result2, <span class="hljs-keyword">char</span> *__zero)</span></span>
<span class="hljs-function"></span>{
  <span class="hljs-keyword">int</span> CpuModel_1; <span class="hljs-comment">// r14d</span>
  <span class="hljs-keyword">unsigned</span> __int8 CpuVendor; <span class="hljs-comment">// al</span>
  <span class="hljs-keyword">char</span> CpuType_Family; <span class="hljs-comment">// r12</span>
  <span class="hljs-keyword">bool</span> IsAnyHypervisorPresent; <span class="hljs-comment">// r9</span>
  <span class="hljs-keyword">char</span> CpuVendor_2; <span class="hljs-comment">// bl</span>
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> ProcessorFlags; <span class="hljs-comment">// ecx</span>
  <span class="hljs-keyword">unsigned</span> __int8 CpuModel; <span class="hljs-comment">// cl</span>
  <span class="hljs-keyword">unsigned</span> __int8 CpuStepping; <span class="hljs-comment">// al</span>
<span class="hljs-comment">//...</span>
  <span class="hljs-keyword">char</span> *result; <span class="hljs-comment">// rax</span>
  <span class="hljs-keyword">unsigned</span> __int8 CpuVendor_1; <span class="hljs-comment">// [rsp+20h] [rbp-60h]</span>
  
  
  CpuVendor = PRCB-&gt;CpuVendor;
  CpuType_Family = PRCB-&gt;CpuType_Family;
  LOBYTE(CpuModel_1) = PRCB-&gt;CpuModel;
<span class="hljs-comment">//...</span>
  CpuVendor_1 = CpuVendor;
  v48 = <span class="hljs-number">1</span>;
  
  <span class="hljs-comment">// Hypervisor check</span>
  <span class="hljs-keyword">if</span> ( HviIsHypervisorMicrosoftCompatible() )
  {
    HviGetEnlightenmentInformation(&amp;v54);
    v53 = <span class="hljs-number">0</span>i64;
    HviGetHypervisorFeatures(&amp;v53);
    <span class="hljs-keyword">if</span> ( (v53 &amp; <span class="hljs-number">0x100000000000</span>i64) == <span class="hljs-number">0</span> || (v54 &amp; <span class="hljs-number">0x1000</span>) != <span class="hljs-number">0</span> )
    {
      IsAnyHypervisorPresent = <span class="hljs-number">1</span>;
    }
    <span class="hljs-keyword">else</span>
    {
      IsAnyHypervisorPresent = <span class="hljs-number">0</span>;
      v48 = <span class="hljs-number">0</span>;
    }
  }
  <span class="hljs-keyword">else</span>
  {
    IsAnyHypervisorPresent = HviIsAnyHypervisorPresent();
    v48 = IsAnyHypervisorPresent;
  }
  v11 = result1;

  <span class="hljs-keyword">if</span> ( KiIsBranchConfusionPresent(PRCB) )
  {
    v11 |= <span class="hljs-number">0x8000</span>ui64;
    *&amp;result1 = v11;
  }
<span class="hljs-comment">//...</span>
  *result2 = result1;
  *(result2 + <span class="hljs-number">16</span>) = <span class="hljs-number">4</span>i64;
  result = __zero;
  <span class="hljs-keyword">if</span> ( __zero )
    *__zero = v8;
  <span class="hljs-keyword">return</span> result;
}</code></pre>
<p>&#xD574;&#xB2F9; &#xD568;&#xC218;&#xC5D0;&#xB294; &#xB2E4;&#xC591;&#xD55C; &#xCD94;&#xCE21; &#xC2E4;&#xD589; &#xAE30;&#xBC18; side-channel &#xCDE8;&#xC57D;&#xC810;&#xC5D0; &#xC601;&#xD5A5;&#xC744; &#xBC1B;&#xB294;&#xC9C0; &#xD655;&#xC778;&#xD558;&#xB294; &#xB85C;&#xC9C1;&#xC774; &#xC788;&#xC9C0;&#xB9CC;, &#xCF54;&#xB4DC;&#xB97C; &#xB2E4; &#xC4F0;&#xAE30;&#xC5D0;&#xB294; &#xB108;&#xBB34; &#xAE30;&#xB2C8;&#xAE4C; KVAS &#xD65C;&#xC131;&#xD654;&#xB97C; &#xACB0;&#xC815;&#xD558;&#xB294; <code>0x8000</code> &#xBE44;&#xD2B8;&#xB97C; &#xC124;&#xC815;&#xD558;&#xB294; &#xCF54;&#xB4DC;&#xB9CC; &#xBCF4;&#xACA0;&#xC2B5;&#xB2C8;&#xB2E4;.</p>
<ul>
<li>&#xCD94;&#xCE21; &#xC2E4;&#xD589; &#xAD00;&#xB828; &#xCDE8;&#xC57D;&#xC810; &#xBAA9;&#xB85D;&#xC740; <a target="_blank" rel="external nofollow noopener noreferrer" href="https://support.microsoft.com/en-us/topic/kb4073119-windows-client-guidance-for-it-pros-to-protect-against-silicon-based-microarchitectural-and-speculative-execution-side-channel-vulnerabilities-35820a8a-ae13-1299-88cc-357f104f5b11">MS &#xD074;&#xB77C;&#xC774;&#xC5B8;&#xB4DC; &#xAC00;&#xC774;&#xB358;&#xC2A4;</a> &#xCC38;&#xACE0;</li>
</ul>
<p><code>KiIsBranchConfusionPresent</code> &#xD568;&#xC218; &#xBC18;&#xD658;&#xAC12;&#xC774; True&#xBA74; <code>0x8000</code> &#xBE44;&#xD2B8;&#xB97C; &#xC124;&#xC815;&#xD558;&#xB124;&#xC694;.</p>
<p><code>KiIsBranchConfusionPresent</code></p>
<pre><code class="hljs jsx">__int64 __fastcall KiIsBranchConfusionPresent(_KPRCB *a1)
{
  bool IsAnyHypervisorPresent; <span class="hljs-comment">// al</span>
  unsigned int v3; <span class="hljs-comment">// edx</span>

  <span class="hljs-keyword">if</span> ( a1-&gt;CpuVendor != <span class="hljs-number">1</span> || (KeFeatureBits2 &amp; <span class="hljs-number">0x1000000</span>) != <span class="hljs-number">0</span> )
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>i64;
  IsAnyHypervisorPresent = HviIsAnyHypervisorPresent();
  v3 = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">if</span> ( IsAnyHypervisorPresent )
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>i64;
  LOBYTE(v3) = a1-&gt;CpuType_Family != <span class="hljs-number">25</span>;
  <span class="hljs-keyword">return</span> v3;
}</code></pre>
<p>&#xD568;&#xC218; &#xB85C;&#xC9C1;&#xC744; &#xBD84;&#xC11D;&#xD558;&#xBA74; &#xB2E4;&#xC74C;&#xACFC; &#xAC19;&#xC2B5;&#xB2C8;&#xB2E4;.</p>
<ol>
<li>CpuVendor&#xAC00; AMD&#xAC00; &#xC544;&#xB2C8;&#xBA74; False &#xBC18;&#xD658;<ul>
<li>Branch Confusion&#xC740; AMD CPU&#xC5D0;&#xB9CC; &#xC601;&#xD5A5;&#xC744; &#xC8FC;&#xB294; &#xCDE8;&#xC57D;&#xC810;(<a target="_blank" rel="external nofollow noopener noreferrer" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-23825">CVE-2022-23825</a>)</li>
</ul>
</li>
<li><code>HviIsAnyHypervisorPresent</code>&#xD568;&#xC218;&#xB97C; &#xD1B5;&#xD574; Hypervisor&#xAC00; &#xD65C;&#xC131;&#xD654;&#xB418;&#xC5B4; &#xC788;&#xC73C;&#xBA74; True &#xBC18;&#xD658;<ul>
<li>CVE-2022-23825&#xB294; &#xAC00;&#xC0C1;&#xD654; &#xD658;&#xACBD;&#xC5D0; &#xC601;&#xD5A5;&#xC744; &#xC8FC;&#xB294; &#xCDE8;&#xC57D;&#xC810;&#xC774;&#xBBC0;&#xB85C; Hyperviosr&#xAC00; &#xD65C;&#xC131;&#xD654;&#xB41C; &#xACBD;&#xC6B0;&#xC5D0;&#xB9CC; KVAS&#xB97C; &#xD65C;&#xC131;&#xD654;&#xD558;&#xB3C4;&#xB85D; &#xAD6C;&#xD604;&#xB428;</li>
</ul>
</li>
<li>Family Number&#xAC00; Zen 3 / Zen 3+ / Zen 4 &#xC778; 25 &#xC778; &#xACBD;&#xC6B0;&#xC5D0;&#xB9CC; True &#xBC18;&#xD658;<ul>
<li>&#xADF8; &#xC678; &#xC544;&#xD0A4;&#xD14D;&#xCC98;&#xB294; &#xC601;&#xD5A5;&#xBC1B;&#xC9C0; &#xC54A;&#xC74C;&#xC744; &#xC54C; &#xC218; &#xC788;&#xC74C;</li>
</ul>
</li>
</ol>
<p>&#xC774;&#xD6C4; <code>KiEnableKvaShadowing</code> &#xC5D0;&#xC11C; KVAS &#xD65C;&#xC131;&#xD654; &#xC804; &#xB9C8;&#xC9C0;&#xB9C9; &#xAC80;&#xC0AC;&#xAC00; &#xC874;&#xC7AC;&#xD569;&#xB2C8;&#xB2E4;.</p>
<pre><code class="hljs cpp"><span class="hljs-function">__int64 __fastcall <span class="hljs-title">KiEnableKvaShadowing</span><span class="hljs-params">(_KPRCB *a1)</span></span>
<span class="hljs-function"></span>{
  __int64 v2; <span class="hljs-comment">// rdx</span>
  __int64 v3; <span class="hljs-comment">// rcx</span>
  <span class="hljs-keyword">char</span> v4; <span class="hljs-comment">// cl</span>
  <span class="hljs-keyword">unsigned</span> __int64 v5; <span class="hljs-comment">// rax</span>
  __int64 v6; <span class="hljs-comment">// rdx</span>
  __int64 v7; <span class="hljs-comment">// r11</span>
  <span class="hljs-keyword">unsigned</span> __int8 v8; <span class="hljs-comment">// cf</span>
  <span class="hljs-keyword">unsigned</span> __int64 v9; <span class="hljs-comment">// rax</span>
  <span class="hljs-keyword">unsigned</span> __int64 v10; <span class="hljs-comment">// rax</span>
  __int64 result; <span class="hljs-comment">// rax</span>
  <span class="hljs-keyword">unsigned</span> __int16 v12; <span class="hljs-comment">// cx</span>

  <span class="hljs-keyword">if</span> ( KiIsKvaShadowDisabled() )
  {
    KiIsKvaShadowConfigDisabled = <span class="hljs-number">1</span>;
  }
  <span class="hljs-keyword">else</span>
  {
    <span class="hljs-keyword">if</span> ( (KeFeatureBits2 &amp; <span class="hljs-number">0x18000</span>) == <span class="hljs-number">0x8000</span> )
      *(_QWORD *)(v3 + <span class="hljs-number">11520</span>) = <span class="hljs-number">3</span>i64;
    v4 = KiKernelCetEnabled;
    <span class="hljs-keyword">if</span> ( !(_BYTE)KiKernelCetEnabled &amp;&amp; (<span class="hljs-keyword">unsigned</span> __int8)KiIsKvaLeakSimulated() )
      KiKvaLeakageSimulate = <span class="hljs-number">1</span>;
    
    <span class="hljs-comment">// Enable KVAS</span>
    <span class="hljs-keyword">if</span> ( KiKvaLeakage || KiKvaLeakageSimulate )
    {
      <span class="hljs-keyword">if</span> ( v4 )
        KeBugCheckEx(<span class="hljs-number">0x5D</span>u, <span class="hljs-number">0x4B766120</span>ui64, <span class="hljs-number">0x4B434554</span>ui64, <span class="hljs-number">0</span>i64, <span class="hljs-number">0</span>i64);
      v5 = __readcr3();
      a1-&gt;KernelDirectoryTableBase = v5;
      *(_QWORD *)(v2 + <span class="hljs-number">4216</span>) = *(_QWORD *)(v2 + <span class="hljs-number">4100</span>);
      KiInitializeDescriptorIst(a1);
      *(_QWORD *)(v7 + <span class="hljs-number">4100</span>) = v7 + <span class="hljs-number">16896</span>;
      <span class="hljs-keyword">if</span> ( a1-&gt;Number )
      {
        result = KiShadowProcessorAllocation(a1, v7);
        <span class="hljs-keyword">if</span> ( !(_DWORD)result )
          <span class="hljs-keyword">return</span> result;
        v12 = *(_WORD *)(KeGetPrcb(<span class="hljs-number">0</span>i64) + <span class="hljs-number">44714</span>);
        a1-&gt;ShadowFlags |= <span class="hljs-number">2u</span>;
        a1-&gt;VerwSelector = v12;
      }
      <span class="hljs-keyword">else</span>
      {
        LOBYTE(v6) = <span class="hljs-number">1</span>;
        KiInitializeIdt(v7, v6);
        KeGetCurrentThread()-&gt;ApcState.Process-&gt;AddressPolicy = <span class="hljs-number">1</span>;
        byte_140FCE0E0 = <span class="hljs-number">1</span>;
        _InterlockedOr(dword_140FCE57C, <span class="hljs-number">0x4000</span>u);
        KiSetAddressPolicy(<span class="hljs-number">1</span>i64);
        v8 = _bittest64((<span class="hljs-keyword">const</span> <span class="hljs-keyword">signed</span> __int64 *)&amp;a1-&gt;FeatureBits, <span class="hljs-number">0x2A</span>u);
        a1-&gt;VerwSelector = <span class="hljs-number">24</span>;
        <span class="hljs-keyword">if</span> ( v8 )
        {
          v9 = __readcr4();
          __writecr4(v9 &amp; <span class="hljs-number">0xFFFFFFFFFFFDFF7F</span>ui64 | <span class="hljs-number">0x20000</span>);
          v10 = __readcr3();
          __writecr3(v10 | <span class="hljs-number">2</span>);
          KiFlushPcid |= <span class="hljs-number">1u</span>;
        }
        <span class="hljs-keyword">if</span> ( (a1-&gt;FeatureBits &amp; <span class="hljs-number">0x240000000000</span>i64) == <span class="hljs-number">0x240000000000</span>i64 )
          KiFlushPcid |= <span class="hljs-number">2u</span>;
        HvlRescindEnlightenments();
        KiKvaShadow = <span class="hljs-number">1</span>;
        KiKvaShadowMode = <span class="hljs-number">2</span> - (KiFlushPcid != <span class="hljs-number">0</span>);
      }
      <span class="hljs-keyword">if</span> ( KiFlushPcid )
        _interlockedbittestandset64((<span class="hljs-keyword">volatile</span> <span class="hljs-keyword">signed</span> __int32 *)&amp;a1-&gt;KernelDirectoryTableBase, <span class="hljs-number">0x3F</span>ui64);
    }
  }
  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>i64;
}</code></pre>
<ul>
<li><code>if ( KiKvaLeakage || KiKvaLeakageSimulate )</code>  &#xBD84;&#xAE30;<ul>
<li><code>KiDetectKvaLeakage</code> &#xD568;&#xC218;&#xC5D0;&#xC11C; &#xC124;&#xC815;&#xD55C; &#xC804;&#xC5ED;&#xBCC0;&#xC218;<code>KiKvaLeakage</code></li>
<li>&#xC218;&#xB3D9; &#xC124;&#xC815;&#xAC12;(&#xB514;&#xBC84;&#xAE45; &#xBC0F; &#xD14C;&#xC2A4;&#xD2B8;&#xC6A9;)&#xC744; &#xD1B5;&#xD574; &#xACB0;&#xC815;&#xB418;&#xB294; &#xAC83;&#xC73C;&#xB85C; &#xCD94;&#xC815;&#xB418;&#xB294; &#xC804;&#xC5ED;&#xBCC0;&#xC218; <code>KiKvaLeakageSimulate</code></li>
</ul>
</li>
<li>&#xB450; &#xC804;&#xC5ED;&#xBCC0;&#xC218; &#xAC12; &#xC911; &#xD558;&#xB098;&#xB77C;&#xB3C4; &#xC124;&#xC815;&#xB418;&#xC5B4; &#xC788;&#xC73C;&#xBA74; KVAS&#xB97C; &#xD65C;&#xC131;&#xD654;</li>
</ul>
<h1 id="&#xC138;&#xC904;&#xC694;&#xC57D;"><a href="#&#xC138;&#xC904;&#xC694;&#xC57D;" class="headerlink" title="&#xC138;&#xC904;&#xC694;&#xC57D;"></a>&#xC138;&#xC904;&#xC694;&#xC57D;</h1><ul>
<li>Windows Kernel&#xC740; &#xCD08;&#xAE30;&#xD654; &#xC2DC; CPU&#xC5D0; &#xB530;&#xB77C; KVAS(&#xBC0F; &#xB2E4;&#xB978; &#xBBF8;&#xD2F0;&#xAC8C;&#xC774;&#xC158;)&#xC744; &#xB3D9;&#xC801;&#xC73C;&#xB85C; &#xD65C;&#xC131;&#xD654;&#xD568;.</li>
<li>KVAS &#xD65C;&#xC131;&#xD654; &#xC5EC;&#xBD80;&#xB97C; &#xACB0;&#xC815;&#xD558;&#xB294; &#xAE30;&#xC900;&#xC740; &#xD06C;&#xAC8C; &#xB450; &#xAC00;&#xC9C0;<ul>
<li>Intel: Rogue Data Cache Load(Meltdown)</li>
<li>AMD: Branch Confusion</li>
</ul>
</li>
<li>CPU&#xAC00; MSR&#xC744; &#xD1B5;&#xD574; &#xC81C;&#xACF5;&#xD558;&#xB294; &#xD558;&#xB4DC;&#xC6E8;&#xC5B4; &#xBBF8;&#xD2F0;&#xAC8C;&#xC774;&#xC158; &#xC801;&#xC6A9; &#xC5EC;&#xBD80;&#xB97C; &#xD655;&#xC778;&#xD558;&#xACE0;, MSR &#xAE30;&#xB2A5;&#xC774; &#xC5C6;&#xC73C;&#xBA74; &#xB808;&#xAC70;&#xC2DC; &#xCCB4;&#xD06C; (bitmask, &#xBAA8;&#xB378;&#xB118;&#xBC84; &#xC815;&#xBCF4; &#xB4F1;)&#xB97C; &#xD1B5;&#xD574; KVAS &#xD65C;&#xC131;&#xD654; &#xC5EC;&#xBD80;&#xB97C; &#xACB0;&#xC815;&#xD568;.</li>
</ul>
<h1 id="&#xB9C8;&#xBB34;&#xB9AC;&#xD558;&#xBA70;"><a href="#&#xB9C8;&#xBB34;&#xB9AC;&#xD558;&#xBA70;" class="headerlink" title="&#xB9C8;&#xBB34;&#xB9AC;&#xD558;&#xBA70;"></a>&#xB9C8;&#xBB34;&#xB9AC;&#xD558;&#xBA70;</h1><p><img src="/2025/08/10/l0ch/deep-dive-into-kva/ko/image1.jpg" srcset="/img/loading.gif" alt="Untitled"></p>
<p>&#xC0AC;&#xC2E4; &#xC608;&#xC804;&#xC5D0; &#xD55C;&#xCC3D; &#xCD94;&#xCE21; &#xC2E4;&#xD589; &#xAE30;&#xBC18;&#xC758; &#xC0AC;&#xC774;&#xB4DC;&#xCC44;&#xB110; &#xCDE8;&#xC57D;&#xC810;&#xC774; &#xC774;&#xC288;&#xB420; &#xB54C; &#xAD6D;&#xBC29;&#xC758; &#xC758;&#xBB34;&#xB97C; &#xC218;&#xD589;&#xD558;&#xB290;&#xB77C; &#xC81C;&#xB300;&#xB85C; &#xD30C;&#xBCF4;&#xC9C8; &#xBABB;&#xD588;&#xB294;&#xB370;&#xC694;, &#xC800;&#xBC88; KASLR bypass&#xC640; &#xC774;&#xBC88; &#xAE00;&#xC744; &#xC791;&#xC131;&#xD558;&#xBA74;&#xC11C; &#xC790;&#xC138;&#xD788; &#xD30C;&#xBCFC; &#xAE30;&#xD68C;&#xAC00; &#xB41C; &#xAC83; &#xAC19;&#xC2B5;&#xB2C8;&#xB2E4;. &#xACFC;&#xAC70;&#xC758; &#xC774;&#xC288;&#xB97C; &#xC81C;&#xB300;&#xB85C; &#xD30C;&#xC545;&#xD558;&#xB294; &#xAC8C; &#xD604;&#xC7AC;&#xC758; &#xD2B8;&#xB80C;&#xB4DC;&#xB97C; &#xB530;&#xB77C;&#xAC00;&#xB294; &#xAC83; &#xB9CC;&#xD07C;&#xC774;&#xB098; &#xC911;&#xC694;&#xD558;&#xB2E4;&#xB294; &#xAC83;&#xC744; &#xB2E4;&#xC2DC; &#xD55C; &#xBC88; &#xB290;&#xB07C;&#xBA74;&#xC11C;,  <del>&#xC774;&#xC81C; Windows Internals &#xC644;&#xB3C5;&#xC744; &#xB2E4;&#xC2DC; &#xC2DC;&#xB3C4;&#xD558;&#xB294; &#xAC78;&#xB85C;..</del></p>
<p>&#xB2E4;&#xC74C;&#xC5D0;&#xB3C4; &#xC7AC;&#xBC0C;&#xB294; &#xC5F0;&#xAD6C; &#xC8FC;&#xC81C; &#xB4E4;&#xACE0; &#xC624;&#xB3C4;&#xB85D; &#xD558;&#xACA0;&#xC2B5;&#xB2C8;&#xB2E4;~</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://support.microsoft.com/en-us/topic/kb4073119-windows-client-guidance-for-it-pros-to-protect-against-silicon-based-microarchitectural-and-speculative-execution-side-channel-vulnerabilities-35820a8a-ae13-1299-88cc-357f104f5b11">https://support.microsoft.com/en-us/topic/kb4073119-windows-client-guidance-for-it-pros-to-protect-against-silicon-based-microarchitectural-and-speculative-execution-side-channel-vulnerabilities-35820a8a-ae13-1299-88cc-357f104f5b11</a></p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-23825">https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-23825</a></p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.intel.com/content/www/us/en/developer/articles/technical/software-security-guidance/technical-documentation/cpuid-enumeration-and-architectural-msrs.html">https://www.intel.com/content/www/us/en/developer/articles/technical/software-security-guidance/technical-documentation/cpuid-enumeration-and-architectural-msrs.html</a></p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/amd64_x/cpu_vendors.htm">https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/amd64_x/cpu_vendors.htm</a></p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://support.microsoft.com/en-us/topic/kb4074629-understanding-speculationcontrol-powershell-script-output-fd70a80a-a63f-e539-cda5-5be4c9e67c04">https://support.microsoft.com/en-us/topic/kb4074629-understanding-speculationcontrol-powershell-script-output-fd70a80a-a63f-e539-cda5-5be4c9e67c04</a></p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.intel.com/content/www/us/en/content-details/782158/intel-64-and-ia-32-architectures-software-developer-s-manual-combined-volumes-1-2a-2b-2c-2d-3a-3b-3c-3d-and-4.html">https://www.intel.com/content/www/us/en/content-details/782158/intel-64-and-ia-32-architectures-software-developer-s-manual-combined-volumes-1-2a-2b-2c-2d-3a-3b-3c-3d-and-4.html</a></p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.vergiliusproject.com/kernels/x64/windows-11/24h2/_KPRCB">https://www.vergiliusproject.com/kernels/x64/windows-11/24h2/_KPRCB</a></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                <div class="post-meta mr-3">
                  <i class="iconfont icon-category"></i>
                  
                  <a class="hover-with-bg" href="/categories/Research/">Research</a>
                  
                </div>
                
                
                <div class="post-meta">
                  <i class="iconfont icon-tags"></i>
                  
                  <a class="hover-with-bg" href="/tags/bypass/">bypass</a>
                  
                  <a class="hover-with-bg" href="/tags/windows/">windows</a>
                  
                  <a class="hover-with-bg" href="/tags/L0ch/">L0ch</a>
                  
                  <a class="hover-with-bg" href="/tags/mitigation/">mitigation</a>
                  
                  <a class="hover-with-bg" href="/tags/exploit-techniques/">exploit techniques</a>
                  
                  <a class="hover-with-bg" href="/tags/KVAS/">KVAS</a>
                  
                </div>
                
              </div>

              <div class="post-metas mb-3">
                <a class="hover-with-bg" style="display: flex;" href="/author">
                  <div class="link-avatar-page">
                    <img src="/img/profile_L0ch.jpg" srcset="/img/loading.gif" alt="L0ch">
                  </div>

                  <div class="link-text">
                    <div class="link-title">L0ch</div>
                  </div>
                </a>
                <div class="link-text">
                  <div class="link-more">
                    <a href="/tags/L0ch">
                      Read more
                      <i class="iconfont icon-arrowdown"></i>
                    </a>
                  </div>
                </div>
              </div>

              <hr>
              <!--<script data-ad-client="ca-pub-3672652207808168" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>-->
              
              
              <div class="post-prevnext row">
                <article class="post-prev col-6">
                  
                  
                  <a href="/2025/08/10/l0ch/deep-dive-into-kva/en/">
                    <i class="iconfont icon-arrowleft"></i>
                    <span class="hidden-mobile">[Research] Deep Dive into KVA Shadow's Dynamic Activation Mechanism(En)</span>
                    <span class="visible-mobile">Previous</span>
                  </a>
                  
                </article>
                <article class="post-next col-6">
                  
                  
                  <a href="/2025/08/09/bekim/2025-08-09/">
                    <span class="hidden-mobile">[하루한줄] CVE-2025-48384: Git CLI의 임의 파일 쓰기 취약점</span>
                    <span class="visible-mobile">Next</span>
                    <i class="iconfont icon-arrowright"></i>
                  </a>
                  
                </article>
              </div>
              
            </div>
            
            <!-- Embed Section -->
            <div style="width: 100%; height: 210px; margin-bottom: 50px; overflow: hidden;">
              <iframe src="https://maily.so/hackyboiz/embed?src=embed" style="width: 100%; height: 100%; border: none;" frameborder="0"></iframe>
            </div>            

            
            <!-- Comments -->
            <article class="comments" id="comments">
              
              
  <div class="disqus" style="width:100%">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'https://hackyboiz.github.io/2025/08/10/l0ch/deep-dive-into-kva/ko/';
        this.page.identifier = '/2025/08/10/l0ch/deep-dive-into-kva/ko/';
      };
      function loadDisqus() {
        (function () {
          var d = document,
            s = d.createElement('script');
          s.src = '//' + 'hackyboiz' + '.disqus.com/embed.js';
          s.setAttribute('data-timestamp', new Date());
          (d.head || d.body).appendChild(s);
        })();
      }
      waitElementVisible('disqus_thread', loadDisqus);
    </script>
    <noscript>Please enable JavaScript to view the
      <a target="_blank" href="https://disqus.com/?ref_noscript" rel="external nofollow noopener noreferrer">comments powered by Disqus.</a>
    </noscript>
  </div>


            </article>
            
          </article>
        </div>
      </div>
    </div>
    
    <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
      <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div id="tocbot"></div>
</div>

    </div>
    
  </div>
</div>

<!-- Custom -->

    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="external nofollow noopener noreferrer"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="external nofollow noopener noreferrer">
        <span>Fluid</span></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script>
<script src="/js/debouncer.js"></script>
<script src="/js/main.js"></script>

<!-- Plugins -->


  
    <script src="/js/lazyload.js"></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script>
  <script src="/js/clipboard-use.js"></script>







  <script src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js"></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js"></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "[Research] Deep Dive into KVA Shadow's Dynamic Activation Mechanism(Ko)&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js"></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script src="/js/local-search.js"></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css">

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>





  

  
    <!-- MathJax -->
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        options: {
          renderActions: {
            findScript: [10, doc => {
              document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                const display = !!node.type.match(/; *mode=display/);
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                const text = document.createTextNode('');
                node.parentNode.replaceChild(text, node);
                math.start = { node: text, delim: '', n: 0 };
                math.end = { node: text, delim: '', n: 0 };
                doc.math.push(math);
              });
            }, '', false],
            insertedScript: [200, () => {
              document.querySelectorAll('mjx-container').forEach(node => {
                let target = node.parentNode;
                if (target.nodeName.toLowerCase() === 'li') {
                  target.parentNode.classList.add('has-jax');
                }
              });
            }, '', false]
          }
        }
      };
    </script>

    <script async src="https://cdn.staticfile.org/mathjax/3.0.5/es5/tex-svg.js"></script>

  













  

  
    <!-- Google Analytics -->
    <script defer>
      window.ga = window.ga || function () { (ga.q = ga.q || []).push(arguments) };
      ga.l = +new Date;
      ga('create', 'UA-177243668-2', 'auto');
      ga('send', 'pageview');
    </script>
    <script async src="https://www.google-analytics.com/analytics.js"></script>
  

  
    <!-- Google gtag.js -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-177243668-2"></script>
    <script defer>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-177243668-2');
    </script>
  

  

  

  





</body>
</html>
