

<!DOCTYPE html>
<html lang="ko-KR" data-default-color-scheme="&#34;auto&#34;">



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico">
  <link rel="icon" type="image/png" href="/img/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="&lt;p&gt;Hello! I&amp;#x2019;m newp1ayer48, the one in charge of the low-level at Hackyboiz! &amp;#x1F938;&amp;#x1F3FB;&amp;#x200D;&amp;#x2642;&amp;#xFE0F;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image01.jpg&#34; alt=&#34;image01.jpg&#34;&gt;&lt;/p&gt;
&lt;p&gt;There&amp;#x2019;s a language frequently used in embedded devices. It&amp;#x2019;s the Lua script!&lt;/p&gt;
&lt;p&gt;Embedded device manufacturers sometimes use customized versions of this Lua script. In such cases, decompiling the compiled Lua script often fails to produce proper results.&lt;/p&gt;
&lt;p&gt;So&amp;#x2026; for my analysis, I decided to improve and patch the decompilation tool myself. Feel free to check out the GitHub for the final patched tool first!&lt;/p&gt;
&lt;p&gt;Let&amp;#x2019;s cover everything from an explanation of Lua Script to how to decompile these custom Lua scripts!&lt;/p&gt;
&lt;h2 id=&#34;1-Lua-Script&#34;&gt;&lt;a href=&#34;#1-Lua-Script&#34; class=&#34;headerlink&#34; title=&#34;1. Lua Script&#34;&gt;&lt;/a&gt;1. Lua Script&lt;/h2&gt;&lt;p&gt;&lt;img src=&#34;image02.jpg&#34; alt=&#34;image02.jpg&#34;&gt;&lt;/p&gt;
&lt;p&gt;Lua is a scripting language developed by a team at the Pontifical Catholic University of Rio de Janeiro (PUC-Rio) in Brazil! (The language of the gods..?) It is known for being small and lightweight, and because it also allows for system control, it&amp;#x2019;s frequently used in embedded systems and game development. Thanks to its lightweight yet powerful scripting capabilities, it&amp;#x2019;s also useful for tools that operate at the protocol level, like developing Wireshark plugins or custom dissectors. The official website provides full documentation on installation and the usage of each library and function. Lua has versions from 5.1 to the current 5.4.&lt;/p&gt;
&lt;p&gt;Furthermore, it boasts excellent interoperability and extensibility with C/C++. Just like C/C++, Lua can be compiled to build files, which is why you can often find compiled Lua files inside devices or programs. The file extension is &lt;code&gt;.lua&lt;/code&gt; for script files and &lt;code&gt;.luac&lt;/code&gt; for compiled files. However, compiled files can also exist with a &lt;code&gt;.lua&lt;/code&gt; extension, so checking the file header is the most reliable method.&lt;/p&gt;
&lt;p&gt;From a security perspective, Lua can be a major vector for vulnerabilities. Functions like &lt;code&gt;os.execute()&lt;/code&gt; can be used to execute system commands, making Command Injection a common vulnerability. Memory Corruption and Overflow vulnerabilities also occur in the Stack and Heap, with corresponding &lt;a href=&#34;https://www.cvedetails.com/product/28436/LUA-LUA.html?vendor_id=13641&#34;&gt;CVEs&lt;/a&gt; being reported.&lt;/p&gt;
&lt;h3 id=&#34;1-1-OpenWrt-and-Luci&#34;&gt;&lt;a href=&#34;#1-1-OpenWrt-and-Luci&#34; class=&#34;headerlink&#34; title=&#34;1.1. OpenWrt and Luci&#34;&gt;&lt;/a&gt;1.1. OpenWrt and Luci&lt;/h3&gt;&lt;p&gt;&lt;img src=&#34;image03.png&#34; alt=&#34;image03.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;OpenWrt is a Linux distribution created for embedded devices, specifically routers. You can install the distribution via the &lt;a href=&#34;https://openwrt.org/&#34;&gt;official website&lt;/a&gt;, which also provides detailed information on routers built with OpenWrt. It&amp;#x2019;s an excellent site for gaining knowledge about embedded hacking! When analyzing routers during an embedded hacking project, you&amp;#x2019;ll frequently come across routers and firmware developed based on the OpenWrt project.&lt;/p&gt;
&lt;p&gt;Projects and firmware developed with OpenWrt often use Lua scripts. In particular, they frequently include Luci, which uses a modified Lua script to conveniently configure the web interface. They often use Lua version 5.1, so the Lua files you analyze will typically be version 5.1&lt;/p&gt;
&lt;h2 id=&#34;2-Lua-Decompiler-luadec&#34;&gt;&lt;a href=&#34;#2-Lua-Decompiler-luadec&#34; class=&#34;headerlink&#34; title=&#34;2. Lua Decompiler: luadec&#34;&gt;&lt;/a&gt;2. Lua Decompiler: luadec&lt;/h2&gt;&lt;p&gt;&lt;img src=&#34;image04.jpg&#34; alt=&#34;image04.jpg&#34;&gt;&lt;/p&gt;
&lt;p&gt;It can be difficult to view the source code of a compiled Lua file. In such cases, you can use a Lua decompiler to see the original source code. The most representative decompilers are the C-based luadec and the Java-based unluac. unluac is often praised for its good performance with versions 5.2 and higher. In this article, we will be targeting Lua 5.1 files, so we&amp;#x2019;ll proceed with decompilation using luadec.&lt;/p&gt;
&lt;p&gt;Stock luadec does not have the OpenWrt patches applied, so you need to apply the relevant patches for the decompilation to proceed smoothly. You can install luadec and apply the OpenWrt patch as shown below.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs bash&#34;&gt;sudo apt-get update
sudo apt-get install libncurses-dev libreadline-dev

git &lt;span class=&#34;hljs-built_in&#34;&gt;clone&lt;/span&gt; https://github.com/viruscamp/luadec
&lt;span class=&#34;hljs-built_in&#34;&gt;cd&lt;/span&gt; luadec
git submodule update --init lua-5.1
ref=master
patch_dir=patches.&lt;span class=&#34;hljs-variable&#34;&gt;$ref&lt;/span&gt;
mkdir &lt;span class=&#34;hljs-variable&#34;&gt;$patch_dir&lt;/span&gt; &amp;amp;&amp;amp; &lt;span class=&#34;hljs-built_in&#34;&gt;cd&lt;/span&gt; &lt;span class=&#34;hljs-variable&#34;&gt;$patch_dir&lt;/span&gt;
patchs=$(curl -sSL -H &lt;span class=&#34;hljs-string&#34;&gt;&amp;apos;Accept: application/vnd.github.v3+json&amp;apos;&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;apos;https://api.github.com/repos/openwrt/openwrt/contents/package/utils/lua/patches?ref=&amp;apos;&lt;/span&gt;&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;&lt;span class=&#34;hljs-variable&#34;&gt;$ref&lt;/span&gt;&amp;quot;&lt;/span&gt; |grep -oP &lt;span class=&#34;hljs-string&#34;&gt;&amp;apos;name\&amp;quot;\s*:\s*\&amp;quot;.*\.patch&amp;apos;&lt;/span&gt; |grep -oP &lt;span class=&#34;hljs-string&#34;&gt;&amp;apos;\d+.*\.patch&amp;apos;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;for&lt;/span&gt; p &lt;span class=&#34;hljs-keyword&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;hljs-variable&#34;&gt;$patchs&lt;/span&gt;;&lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt;  
wget &lt;span class=&#34;hljs-string&#34;&gt;&amp;apos;https://raw.githubusercontent.com/openwrt/openwrt/master/package/utils/lua/patches/&amp;apos;&lt;/span&gt;&lt;span class=&#34;hljs-variable&#34;&gt;${p}&lt;/span&gt;  -O &lt;span class=&#34;hljs-variable&#34;&gt;$p&lt;/span&gt;;
&lt;span class=&#34;hljs-keyword&#34;&gt;done&lt;/span&gt;

&lt;span class=&#34;hljs-built_in&#34;&gt;cd&lt;/span&gt; ../lua-5.1
&lt;span class=&#34;hljs-keyword&#34;&gt;for&lt;/span&gt; i &lt;span class=&#34;hljs-keyword&#34;&gt;in&lt;/span&gt; ../&lt;span class=&#34;hljs-variable&#34;&gt;${patch_dir}&lt;/span&gt;/*.patch; &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; patch -p1 &amp;lt;&lt;span class=&#34;hljs-variable&#34;&gt;$i&lt;/span&gt; ; &lt;span class=&#34;hljs-keyword&#34;&gt;done&lt;/span&gt;

MAKEFILE=&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;src/Makefile&amp;quot;&lt;/span&gt;
cp &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;&lt;span class=&#34;hljs-variable&#34;&gt;$MAKEFILE&lt;/span&gt;&amp;quot;&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;&lt;span class=&#34;hljs-variable&#34;&gt;$MAKEFILE&lt;/span&gt;.bak&amp;quot;&lt;/span&gt;
sed -i &lt;span class=&#34;hljs-string&#34;&gt;&amp;apos;/# USE_READLINE=1/a PKG_VERSION = 5.1.5&amp;apos;&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;&lt;span class=&#34;hljs-variable&#34;&gt;$MAKEFILE&lt;/span&gt;&amp;quot;&lt;/span&gt;
sed -i &lt;span class=&#34;hljs-string&#34;&gt;&amp;apos;s/CFLAGS= -O2 -Wall $(MYCFLAGS)/CFLAGS= -fPIC -O2 -Wall $(MYCFLAGS)/&amp;apos;&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;&lt;span class=&#34;hljs-variable&#34;&gt;$MAKEFILE&lt;/span&gt;&amp;quot;&lt;/span&gt;
sed -i &lt;span class=&#34;hljs-string&#34;&gt;&amp;apos;s/$(CC) -o $@ -L\. -llua $(MYLDFLAGS) $(LUA_O) $(LIBS)/$(CC) -o $@ $(LUA_O) $(MYLDFLAGS) -L. -llua $(LIBS)/&amp;apos;&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;&lt;span class=&#34;hljs-variable&#34;&gt;$MAKEFILE&lt;/span&gt;&amp;quot;&lt;/span&gt;
sed -i &lt;span class=&#34;hljs-string&#34;&gt;&amp;apos;s/$(CC) -o $@ -L\. -llua $(MYLDFLAGS) $(LUAC_O) $(LIBS)/$(CC) -o $@ $(LUAC_O) $(MYLDFLAGS) -L. -llua $(LIBS)/&amp;apos;&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;&lt;span class=&#34;hljs-variable&#34;&gt;$MAKEFILE&lt;/span&gt;&amp;quot;&lt;/span&gt;

&lt;span class=&#34;hljs-built_in&#34;&gt;cd&lt;/span&gt; src
make linux
&lt;span class=&#34;hljs-built_in&#34;&gt;export&lt;/span&gt; LD_LIBRARY_PATH=`&lt;span class=&#34;hljs-built_in&#34;&gt;pwd&lt;/span&gt;`/src/
&lt;span class=&#34;hljs-built_in&#34;&gt;cd&lt;/span&gt; ../../luadec
make LUAVER=5.1
sudo cp luadec /usr/&lt;span class=&#34;hljs-built_in&#34;&gt;local&lt;/span&gt;/bin/&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;After installation and patching, if you decompile the example file, you can see a part of the decompilation result as shown below.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs lua&#34;&gt;./luadec ./luaFile.lua&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code class=&#34;hljs lua&#34;&gt;&lt;span class=&#34;hljs-comment&#34;&gt;-- params : ...&lt;/span&gt;
&lt;span class=&#34;hljs-comment&#34;&gt;-- function num : 0&lt;/span&gt;
&lt;span class=&#34;hljs-built_in&#34;&gt;module&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.controller.login&amp;quot;&lt;/span&gt;, &lt;span class=&#34;hljs-built_in&#34;&gt;package&lt;/span&gt;.&lt;span class=&#34;hljs-built_in&#34;&gt;seeall&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_0 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.model.controller&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_1 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;nixio&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_2 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;nixio.fs&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_3 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.sys&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_4 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.util&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_5 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.tools.error&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_6 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.model.log&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_7 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.tools.debug&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_8 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.json&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_9 = (&lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.tools.datatypes&amp;quot;&lt;/span&gt;))
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_10 = &lt;span class=&#34;hljs-literal&#34;&gt;nil&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_11 = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/var/run/luci-attempts.lock&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_12 = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/tmp/luci-attempts&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_13 = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/tmp/TIME_STAMP&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_14 = Unknown_Type_Error
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_15 = Unknown_Type_Error
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_16 = Unknown_Type_Error
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_17 = Unknown_Type_Error
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_18 = Unknown_Type_Error
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_19 = Unknown_Type_Error
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_20 = Unknown_Type_Error
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_21 = Unknown_Type_Error
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_22 = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;users&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_23 = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;02008001&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_24 = Unknown_Type_Error
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_25 = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;02108001&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_31 = &lt;span class=&#34;hljs-function&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;function&lt;/span&gt;&lt;span class=&#34;hljs-params&#34;&gt;(l_1_0)&lt;/span&gt;&lt;/span&gt;

...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Looking at the decompilation result, you can see that there are variables or values that could not be interpreted.&lt;/p&gt;
&lt;p&gt;When parts are not interpreted like this, it can make analysis difficult.&lt;/p&gt;
&lt;h2 id=&#34;3-Decompiling-custom-lua-files-with-luadec&#34;&gt;&lt;a href=&#34;#3-Decompiling-custom-lua-files-with-luadec&#34; class=&#34;headerlink&#34; title=&#34;3. Decompiling custom lua files with luadec&#34;&gt;&lt;/a&gt;3. Decompiling custom lua files with luadec&lt;/h2&gt;&lt;p&gt;The decompilation errors that occur when decompiling the sample file with luadec can be summarized as follows:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Abnormal table initialization&lt;ul&gt;
&lt;li&gt;&lt;code&gt;SetList fails&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Abnormal table initialization&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Unknown_Type_Error&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Control flow analysis failure&lt;ul&gt;
&lt;li&gt;&lt;code&gt;cannot find blockend&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Among these, the source files responsible for the core decompilation functions in luadec are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;decompile.c&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;  This is the main source code that operates when luadec decompiles. The core logic for decompilation, such as interpreting the bytecode of the Lua file and handling variables and control flow, all exists within this file.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;proto.c&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;  This source code is responsible for interpreting constant values. It translates constant values stored in the bytecode, such as numbers, strings, and booleans, into text. It also plays a role in distributing arguments to the Opcodes.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Let&amp;#x2019;s look at the analysis I conducted and the luadec patching methods I used to solve the decompilation errors mentioned above!&lt;/p&gt;
&lt;h3 id=&#34;3-1-Lua-File-Analysis&#34;&gt;&lt;a href=&#34;#3-1-Lua-File-Analysis&#34; class=&#34;headerlink&#34; title=&#34;3.1. Lua File Analysis&#34;&gt;&lt;/a&gt;3.1. Lua File Analysis&lt;/h3&gt;&lt;p&gt;&lt;img src=&#34;image05.png&#34; alt=&#34;image05.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;The structure of a Lua file is as shown in the picture above, taken from &lt;a href=&#34;https://ieeexplore.ieee.org/document/10163061&#34;&gt;this paper&lt;/a&gt;. It consists of a file header, a function header, code, and a constants table. Using this structure, you can compare the file&amp;#x2019;s hex information to check its contents.&lt;/p&gt;
&lt;p&gt;First, to check the version information, I examined the header. The Lua file header information can be seen in the image below.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image06.png&#34; alt=&#34;image06.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;Checking the header information of the sample Lua file confirms that it is Lua version 5.1.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image07.png&#34; alt=&#34;image07.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;Through the code and constant table sections identifiable from the file structure, you can directly check the Opcodes and constants.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs bash&#34;&gt;$ luac -l ./luafile.lua
...
2 [-]: CALL      R0 2 2       ; R0 := R0(R1)
...

$ xxd ./luaFile.lua
...
00000000: 1b4c 7561 5100 0104 0404 0804 0000 0000
...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Instructions are stored in 4-byte little-endian format. By substituting the offset location as &lt;code&gt;$pc * 4&lt;/code&gt;, you can find the corresponding hex value and map it to interpret the instruction. This way, you can identify the opcode and instruction.&lt;/p&gt;
&lt;p&gt;Using this method or by examining the luadec errors discussed later, you can confirm the existence of custom elements or parts that differ from a standard Lua file.&lt;/p&gt;
&lt;h3 id=&#34;3-2-Abnormal-table-initialization&#34;&gt;&lt;a href=&#34;#3-2-Abnormal-table-initialization&#34; class=&#34;headerlink&#34; title=&#34;3.2. Abnormal table initialization&#34;&gt;&lt;/a&gt;3.2. Abnormal table initialization&lt;/h3&gt;&lt;p&gt;This error, which appears with the message &lt;code&gt;SetList fails&lt;/code&gt;, is caused by an abnormal table initialization in &lt;code&gt;SetList&lt;/code&gt;. This problem occurs when the &lt;code&gt;SETLIST&lt;/code&gt; instruction tries to fill a table starting from index 0, which is different from the Lua standard.&lt;/p&gt;
&lt;p&gt;This can be confirmed in the &lt;code&gt;SetList()&lt;/code&gt; function within the original &lt;code&gt;decompile.c&lt;/code&gt; source code of luadec.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs c&#34;&gt;&lt;span class=&#34;hljs-comment&#34;&gt;// decompile.c&lt;/span&gt;

&lt;span class=&#34;hljs-function&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;hljs-title&#34;&gt;SetList&lt;/span&gt;&lt;span class=&#34;hljs-params&#34;&gt;(Function* F, &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; a, &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; b, &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; c)&lt;/span&gt; &lt;/span&gt;{
	&lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; i;
	DecTable* tbl = (DecTable*)FindFromListTail(&amp;amp;(F-&amp;gt;tables), (ListItemCmpFn)MatchTable, &amp;amp;a);
	&lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; (tbl == &lt;span class=&#34;hljs-literal&#34;&gt;NULL&lt;/span&gt;) {
		&lt;span class=&#34;hljs-built_in&#34;&gt;sprintf&lt;/span&gt;(errortmp, &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;No list found for R%d , SetList fails&amp;quot;&lt;/span&gt;, a);
		SET_ERROR(F, errortmp);
		&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt;;
	}
	&lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; (b == &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;) {
		&lt;span class=&#34;hljs-keyword&#34;&gt;const&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;* rstr;
		i = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;
		&lt;span class=&#34;hljs-keyword&#34;&gt;while&lt;/span&gt; (&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;) {
			rstr = GetR(F, a + i);
			&lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; (error)
				&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt;;
			&lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;hljs-built_in&#34;&gt;strcmp&lt;/span&gt;(rstr,&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;.end&amp;quot;&lt;/span&gt;) == &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;)
				&lt;span class=&#34;hljs-keyword&#34;&gt;break&lt;/span&gt;;
			AddToTable(F, tbl, rstr, &lt;span class=&#34;hljs-literal&#34;&gt;NULL&lt;/span&gt;); &lt;span class=&#34;hljs-comment&#34;&gt;// Lua5.1 specific &lt;span class=&#34;hljs-doctag&#34;&gt;TODO:&lt;/span&gt; it&amp;apos;s not really this :(&lt;/span&gt;
			i++;
		};
	} &lt;span class=&#34;hljs-comment&#34;&gt;//should be {...} or func(func()) ,when b == 0, that will use all avaliable reg from R(a)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This function handles the &lt;code&gt;SETLIST&lt;/code&gt; opcode but completely ignores the &lt;code&gt;c&lt;/code&gt; argument, which determines the starting index of the table. In Lua 5.1, the starting index of a table is calculated by the formula &lt;code&gt;(c-1) * LFIELDS_PER_FLUSH&lt;/code&gt; (where &lt;code&gt;LFIELDS_PER_FLUSH&lt;/code&gt; is usually 50).&lt;/p&gt;
&lt;p&gt;As seen in the bytecode of the sample file, when &lt;code&gt;c&lt;/code&gt; is 1, the starting index becomes 0. However, the code above does not perform this calculation, breaking the decompilation logic. To fix this, I modified the &lt;code&gt;SetList&lt;/code&gt; function to correctly calculate the starting index using the &lt;code&gt;c&lt;/code&gt; argument.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs c&#34;&gt;&lt;span class=&#34;hljs-comment&#34;&gt;// decompile.c&lt;/span&gt;

&lt;span class=&#34;hljs-function&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;hljs-title&#34;&gt;SetList&lt;/span&gt;&lt;span class=&#34;hljs-params&#34;&gt;(Function* F, &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; a, &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; b, &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; c)&lt;/span&gt; &lt;/span&gt;{
	&lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; i;
	DecTable* tbl = (DecTable*)FindFromListTail(&amp;amp;(F-&amp;gt;tables), (ListItemCmpFn)MatchTable, &amp;amp;a);
	&lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; (tbl == &lt;span class=&#34;hljs-literal&#34;&gt;NULL&lt;/span&gt;) {
		&lt;span class=&#34;hljs-built_in&#34;&gt;sprintf&lt;/span&gt;(errortmp, &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;No list found for R%d , SetList fails&amp;quot;&lt;/span&gt;, a);
		SET_ERROR(F, errortmp);
		&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt;;
	}

	&lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; start_index = (c - &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;) * LFIELDS_PER_FLUSH;

	&lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; (b == &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;) {
		&lt;span class=&#34;hljs-keyword&#34;&gt;const&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;* rstr;
		i = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;
		&lt;span class=&#34;hljs-keyword&#34;&gt;while&lt;/span&gt; (&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;) {
			rstr = GetR(F, a + i);
			&lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; (error)
				&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt;;
			&lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;hljs-built_in&#34;&gt;strcmp&lt;/span&gt;(rstr,&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;.end&amp;quot;&lt;/span&gt;) == &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;)
				&lt;span class=&#34;hljs-keyword&#34;&gt;break&lt;/span&gt;;
			AddToTable(F, tbl, rstr, &lt;span class=&#34;hljs-literal&#34;&gt;NULL&lt;/span&gt;); &lt;span class=&#34;hljs-comment&#34;&gt;// Lua5.1 specific &lt;span class=&#34;hljs-doctag&#34;&gt;TODO:&lt;/span&gt; it&amp;apos;s not really this :(&lt;/span&gt;
			i++;
		};
	} &lt;span class=&#34;hljs-comment&#34;&gt;//should be {...} or func(func()) ,when b == 0, that will use all avaliable reg from R(a)&lt;/span&gt;

	&lt;span class=&#34;hljs-keyword&#34;&gt;for&lt;/span&gt; (i = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;; i &amp;lt;= b; i++) {
		&lt;span class=&#34;hljs-keyword&#34;&gt;const&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;* rstr = GetR(F, a + i);
		&lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; (error)
			&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt;;
		AddToTable(F, tbl, rstr, start_index + i); &lt;span class=&#34;hljs-comment&#34;&gt;// Lua5.1 specific &lt;span class=&#34;hljs-doctag&#34;&gt;TODO:&lt;/span&gt; it&amp;apos;s not really this :(&lt;/span&gt;
	}
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Patching it this way solves the &lt;code&gt;SetList&lt;/code&gt; fails error!&lt;/p&gt;
&lt;h3 id=&#34;3-3-Unknown-Constant-Data-Type&#34;&gt;&lt;a href=&#34;#3-3-Unknown-Constant-Data-Type&#34; class=&#34;headerlink&#34; title=&#34;3.3. Unknown Constant Data Type&#34;&gt;&lt;/a&gt;3.3. Unknown Constant Data Type&lt;/h3&gt;&lt;p&gt;This error, which can be seen in local variables with the message &lt;code&gt;Unknown_Type_Error&lt;/code&gt;, is caused by a constant. The problem arises because a specific constant type included in the bytecode is not a standard constant type, and therefore, the decompiler fails to recognize it.&lt;/p&gt;
&lt;p&gt;This can be checked in &lt;code&gt;proto.c&lt;/code&gt;, which is responsible for interpreting constant values.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs c&#34;&gt;&lt;span class=&#34;hljs-comment&#34;&gt;// proto.c&lt;/span&gt;

...
&lt;span class=&#34;hljs-function&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;* &lt;span class=&#34;hljs-title&#34;&gt;DecompileConstant&lt;/span&gt;&lt;span class=&#34;hljs-params&#34;&gt;(&lt;span class=&#34;hljs-keyword&#34;&gt;const&lt;/span&gt; Proto* f, &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; i)&lt;/span&gt; &lt;/span&gt;{
	&lt;span class=&#34;hljs-keyword&#34;&gt;const&lt;/span&gt; TValue* o = &amp;amp;f-&amp;gt;k[i];
	&lt;span class=&#34;hljs-keyword&#34;&gt;switch&lt;/span&gt; (ttype(o)) {
	&lt;span class=&#34;hljs-keyword&#34;&gt;case&lt;/span&gt; LUA_TBOOLEAN:
		&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; strdup(bvalue(o)?&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;true&amp;quot;&lt;/span&gt;:&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;false&amp;quot;&lt;/span&gt;);
	&lt;span class=&#34;hljs-keyword&#34;&gt;case&lt;/span&gt; LUA_TNIL:
		&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; strdup(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;nil&amp;quot;&lt;/span&gt;);
&lt;span class=&#34;hljs-meta&#34;&gt;#&lt;span class=&#34;hljs-meta-keyword&#34;&gt;if&lt;/span&gt; LUA_VERSION_NUM == 501 || LUA_VERSION_NUM == 502&lt;/span&gt;
	&lt;span class=&#34;hljs-keyword&#34;&gt;case&lt;/span&gt; LUA_TNUMBER:
	{
		&lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;* ret = (&lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;*)&lt;span class=&#34;hljs-built_in&#34;&gt;calloc&lt;/span&gt;(&lt;span class=&#34;hljs-number&#34;&gt;128&lt;/span&gt;, &lt;span class=&#34;hljs-keyword&#34;&gt;sizeof&lt;/span&gt;(&lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;));
		&lt;span class=&#34;hljs-built_in&#34;&gt;sprintf&lt;/span&gt;(ret, LUA_NUMBER_FMT, nvalue(o));
		&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; ret;
	}
...

...
	&lt;span class=&#34;hljs-keyword&#34;&gt;default&lt;/span&gt;:
		&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; strdup(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Unknown_Type_Error&amp;quot;&lt;/span&gt;);
	}
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The code flows to the appropriate branch for the constant type through &lt;code&gt;switch (ttype(o))&lt;/code&gt;. To identify the value of the constant type causing the &lt;code&gt;Unknown_Type_Error&lt;/code&gt;, I modified the code as shown below and checked the result.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs c&#34;&gt;	&lt;span class=&#34;hljs-keyword&#34;&gt;default&lt;/span&gt;:
		&lt;span class=&#34;hljs-built_in&#34;&gt;printf&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;DEBUG: Found unknown constant type: %d\n&amp;quot;&lt;/span&gt;, ttype(o));
		&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; strdup(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Unknown_Type_Error&amp;quot;&lt;/span&gt;);
	}
}&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code class=&#34;hljs lua&#34;&gt;DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Checking the result above, we can see that the sample file uses a type of 9. The standard constant types for Lua 5.1 range from 0 to 8.&lt;/p&gt;
&lt;div class=&#34;table-container&#34;&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Number&lt;/th&gt;
&lt;th&gt;Type Macro&lt;/th&gt;
&lt;th&gt;Description&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;td&gt;&lt;code&gt;LUA_TNIL&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;nil&lt;/code&gt; value&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;&lt;code&gt;LUA_TBOOLEAN&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;true&lt;/code&gt; or &lt;code&gt;false&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;&lt;code&gt;LUA_TLIGHTUSERDATA&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;small user data&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;&lt;code&gt;LUA_TNUMBER&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;number (No distinction integer/float)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;&lt;code&gt;LUA_TSTRING&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;strings&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;5&lt;/td&gt;
&lt;td&gt;&lt;code&gt;LUA_TTABLE&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;table&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;6&lt;/td&gt;
&lt;td&gt;&lt;code&gt;LUA_TFUNCTION&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;function (closer)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;7&lt;/td&gt;
&lt;td&gt;&lt;code&gt;LUA_TUSERDATA&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;all user data&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;8&lt;/td&gt;
&lt;td&gt;&lt;code&gt;LUA_TTHREAD&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;thread (coroutine)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;p&gt;From this, we can confirm that the sample file uses a custom constant type with a value of 9, and the error occurs because it cannot be recognized. By looking at the disassembly where this constant type is used, we can see it&amp;#x2019;s being used like an integer.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs bash&#34;&gt;$ luadec -dis ./luaFile.lua
19 [-]: SUB R6 R6 K10 ; R6 := R6 - Unknown_Type_Error&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;To solve this, I modified the code by adding a &lt;code&gt;case&lt;/code&gt; statement to handle the custom constant type 9 as an integer.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs c&#34;&gt;&lt;span class=&#34;hljs-function&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;* &lt;span class=&#34;hljs-title&#34;&gt;DecompileConstant&lt;/span&gt;&lt;span class=&#34;hljs-params&#34;&gt;(&lt;span class=&#34;hljs-keyword&#34;&gt;const&lt;/span&gt; Proto* f, &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; i)&lt;/span&gt; &lt;/span&gt;{
	&lt;span class=&#34;hljs-keyword&#34;&gt;const&lt;/span&gt; TValue* o = &amp;amp;f-&amp;gt;k[i];
	&lt;span class=&#34;hljs-keyword&#34;&gt;switch&lt;/span&gt; (ttype(o)) {
	&lt;span class=&#34;hljs-keyword&#34;&gt;case&lt;/span&gt; LUA_TBOOLEAN:
		&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; strdup(bvalue(o)?&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;true&amp;quot;&lt;/span&gt;:&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;false&amp;quot;&lt;/span&gt;);
	&lt;span class=&#34;hljs-keyword&#34;&gt;case&lt;/span&gt; LUA_TNIL:
		&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; strdup(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;nil&amp;quot;&lt;/span&gt;);
&lt;span class=&#34;hljs-meta&#34;&gt;#&lt;span class=&#34;hljs-meta-keyword&#34;&gt;if&lt;/span&gt; LUA_VERSION_NUM == 501 || LUA_VERSION_NUM == 502&lt;/span&gt;
	&lt;span class=&#34;hljs-keyword&#34;&gt;case&lt;/span&gt; LUA_TNUMBER:
	{
		&lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;* ret = (&lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;*)&lt;span class=&#34;hljs-built_in&#34;&gt;calloc&lt;/span&gt;(&lt;span class=&#34;hljs-number&#34;&gt;128&lt;/span&gt;, &lt;span class=&#34;hljs-keyword&#34;&gt;sizeof&lt;/span&gt;(&lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;));
		&lt;span class=&#34;hljs-built_in&#34;&gt;sprintf&lt;/span&gt;(ret, LUA_NUMBER_FMT, nvalue(o));
		&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; ret;
	}
	&lt;span class=&#34;hljs-keyword&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;:
  {
      &lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;* ret = (&lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;*)&lt;span class=&#34;hljs-built_in&#34;&gt;calloc&lt;/span&gt;(&lt;span class=&#34;hljs-number&#34;&gt;128&lt;/span&gt;, &lt;span class=&#34;hljs-keyword&#34;&gt;sizeof&lt;/span&gt;(&lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;));
      &lt;span class=&#34;hljs-built_in&#34;&gt;sprintf&lt;/span&gt;(ret, LUA_INTEGER_FMT, ivalue(o)); 
      &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; ret;
  }
	&lt;span class=&#34;hljs-keyword&#34;&gt;case&lt;/span&gt; LUA_TSTRING:&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;After modifying the code to print the value as an integer, you can see that the error is resolved as shown below.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs lua&#34;&gt;&lt;span class=&#34;hljs-comment&#34;&gt;-- params : ...&lt;/span&gt;
&lt;span class=&#34;hljs-comment&#34;&gt;-- function num : 0&lt;/span&gt;
&lt;span class=&#34;hljs-built_in&#34;&gt;module&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.controller.login&amp;quot;&lt;/span&gt;, &lt;span class=&#34;hljs-built_in&#34;&gt;package&lt;/span&gt;.&lt;span class=&#34;hljs-built_in&#34;&gt;seeall&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_0 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.model.controller&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_1 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;nixio&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_2 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;nixio.fs&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_3 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.sys&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_4 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.util&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_5 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.tools.error&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_6 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.model.log&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_7 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.tools.debug&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_8 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.json&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_9 = (&lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.tools.datatypes&amp;quot;&lt;/span&gt;))
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_10 = &lt;span class=&#34;hljs-literal&#34;&gt;nil&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_11 = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/var/run/luci-attempts.lock&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_12 = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/tmp/luci-attempts&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_13 = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/tmp/TIME_STAMP&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_14 = &lt;span class=&#34;hljs-number&#34;&gt;7200&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_15 = &lt;span class=&#34;hljs-number&#34;&gt;10&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_16 = &lt;span class=&#34;hljs-number&#34;&gt;88&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_17 = &lt;span class=&#34;hljs-number&#34;&gt;14201&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_18 = &lt;span class=&#34;hljs-number&#34;&gt;14203&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_19 = &lt;span class=&#34;hljs-number&#34;&gt;24&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_20 = &lt;span class=&#34;hljs-number&#34;&gt;13242&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_21 = &lt;span class=&#34;hljs-number&#34;&gt;13243&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_22 = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;users&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_23 = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;02008001&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_24 = &lt;span class=&#34;hljs-number&#34;&gt;4&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_25 = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;02108001&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_31 = &lt;span class=&#34;hljs-function&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;function&lt;/span&gt;&lt;span class=&#34;hljs-params&#34;&gt;(l_1_0)&lt;/span&gt;&lt;/span&gt;
...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This allows us to interpret all the parts that were using uninterpreted variables.&lt;/p&gt;
&lt;p&gt;The patched luadec tool can be found at the GitHub repository below!&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/newp1ayer48/luadec-patched&#34;&gt;https://github.com/newp1ayer48/luadec-patched&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;You can install and use it as follows.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs bash&#34;&gt;git &lt;span class=&#34;hljs-built_in&#34;&gt;clone&lt;/span&gt; https://github.com/newp1ayer48/luadec-patched.git
&lt;span class=&#34;hljs-built_in&#34;&gt;cd&lt;/span&gt; ./luadec-patched/luadec
chmod +x ./luadec
./luadec luaFile/lua&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The control flow analysis failure error is scheduled to be patched in the future. I plan to continue patching for custom Lua scripts from other products, devices, and environments as I encounter them.&lt;/p&gt;
&lt;p&gt;When I first started analyzing the custom Lua, I felt quite lost. But as I analyzed the file and patched the tool, more and more parts became interpretable, which was very satisfying! I hope this article and the tool I patched can be helpful to others who are analyzing Lua files!&lt;/p&gt;
&lt;p&gt;I&amp;#x2019;ll be back with another embedded topic next time! Thanks for reading! &amp;#x1F44B;&amp;#x1F3FB;&lt;/p&gt;
 - hack &amp; life">
  <meta name="author" content="j0dev, y2sman">
  <meta name="keywords" content>
  <meta name="google-site-verification" content="DXkyiaX95-ws53Tyt0m91_umRf4gfV2qJIQZ5zQDIO4">
  <meta name="naver-site-verification" content="0b4fea742ed293b82621684e466d9f26c3ccee06">


  <meta property="og:type" content="website"> 
  <meta property="og:title" content="[Research] Custom Lua Script  Decompile (EN) - hackyboiz">
  <meta property="og:description" content="&lt;p&gt;Hello! I&amp;#x2019;m newp1ayer48, the one in charge of the low-level at Hackyboiz! &amp;#x1F938;&amp;#x1F3FB;&amp;#x200D;&amp;#x2642;&amp;#xFE0F;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image01.jpg&#34; alt=&#34;image01.jpg&#34;&gt;&lt;/p&gt;
&lt;p&gt;There&amp;#x2019;s a language frequently used in embedded devices. It&amp;#x2019;s the Lua script!&lt;/p&gt;
&lt;p&gt;Embedded device manufacturers sometimes use customized versions of this Lua script. In such cases, decompiling the compiled Lua script often fails to produce proper results.&lt;/p&gt;
&lt;p&gt;So&amp;#x2026; for my analysis, I decided to improve and patch the decompilation tool myself. Feel free to check out the GitHub for the final patched tool first!&lt;/p&gt;
&lt;p&gt;Let&amp;#x2019;s cover everything from an explanation of Lua Script to how to decompile these custom Lua scripts!&lt;/p&gt;
&lt;h2 id=&#34;1-Lua-Script&#34;&gt;&lt;a href=&#34;#1-Lua-Script&#34; class=&#34;headerlink&#34; title=&#34;1. Lua Script&#34;&gt;&lt;/a&gt;1. Lua Script&lt;/h2&gt;&lt;p&gt;&lt;img src=&#34;image02.jpg&#34; alt=&#34;image02.jpg&#34;&gt;&lt;/p&gt;
&lt;p&gt;Lua is a scripting language developed by a team at the Pontifical Catholic University of Rio de Janeiro (PUC-Rio) in Brazil! (The language of the gods..?) It is known for being small and lightweight, and because it also allows for system control, it&amp;#x2019;s frequently used in embedded systems and game development. Thanks to its lightweight yet powerful scripting capabilities, it&amp;#x2019;s also useful for tools that operate at the protocol level, like developing Wireshark plugins or custom dissectors. The official website provides full documentation on installation and the usage of each library and function. Lua has versions from 5.1 to the current 5.4.&lt;/p&gt;
&lt;p&gt;Furthermore, it boasts excellent interoperability and extensibility with C/C++. Just like C/C++, Lua can be compiled to build files, which is why you can often find compiled Lua files inside devices or programs. The file extension is &lt;code&gt;.lua&lt;/code&gt; for script files and &lt;code&gt;.luac&lt;/code&gt; for compiled files. However, compiled files can also exist with a &lt;code&gt;.lua&lt;/code&gt; extension, so checking the file header is the most reliable method.&lt;/p&gt;
&lt;p&gt;From a security perspective, Lua can be a major vector for vulnerabilities. Functions like &lt;code&gt;os.execute()&lt;/code&gt; can be used to execute system commands, making Command Injection a common vulnerability. Memory Corruption and Overflow vulnerabilities also occur in the Stack and Heap, with corresponding &lt;a href=&#34;https://www.cvedetails.com/product/28436/LUA-LUA.html?vendor_id=13641&#34;&gt;CVEs&lt;/a&gt; being reported.&lt;/p&gt;
&lt;h3 id=&#34;1-1-OpenWrt-and-Luci&#34;&gt;&lt;a href=&#34;#1-1-OpenWrt-and-Luci&#34; class=&#34;headerlink&#34; title=&#34;1.1. OpenWrt and Luci&#34;&gt;&lt;/a&gt;1.1. OpenWrt and Luci&lt;/h3&gt;&lt;p&gt;&lt;img src=&#34;image03.png&#34; alt=&#34;image03.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;OpenWrt is a Linux distribution created for embedded devices, specifically routers. You can install the distribution via the &lt;a href=&#34;https://openwrt.org/&#34;&gt;official website&lt;/a&gt;, which also provides detailed information on routers built with OpenWrt. It&amp;#x2019;s an excellent site for gaining knowledge about embedded hacking! When analyzing routers during an embedded hacking project, you&amp;#x2019;ll frequently come across routers and firmware developed based on the OpenWrt project.&lt;/p&gt;
&lt;p&gt;Projects and firmware developed with OpenWrt often use Lua scripts. In particular, they frequently include Luci, which uses a modified Lua script to conveniently configure the web interface. They often use Lua version 5.1, so the Lua files you analyze will typically be version 5.1&lt;/p&gt;
&lt;h2 id=&#34;2-Lua-Decompiler-luadec&#34;&gt;&lt;a href=&#34;#2-Lua-Decompiler-luadec&#34; class=&#34;headerlink&#34; title=&#34;2. Lua Decompiler: luadec&#34;&gt;&lt;/a&gt;2. Lua Decompiler: luadec&lt;/h2&gt;&lt;p&gt;&lt;img src=&#34;image04.jpg&#34; alt=&#34;image04.jpg&#34;&gt;&lt;/p&gt;
&lt;p&gt;It can be difficult to view the source code of a compiled Lua file. In such cases, you can use a Lua decompiler to see the original source code. The most representative decompilers are the C-based luadec and the Java-based unluac. unluac is often praised for its good performance with versions 5.2 and higher. In this article, we will be targeting Lua 5.1 files, so we&amp;#x2019;ll proceed with decompilation using luadec.&lt;/p&gt;
&lt;p&gt;Stock luadec does not have the OpenWrt patches applied, so you need to apply the relevant patches for the decompilation to proceed smoothly. You can install luadec and apply the OpenWrt patch as shown below.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs bash&#34;&gt;sudo apt-get update
sudo apt-get install libncurses-dev libreadline-dev

git &lt;span class=&#34;hljs-built_in&#34;&gt;clone&lt;/span&gt; https://github.com/viruscamp/luadec
&lt;span class=&#34;hljs-built_in&#34;&gt;cd&lt;/span&gt; luadec
git submodule update --init lua-5.1
ref=master
patch_dir=patches.&lt;span class=&#34;hljs-variable&#34;&gt;$ref&lt;/span&gt;
mkdir &lt;span class=&#34;hljs-variable&#34;&gt;$patch_dir&lt;/span&gt; &amp;amp;&amp;amp; &lt;span class=&#34;hljs-built_in&#34;&gt;cd&lt;/span&gt; &lt;span class=&#34;hljs-variable&#34;&gt;$patch_dir&lt;/span&gt;
patchs=$(curl -sSL -H &lt;span class=&#34;hljs-string&#34;&gt;&amp;apos;Accept: application/vnd.github.v3+json&amp;apos;&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;apos;https://api.github.com/repos/openwrt/openwrt/contents/package/utils/lua/patches?ref=&amp;apos;&lt;/span&gt;&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;&lt;span class=&#34;hljs-variable&#34;&gt;$ref&lt;/span&gt;&amp;quot;&lt;/span&gt; |grep -oP &lt;span class=&#34;hljs-string&#34;&gt;&amp;apos;name\&amp;quot;\s*:\s*\&amp;quot;.*\.patch&amp;apos;&lt;/span&gt; |grep -oP &lt;span class=&#34;hljs-string&#34;&gt;&amp;apos;\d+.*\.patch&amp;apos;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;for&lt;/span&gt; p &lt;span class=&#34;hljs-keyword&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;hljs-variable&#34;&gt;$patchs&lt;/span&gt;;&lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt;  
wget &lt;span class=&#34;hljs-string&#34;&gt;&amp;apos;https://raw.githubusercontent.com/openwrt/openwrt/master/package/utils/lua/patches/&amp;apos;&lt;/span&gt;&lt;span class=&#34;hljs-variable&#34;&gt;${p}&lt;/span&gt;  -O &lt;span class=&#34;hljs-variable&#34;&gt;$p&lt;/span&gt;;
&lt;span class=&#34;hljs-keyword&#34;&gt;done&lt;/span&gt;

&lt;span class=&#34;hljs-built_in&#34;&gt;cd&lt;/span&gt; ../lua-5.1
&lt;span class=&#34;hljs-keyword&#34;&gt;for&lt;/span&gt; i &lt;span class=&#34;hljs-keyword&#34;&gt;in&lt;/span&gt; ../&lt;span class=&#34;hljs-variable&#34;&gt;${patch_dir}&lt;/span&gt;/*.patch; &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; patch -p1 &amp;lt;&lt;span class=&#34;hljs-variable&#34;&gt;$i&lt;/span&gt; ; &lt;span class=&#34;hljs-keyword&#34;&gt;done&lt;/span&gt;

MAKEFILE=&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;src/Makefile&amp;quot;&lt;/span&gt;
cp &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;&lt;span class=&#34;hljs-variable&#34;&gt;$MAKEFILE&lt;/span&gt;&amp;quot;&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;&lt;span class=&#34;hljs-variable&#34;&gt;$MAKEFILE&lt;/span&gt;.bak&amp;quot;&lt;/span&gt;
sed -i &lt;span class=&#34;hljs-string&#34;&gt;&amp;apos;/# USE_READLINE=1/a PKG_VERSION = 5.1.5&amp;apos;&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;&lt;span class=&#34;hljs-variable&#34;&gt;$MAKEFILE&lt;/span&gt;&amp;quot;&lt;/span&gt;
sed -i &lt;span class=&#34;hljs-string&#34;&gt;&amp;apos;s/CFLAGS= -O2 -Wall $(MYCFLAGS)/CFLAGS= -fPIC -O2 -Wall $(MYCFLAGS)/&amp;apos;&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;&lt;span class=&#34;hljs-variable&#34;&gt;$MAKEFILE&lt;/span&gt;&amp;quot;&lt;/span&gt;
sed -i &lt;span class=&#34;hljs-string&#34;&gt;&amp;apos;s/$(CC) -o $@ -L\. -llua $(MYLDFLAGS) $(LUA_O) $(LIBS)/$(CC) -o $@ $(LUA_O) $(MYLDFLAGS) -L. -llua $(LIBS)/&amp;apos;&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;&lt;span class=&#34;hljs-variable&#34;&gt;$MAKEFILE&lt;/span&gt;&amp;quot;&lt;/span&gt;
sed -i &lt;span class=&#34;hljs-string&#34;&gt;&amp;apos;s/$(CC) -o $@ -L\. -llua $(MYLDFLAGS) $(LUAC_O) $(LIBS)/$(CC) -o $@ $(LUAC_O) $(MYLDFLAGS) -L. -llua $(LIBS)/&amp;apos;&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;&lt;span class=&#34;hljs-variable&#34;&gt;$MAKEFILE&lt;/span&gt;&amp;quot;&lt;/span&gt;

&lt;span class=&#34;hljs-built_in&#34;&gt;cd&lt;/span&gt; src
make linux
&lt;span class=&#34;hljs-built_in&#34;&gt;export&lt;/span&gt; LD_LIBRARY_PATH=`&lt;span class=&#34;hljs-built_in&#34;&gt;pwd&lt;/span&gt;`/src/
&lt;span class=&#34;hljs-built_in&#34;&gt;cd&lt;/span&gt; ../../luadec
make LUAVER=5.1
sudo cp luadec /usr/&lt;span class=&#34;hljs-built_in&#34;&gt;local&lt;/span&gt;/bin/&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;After installation and patching, if you decompile the example file, you can see a part of the decompilation result as shown below.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs lua&#34;&gt;./luadec ./luaFile.lua&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code class=&#34;hljs lua&#34;&gt;&lt;span class=&#34;hljs-comment&#34;&gt;-- params : ...&lt;/span&gt;
&lt;span class=&#34;hljs-comment&#34;&gt;-- function num : 0&lt;/span&gt;
&lt;span class=&#34;hljs-built_in&#34;&gt;module&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.controller.login&amp;quot;&lt;/span&gt;, &lt;span class=&#34;hljs-built_in&#34;&gt;package&lt;/span&gt;.&lt;span class=&#34;hljs-built_in&#34;&gt;seeall&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_0 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.model.controller&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_1 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;nixio&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_2 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;nixio.fs&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_3 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.sys&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_4 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.util&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_5 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.tools.error&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_6 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.model.log&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_7 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.tools.debug&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_8 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.json&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_9 = (&lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.tools.datatypes&amp;quot;&lt;/span&gt;))
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_10 = &lt;span class=&#34;hljs-literal&#34;&gt;nil&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_11 = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/var/run/luci-attempts.lock&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_12 = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/tmp/luci-attempts&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_13 = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/tmp/TIME_STAMP&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_14 = Unknown_Type_Error
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_15 = Unknown_Type_Error
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_16 = Unknown_Type_Error
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_17 = Unknown_Type_Error
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_18 = Unknown_Type_Error
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_19 = Unknown_Type_Error
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_20 = Unknown_Type_Error
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_21 = Unknown_Type_Error
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_22 = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;users&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_23 = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;02008001&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_24 = Unknown_Type_Error
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_25 = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;02108001&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_31 = &lt;span class=&#34;hljs-function&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;function&lt;/span&gt;&lt;span class=&#34;hljs-params&#34;&gt;(l_1_0)&lt;/span&gt;&lt;/span&gt;

...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Looking at the decompilation result, you can see that there are variables or values that could not be interpreted.&lt;/p&gt;
&lt;p&gt;When parts are not interpreted like this, it can make analysis difficult.&lt;/p&gt;
&lt;h2 id=&#34;3-Decompiling-custom-lua-files-with-luadec&#34;&gt;&lt;a href=&#34;#3-Decompiling-custom-lua-files-with-luadec&#34; class=&#34;headerlink&#34; title=&#34;3. Decompiling custom lua files with luadec&#34;&gt;&lt;/a&gt;3. Decompiling custom lua files with luadec&lt;/h2&gt;&lt;p&gt;The decompilation errors that occur when decompiling the sample file with luadec can be summarized as follows:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Abnormal table initialization&lt;ul&gt;
&lt;li&gt;&lt;code&gt;SetList fails&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Abnormal table initialization&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Unknown_Type_Error&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Control flow analysis failure&lt;ul&gt;
&lt;li&gt;&lt;code&gt;cannot find blockend&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Among these, the source files responsible for the core decompilation functions in luadec are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;decompile.c&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;  This is the main source code that operates when luadec decompiles. The core logic for decompilation, such as interpreting the bytecode of the Lua file and handling variables and control flow, all exists within this file.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;proto.c&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;  This source code is responsible for interpreting constant values. It translates constant values stored in the bytecode, such as numbers, strings, and booleans, into text. It also plays a role in distributing arguments to the Opcodes.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Let&amp;#x2019;s look at the analysis I conducted and the luadec patching methods I used to solve the decompilation errors mentioned above!&lt;/p&gt;
&lt;h3 id=&#34;3-1-Lua-File-Analysis&#34;&gt;&lt;a href=&#34;#3-1-Lua-File-Analysis&#34; class=&#34;headerlink&#34; title=&#34;3.1. Lua File Analysis&#34;&gt;&lt;/a&gt;3.1. Lua File Analysis&lt;/h3&gt;&lt;p&gt;&lt;img src=&#34;image05.png&#34; alt=&#34;image05.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;The structure of a Lua file is as shown in the picture above, taken from &lt;a href=&#34;https://ieeexplore.ieee.org/document/10163061&#34;&gt;this paper&lt;/a&gt;. It consists of a file header, a function header, code, and a constants table. Using this structure, you can compare the file&amp;#x2019;s hex information to check its contents.&lt;/p&gt;
&lt;p&gt;First, to check the version information, I examined the header. The Lua file header information can be seen in the image below.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image06.png&#34; alt=&#34;image06.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;Checking the header information of the sample Lua file confirms that it is Lua version 5.1.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image07.png&#34; alt=&#34;image07.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;Through the code and constant table sections identifiable from the file structure, you can directly check the Opcodes and constants.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs bash&#34;&gt;$ luac -l ./luafile.lua
...
2 [-]: CALL      R0 2 2       ; R0 := R0(R1)
...

$ xxd ./luaFile.lua
...
00000000: 1b4c 7561 5100 0104 0404 0804 0000 0000
...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Instructions are stored in 4-byte little-endian format. By substituting the offset location as &lt;code&gt;$pc * 4&lt;/code&gt;, you can find the corresponding hex value and map it to interpret the instruction. This way, you can identify the opcode and instruction.&lt;/p&gt;
&lt;p&gt;Using this method or by examining the luadec errors discussed later, you can confirm the existence of custom elements or parts that differ from a standard Lua file.&lt;/p&gt;
&lt;h3 id=&#34;3-2-Abnormal-table-initialization&#34;&gt;&lt;a href=&#34;#3-2-Abnormal-table-initialization&#34; class=&#34;headerlink&#34; title=&#34;3.2. Abnormal table initialization&#34;&gt;&lt;/a&gt;3.2. Abnormal table initialization&lt;/h3&gt;&lt;p&gt;This error, which appears with the message &lt;code&gt;SetList fails&lt;/code&gt;, is caused by an abnormal table initialization in &lt;code&gt;SetList&lt;/code&gt;. This problem occurs when the &lt;code&gt;SETLIST&lt;/code&gt; instruction tries to fill a table starting from index 0, which is different from the Lua standard.&lt;/p&gt;
&lt;p&gt;This can be confirmed in the &lt;code&gt;SetList()&lt;/code&gt; function within the original &lt;code&gt;decompile.c&lt;/code&gt; source code of luadec.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs c&#34;&gt;&lt;span class=&#34;hljs-comment&#34;&gt;// decompile.c&lt;/span&gt;

&lt;span class=&#34;hljs-function&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;hljs-title&#34;&gt;SetList&lt;/span&gt;&lt;span class=&#34;hljs-params&#34;&gt;(Function* F, &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; a, &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; b, &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; c)&lt;/span&gt; &lt;/span&gt;{
	&lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; i;
	DecTable* tbl = (DecTable*)FindFromListTail(&amp;amp;(F-&amp;gt;tables), (ListItemCmpFn)MatchTable, &amp;amp;a);
	&lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; (tbl == &lt;span class=&#34;hljs-literal&#34;&gt;NULL&lt;/span&gt;) {
		&lt;span class=&#34;hljs-built_in&#34;&gt;sprintf&lt;/span&gt;(errortmp, &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;No list found for R%d , SetList fails&amp;quot;&lt;/span&gt;, a);
		SET_ERROR(F, errortmp);
		&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt;;
	}
	&lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; (b == &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;) {
		&lt;span class=&#34;hljs-keyword&#34;&gt;const&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;* rstr;
		i = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;
		&lt;span class=&#34;hljs-keyword&#34;&gt;while&lt;/span&gt; (&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;) {
			rstr = GetR(F, a + i);
			&lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; (error)
				&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt;;
			&lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;hljs-built_in&#34;&gt;strcmp&lt;/span&gt;(rstr,&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;.end&amp;quot;&lt;/span&gt;) == &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;)
				&lt;span class=&#34;hljs-keyword&#34;&gt;break&lt;/span&gt;;
			AddToTable(F, tbl, rstr, &lt;span class=&#34;hljs-literal&#34;&gt;NULL&lt;/span&gt;); &lt;span class=&#34;hljs-comment&#34;&gt;// Lua5.1 specific &lt;span class=&#34;hljs-doctag&#34;&gt;TODO:&lt;/span&gt; it&amp;apos;s not really this :(&lt;/span&gt;
			i++;
		};
	} &lt;span class=&#34;hljs-comment&#34;&gt;//should be {...} or func(func()) ,when b == 0, that will use all avaliable reg from R(a)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This function handles the &lt;code&gt;SETLIST&lt;/code&gt; opcode but completely ignores the &lt;code&gt;c&lt;/code&gt; argument, which determines the starting index of the table. In Lua 5.1, the starting index of a table is calculated by the formula &lt;code&gt;(c-1) * LFIELDS_PER_FLUSH&lt;/code&gt; (where &lt;code&gt;LFIELDS_PER_FLUSH&lt;/code&gt; is usually 50).&lt;/p&gt;
&lt;p&gt;As seen in the bytecode of the sample file, when &lt;code&gt;c&lt;/code&gt; is 1, the starting index becomes 0. However, the code above does not perform this calculation, breaking the decompilation logic. To fix this, I modified the &lt;code&gt;SetList&lt;/code&gt; function to correctly calculate the starting index using the &lt;code&gt;c&lt;/code&gt; argument.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs c&#34;&gt;&lt;span class=&#34;hljs-comment&#34;&gt;// decompile.c&lt;/span&gt;

&lt;span class=&#34;hljs-function&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;void&lt;/span&gt; &lt;span class=&#34;hljs-title&#34;&gt;SetList&lt;/span&gt;&lt;span class=&#34;hljs-params&#34;&gt;(Function* F, &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; a, &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; b, &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; c)&lt;/span&gt; &lt;/span&gt;{
	&lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; i;
	DecTable* tbl = (DecTable*)FindFromListTail(&amp;amp;(F-&amp;gt;tables), (ListItemCmpFn)MatchTable, &amp;amp;a);
	&lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; (tbl == &lt;span class=&#34;hljs-literal&#34;&gt;NULL&lt;/span&gt;) {
		&lt;span class=&#34;hljs-built_in&#34;&gt;sprintf&lt;/span&gt;(errortmp, &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;No list found for R%d , SetList fails&amp;quot;&lt;/span&gt;, a);
		SET_ERROR(F, errortmp);
		&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt;;
	}

	&lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; start_index = (c - &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;) * LFIELDS_PER_FLUSH;

	&lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; (b == &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;) {
		&lt;span class=&#34;hljs-keyword&#34;&gt;const&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;* rstr;
		i = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;
		&lt;span class=&#34;hljs-keyword&#34;&gt;while&lt;/span&gt; (&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;) {
			rstr = GetR(F, a + i);
			&lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; (error)
				&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt;;
			&lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;hljs-built_in&#34;&gt;strcmp&lt;/span&gt;(rstr,&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;.end&amp;quot;&lt;/span&gt;) == &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;)
				&lt;span class=&#34;hljs-keyword&#34;&gt;break&lt;/span&gt;;
			AddToTable(F, tbl, rstr, &lt;span class=&#34;hljs-literal&#34;&gt;NULL&lt;/span&gt;); &lt;span class=&#34;hljs-comment&#34;&gt;// Lua5.1 specific &lt;span class=&#34;hljs-doctag&#34;&gt;TODO:&lt;/span&gt; it&amp;apos;s not really this :(&lt;/span&gt;
			i++;
		};
	} &lt;span class=&#34;hljs-comment&#34;&gt;//should be {...} or func(func()) ,when b == 0, that will use all avaliable reg from R(a)&lt;/span&gt;

	&lt;span class=&#34;hljs-keyword&#34;&gt;for&lt;/span&gt; (i = &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;; i &amp;lt;= b; i++) {
		&lt;span class=&#34;hljs-keyword&#34;&gt;const&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;* rstr = GetR(F, a + i);
		&lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; (error)
			&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt;;
		AddToTable(F, tbl, rstr, start_index + i); &lt;span class=&#34;hljs-comment&#34;&gt;// Lua5.1 specific &lt;span class=&#34;hljs-doctag&#34;&gt;TODO:&lt;/span&gt; it&amp;apos;s not really this :(&lt;/span&gt;
	}
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Patching it this way solves the &lt;code&gt;SetList&lt;/code&gt; fails error!&lt;/p&gt;
&lt;h3 id=&#34;3-3-Unknown-Constant-Data-Type&#34;&gt;&lt;a href=&#34;#3-3-Unknown-Constant-Data-Type&#34; class=&#34;headerlink&#34; title=&#34;3.3. Unknown Constant Data Type&#34;&gt;&lt;/a&gt;3.3. Unknown Constant Data Type&lt;/h3&gt;&lt;p&gt;This error, which can be seen in local variables with the message &lt;code&gt;Unknown_Type_Error&lt;/code&gt;, is caused by a constant. The problem arises because a specific constant type included in the bytecode is not a standard constant type, and therefore, the decompiler fails to recognize it.&lt;/p&gt;
&lt;p&gt;This can be checked in &lt;code&gt;proto.c&lt;/code&gt;, which is responsible for interpreting constant values.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs c&#34;&gt;&lt;span class=&#34;hljs-comment&#34;&gt;// proto.c&lt;/span&gt;

...
&lt;span class=&#34;hljs-function&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;* &lt;span class=&#34;hljs-title&#34;&gt;DecompileConstant&lt;/span&gt;&lt;span class=&#34;hljs-params&#34;&gt;(&lt;span class=&#34;hljs-keyword&#34;&gt;const&lt;/span&gt; Proto* f, &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; i)&lt;/span&gt; &lt;/span&gt;{
	&lt;span class=&#34;hljs-keyword&#34;&gt;const&lt;/span&gt; TValue* o = &amp;amp;f-&amp;gt;k[i];
	&lt;span class=&#34;hljs-keyword&#34;&gt;switch&lt;/span&gt; (ttype(o)) {
	&lt;span class=&#34;hljs-keyword&#34;&gt;case&lt;/span&gt; LUA_TBOOLEAN:
		&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; strdup(bvalue(o)?&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;true&amp;quot;&lt;/span&gt;:&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;false&amp;quot;&lt;/span&gt;);
	&lt;span class=&#34;hljs-keyword&#34;&gt;case&lt;/span&gt; LUA_TNIL:
		&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; strdup(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;nil&amp;quot;&lt;/span&gt;);
&lt;span class=&#34;hljs-meta&#34;&gt;#&lt;span class=&#34;hljs-meta-keyword&#34;&gt;if&lt;/span&gt; LUA_VERSION_NUM == 501 || LUA_VERSION_NUM == 502&lt;/span&gt;
	&lt;span class=&#34;hljs-keyword&#34;&gt;case&lt;/span&gt; LUA_TNUMBER:
	{
		&lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;* ret = (&lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;*)&lt;span class=&#34;hljs-built_in&#34;&gt;calloc&lt;/span&gt;(&lt;span class=&#34;hljs-number&#34;&gt;128&lt;/span&gt;, &lt;span class=&#34;hljs-keyword&#34;&gt;sizeof&lt;/span&gt;(&lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;));
		&lt;span class=&#34;hljs-built_in&#34;&gt;sprintf&lt;/span&gt;(ret, LUA_NUMBER_FMT, nvalue(o));
		&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; ret;
	}
...

...
	&lt;span class=&#34;hljs-keyword&#34;&gt;default&lt;/span&gt;:
		&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; strdup(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Unknown_Type_Error&amp;quot;&lt;/span&gt;);
	}
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The code flows to the appropriate branch for the constant type through &lt;code&gt;switch (ttype(o))&lt;/code&gt;. To identify the value of the constant type causing the &lt;code&gt;Unknown_Type_Error&lt;/code&gt;, I modified the code as shown below and checked the result.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs c&#34;&gt;	&lt;span class=&#34;hljs-keyword&#34;&gt;default&lt;/span&gt;:
		&lt;span class=&#34;hljs-built_in&#34;&gt;printf&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;DEBUG: Found unknown constant type: %d\n&amp;quot;&lt;/span&gt;, ttype(o));
		&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; strdup(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Unknown_Type_Error&amp;quot;&lt;/span&gt;);
	}
}&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code class=&#34;hljs lua&#34;&gt;DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;
DEBUG: Found unknown constant &lt;span class=&#34;hljs-built_in&#34;&gt;type&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Checking the result above, we can see that the sample file uses a type of 9. The standard constant types for Lua 5.1 range from 0 to 8.&lt;/p&gt;
&lt;div class=&#34;table-container&#34;&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Number&lt;/th&gt;
&lt;th&gt;Type Macro&lt;/th&gt;
&lt;th&gt;Description&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;td&gt;&lt;code&gt;LUA_TNIL&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;nil&lt;/code&gt; value&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;&lt;code&gt;LUA_TBOOLEAN&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;true&lt;/code&gt; or &lt;code&gt;false&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;&lt;code&gt;LUA_TLIGHTUSERDATA&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;small user data&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;&lt;code&gt;LUA_TNUMBER&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;number (No distinction integer/float)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;&lt;code&gt;LUA_TSTRING&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;strings&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;5&lt;/td&gt;
&lt;td&gt;&lt;code&gt;LUA_TTABLE&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;table&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;6&lt;/td&gt;
&lt;td&gt;&lt;code&gt;LUA_TFUNCTION&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;function (closer)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;7&lt;/td&gt;
&lt;td&gt;&lt;code&gt;LUA_TUSERDATA&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;all user data&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;8&lt;/td&gt;
&lt;td&gt;&lt;code&gt;LUA_TTHREAD&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;thread (coroutine)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;p&gt;From this, we can confirm that the sample file uses a custom constant type with a value of 9, and the error occurs because it cannot be recognized. By looking at the disassembly where this constant type is used, we can see it&amp;#x2019;s being used like an integer.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs bash&#34;&gt;$ luadec -dis ./luaFile.lua
19 [-]: SUB R6 R6 K10 ; R6 := R6 - Unknown_Type_Error&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;To solve this, I modified the code by adding a &lt;code&gt;case&lt;/code&gt; statement to handle the custom constant type 9 as an integer.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs c&#34;&gt;&lt;span class=&#34;hljs-function&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;* &lt;span class=&#34;hljs-title&#34;&gt;DecompileConstant&lt;/span&gt;&lt;span class=&#34;hljs-params&#34;&gt;(&lt;span class=&#34;hljs-keyword&#34;&gt;const&lt;/span&gt; Proto* f, &lt;span class=&#34;hljs-keyword&#34;&gt;int&lt;/span&gt; i)&lt;/span&gt; &lt;/span&gt;{
	&lt;span class=&#34;hljs-keyword&#34;&gt;const&lt;/span&gt; TValue* o = &amp;amp;f-&amp;gt;k[i];
	&lt;span class=&#34;hljs-keyword&#34;&gt;switch&lt;/span&gt; (ttype(o)) {
	&lt;span class=&#34;hljs-keyword&#34;&gt;case&lt;/span&gt; LUA_TBOOLEAN:
		&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; strdup(bvalue(o)?&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;true&amp;quot;&lt;/span&gt;:&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;false&amp;quot;&lt;/span&gt;);
	&lt;span class=&#34;hljs-keyword&#34;&gt;case&lt;/span&gt; LUA_TNIL:
		&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; strdup(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;nil&amp;quot;&lt;/span&gt;);
&lt;span class=&#34;hljs-meta&#34;&gt;#&lt;span class=&#34;hljs-meta-keyword&#34;&gt;if&lt;/span&gt; LUA_VERSION_NUM == 501 || LUA_VERSION_NUM == 502&lt;/span&gt;
	&lt;span class=&#34;hljs-keyword&#34;&gt;case&lt;/span&gt; LUA_TNUMBER:
	{
		&lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;* ret = (&lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;*)&lt;span class=&#34;hljs-built_in&#34;&gt;calloc&lt;/span&gt;(&lt;span class=&#34;hljs-number&#34;&gt;128&lt;/span&gt;, &lt;span class=&#34;hljs-keyword&#34;&gt;sizeof&lt;/span&gt;(&lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;));
		&lt;span class=&#34;hljs-built_in&#34;&gt;sprintf&lt;/span&gt;(ret, LUA_NUMBER_FMT, nvalue(o));
		&lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; ret;
	}
	&lt;span class=&#34;hljs-keyword&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;hljs-number&#34;&gt;9&lt;/span&gt;:
  {
      &lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;* ret = (&lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;*)&lt;span class=&#34;hljs-built_in&#34;&gt;calloc&lt;/span&gt;(&lt;span class=&#34;hljs-number&#34;&gt;128&lt;/span&gt;, &lt;span class=&#34;hljs-keyword&#34;&gt;sizeof&lt;/span&gt;(&lt;span class=&#34;hljs-keyword&#34;&gt;char&lt;/span&gt;));
      &lt;span class=&#34;hljs-built_in&#34;&gt;sprintf&lt;/span&gt;(ret, LUA_INTEGER_FMT, ivalue(o)); 
      &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; ret;
  }
	&lt;span class=&#34;hljs-keyword&#34;&gt;case&lt;/span&gt; LUA_TSTRING:&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;After modifying the code to print the value as an integer, you can see that the error is resolved as shown below.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs lua&#34;&gt;&lt;span class=&#34;hljs-comment&#34;&gt;-- params : ...&lt;/span&gt;
&lt;span class=&#34;hljs-comment&#34;&gt;-- function num : 0&lt;/span&gt;
&lt;span class=&#34;hljs-built_in&#34;&gt;module&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.controller.login&amp;quot;&lt;/span&gt;, &lt;span class=&#34;hljs-built_in&#34;&gt;package&lt;/span&gt;.&lt;span class=&#34;hljs-built_in&#34;&gt;seeall&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_0 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.model.controller&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_1 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;nixio&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_2 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;nixio.fs&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_3 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.sys&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_4 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.util&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_5 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.tools.error&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_6 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.model.log&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_7 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.tools.debug&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_8 = &lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.json&amp;quot;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_9 = (&lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;luci.tools.datatypes&amp;quot;&lt;/span&gt;))
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_10 = &lt;span class=&#34;hljs-literal&#34;&gt;nil&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_11 = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/var/run/luci-attempts.lock&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_12 = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/tmp/luci-attempts&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_13 = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/tmp/TIME_STAMP&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_14 = &lt;span class=&#34;hljs-number&#34;&gt;7200&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_15 = &lt;span class=&#34;hljs-number&#34;&gt;10&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_16 = &lt;span class=&#34;hljs-number&#34;&gt;88&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_17 = &lt;span class=&#34;hljs-number&#34;&gt;14201&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_18 = &lt;span class=&#34;hljs-number&#34;&gt;14203&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_19 = &lt;span class=&#34;hljs-number&#34;&gt;24&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_20 = &lt;span class=&#34;hljs-number&#34;&gt;13242&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_21 = &lt;span class=&#34;hljs-number&#34;&gt;13243&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_22 = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;users&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_23 = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;02008001&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_24 = &lt;span class=&#34;hljs-number&#34;&gt;4&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_25 = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;02108001&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;local&lt;/span&gt; l_0_31 = &lt;span class=&#34;hljs-function&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;function&lt;/span&gt;&lt;span class=&#34;hljs-params&#34;&gt;(l_1_0)&lt;/span&gt;&lt;/span&gt;
...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This allows us to interpret all the parts that were using uninterpreted variables.&lt;/p&gt;
&lt;p&gt;The patched luadec tool can be found at the GitHub repository below!&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/newp1ayer48/luadec-patched&#34;&gt;https://github.com/newp1ayer48/luadec-patched&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;You can install and use it as follows.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs bash&#34;&gt;git &lt;span class=&#34;hljs-built_in&#34;&gt;clone&lt;/span&gt; https://github.com/newp1ayer48/luadec-patched.git
&lt;span class=&#34;hljs-built_in&#34;&gt;cd&lt;/span&gt; ./luadec-patched/luadec
chmod +x ./luadec
./luadec luaFile/lua&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The control flow analysis failure error is scheduled to be patched in the future. I plan to continue patching for custom Lua scripts from other products, devices, and environments as I encounter them.&lt;/p&gt;
&lt;p&gt;When I first started analyzing the custom Lua, I felt quite lost. But as I analyzed the file and patched the tool, more and more parts became interpretable, which was very satisfying! I hope this article and the tool I patched can be helpful to others who are analyzing Lua files!&lt;/p&gt;
&lt;p&gt;I&amp;#x2019;ll be back with another embedded topic next time! Thanks for reading! &amp;#x1F44B;&amp;#x1F3FB;&lt;/p&gt;
 - hack &amp; life">
  <meta property="og:image" content="https://hackyboiz.github.io/2025/10/04/newp1ayer48/lua/kr/image02.jpg">
  <meta property="og:url" content="https://hackyboiz.github.io/">

  <link rel="canonical" href="https://hackyboiz.github.io/2025/10/04/newp1ayer48/lua/en/">

  <title>[Research] Custom Lua Script  Decompile (EN) - hackyboiz</title>

  <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css">


  <link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css">
  <link rel="stylesheet" href="/lib/hint/hint.min.css">

  
    
    <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css">
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_6peoq002giu.css">
<link rel="stylesheet" href="/.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">
<link rel="stylesheet" href="/.css">


<link rel="stylesheet" href="/css/main.css">

<!-- 自定义样式保持在最底部 -->


  <script src="/js/utils.js"></script>
  <script src="/js/color-schema.js"></script>

<meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/rss2.xml" title="hackyboiz" type="application/rss+xml">
</head>


<body>
  <header style="height: 40vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">&nbsp;<strong>Hackyboiz</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-addrcard"></i>
                About
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/author/">
                <i class="iconfont icon-user-fill"></i>
                Author
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax="true" style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2025-10-04 19:00" pubdate>
      2025년 10월 4일 오후
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      2.6k 자
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      52
       분
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2">
      <!--<script data-ad-client="ca-pub-3672652207808168" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>-->
    </div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">[Research] Custom Lua Script  Decompile (EN)</h1>
                       
            <div class="markdown-body" id="post-body">
              <!-- <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>-->
              <!-- hackyboiz_horizen_index -->
              <!--
              <ins class="adsbygoogle"
                   style="display:block"
                   data-ad-client="ca-pub-3672652207808168"
                   data-ad-slot="8887862313"
                   data-ad-format="auto"
                   data-full-width-responsive="true"></ins>
              <script>
                   (adsbygoogle = window.adsbygoogle || []).push({});
              </script>
              -->
              <p>Hello! I&#x2019;m newp1ayer48, the one in charge of the low-level at Hackyboiz! &#x1F938;&#x1F3FB;&#x200D;&#x2642;&#xFE0F;</p>
<p><img src="image01.jpg" srcset="/img/loading.gif" alt="image01.jpg"></p>
<p>There&#x2019;s a language frequently used in embedded devices. It&#x2019;s the Lua script!</p>
<p>Embedded device manufacturers sometimes use customized versions of this Lua script. In such cases, decompiling the compiled Lua script often fails to produce proper results.</p>
<p>So&#x2026; for my analysis, I decided to improve and patch the decompilation tool myself. Feel free to check out the GitHub for the final patched tool first!</p>
<p>Let&#x2019;s cover everything from an explanation of Lua Script to how to decompile these custom Lua scripts!</p>
<h2 id="1-Lua-Script"><a href="#1-Lua-Script" class="headerlink" title="1. Lua Script"></a>1. Lua Script</h2><p><img src="image02.jpg" srcset="/img/loading.gif" alt="image02.jpg"></p>
<p>Lua is a scripting language developed by a team at the Pontifical Catholic University of Rio de Janeiro (PUC-Rio) in Brazil! (The language of the gods..?) It is known for being small and lightweight, and because it also allows for system control, it&#x2019;s frequently used in embedded systems and game development. Thanks to its lightweight yet powerful scripting capabilities, it&#x2019;s also useful for tools that operate at the protocol level, like developing Wireshark plugins or custom dissectors. The official website provides full documentation on installation and the usage of each library and function. Lua has versions from 5.1 to the current 5.4.</p>
<p>Furthermore, it boasts excellent interoperability and extensibility with C/C++. Just like C/C++, Lua can be compiled to build files, which is why you can often find compiled Lua files inside devices or programs. The file extension is <code>.lua</code> for script files and <code>.luac</code> for compiled files. However, compiled files can also exist with a <code>.lua</code> extension, so checking the file header is the most reliable method.</p>
<p>From a security perspective, Lua can be a major vector for vulnerabilities. Functions like <code>os.execute()</code> can be used to execute system commands, making Command Injection a common vulnerability. Memory Corruption and Overflow vulnerabilities also occur in the Stack and Heap, with corresponding <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.cvedetails.com/product/28436/LUA-LUA.html?vendor_id=13641">CVEs</a> being reported.</p>
<h3 id="1-1-OpenWrt-and-Luci"><a href="#1-1-OpenWrt-and-Luci" class="headerlink" title="1.1. OpenWrt and Luci"></a>1.1. OpenWrt and Luci</h3><p><img src="image03.png" srcset="/img/loading.gif" alt="image03.png"></p>
<p>OpenWrt is a Linux distribution created for embedded devices, specifically routers. You can install the distribution via the <a target="_blank" rel="external nofollow noopener noreferrer" href="https://openwrt.org/">official website</a>, which also provides detailed information on routers built with OpenWrt. It&#x2019;s an excellent site for gaining knowledge about embedded hacking! When analyzing routers during an embedded hacking project, you&#x2019;ll frequently come across routers and firmware developed based on the OpenWrt project.</p>
<p>Projects and firmware developed with OpenWrt often use Lua scripts. In particular, they frequently include Luci, which uses a modified Lua script to conveniently configure the web interface. They often use Lua version 5.1, so the Lua files you analyze will typically be version 5.1</p>
<h2 id="2-Lua-Decompiler-luadec"><a href="#2-Lua-Decompiler-luadec" class="headerlink" title="2. Lua Decompiler: luadec"></a>2. Lua Decompiler: luadec</h2><p><img src="image04.jpg" srcset="/img/loading.gif" alt="image04.jpg"></p>
<p>It can be difficult to view the source code of a compiled Lua file. In such cases, you can use a Lua decompiler to see the original source code. The most representative decompilers are the C-based luadec and the Java-based unluac. unluac is often praised for its good performance with versions 5.2 and higher. In this article, we will be targeting Lua 5.1 files, so we&#x2019;ll proceed with decompilation using luadec.</p>
<p>Stock luadec does not have the OpenWrt patches applied, so you need to apply the relevant patches for the decompilation to proceed smoothly. You can install luadec and apply the OpenWrt patch as shown below.</p>
<pre><code class="hljs bash">sudo apt-get update
sudo apt-get install libncurses-dev libreadline-dev

git <span class="hljs-built_in">clone</span> https://github.com/viruscamp/luadec
<span class="hljs-built_in">cd</span> luadec
git submodule update --init lua-5.1
ref=master
patch_dir=patches.<span class="hljs-variable">$ref</span>
mkdir <span class="hljs-variable">$patch_dir</span> &amp;&amp; <span class="hljs-built_in">cd</span> <span class="hljs-variable">$patch_dir</span>
patchs=$(curl -sSL -H <span class="hljs-string">&apos;Accept: application/vnd.github.v3+json&apos;</span> <span class="hljs-string">&apos;https://api.github.com/repos/openwrt/openwrt/contents/package/utils/lua/patches?ref=&apos;</span><span class="hljs-string">&quot;<span class="hljs-variable">$ref</span>&quot;</span> |grep -oP <span class="hljs-string">&apos;name\&quot;\s*:\s*\&quot;.*\.patch&apos;</span> |grep -oP <span class="hljs-string">&apos;\d+.*\.patch&apos;</span>)
<span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> <span class="hljs-variable">$patchs</span>;<span class="hljs-keyword">do</span>  
wget <span class="hljs-string">&apos;https://raw.githubusercontent.com/openwrt/openwrt/master/package/utils/lua/patches/&apos;</span><span class="hljs-variable">${p}</span>  -O <span class="hljs-variable">$p</span>;
<span class="hljs-keyword">done</span>

<span class="hljs-built_in">cd</span> ../lua-5.1
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> ../<span class="hljs-variable">${patch_dir}</span>/*.patch; <span class="hljs-keyword">do</span> patch -p1 &lt;<span class="hljs-variable">$i</span> ; <span class="hljs-keyword">done</span>

MAKEFILE=<span class="hljs-string">&quot;src/Makefile&quot;</span>
cp <span class="hljs-string">&quot;<span class="hljs-variable">$MAKEFILE</span>&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$MAKEFILE</span>.bak&quot;</span>
sed -i <span class="hljs-string">&apos;/# USE_READLINE=1/a PKG_VERSION = 5.1.5&apos;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$MAKEFILE</span>&quot;</span>
sed -i <span class="hljs-string">&apos;s/CFLAGS= -O2 -Wall $(MYCFLAGS)/CFLAGS= -fPIC -O2 -Wall $(MYCFLAGS)/&apos;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$MAKEFILE</span>&quot;</span>
sed -i <span class="hljs-string">&apos;s/$(CC) -o $@ -L\. -llua $(MYLDFLAGS) $(LUA_O) $(LIBS)/$(CC) -o $@ $(LUA_O) $(MYLDFLAGS) -L. -llua $(LIBS)/&apos;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$MAKEFILE</span>&quot;</span>
sed -i <span class="hljs-string">&apos;s/$(CC) -o $@ -L\. -llua $(MYLDFLAGS) $(LUAC_O) $(LIBS)/$(CC) -o $@ $(LUAC_O) $(MYLDFLAGS) -L. -llua $(LIBS)/&apos;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$MAKEFILE</span>&quot;</span>

<span class="hljs-built_in">cd</span> src
make linux
<span class="hljs-built_in">export</span> LD_LIBRARY_PATH=`<span class="hljs-built_in">pwd</span>`/src/
<span class="hljs-built_in">cd</span> ../../luadec
make LUAVER=5.1
sudo cp luadec /usr/<span class="hljs-built_in">local</span>/bin/</code></pre>
<p>After installation and patching, if you decompile the example file, you can see a part of the decompilation result as shown below.</p>
<pre><code class="hljs lua">./luadec ./luaFile.lua</code></pre>
<pre><code class="hljs lua"><span class="hljs-comment">-- params : ...</span>
<span class="hljs-comment">-- function num : 0</span>
<span class="hljs-built_in">module</span>(<span class="hljs-string">&quot;luci.controller.login&quot;</span>, <span class="hljs-built_in">package</span>.<span class="hljs-built_in">seeall</span>)
<span class="hljs-keyword">local</span> l_0_0 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;luci.model.controller&quot;</span>)
<span class="hljs-keyword">local</span> l_0_1 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;nixio&quot;</span>)
<span class="hljs-keyword">local</span> l_0_2 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;nixio.fs&quot;</span>)
<span class="hljs-keyword">local</span> l_0_3 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;luci.sys&quot;</span>)
<span class="hljs-keyword">local</span> l_0_4 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;luci.util&quot;</span>)
<span class="hljs-keyword">local</span> l_0_5 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;luci.tools.error&quot;</span>)
<span class="hljs-keyword">local</span> l_0_6 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;luci.model.log&quot;</span>)
<span class="hljs-keyword">local</span> l_0_7 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;luci.tools.debug&quot;</span>)
<span class="hljs-keyword">local</span> l_0_8 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;luci.json&quot;</span>)
<span class="hljs-keyword">local</span> l_0_9 = (<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;luci.tools.datatypes&quot;</span>))
<span class="hljs-keyword">local</span> l_0_10 = <span class="hljs-literal">nil</span>
<span class="hljs-keyword">local</span> l_0_11 = <span class="hljs-string">&quot;/var/run/luci-attempts.lock&quot;</span>
<span class="hljs-keyword">local</span> l_0_12 = <span class="hljs-string">&quot;/tmp/luci-attempts&quot;</span>
<span class="hljs-keyword">local</span> l_0_13 = <span class="hljs-string">&quot;/tmp/TIME_STAMP&quot;</span>
<span class="hljs-keyword">local</span> l_0_14 = Unknown_Type_Error
<span class="hljs-keyword">local</span> l_0_15 = Unknown_Type_Error
<span class="hljs-keyword">local</span> l_0_16 = Unknown_Type_Error
<span class="hljs-keyword">local</span> l_0_17 = Unknown_Type_Error
<span class="hljs-keyword">local</span> l_0_18 = Unknown_Type_Error
<span class="hljs-keyword">local</span> l_0_19 = Unknown_Type_Error
<span class="hljs-keyword">local</span> l_0_20 = Unknown_Type_Error
<span class="hljs-keyword">local</span> l_0_21 = Unknown_Type_Error
<span class="hljs-keyword">local</span> l_0_22 = <span class="hljs-string">&quot;users&quot;</span>
<span class="hljs-keyword">local</span> l_0_23 = <span class="hljs-string">&quot;02008001&quot;</span>
<span class="hljs-keyword">local</span> l_0_24 = Unknown_Type_Error
<span class="hljs-keyword">local</span> l_0_25 = <span class="hljs-string">&quot;02108001&quot;</span>
<span class="hljs-keyword">local</span> l_0_31 = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(l_1_0)</span></span>

...</code></pre>
<p>Looking at the decompilation result, you can see that there are variables or values that could not be interpreted.</p>
<p>When parts are not interpreted like this, it can make analysis difficult.</p>
<h2 id="3-Decompiling-custom-lua-files-with-luadec"><a href="#3-Decompiling-custom-lua-files-with-luadec" class="headerlink" title="3. Decompiling custom lua files with luadec"></a>3. Decompiling custom lua files with luadec</h2><p>The decompilation errors that occur when decompiling the sample file with luadec can be summarized as follows:</p>
<ul>
<li>Abnormal table initialization<ul>
<li><code>SetList fails</code></li>
</ul>
</li>
<li>Abnormal table initialization<ul>
<li><code>Unknown_Type_Error</code></li>
</ul>
</li>
<li>Control flow analysis failure<ul>
<li><code>cannot find blockend</code></li>
</ul>
</li>
</ul>
<p>Among these, the source files responsible for the core decompilation functions in luadec are:</p>
<ul>
<li><p><code>decompile.c</code></p>
<p>  This is the main source code that operates when luadec decompiles. The core logic for decompilation, such as interpreting the bytecode of the Lua file and handling variables and control flow, all exists within this file.</p>
</li>
<li><p><code>proto.c</code></p>
<p>  This source code is responsible for interpreting constant values. It translates constant values stored in the bytecode, such as numbers, strings, and booleans, into text. It also plays a role in distributing arguments to the Opcodes.</p>
</li>
</ul>
<p>Let&#x2019;s look at the analysis I conducted and the luadec patching methods I used to solve the decompilation errors mentioned above!</p>
<h3 id="3-1-Lua-File-Analysis"><a href="#3-1-Lua-File-Analysis" class="headerlink" title="3.1. Lua File Analysis"></a>3.1. Lua File Analysis</h3><p><img src="image05.png" srcset="/img/loading.gif" alt="image05.png"></p>
<p>The structure of a Lua file is as shown in the picture above, taken from <a target="_blank" rel="external nofollow noopener noreferrer" href="https://ieeexplore.ieee.org/document/10163061">this paper</a>. It consists of a file header, a function header, code, and a constants table. Using this structure, you can compare the file&#x2019;s hex information to check its contents.</p>
<p>First, to check the version information, I examined the header. The Lua file header information can be seen in the image below.</p>
<p><img src="image06.png" srcset="/img/loading.gif" alt="image06.png"></p>
<p>Checking the header information of the sample Lua file confirms that it is Lua version 5.1.</p>
<p><img src="image07.png" srcset="/img/loading.gif" alt="image07.png"></p>
<p>Through the code and constant table sections identifiable from the file structure, you can directly check the Opcodes and constants.</p>
<pre><code class="hljs bash">$ luac -l ./luafile.lua
...
2 [-]: CALL      R0 2 2       ; R0 := R0(R1)
...

$ xxd ./luaFile.lua
...
00000000: 1b4c 7561 5100 0104 0404 0804 0000 0000
...</code></pre>
<p>Instructions are stored in 4-byte little-endian format. By substituting the offset location as <code>$pc * 4</code>, you can find the corresponding hex value and map it to interpret the instruction. This way, you can identify the opcode and instruction.</p>
<p>Using this method or by examining the luadec errors discussed later, you can confirm the existence of custom elements or parts that differ from a standard Lua file.</p>
<h3 id="3-2-Abnormal-table-initialization"><a href="#3-2-Abnormal-table-initialization" class="headerlink" title="3.2. Abnormal table initialization"></a>3.2. Abnormal table initialization</h3><p>This error, which appears with the message <code>SetList fails</code>, is caused by an abnormal table initialization in <code>SetList</code>. This problem occurs when the <code>SETLIST</code> instruction tries to fill a table starting from index 0, which is different from the Lua standard.</p>
<p>This can be confirmed in the <code>SetList()</code> function within the original <code>decompile.c</code> source code of luadec.</p>
<pre><code class="hljs c"><span class="hljs-comment">// decompile.c</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SetList</span><span class="hljs-params">(Function* F, <span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b, <span class="hljs-keyword">int</span> c)</span> </span>{
	<span class="hljs-keyword">int</span> i;
	DecTable* tbl = (DecTable*)FindFromListTail(&amp;(F-&gt;tables), (ListItemCmpFn)MatchTable, &amp;a);
	<span class="hljs-keyword">if</span> (tbl == <span class="hljs-literal">NULL</span>) {
		<span class="hljs-built_in">sprintf</span>(errortmp, <span class="hljs-string">&quot;No list found for R%d , SetList fails&quot;</span>, a);
		SET_ERROR(F, errortmp);
		<span class="hljs-keyword">return</span>;
	}
	<span class="hljs-keyword">if</span> (b == <span class="hljs-number">0</span>) {
		<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* rstr;
		i = <span class="hljs-number">1</span>;
		<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
			rstr = GetR(F, a + i);
			<span class="hljs-keyword">if</span> (error)
				<span class="hljs-keyword">return</span>;
			<span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(rstr,<span class="hljs-string">&quot;.end&quot;</span>) == <span class="hljs-number">0</span>)
				<span class="hljs-keyword">break</span>;
			AddToTable(F, tbl, rstr, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">// Lua5.1 specific <span class="hljs-doctag">TODO:</span> it&apos;s not really this :(</span>
			i++;
		};
	} <span class="hljs-comment">//should be {...} or func(func()) ,when b == 0, that will use all avaliable reg from R(a)</span></code></pre>
<p>This function handles the <code>SETLIST</code> opcode but completely ignores the <code>c</code> argument, which determines the starting index of the table. In Lua 5.1, the starting index of a table is calculated by the formula <code>(c-1) * LFIELDS_PER_FLUSH</code> (where <code>LFIELDS_PER_FLUSH</code> is usually 50).</p>
<p>As seen in the bytecode of the sample file, when <code>c</code> is 1, the starting index becomes 0. However, the code above does not perform this calculation, breaking the decompilation logic. To fix this, I modified the <code>SetList</code> function to correctly calculate the starting index using the <code>c</code> argument.</p>
<pre><code class="hljs c"><span class="hljs-comment">// decompile.c</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SetList</span><span class="hljs-params">(Function* F, <span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b, <span class="hljs-keyword">int</span> c)</span> </span>{
	<span class="hljs-keyword">int</span> i;
	DecTable* tbl = (DecTable*)FindFromListTail(&amp;(F-&gt;tables), (ListItemCmpFn)MatchTable, &amp;a);
	<span class="hljs-keyword">if</span> (tbl == <span class="hljs-literal">NULL</span>) {
		<span class="hljs-built_in">sprintf</span>(errortmp, <span class="hljs-string">&quot;No list found for R%d , SetList fails&quot;</span>, a);
		SET_ERROR(F, errortmp);
		<span class="hljs-keyword">return</span>;
	}

	<span class="hljs-keyword">int</span> start_index = (c - <span class="hljs-number">1</span>) * LFIELDS_PER_FLUSH;

	<span class="hljs-keyword">if</span> (b == <span class="hljs-number">0</span>) {
		<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* rstr;
		i = <span class="hljs-number">1</span>;
		<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
			rstr = GetR(F, a + i);
			<span class="hljs-keyword">if</span> (error)
				<span class="hljs-keyword">return</span>;
			<span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(rstr,<span class="hljs-string">&quot;.end&quot;</span>) == <span class="hljs-number">0</span>)
				<span class="hljs-keyword">break</span>;
			AddToTable(F, tbl, rstr, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">// Lua5.1 specific <span class="hljs-doctag">TODO:</span> it&apos;s not really this :(</span>
			i++;
		};
	} <span class="hljs-comment">//should be {...} or func(func()) ,when b == 0, that will use all avaliable reg from R(a)</span>

	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; i &lt;= b; i++) {
		<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* rstr = GetR(F, a + i);
		<span class="hljs-keyword">if</span> (error)
			<span class="hljs-keyword">return</span>;
		AddToTable(F, tbl, rstr, start_index + i); <span class="hljs-comment">// Lua5.1 specific <span class="hljs-doctag">TODO:</span> it&apos;s not really this :(</span>
	}
}</code></pre>
<p>Patching it this way solves the <code>SetList</code> fails error!</p>
<h3 id="3-3-Unknown-Constant-Data-Type"><a href="#3-3-Unknown-Constant-Data-Type" class="headerlink" title="3.3. Unknown Constant Data Type"></a>3.3. Unknown Constant Data Type</h3><p>This error, which can be seen in local variables with the message <code>Unknown_Type_Error</code>, is caused by a constant. The problem arises because a specific constant type included in the bytecode is not a standard constant type, and therefore, the decompiler fails to recognize it.</p>
<p>This can be checked in <code>proto.c</code>, which is responsible for interpreting constant values.</p>
<pre><code class="hljs c"><span class="hljs-comment">// proto.c</span>

...
<span class="hljs-function"><span class="hljs-keyword">char</span>* <span class="hljs-title">DecompileConstant</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Proto* f, <span class="hljs-keyword">int</span> i)</span> </span>{
	<span class="hljs-keyword">const</span> TValue* o = &amp;f-&gt;k[i];
	<span class="hljs-keyword">switch</span> (ttype(o)) {
	<span class="hljs-keyword">case</span> LUA_TBOOLEAN:
		<span class="hljs-keyword">return</span> strdup(bvalue(o)?<span class="hljs-string">&quot;true&quot;</span>:<span class="hljs-string">&quot;false&quot;</span>);
	<span class="hljs-keyword">case</span> LUA_TNIL:
		<span class="hljs-keyword">return</span> strdup(<span class="hljs-string">&quot;nil&quot;</span>);
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> LUA_VERSION_NUM == 501 || LUA_VERSION_NUM == 502</span>
	<span class="hljs-keyword">case</span> LUA_TNUMBER:
	{
		<span class="hljs-keyword">char</span>* ret = (<span class="hljs-keyword">char</span>*)<span class="hljs-built_in">calloc</span>(<span class="hljs-number">128</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>));
		<span class="hljs-built_in">sprintf</span>(ret, LUA_NUMBER_FMT, nvalue(o));
		<span class="hljs-keyword">return</span> ret;
	}
...

...
	<span class="hljs-keyword">default</span>:
		<span class="hljs-keyword">return</span> strdup(<span class="hljs-string">&quot;Unknown_Type_Error&quot;</span>);
	}
}</code></pre>
<p>The code flows to the appropriate branch for the constant type through <code>switch (ttype(o))</code>. To identify the value of the constant type causing the <code>Unknown_Type_Error</code>, I modified the code as shown below and checked the result.</p>
<pre><code class="hljs c">	<span class="hljs-keyword">default</span>:
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;DEBUG: Found unknown constant type: %d\n&quot;</span>, ttype(o));
		<span class="hljs-keyword">return</span> strdup(<span class="hljs-string">&quot;Unknown_Type_Error&quot;</span>);
	}
}</code></pre>
<pre><code class="hljs lua">DEBUG: Found unknown constant <span class="hljs-built_in">type</span>: <span class="hljs-number">9</span>
DEBUG: Found unknown constant <span class="hljs-built_in">type</span>: <span class="hljs-number">9</span>
DEBUG: Found unknown constant <span class="hljs-built_in">type</span>: <span class="hljs-number">9</span>
DEBUG: Found unknown constant <span class="hljs-built_in">type</span>: <span class="hljs-number">9</span>
DEBUG: Found unknown constant <span class="hljs-built_in">type</span>: <span class="hljs-number">9</span>
DEBUG: Found unknown constant <span class="hljs-built_in">type</span>: <span class="hljs-number">9</span>
DEBUG: Found unknown constant <span class="hljs-built_in">type</span>: <span class="hljs-number">9</span>
DEBUG: Found unknown constant <span class="hljs-built_in">type</span>: <span class="hljs-number">9</span>
DEBUG: Found unknown constant <span class="hljs-built_in">type</span>: <span class="hljs-number">9</span>
DEBUG: Found unknown constant <span class="hljs-built_in">type</span>: <span class="hljs-number">9</span>
DEBUG: Found unknown constant <span class="hljs-built_in">type</span>: <span class="hljs-number">9</span>
DEBUG: Found unknown constant <span class="hljs-built_in">type</span>: <span class="hljs-number">9</span>
DEBUG: Found unknown constant <span class="hljs-built_in">type</span>: <span class="hljs-number">9</span>
DEBUG: Found unknown constant <span class="hljs-built_in">type</span>: <span class="hljs-number">9</span>
DEBUG: Found unknown constant <span class="hljs-built_in">type</span>: <span class="hljs-number">9</span>
DEBUG: Found unknown constant <span class="hljs-built_in">type</span>: <span class="hljs-number">9</span>
DEBUG: Found unknown constant <span class="hljs-built_in">type</span>: <span class="hljs-number">9</span>
DEBUG: Found unknown constant <span class="hljs-built_in">type</span>: <span class="hljs-number">9</span></code></pre>
<p>Checking the result above, we can see that the sample file uses a type of 9. The standard constant types for Lua 5.1 range from 0 to 8.</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Number</th>
<th>Type Macro</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td><code>LUA_TNIL</code></td>
<td><code>nil</code> value</td>
</tr>
<tr>
<td>1</td>
<td><code>LUA_TBOOLEAN</code></td>
<td><code>true</code> or <code>false</code></td>
</tr>
<tr>
<td>2</td>
<td><code>LUA_TLIGHTUSERDATA</code></td>
<td>small user data</td>
</tr>
<tr>
<td>3</td>
<td><code>LUA_TNUMBER</code></td>
<td>number (No distinction integer/float)</td>
</tr>
<tr>
<td>4</td>
<td><code>LUA_TSTRING</code></td>
<td>strings</td>
</tr>
<tr>
<td>5</td>
<td><code>LUA_TTABLE</code></td>
<td>table</td>
</tr>
<tr>
<td>6</td>
<td><code>LUA_TFUNCTION</code></td>
<td>function (closer)</td>
</tr>
<tr>
<td>7</td>
<td><code>LUA_TUSERDATA</code></td>
<td>all user data</td>
</tr>
<tr>
<td>8</td>
<td><code>LUA_TTHREAD</code></td>
<td>thread (coroutine)</td>
</tr>
</tbody>
</table>
</div>
<p>From this, we can confirm that the sample file uses a custom constant type with a value of 9, and the error occurs because it cannot be recognized. By looking at the disassembly where this constant type is used, we can see it&#x2019;s being used like an integer.</p>
<pre><code class="hljs bash">$ luadec -dis ./luaFile.lua
19 [-]: SUB R6 R6 K10 ; R6 := R6 - Unknown_Type_Error</code></pre>
<p>To solve this, I modified the code by adding a <code>case</code> statement to handle the custom constant type 9 as an integer.</p>
<pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">char</span>* <span class="hljs-title">DecompileConstant</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Proto* f, <span class="hljs-keyword">int</span> i)</span> </span>{
	<span class="hljs-keyword">const</span> TValue* o = &amp;f-&gt;k[i];
	<span class="hljs-keyword">switch</span> (ttype(o)) {
	<span class="hljs-keyword">case</span> LUA_TBOOLEAN:
		<span class="hljs-keyword">return</span> strdup(bvalue(o)?<span class="hljs-string">&quot;true&quot;</span>:<span class="hljs-string">&quot;false&quot;</span>);
	<span class="hljs-keyword">case</span> LUA_TNIL:
		<span class="hljs-keyword">return</span> strdup(<span class="hljs-string">&quot;nil&quot;</span>);
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> LUA_VERSION_NUM == 501 || LUA_VERSION_NUM == 502</span>
	<span class="hljs-keyword">case</span> LUA_TNUMBER:
	{
		<span class="hljs-keyword">char</span>* ret = (<span class="hljs-keyword">char</span>*)<span class="hljs-built_in">calloc</span>(<span class="hljs-number">128</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>));
		<span class="hljs-built_in">sprintf</span>(ret, LUA_NUMBER_FMT, nvalue(o));
		<span class="hljs-keyword">return</span> ret;
	}
	<span class="hljs-keyword">case</span> <span class="hljs-number">9</span>:
  {
      <span class="hljs-keyword">char</span>* ret = (<span class="hljs-keyword">char</span>*)<span class="hljs-built_in">calloc</span>(<span class="hljs-number">128</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>));
      <span class="hljs-built_in">sprintf</span>(ret, LUA_INTEGER_FMT, ivalue(o)); 
      <span class="hljs-keyword">return</span> ret;
  }
	<span class="hljs-keyword">case</span> LUA_TSTRING:</code></pre>
<p>After modifying the code to print the value as an integer, you can see that the error is resolved as shown below.</p>
<pre><code class="hljs lua"><span class="hljs-comment">-- params : ...</span>
<span class="hljs-comment">-- function num : 0</span>
<span class="hljs-built_in">module</span>(<span class="hljs-string">&quot;luci.controller.login&quot;</span>, <span class="hljs-built_in">package</span>.<span class="hljs-built_in">seeall</span>)
<span class="hljs-keyword">local</span> l_0_0 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;luci.model.controller&quot;</span>)
<span class="hljs-keyword">local</span> l_0_1 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;nixio&quot;</span>)
<span class="hljs-keyword">local</span> l_0_2 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;nixio.fs&quot;</span>)
<span class="hljs-keyword">local</span> l_0_3 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;luci.sys&quot;</span>)
<span class="hljs-keyword">local</span> l_0_4 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;luci.util&quot;</span>)
<span class="hljs-keyword">local</span> l_0_5 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;luci.tools.error&quot;</span>)
<span class="hljs-keyword">local</span> l_0_6 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;luci.model.log&quot;</span>)
<span class="hljs-keyword">local</span> l_0_7 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;luci.tools.debug&quot;</span>)
<span class="hljs-keyword">local</span> l_0_8 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;luci.json&quot;</span>)
<span class="hljs-keyword">local</span> l_0_9 = (<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;luci.tools.datatypes&quot;</span>))
<span class="hljs-keyword">local</span> l_0_10 = <span class="hljs-literal">nil</span>
<span class="hljs-keyword">local</span> l_0_11 = <span class="hljs-string">&quot;/var/run/luci-attempts.lock&quot;</span>
<span class="hljs-keyword">local</span> l_0_12 = <span class="hljs-string">&quot;/tmp/luci-attempts&quot;</span>
<span class="hljs-keyword">local</span> l_0_13 = <span class="hljs-string">&quot;/tmp/TIME_STAMP&quot;</span>
<span class="hljs-keyword">local</span> l_0_14 = <span class="hljs-number">7200</span>
<span class="hljs-keyword">local</span> l_0_15 = <span class="hljs-number">10</span>
<span class="hljs-keyword">local</span> l_0_16 = <span class="hljs-number">88</span>
<span class="hljs-keyword">local</span> l_0_17 = <span class="hljs-number">14201</span>
<span class="hljs-keyword">local</span> l_0_18 = <span class="hljs-number">14203</span>
<span class="hljs-keyword">local</span> l_0_19 = <span class="hljs-number">24</span>
<span class="hljs-keyword">local</span> l_0_20 = <span class="hljs-number">13242</span>
<span class="hljs-keyword">local</span> l_0_21 = <span class="hljs-number">13243</span>
<span class="hljs-keyword">local</span> l_0_22 = <span class="hljs-string">&quot;users&quot;</span>
<span class="hljs-keyword">local</span> l_0_23 = <span class="hljs-string">&quot;02008001&quot;</span>
<span class="hljs-keyword">local</span> l_0_24 = <span class="hljs-number">4</span>
<span class="hljs-keyword">local</span> l_0_25 = <span class="hljs-string">&quot;02108001&quot;</span>
<span class="hljs-keyword">local</span> l_0_31 = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(l_1_0)</span></span>
...</code></pre>
<p>This allows us to interpret all the parts that were using uninterpreted variables.</p>
<p>The patched luadec tool can be found at the GitHub repository below!</p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/newp1ayer48/luadec-patched">https://github.com/newp1ayer48/luadec-patched</a></p>
<p>You can install and use it as follows.</p>
<pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/newp1ayer48/luadec-patched.git
<span class="hljs-built_in">cd</span> ./luadec-patched/luadec
chmod +x ./luadec
./luadec luaFile/lua</code></pre>
<p>The control flow analysis failure error is scheduled to be patched in the future. I plan to continue patching for custom Lua scripts from other products, devices, and environments as I encounter them.</p>
<p>When I first started analyzing the custom Lua, I felt quite lost. But as I analyzed the file and patched the tool, more and more parts became interpretable, which was very satisfying! I hope this article and the tool I patched can be helpful to others who are analyzing Lua files!</p>
<p>I&#x2019;ll be back with another embedded topic next time! Thanks for reading! &#x1F44B;&#x1F3FB;</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                <div class="post-meta mr-3">
                  <i class="iconfont icon-category"></i>
                  
                  <a class="hover-with-bg" href="/categories/Research/">Research</a>
                  
                </div>
                
                
                <div class="post-meta">
                  <i class="iconfont icon-tags"></i>
                  
                  <a class="hover-with-bg" href="/tags/newp1ayer48/">newp1ayer48</a>
                  
                  <a class="hover-with-bg" href="/tags/Embedded/">Embedded</a>
                  
                  <a class="hover-with-bg" href="/tags/Lua/">Lua</a>
                  
                  <a class="hover-with-bg" href="/tags/luadec/">luadec</a>
                  
                  <a class="hover-with-bg" href="/tags/luci/">luci</a>
                  
                  <a class="hover-with-bg" href="/tags/openwrt/">openwrt</a>
                  
                </div>
                
              </div>

              <div class="post-metas mb-3">
                <a class="hover-with-bg" style="display: flex;" href="/author">
                  <div class="link-avatar-page">
                    <img src="/img/profile_newp1ayer48.jpg" srcset="/img/loading.gif" alt="newp1ayer48">
                  </div>

                  <div class="link-text">
                    <div class="link-title">newp1ayer48</div>
                  </div>
                </a>
                <div class="link-text">
                  <div class="link-more">
                    <a href="/tags/newp1ayer48">
                      Read more
                      <i class="iconfont icon-arrowdown"></i>
                    </a>
                  </div>
                </div>
              </div>

              <hr>
              <!--<script data-ad-client="ca-pub-3672652207808168" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>-->
              
              <!--  -->
              <p class="note note-warning">본 글은 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.ko" rel="external nofollow noopener noreferrer">CC BY-SA 4.0</a> 라이선스로 배포됩니다. 공유 또는 변경 시 반드시 출처를 남겨주시기 바랍니다.</p>
              
              
              
              <div class="post-prevnext row">
                <article class="post-prev col-6">
                  
                  
                  <a href="/2025/10/04/newp1ayer48/lua/kr/">
                    <i class="iconfont icon-arrowleft"></i>
                    <span class="hidden-mobile">[Research] Custom Lua Script  Decompile (KR)</span>
                    <span class="visible-mobile">Previous</span>
                  </a>
                  
                </article>
                <article class="post-next col-6">
                  
                  
                  <a href="/2025/10/01/ji9umi/CVE-2025-48062/">
                    <span class="hidden-mobile">[하루한줄] CVE-2025-48062: Discourse의 Topic 초대 시 전송되는 이메일을 통한 HTML Injection 취약점</span>
                    <span class="visible-mobile">Next</span>
                    <i class="iconfont icon-arrowright"></i>
                  </a>
                  
                </article>
              </div>
              
            </div>
            
            <!-- Embed Section -->
            <div style="width: 100%; height: 210px; margin-bottom: 50px; overflow: hidden;">
              <iframe src="https://maily.so/hackyboiz/embed?src=embed" style="width: 100%; height: 100%; border: none;" frameborder="0"></iframe>
            </div>            

            
            <!-- Comments -->
            <article class="comments" id="comments">
              
              
  <div class="disqus" style="width:100%">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'https://hackyboiz.github.io/2025/10/04/newp1ayer48/lua/en/';
        this.page.identifier = '/2025/10/04/newp1ayer48/lua/en/';
      };
      function loadDisqus() {
        (function () {
          var d = document,
            s = d.createElement('script');
          s.src = '//' + 'hackyboiz' + '.disqus.com/embed.js';
          s.setAttribute('data-timestamp', new Date());
          (d.head || d.body).appendChild(s);
        })();
      }
      waitElementVisible('disqus_thread', loadDisqus);
    </script>
    <noscript>Please enable JavaScript to view the
      <a target="_blank" href="https://disqus.com/?ref_noscript" rel="external nofollow noopener noreferrer">comments powered by Disqus.</a>
    </noscript>
  </div>


            </article>
            
          </article>
        </div>
      </div>
    </div>
    
    <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
      <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div id="tocbot"></div>
</div>

    </div>
    
  </div>
</div>

<!-- Custom -->

    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="external nofollow noopener noreferrer"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="external nofollow noopener noreferrer">
        <span>Fluid</span></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script>
<script src="/js/debouncer.js"></script>
<script src="/js/main.js"></script>

<!-- Plugins -->


  
    <script src="/js/lazyload.js"></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script>
  <script src="/js/clipboard-use.js"></script>







  <script src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js"></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js"></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "[Research] Custom Lua Script  Decompile (EN)&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js"></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script src="/js/local-search.js"></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css">

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>





  

  
    <!-- MathJax -->
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        options: {
          renderActions: {
            findScript: [10, doc => {
              document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                const display = !!node.type.match(/; *mode=display/);
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                const text = document.createTextNode('');
                node.parentNode.replaceChild(text, node);
                math.start = { node: text, delim: '', n: 0 };
                math.end = { node: text, delim: '', n: 0 };
                doc.math.push(math);
              });
            }, '', false],
            insertedScript: [200, () => {
              document.querySelectorAll('mjx-container').forEach(node => {
                let target = node.parentNode;
                if (target.nodeName.toLowerCase() === 'li') {
                  target.parentNode.classList.add('has-jax');
                }
              });
            }, '', false]
          }
        }
      };
    </script>

    <script async src="https://cdn.staticfile.org/mathjax/3.0.5/es5/tex-svg.js"></script>

  













  

  
    <!-- Google Analytics -->
    <script defer>
      window.ga = window.ga || function () { (ga.q = ga.q || []).push(arguments) };
      ga.l = +new Date;
      ga('create', 'UA-177243668-2', 'auto');
      ga('send', 'pageview');
    </script>
    <script async src="https://www.google-analytics.com/analytics.js"></script>
  

  
    <!-- Google gtag.js -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-177243668-2"></script>
    <script defer>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-177243668-2');
    </script>
  

  

  

  





</body>
</html>
