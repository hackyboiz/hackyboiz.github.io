---
title: "[í•˜ë£¨í•œì¤„] CVE-2025-21298: Windows OLE Double Free ì·¨ì•½ì "
author: mungsul
tags: [Windows, RCE, mungsul, Double-Free]
categories: [1day1line]
date: 2025-02-08 17:00:00
cc: true
index_img: /img/1day1line.png
---
## URL

- https://github.com/ynwarcs/CVE-2025-21298
- https://msrc.microsoft.com/update-guide/vulnerability/CVE-2025-21298

## Target

- Windows 10 Version 1809 affected from 10.0.17763.0 before 10.0.17763.6775
- Windows Server 2019 affected from 10.0.17763.0 before 10.0.17763.6775
- Windows Server 2019 (Server Core installation) affected from 10.0.17763.0 before 10.0.17763.6775
- Windows Server 2022 affected from 10.0.20348.0 before 10.0.20348.3091
- Windows 10 Version 21H2 affected from 10.0.19043.0 before 10.0.19044.5371
- Windows 11 version 22H2 affected from 10.0.22621.0 before 10.0.22621.4751
- Windows 10 Version 22H2 affected from 10.0.19045.0 before 10.0.19045.5371
- Windows Server 2025 (Server Core installation) affected from 10.0.26100.0 before 10.0.26100.2894
- Windows 11 version 22H3 affected from 10.0.22631.0 before 10.0.22631.4751
- Windows 11 Version 23H2 affected from 10.0.22631.0 before 10.0.22631.4751
- Windows Server 2022, 23H2 Edition (Server Core installation) affected from 10.0.25398.0 before 10.0.25398.1369
- Windows 11 Version 24H2 affected from 10.0.26100.0 before 10.0.26100.2894
- Windows Server 2025 affected from 10.0.26100.0 before 10.0.26100.2894
- Windows 10 Version 1507 affected from 10.0.10240.0 before 10.0.10240.20890
- Windows 10 Version 1607 affected from 10.0.14393.0 before 10.0.14393.7699
- Windows Server 2016 affected from 10.0.14393.0 before 10.0.14393.7699
- Windows Server 2016 (Server Core installation) affected from 10.0.14393.0 before 10.0.14393.7699
- Windows Server 2008 Service Pack 2 affected from 6.0.6003.0 before 6.0.6003.23070
- Windows Server 2008 Service Pack 2 (Server Core installation) affected from 6.0.6003.0 before 6.0.6003.23070
- Windows Server 2008 Service Pack 2 affected from 6.0.6003.0 before 6.0.6003.23070
- Windows Server 2008 R2 Service Pack 1 affected from 6.1.7601.0 before 6.1.7601.27520
- Windows Server 2008 R2 Service Pack 1 (Server Core installation) affected from 6.1.7601.0 before 6.1.7601.27520
- Windows Server 2012 affected from 6.2.9200.0 before 6.2.9200.25273
- Windows Server 2012 (Server Core installation) affected from 6.2.9200.0 before 6.2.9200.25273
- Windows Server 2012 R2 affected from 6.3.9600.0 before 6.3.9600.22371
- Windows Server 2012 R2 (Server Core installation) affected from 6.3.9600.0 before 6.3.9600.22371


## Explain

Windows OLE ì—ì„œ Double Free ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. MS Word ì™€ ê°™ì€ OLEë¥¼ ì‚¬ìš©í•˜ëŠ” MS Office ë¥˜ë“¤ì—ì„œ ì·¨ì•½ì ì„ íŠ¸ë¦¬ê±°í•  ìˆ˜ ìˆê¸°ì— ìƒë‹¹íˆ ì˜í–¥ë„ê°€ ë†’ì€ RCE ì·¨ì•½ì ì´ë¼ê³  ë³´ì—¬ì§€ë„¤ìš”.

OLE (Object Linking and Embedding) ëŠ” Windows ì˜ ê°ì¢… í”„ë¡œê·¸ë¨ë“¤ì´ ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ëŠ” ê¸°ëŠ¥ ì¤‘ì— í•˜ë‚˜ì…ë‹ˆë‹¤. ëŒ€í‘œì ìœ¼ë¡œ ë¬¸ì„œ ê°„ ë°ì´í„° ê³µìœ ë¥¼ í•  ë•Œ ì‚¬ìš©ë˜ëŠ”ë°ìš”. ì˜ˆë¥¼ ë“¤ì–´ì„œ ì´ë¯¸ì§€ í•˜ë‚˜ê°€ ì—¬ëŸ¬ ë¬¸ì„œ íŒŒì¼ì— ì‚½ì…ë˜ì—ˆë‹¤ê³  í•´ë´…ì‹œë‹¤. 

ì´ë¯¸ì§€ê°€ ë³€ê²½ëœë‹¤ë©´ ì‚½ì…ëœ ëª¨ë“  ë¬¸ì„œë“¤ì˜ ì´ë¯¸ì§€ë¥¼ ë³€ê²½í•´ì•¼í•´ì„œ ìƒë‹¹íˆ ë¶ˆí¸í•  ê²ë‹ˆë‹¤. ì´ ë•Œ, ë¬¸ì„œ í•˜ë‚˜ì—ì„œ ì´ë¯¸ì§€ë¥¼ ë³€ê²½í•´ë„ ë‹¤ë¥¸ ë¬¸ì„œë“¤ì— ë‹¤ ë°˜ì˜ë˜ê²Œë” í•˜ëŠ”ê²Œ OLE ì˜ ì¥ì  ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤.

ë‹¤ë§Œ ì´ëŸ° ê°•ë ¥í•œ ê¸°ëŠ¥ ë•ë¶„ì— ìˆ˜ ë…„ê°„ ë§ì€ ì·¨ì•½ì ë“¤ì´ ì´ OLE ê¸°ëŠ¥ í†µí•´ ë°œê²¬ë˜ê³¤ í•˜ì˜€ìŠµë‹ˆë‹¤. ğŸ˜¢

### Root Cause

`ole32.dll` ì˜ `UtOlePresStmToContentsStm` ë¼ëŠ” í•¨ìˆ˜ì—ì„œ ì·¨ì•½ì ì´ ë°œìƒí–ˆëŠ”ë°ìš”. ì´ í•¨ìˆ˜ëŠ” OlePres ìŠ¤íŠ¸ë¦¼ ë‚´ ë°ì´í„°ë¥¼ ì ì ˆí•˜ê²Œ ë³€í™˜í•´ì„œ `CONTENTS` ë¼ëŠ” ìŠ¤íŠ¸ë¦¼ì— ì‚½ì…í•˜ê²Œë” êµ¬í˜„ëœ ì½”ë“œì…ë‹ˆë‹¤. 

ì•„ë˜ ì½”ë“œëŠ” 2025ë…„ 1ì›”ì— íŒ¨ì¹˜ëœ `UtOlePresStmToContentsStm` í•¨ìˆ˜ë¥¼ ë””í•‘í•œ ê²°ê³¼ì…ë‹ˆë‹¤. ì½”ë“œë¥¼ ë³´ì‹œë©´ `CONTENTS` ìŠ¤íŠ¸ë¦¼ìš© `pstmContents` ë¥¼ í• ë‹¹í•˜ê³ ì„œ ì¦‰ì‹œ í•´ì œë¥¼ í•˜ëŠ”ë°ìš”. `OlePres` ìŠ¤íŠ¸ë¦¼ì´ ì„¸íŒ…ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´ `OpenStream` í•¨ìˆ˜ê°€ ì‹¤íŒ¨í•˜ê³  ì´ì–´ì„œ `UtReadOlePresStmHeader` í•¨ìˆ˜ë„ ì‹¤íŒ¨í•˜ì—¬ `pstmContents` ì´ ê°’ì„ ê°€ë¦¬í‚¤ëŠ” ì±„ë¡œ í•´ì œë¥¼ í•œ ë²ˆ ë” í•˜ê²Œ ë©ë‹ˆë‹¤.


```
__int64 __fastcall UtOlePresStmToContentsStm(IStorage *pstg, wchar_t *puiStatus, __int64 a3, unsigned int *lpszPresStm)
{
  struct IStorageVtbl *lpVtbl; // rax
  int v7; // r14d
+ bool IsEnabled; // al
  IStream *v10; // rcx
  bool v11; // zf
  struct IStorageVtbl *v12; // rax
  int v13; // ebx
  HRESULT v14; // eax
  const wchar_t *v15; // rdx
  IStream *pstmContents; // [rsp+40h] [rbp-19h] BYREF
  IStream *pstmOlePres; // [rsp+48h] [rbp-11h] BYREF
  tagFORMATETC foretc; // [rsp+50h] [rbp-9h] BYREF
  tagHDIBFILEHDR hdfh; // [rsp+70h] [rbp+17h] BYREF

  *lpszPresStm = 0;
  lpVtbl = pstg->lpVtbl;
  pstmContents = 0LL;
  v7 = 1;
 
  // "CONTENTS" ìŠ¤íŠ¸ë¦¼ì„ ìƒì„±í•˜ê³  pstmContents ì— ì €ì¥
  if ( (lpVtbl->CreateStream)(pstg, L"CONTENTS", 18LL, 0LL, 0, &pstmContents) )
    return 0LL;

  // pstmContents ë¥¼ ì¦‰ì‹œ í•´ì œ.
  (pstmContents->lpVtbl->Release)(pstmContents);
+ IsEnabled = wil::details::FeatureImpl<__WilFeatureTraits_Feature_3047977275>::__private_IsEnabled(&`wil::Feature<__WilFeatureTraits_Feature_3047977275>::GetImpl'::`2'::impl);
+ v10 = pstmContents;
+ v11 = !IsEnabled;
  v12 = pstg->lpVtbl;
+ if ( !v11 )
+   v10 = 0LL;
+ pstmContents = v10;
  (v12->DestroyElement)(pstg, L"CONTENTS");

  v13 = (pstg->lpVtbl->OpenStream)(pstg, &OlePres, 0LL, 16LL, 0, &pstmOlePres);
  if ( v13 )
  {
    *lpszPresStm |= 1u;
    if ( (pstg->lpVtbl->OpenStream)(pstg, L"CONTENTS", 0LL, 16LL, 0, &pstmContents) )
    {
      *lpszPresStm |= 2u;
    }
    else
    {
      // ì´ìª½ ë¶„ê¸°ë¥¼ íƒ€ë„ë¡ íŠ¸ë¦¬ê±°
      (pstmContents->lpVtbl->Release)(pstmContents);
+     wil::details::FeatureImpl<__WilFeatureTraits_Feature_3047977275>::__private_IsEnabled(&`wil::Feature<__WilFeatureTraits_Feature_3047977275>::GetImpl'::`2'::impl);
    }
    return v13;
  }
  foretc.ptd = 0LL;
  v13 = UtReadOlePresStmHeader(pstmOlePres, &foretc, 0LL, 0LL);
  if ( v13 >= 0 )
  {
    v13 = (pstmOlePres->lpVtbl->Read)(pstmOlePres, &hdfh, 16LL);
    if ( v13 >= 0 )
    {
      v13 = OpenOrCreateStream(pstg, L"CONTENTS", &pstmContents);
      if ( v13 < 0 )
      {
        *lpszPresStm |= 2u;
        goto $errRtn_197;
      }
      if ( foretc.dwAspect == 4 )
      {
        *lpszPresStm |= 4u;
        v7 = 0;
        v13 = 0;
        goto $errRtn_197;
      }
      if ( foretc.cfFormat == 8 )
      {
        v14 = UtDIBStmToDIBFileStm(pstmOlePres, hdfh.dwSize, pstmContents);
LABEL_19:
        v13 = v14;
        goto $errRtn_197;
      }
      if ( foretc.cfFormat == 3 )
      {
        v14 = UtMFStmToPlaceableMFStm(pstmOlePres, hdfh.dwSize, hdfh.dwWidth, hdfh.dwHeight, pstmContents);
        goto LABEL_19;
      }
      v13 = -2147221398;
    }
  }
$errRtn_197:
  if ( pstmOlePres )
    (pstmOlePres->lpVtbl->Release)(pstmOlePres);
  // pstmContents ë‚´ ê°’ì´ ìˆë‹¤ë©´ í•´ì œ ì§„í–‰.
  if ( pstmContents )
    (pstmContents->lpVtbl->Release)(pstmContents);
  if ( foretc.ptd )
    CoTaskMemFree(foretc.ptd);
  if ( v13 )
  {
    v15 = L"CONTENTS";
    goto LABEL_31;
  }
  if ( v7 )
  {
    v15 = &OlePres;
LABEL_31:
    (pstg->lpVtbl->DestroyElement)(pstg, v15);
  }
  return v13;
}

```
íŒ¨ì¹˜ëœ ë¼ì¸ì„ ë³´ë©´ IsEnabled ë¼ëŠ” flag ë¥¼ í•˜ë‚˜ ì¶”ê°€í•´ì„œ `pstmContents` ì˜ í•´ì œ ì—¬ë¶€ë¥¼ íŒë‹¨í•˜ê³  í•´ì œê°€ ë˜ì—ˆìœ¼ë©´ 0ìœ¼ë¡œ ì´ˆê¸°í™” í•˜ê²Œë” íŒ¨ì¹˜ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.



## Reference

- https://msrc.microsoft.com/update-guide/vulnerability/CVE-2025-21298

- https://asec.ahnlab.com/ko/tag/cve-2025-21298-ko/

- https://www.offsec.com/blog/cve-2025-21298/

- https://github.com/ynwarcs/CVE-2025-21298/blob/main/diff/ole32_dec24.dll-ole32_jan25.dll.ghidriff.md