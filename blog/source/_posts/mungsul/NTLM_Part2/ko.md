---
title: "[Research] Windows Authentication Series (Part2. Kerberos)(KR)"
author: mungsul
tags: [mungsul, Kerberos, Windows, Authentication]
categories: [Research]
date: 2025-04-21 23:00:00
cc: true
index_img: /2025/04/21/mungsul/NTLM_Part2/ko/thumbnail.jpg
---

# Introduction

μ•λ…•ν•μ„Έμ”. Windows Authentication Series λ΅ λ‹¤μ‹ μ°Ύμ•„λµ™κ² λμ—μµλ‹λ‹¤. Part1 NTLM λ•λ” Part2 λ• NTLM κ΄€λ ¨ CVE λ¥Ό μ‚΄ν΄λ³Ό μμ •μ΄λΌκ³  ν–μ—λ”λ°μ”. NTLM κ΄€λ ¨ CVEλ¥Ό λ‹¤λ£¨λ” κ²ƒλ„ μΆ‹μ§€λ§ Windows μ—μ„ μ£Όλ΅ μ‚¬μ©λλ” Kerberos μΈμ¦ ν”„λ΅ν† μ½μ— λ€ν•΄μ„ λ¨Όμ € λ‹¤λ¤„λ΄μ•Όκ² λ‹¤ μ‹¶μ–΄μ„ λ‚΄μ©μ„ μ¤€λΉ„ν•΄λ΄¤μµλ‹λ‹¤.

μ΄ κΈ€μ—μ„λ” Kerberos μ κΈ°λ³Έμ μΈ μ‘λ™ μ›λ¦¬λ¶€ν„° Windows ν™κ²½μ—μ„μ κµ¬ν„ λ°©μ‹, Kerberos κ΄€λ ¨ κ³µκ²©κ³Ό κ΄€λ ¨ CVE μ·¨μ•½μ  λ‡ μΆ…μ„ λ¶„μ„ν•΄λ³΄λ” μ‹κ°„μ„ κ°€μ Έλ³΄λ„λ΅ ν•κ² μµλ‹λ‹¤.

# Kerberos μΈμ¦

Kerberos λ” ν‹°μΌ“ κΈ°λ°μ μΈμ¦ ν”„λ΅ν† μ½μ…λ‹λ‹¤. μ΄ ν”„λ΅ν† μ½μ€ KDC λ¥Ό ν†µν•΄ λ€μΉ­ ν‚¤ μ•”νΈν™” κΈ°λ°μ ν‹°μΌ“μ„ λ°κΈ‰ν•¨μΌλ΅μ¨ ν¨μ¤μ›λ“ μμ²΄λ¥Ό λ„¤νΈμ›ν¬μ— λ…Έμ¶ν•μ§€ μ•κ³ λ„ μ‚¬μ©μμ™€ μ„λΉ„μ¤κ°€ μƒνΈ μΈμ¦μ„ μν–‰ν•κ² ν•΄μ¤λ‹λ‹¤.

μ΄ μΈμ¦ κµ¬μ΅°μ—μ„λ” λ‹¤μκ³Ό κ°™μ€ μ”μ†κ°€ λ“±μ¥ν•©λ‹λ‹¤.

- KDC (Key Distribution Center): ν‚¤ λ°°ν¬ μ„Όν„°, AS μ™€ TGS λ¥Ό λ¬¶μ€ μ”μ†λ΅ μΈμ¦ μ„λΉ„μ¤ μ κ³µ λ° μ„Έμ…ν‚¤ μƒμ„±, λ¶„λ°°λ¥Ό μν–‰ν•©λ‹λ‹¤.
- AS (Authentication Server): μΈμ¦ μ„λ²„, ν΄λΌμ΄μ–ΈνΈμ μΈμ¦μ„ μν–‰ν•κ³  ν΄λΌμ΄μ–ΈνΈμ—κ² TGSμ λΉ„λ°€ν‚¤λ΅ μ•”νΈν™”λ TGTλ¥Ό λ°κΈ‰ν•©λ‹λ‹¤.
- TGS (Ticket Granting Server): ν‹°μΌ“ λ¶€μ—¬ μ„λ²„, ν΄λΌμ΄μ–ΈνΈκ°€ TGTλ¥Ό TGS μ— λ³΄λ‚΄λ©΄ ST μ™€ μ„Έμ…ν‚¤λ¥Ό λ°κΈ‰ν•©λ‹λ‹¤.
- TGT (Ticket Granting Ticket): ν‹°μΌ“ λ¶€μ—¬ ν‹°μΌ“, TGS μ—μ„ ν‹°μΌ“μ„ λ°κΈ‰λ°›μ„ μ μλ” ν‹°μΌ“μ…λ‹λ‹¤.
- ST (Service Ticket): μ„λΉ„μ¤λ¥Ό μ΄μ©ν•  μ μλ” ν‹°μΌ“μ…λ‹λ‹¤.
- SS (Service Server): μ„λΉ„μ¤λ¥Ό μ κ³µν•λ” μ„λ²„μ…λ‹λ‹¤.

Kerberos μΈμ¦ μ μ°¨λ¥Ό κ°„λ‹¨ν•κ² μ •λ¦¬ν•λ©΄ λ‹¤μκ³Ό κ°™μµλ‹λ‹¤.

1. ν΄λΌμ΄μ–ΈνΈκ°€ AS μ— μΈμ¦ μ”μ²­μ„ ν•©λ‹λ‹¤.
2. AS κ°€ ν΄λΌμ΄μ–ΈνΈμ—κ² TGT λ¥Ό λ°κΈ‰ν•©λ‹λ‹¤.
    1. μ΄ λ•, TGTλ” TGS μ λΉ„λ°€ν‚¤λ΅ μ•”νΈν™” λ©λ‹λ‹¤.
    2. AS, TGS λ” KDCλ΅ μΌλ°μ μΌλ΅ κ°™μ€ νΈμ¤νΈλ¥Ό κ³µμ ν•©λ‹λ‹¤.
3. ν΄λΌμ΄μ–ΈνΈκ°€  TGT μ™€ μ”μ²­ν•  μ„λΉ„μ¤μ ID λ¥Ό TGS μ— μ „λ‹¬ν•©λ‹λ‹¤.
4. TGS κ°€ ν΄λΌμ΄μ–ΈνΈμ—κ² ST λ¥Ό λ°κΈ‰ν•©λ‹λ‹¤.
    1. μ΄ λ•, ν΄λΌμ΄μ–ΈνΈκ°€ μ ‘κ·Ό μ”μ²­ν•λ” μ„λΉ„μ¤λ” SPN (Service Principal Name) μΌλ΅ TGSμ— λ“±λ΅λμ–΄ μμ–΄μ•Ό ν•©λ‹λ‹¤.
5. ν΄λΌμ΄μ–ΈνΈκ°€ STλ¥Ό μ„λ²„μ— μ „λ‹¬ν•©λ‹λ‹¤.
6. ν†µμ‹ μ„ μν–‰ν•©λ‹λ‹¤.

μ„ κ³Όμ •μ„ λ„μ‹ν™”ν• κ·Έλ¦Όμ€ λ‹¤μκ³Ό κ°™μµλ‹λ‹¤.

![](ko/1.png)

## Windowsμ—μ„μ Kerberos μΈμ¦

Windows Kerberos κµ¬ν„μ—μ„λ” ν‹°μΌ“μ— PAC (Privilege Attribute Certificate) λΌλ”κ² ν¬ν•¨λ©λ‹λ‹¤. PAC λ” μ‚¬μ©μμ κ·Έλ£Ή μ •λ³΄μ™€ κ¶ν• λ°μ΄ν„° λ“±μ„ ν¬ν•¨ν•λ”λ°μ”. KDCκ°€ μ΄ μ •λ³΄λ¥Ό μ„λ…ν•μ—¬ ν‹°μΌ“μ„ λ°κΈ‰ν•κ² λ©λ‹λ‹¤. μ„λΉ„μ¤ μ„λ²„λ” ν‹°μΌ“μ΄ μ¤λ©΄ PACλ¥Ό λ³΄κ³  κ¶ν•μ„ ν™•μΈν•μ—¬ μ ‘κ·Όμ„ ν—μ©ν•κ±°λ‚ κ±°λ¶€μ‹ν‚µλ‹λ‹¤.

μ, Windows μ—μ„λ” μ„μ—μ„ λ€λµμ μΌλ΅ μ„¤λ…ν• Kerberos μΈμ¦ κ³Όμ •μ„ λ‹¤μ κ·Έλ¦Όμ²λΌ μ§„ν–‰ν•λ”λ°μ”. 

λ¨Έλ¦¬κ°€ μ•„ν”„μ§€λ§ ν•λ‚ν•λ‚ μ‚΄ν΄λ³΄λ„λ΅ ν•κ² μµλ‹λ‹¤.

![](ko/2.png)

**1) AS-REQ**

AS-REQ μ—μ„λ” ν΄λΌμ΄μ–ΈνΈκ°€ KDC μ μΈμ¦ μ„λΉ„μ¤μ— μμ‹ μ IDλ΅ ν‹°μΌ“μ„ μ”μ²­ν•©λ‹λ‹¤. Windows κΈ°λ³Έ μ„¤μ • μƒ, μ‚¬μ „ μΈμ¦μ„ ν†µν•΄ μ‚¬μ©μκ°€ ν„μ¬ μ‹κ°μ„ μμ‹ μ λΉ„λ°€ν‚¤ (NTLM hash) λ΅ μ•”νΈν™”ν•μ—¬ λ³΄λƒ…λ‹λ‹¤. KDCλ” DC(Domain Controller) μ— λ³΄κ΄€λμ–΄ μλ” μ‚¬μ©μμ NTLM hash λ΅ μ΄λ¥Ό λ³µνΈν™”ν•μ—¬ μ‚¬μ©μλ¥Ό μΈμ¦ν•©λ‹λ‹¤.

**2) AS-REP** 

AS-REQ μ—μ„ κ²€μ¦μ΄ μ„±κ³µν•λ©΄ AS-REP μ‘λ‹µμΌλ΅ ν΄λΌμ΄μ–ΈνΈμ—κ² **TGTμ™€ μ„Έμ…ν‚¤(ν΄λΌμ΄μ–ΈνΈ-TGS)** λ¥Ό λ°κΈ‰ν•©λ‹λ‹¤. μ„Έμ…ν‚¤λ” μ‚¬μ©μμ NTLM hashλ΅ μ•”νΈν™”λλ©° TGTλ” **KDCμ λ§μ¤ν„° ν‚¤ (krbtgt κ³„μ •μ NTLM hash)** λ΅ μ•”νΈν™” λμ–΄ μκΈ°μ— ν΄λΌμ΄μ–ΈνΈλ” TGTλ¥Ό λ³µνΈν™”ν•  μλ” μ—†μµλ‹λ‹¤.

**3) TGS-REQ** 

ν΄λΌμ΄μ–ΈνΈκ°€ μ„λΉ„μ¤ μ„λ²„μ— μ ‘κ·Όμ΄ ν•„μ”ν•  λ• TGT λ¥Ό TGS-REQ λ©”μ‹μ§€μ— μ‹¤μ–΄μ„ KDCμ TGS μ— λ³΄λƒ…λ‹λ‹¤. μ΄ μ”μ²­μ—λ” λ€μƒ μ„λΉ„μ¤μ SPN κ³Ό μ•μ„ λ°κΈ‰λ ν΄λΌμ΄μ–ΈνΈ-TGSκ°„ μ„Έμ…ν‚¤λ„ ν¬ν•¨ν•©λ‹λ‹¤.

**4) TGS-REP** 

KDCλ” TGS-REQλ¥Ό λ°›μ•„μ„ TGTκ°€ μ ν¨ν•μ§€ ν™•μΈν•©λ‹λ‹¤. TGT λ” KDC μ λ§μ¤ν„°ν‚¤λ΅ μ•”νΈν™” λμ–΄ μκΈ°μ— KDCκ°€ λ³µνΈν™” ν•μ—¬ κ²€μ¦ν•  μ μμµλ‹λ‹¤. 

κ·Έλ¦¬κ³  ν•΄λ‹Ή μ‚¬μ©μκ°€ μ”μ²­ν• μ„λΉ„μ¤μ— μ ‘κ·Ό κ¶ν•μ΄ ν™•μΈν•κ³  λ¬Έμ κ°€ μ—†μΌλ©΄ TGS-REP μ‘λ‹µμ„ ν΄λΌμ΄μ–ΈνΈμ—κ² λ³΄λƒ…λ‹λ‹¤. 

μ—¬κΈ°μ—λ” **μ„Έμ… ν‚¤**(**ν΄λΌμ΄μ–ΈνΈ-μ„λΉ„μ¤ μ„λ²„**)μ™€ **μ„λΉ„μ¤ ν‹°μΌ“(ST)**μ΄ ν¬ν•¨λ©λ‹λ‹¤. 

μ„λΉ„μ¤ ν‹°μΌ“μ€ ν•΄λ‹Ή μ„λΉ„μ¤ κ³„μ •μ λΉ„λ°€ ν‚¤(μ„λΉ„μ¤ κ³„μ •μ NTLM hash)λ΅ μ•”νΈν™”λμ–΄ μμΌλ―€λ΅ **μ„λΉ„μ¤λ§** λ³µνΈν™” ν•μ—¬ μ—΄λν•  μ μκ³  ν΄λΌμ΄μ–ΈνΈλ” λ‚΄μ©μ„ μ• μ μ—†μµλ‹λ‹¤. ν΄λΌμ΄μ–ΈνΈλ” μ΄ STλ¥Ό λ°›μ•„λ‘μ—λ‹¤κ°€ μ‹¤μ  μ„λΉ„μ¤μ— μ ‘μ†ν•  λ• μ‚¬μ©ν•κ² λ©λ‹λ‹¤.

**5) AP-REQ**

μµμΆ…μ μΌλ΅ ν΄λΌμ΄μ–ΈνΈλ” μ„λΉ„μ¤ ν‹°μΌ“μ„ λ“¤κ³  AP-REQ λ¥Ό λ€μƒ μ„λ²„(μ„λΉ„μ¤)μ— μ μ‹ν•μ—¬ μ ‘μ†μ„ μ‹λ„ν•©λ‹λ‹¤. μ΄λ• ν΄λΌμ΄μ–ΈνΈλ” μμ‹ μ μ‹ μ›μ„ μ¦λ…ν•κΈ° μ„ν•΄ μ•μ„ λ°›μ€ μ„λΉ„μ¤ μ„Έμ… ν‚¤λ΅ μ•”νΈν™”ν• μΈμ¦μ(Authenticator, νƒ€μ„μ¤νƒ¬ν”„ λ“±)λ„ ν•¨κ» λ³΄λƒ…λ‹λ‹¤.

μ„λ²„λ” λ„λ©”μΈ μ»¨νΈλ΅¤λ¬μ— KERB_VERIFY_PAC λ©”μ‹μ§€λ¥Ό μ „μ†΅ν•μ—¬ μ„λΉ„μ¤ ν‹°μΌ“ λ‚΄ PAC μ μ„λ… κ²€μ¦μ„ ν•©λ‹λ‹¤. μ΄ PACλ” KDCμ μ„λ…μΌλ΅ λ³΄νΈλλ©°, μ„λΉ„μ¤λ” ν‹°μΌ“μ„ κ²€μ¦ν•  λ• PACμ λ¬΄κ²°μ„±μ„ ν™•μΈν•¨μΌλ΅μ¨ μ‚¬μ©μμ λ„λ©”μΈ λ‚΄ κ¶ν•μ„ μ‹ λΆ°ν•  μ μμµλ‹λ‹¤.

![](ko/3.png)

**6) AP-REP** 

μ„λΉ„μ¤ μ„λ²„μ—μ„λ” ν΄λΌμ΄μ–ΈνΈκ°€ μ μ‹ν• μ„λΉ„μ¤ ν‹°μΌ“μ PACλ¥Ό ν™•μΈν•κ³  κ²€μ¦μ΄ μ„±κ³µν•λ©΄ μ„λ²„λ” AP-REP λ©”μ‹μ§€λ΅ ν΄λΌμ΄μ–ΈνΈμ—κ² μ‘λ‹µμ„ λ³΄λ‚΄ μ„Έμ… ν‚¤ ν‘μƒμ„ μ™„λ£μ‹ν‚µλ‹λ‹¤. μ΄ν›„ ν΄λΌμ΄μ–ΈνΈλ” ν•΄λ‹Ή μ„λΉ„μ¤μ— μ ‘κ·Όμ΄ ν—μ©λ©λ‹λ‹¤. 

---

μ„¤λ…μ—μ„ μ• μ μλ“―μ΄, Windows μ—μ„μ Kerberos μΈμ¦μ€ μ„λ΅ κ³µμ λλ” μ•”νΈν‚¤κ°€ μ‚¬μ©μμ NTLM hash μ΄λ©° PAC λΌκ³  ν•λ” κ¶ν• μ •λ³΄κ°€ ν‹°μΌ“μ— λ‹΄κ²¨μκ³  PACλ” KDCκ°€ μ„λ…ν•μ—¬ λ¬΄κ²°μ„±μ„ ν™•λ³΄ν•©λ‹λ‹¤.

# Kerberos κ΄€λ ¨ κ³µκ²©

Kerberos ν”„λ΅ν† μ½ μμ²΄λ” μ•μ „ν•κ² μ„¤κ³„λμ—μΌλ‚, κµ¬ν„μƒ μ„¤μ •μ΄λ‚ μ΄μ ν™κ²½μ— λ”°λΌ λ‹¤μ–‘ν• κ³µκ²© κΈ°λ²•μ΄ μ—°κµ¬λμ–΄ μ™”μµλ‹λ‹¤. Windows Kerberos ν™κ²½μ—μ„ μ£Όλ΅ λ‹¤λ¤„μ§€λ” κ³µκ²© κΈ°λ²•λ“¤μ— λ€ν•΄μ„ μ•μ•„λ΄…μ‹λ‹¤.

## Kerberoasting

Kerberoasting μ€ ν•©λ²•μ μΈ λ„λ©”μΈ μ‚¬μ©μ κ³„μ •μΌλ΅ **μ„λΉ„μ¤ κ³„μ •**μ Kerberos ν‹°μΌ“μ„ μ”μ²­ν• ν›„, ν‹°μΌ“μ— ν¬ν•¨λ μ•”νΈν™”λ μ •λ³΄λ¥Ό ν¬λ™ν•μ—¬ μ„λΉ„μ¤ κ³„μ •μ ν¨μ¤μ›λ“λ¥Ό νƒμ·¨ν•λ” κ³µκ²© κΈ°λ²•μ…λ‹λ‹¤.

AD λ„λ©”μΈ μ•μ— μλ” μ‚¬μ©μλΌλ©΄ SPN μ†μ„±μ΄ μλ” κ³„μ •μ— λ€ν•΄μ„ TGS-REQ λ¥Ό ν†µν•΄ μ„λΉ„μ¤ ν‹°μΌ“μ„ μ”μ²­ν•  μ μμµλ‹λ‹¤.  μ¦‰, κ³µκ²©μκ°€ λ„λ©”μΈ λ‚΄λ΅ μ΄λ―Έ μΉ¨ν¬ν• μƒνƒμ—μ„ μ‚¬μ©ν•  μ μλ” κΈ°λ²•μ΄μ£ .

μ„λΉ„μ¤ ν‹°μΌ“μ€ NTLM hash λ΅ μ•”νΈν™”λμ–΄ μκΈ° λ•λ¬Έμ— ν¬λ™μ΄ μ„±κ³µν•λ‹¤λ©΄ NTLM hash λ¥Ό μ•μ•„λ‚΄λ” κ²ƒμ΄λ©° μ΄ hash λ¥Ό μ–»μ—λ‹¤λ” κ²ƒμ€ Windows ν™κ²½μ—μ„ ν¨μ¤μ›λ“λ¥Ό μ–»μ–΄λ‚Έ κ²ƒκ³Ό λ‹¤λ¦„μ΄ μ—†μµλ‹λ‹¤.

## AS-REP Roasting

**AS-REP Roasting**μ€ Kerberoastingκ³Ό μ μ‚¬ν•μ§€λ§, **Kerberos Pre-Authenticationμ΄ λΉ„ν™μ„±ν™”**λ μ‚¬μ©μλ¥Ό ν‘μ μΌλ΅ ν•λ” κΈ°λ²•μ…λ‹λ‹¤.

μ‚¬μ „ μΈμ¦μ€ TGT κ°€ λ°κΈ‰λκΈ° μ „μ— μ‚¬μ „μ— κ³µμ λ key λ¥Ό ν΄λΌμ΄μ–ΈνΈκ°€ μ•κ³  μλ”μ§€ ν™•μΈν•λ” κ³Όμ •μ…λ‹λ‹¤.

AD κ³„μ • μ†μ„± μ¤‘ β€Do not require Kerberos pre authenticationβ€ μ΄λΌλ” μµμ…μ΄ μ„¤μ •λμ–΄ μμΌλ©΄ μ‚¬μ „ μΈμ¦ μ—†μ΄ TGT λ¥Ό λ°κΈ‰ν•΄μ¤λ‹λ‹¤. κ·Έλ¬λ‹κΉ, ν¨μ¤μ›λ“ μ—†μ΄λ„ TGTλ¥Ό λ°κΈ‰λ°›μ„ μ μλ‹¤λ” λ§μ…λ‹λ‹¤.

TGT λ” KDCμ λ§μ¤ν„°ν‚¤ μ¦‰, krbtgt κ³„μ •μ NTLM hash λ΅ μ•”νΈν™”λκΈ° λ•λ¬Έμ— TGT ν¬λ™μ— μ„±κ³µν•λ‹¤λ©΄ krbtgt κ³„μ •μ κ¶ν•μ„ νƒμ·¨ν•  μ μκ² λλ” μ…μ…λ‹λ‹¤. 

## Silver Ticket

λ§μ•½ νΉμ • μ„λΉ„μ¤ κ³„μ •μ NTLM hash λ¥Ό μ–»μ–΄λ‚Έ μƒν™©μ΄λΌλ©΄ μ΄λ¥Ό μ΄μ©ν•΄ PACλ¥Ό μ΅°μ‘ν• λ‹¤λ¥Έ μ„λΉ„μ¤ ν‹°μΌ“μ„ λ§λ“¤μ–΄λ‚Ό μ μμµλ‹λ‹¤. 

μ„λΉ„μ¤ ν‹°μΌ“μ€ μ›λ TGS μ—μ„ λ°κΈ‰μ„ ν•΄μ£Όμ§€λ§ TGS λ¥Ό ν†µν•μ§€ μ•κ³ λ„ μ„λΉ„μ¤ ν‹°μΌ“ μƒμ„±μ΄ κ°€λ¥ν•©λ‹λ‹¤.

μ„λΉ„μ¤ ν‹°μΌ“ λ‚΄ PAC λ” μ„λΉ„μ¤ κ³„μ • λΉ„λ°€ν‚¤μ™€ krbtgt κ³„μ • λΉ„λ°€ν‚¤ 2κ°λ΅ μ„λ…μ΄ λλ”λ°, μ„λΉ„μ¤ κ³„μ • λΉ„λ°€ν‚¤ μ„λ…λ§ κ²€μ¦ν•λ” κ²½μ°κ°€ μμµλ‹λ‹¤.

λ€ν‘μ μΌλ΅ SeTcbPrivilege κ¶ν•μ΄ μλ” κ²½μ°κ°€ κ·Έλ¬ν•λ°μ”. μ΄ κ¶ν•μ΄ μλ” κ³„μ •μ€ μ„λΉ„μ¤ κ³„μ • λΉ„λ°€ν‚¤ μ„λ…λ§ κ²€μ¦ν•κΈ° λ•λ¬Έμ— Silver Ticket μ λ€μƒμ΄ λλ‹¤κ³  λ³Ό μ μμµλ‹λ‹¤.

## Golden Ticket

krbtgt κ³„μ •μ NTLM hash λ¥Ό μ–»μ–΄λƒλ‹¤λ©΄ TGT μƒμ„±μ΄ κ°€λ¥ν•©λ‹λ‹¤. μ΄ TGT μ—λ„ PAC κ°€ ν¬ν•¨λλ”λ°μ”. μ•μ„ Silver Ticket μ€ μ„λΉ„μ¤ ν‹°μΌ“μ PACλ¥Ό μ΅°μ‘ν–λ‹¤λ©΄ Golden Ticket μ€ TGT μ PACλ¥Ό μ΅°μ‘ν•©λ‹λ‹¤.

μ΅°μ‘λ PACλ¥Ό κ°€μ§„ TGTκ°€ TGS μ— μ „λ‹¬μ΄ λλ©΄ ν•΄λ‹Ή κ¶ν•μΌλ΅ μ„λΉ„μ¤ ν‹°μΌ“μ΄ λ°κΈ‰λκΈ° λ•λ¬Έμ— μ΄λ¥Ό μ΄μ©ν•΄μ„ λ„λ©”μΈ μ–΄λ“λ―Ό λ“± λ” λ†’μ€ κ¶ν•μΌλ΅ μƒμΉν•  μ μμµλ‹λ‹¤.

# Kerberos κ΄€λ ¨ μ·¨μ•½μ 

Kerberos ν”„λ΅ν† μ½μ€ λ‚΄μ©μ΄ λ°©λ€ν•κ³  Windows μ—μ„ κµ¬ν„ν• κ°μΆ… κ΄€λ ¨ κΈ°λ¥λ“¤μ„ λ¨λ‘ μ†κ°ν•λ” κ²ƒμ€ μ–΄λ µμµλ‹λ‹¤. κ·Έλ ‡κΈ°μ— CVE λ‡ μΆ…μ„ μ‚΄ν΄λ³΄λ©΄μ„ μ–΄λ–¤ μ„Έλ¶€ μ‚¬ν•­λ“¤μ΄ μλ”μ§€μ™€ λ°μƒν–λ μ·¨μ•½μ μ— λ€ν•΄ μ•μ•„λ³΄λ” μ‹κ°„μ„ κ°–λ„λ΅ ν•κ² μµλ‹λ‹¤.

## CVE-2020-17049

CVE-2020-17049λ” Kerberos Delegation λ©”μ»¤λ‹μ¦μ—μ„ λ°κ²¬λ λ³΄μ• μ·¨μ•½μ μΌλ΅, β€Bronze Bitβ€ κ³µκ²©μΌλ΅ μ•λ ¤μ Έ μμµλ‹λ‹¤. 

Delegtation μ€ μ§μ—­ν•λ©΄ μ„μ„μΈλ°μ”. μλ¥Ό λ“¤μ–΄μ„ μ‚¬μ©μκ°€ μ›Ή μ• ν”λ¦¬μΌ€μ΄μ…μ— μΈμ¦μ„ ν•κ³ , μ›Ή μ• ν”λ¦¬μΌ€μ΄μ…μ΄ μ‚¬μ©μ κ¶ν•μ— λ”°λΌ λ°μ΄ν„°λ² μ΄μ¤μ— μ ‘κ·Όν•΄μ•Όν•  λ•κ°€ μλ‹¤κ³  ν•©μ‹λ‹¤. μ΄ λ• μ›Ή μ• ν”λ¦¬μΌ€μ΄μ…μ΄ μ‚¬μ©μ κ¶ν•μ„ β€μ„μ„β€ λ°›μ•„μ„ μ”μ²­μ„ ν•΄μ•Όν•κΈ° λ•λ¬Έμ— μ΄λ¥Ό μ§€μ›ν•κΈ° μ„ν• Kerberos Delegation μ΄ μ—¬λ¬ μΆ… κµ¬ν„λμ–΄ μμµλ‹λ‹¤. (Unconstrained Delegation, Constrained Delegation, μ„μ„ ν•μ§€ μ•μ λ“±) 

μ„μ„μ΄ κ°€λ¥ν• μ„λΉ„μ¤λ“¤μ„ μ§€μ •ν•λ” AllowedToDelegateTo ν”„λ΅νΌν‹°λ¥Ό μ΄μ©ν•΄ νΉμ • μ„λΉ„μ¤Aκ°€ λ‹¤λ¥Έ μ„λΉ„μ¤Bμ— μ„μ„μ΄ κ°€λ¥ν•λ‹¤λ” κ²ƒμ„ μ •λ³΄λ¥Ό μ €μ¥ν•λ” κ²ƒμ΄μ£ .

μ„λΉ„μ¤ ν‹°μΌ“μ— μλ” Forwardable Flag λ” μ΄ ν‹°μΌ“μ΄ Relay κ°€ κ°€λ¥ν•λλƒλ¥Ό ν‘κΈ°ν•λ” λΉ„νΈμΈλ°μ”. Forwardable μ΄ 1μ΄λΌλ©΄ κ¶ν• μ„μ„μ΄ κ°€λ¥ν•λ‹¤λ” λ§μ…λ‹λ‹¤. κ·Έλμ„ μ•μ„ Kerberos Delegation μµμ… μ¤‘ μ„μ„ ν•μ§€ μ•μ μµμ…μ΄λ‚, AllowedToDelegateTo λ΅ μ •μκ°€ λμ–΄ μμ§€ μ•μ„ κ²½μ° Forwardableμ΄ 0μ…λ‹λ‹¤.

κ·Έλ°λ° Forwardable bit λ” KDCμ μ„λ…, μ„λΉ„μ¤μ μ„λ… λ“±μΌλ΅ λ³΄νΈλμ–΄ μμ§€ μ•μ•„μ„ λ³€μ΅°κ°€ κ°€λ¥ν•©λ‹λ‹¤.

μ΄ μ―¤ μ¤λ©΄ μ΄ CVEκ°€ μ–΄λ–¤ μ·¨μ•½μ μΈμ§€ κ°μ΄ μ¤μ‹λ‚μ”?

μ„λΉ„μ¤ ν‹°μΌ“μ— μλ”Forwardable Flag λ¥Ό μ΅°μ‘ν•μ—¬ μ„λΉ„μ¤μ— λ³΄λ‚΄λ©΄ κ·Έ μ„λΉ„μ¤κ°€ κ¶ν• μ„μ„μ„ ν•κ³  μμ§€ μ•λ”λΌλ„ κ°•μ λ΅ κ¶ν• μ„μ„μ„ ν•κ² λμ–΄ κ¶ν•μ„ νƒμ·¨ν•  μ μλ” μ·¨μ•½μ μ…λ‹λ‹¤.

Windows μ—μ„λ” Kerberos Contrained Delegation (MS-SFU) λ” S4U2proxy ν”„λ΅ν† μ½λ΅ κ¶ν• μ„μ„μ„ κµ¬ν„ν–λ”λ°μ”. λ§μ•½ μ„λΉ„μ¤ Aκ°€ μ„λΉ„μ¤ Bλ΅ κ¶ν• μ„μ„μ΄ λ  λ• A μ„λΉ„μ¤ ν‹°μΌ“λ§ κ°€μ§€κ³ μ„λ” μ„λΉ„μ¤ Bμ— μ”μ²­μ΄ λ¶κ°€λ¥ν•©λ‹λ‹¤. S4U2proxy λ¥Ό ν†µν•΄ KDCμ— A μ„λΉ„μ¤ ν‹°μΌ“μ„ μ μ‹ν•κ³  B μ„λΉ„μ¤ ν‹°μΌ“μ„ λ°›μµλ‹λ‹¤.

μ΄λ ‡κ² Forwardable flagλ¥Ό 1λ΅ μ„¤μ •ν•μ—¬ κ°•μ μ μΌλ΅ κ¶ν• μ„μ„μ„ μ λ°ν•λ” μ·¨μ•½μ μ΄λΌκ³  λ³Ό μ μκ² μµλ‹λ‹¤.

## CVE-2022-33647 & CVE-2022-33679

**CVE-2022-33647**κ³Ό **CVE-2022-33679**λ” κµ¬κΈ€ Project Zero μ James Forshaw κ°€ λ°κ²¬ν• μ·¨μ•½μ μΌλ΅, Kerberos μΈμ¦ κ³Όμ • μ¤‘ RC4 μ•”νΈν™” μ‚¬μ©μ„ κ°€λ¥ν•λ„λ΅ ν•μ—¬ λΈλ£¨νΈν¬μ¤ λ“±μ λ°©λ²•μΌλ΅ μ„Έμ…ν‚¤λ¥Ό λ³µνΈν™” ν•κ³  κ¶ν•μ„ νƒμ·¨ν•λ” μ·¨μ•½μ μ…λ‹λ‹¤. Kerberos κ°€ μ›λλ” AES κΈ°λ° μ•”νΈν™”λ¥Ό μ„ νΈν•μ§€λ§ ν•μ„ νΈν™μ„± λ•λ¬Έμ— RC4-HMAC(MD4) λ°©μ‹μ„ μ§€μ›ν•κΈ°μ— μ·¨μ•½μ  νΈλ¦¬κ±°μ—μ„λ” RC4 λ¥Ό κ°•μ λ΅ μ‚¬μ©ν•λ„λ΅ ν•©λ‹λ‹¤.

ν΄λΌμ΄μ–ΈνΈκ°€ AS-REQ λ¥Ό KDCμ— μ „λ‹¬ν•  λ• etype μ΄λΌλ” μ •μν• ν•„λ“λ¥Ό μ΄μ©ν•΄μ„ μ§€μ› κ°€λ¥ν• μ•”νΈν™” μ•κ³ λ¦¬μ¦μ„ μ§€μ •ν•  μ μμµλ‹λ‹¤. μ„λ²„λ” μ΄λ¥Ό λ°›κ³ μ„ μ§€μ› κ°€λ¥ν• μ•”νΈν™” μ•κ³ λ¦¬μ¦μ„ ν™•μΈν•κ³  μ‚¬μ© κ°€λ¥ν•λ‹¤λ©΄ ν΄λΌμ΄μ–ΈνΈκ°€ μ μ‹ν• μ•”νΈν™” μ•κ³ λ¦¬μ¦μ„ μ‚¬μ©ν•κ² λ©λ‹λ‹¤. 

CVE-2022-33647 λ¥Ό Exploit ν•κΈ° μ„ν•΄ Forshaw ν•λ‹μ΄ μ‚¬μ©ν• μ•„μ΄λ””μ–΄κ°€ λ†€λΌμ΄λ°μ”. ν• λ² μ‚΄ν΄λ³΄κ² μµλ‹λ‹¤. 

ν΄λΌμ΄μ–ΈνΈκ°€ μΈμ¦ν•  λ• μΌλ°μ μΌλ΅ μ‚¬μ „ μΈμ¦ νƒ€μ„μ¤νƒ¬ν”„κ°€ μ—†λ” μ”μ²­μ„ KDCμ— λ³΄λƒ…λ‹λ‹¤. KDCλ” κ·Έλ¬λ©΄ KDC_ERR_PREAUTH_REQUIRED λΌλ” μ—λ¬ μ½”λ“λ¥Ό ν¬ν•¨ν•΄μ„ λ°ν™ν•©λ‹λ‹¤. μ΄ μ¤λ¥ μ‘λ‹µμ—μ„λ” ν•„μ”ν• μ•”νΈν™” λ©λ΅ λ“±μ„ μ‹¤μ–΄μ„ ν΄λΌμ΄μ–ΈνΈκ°€ μ μ ν•κ² μ•”νΈν™”λ¥Ό μν–‰ν•  μ μκ² ν•λ”λ°μ”. MITM μ„ ν†µν•΄ ν΄λΌμ΄μ–ΈνΈμ AS-REQ λ¥Ό κ°€λ΅μ±„κ³  μ—λ¬λ¥Ό λ°ν™ν•λ©΄μ„ μ—λ¬μ— RC4-MD4 μ— λ€ν• μ •λ³΄λ¥Ό λ„£μ–΄ ν΄λΌμ΄μ–ΈνΈκ°€ RC4-MD4 λ¥Ό μ‚¬μ©ν•λ„λ΅ ν•©λ‹λ‹¤. RC4λ¥Ό μ‚¬μ©ν•λ” AS-REQ λ¥Ό λ¦΄λ μ΄ν•μ—¬ KDCμ— λ³΄λ‚΄μ–΄ AS-REP λ¥Ό λ°›μµλ‹λ‹¤.

μ κ·Έλ¬λ©΄, κ³µκ²©μλ” RC4λ¥Ό μ‚¬μ©ν•λ” AS-REQ μ™€ AS-REP μ— ν¬ν•¨λ μ•”νΈν™”λ μ„Έμ…ν‚¤μ™€ TGTλ¥Ό μ–»μ—μµλ‹λ‹¤. AS-REQ μ—λ” PA-ENC-TS-ENC λΌκ³  ν•λ” νƒ€μ„μ¤νƒ¬ν”„λ¥Ό μ§€μ •ν•λ” κµ¬μ΅°κ°€ μκ³  AS-REP λ” EncASRepPart λΌκ³  ν•λ” μ•”νΈν™” μ‘λ‹µ κµ¬μ΅°λ΅ μ΄λ¤„μ Έ μμµλ‹λ‹¤.

![](ko/4.png)

RC4 λ” μƒμ„±λ μ¤νΈλ¦Ό ν‚¤λ΅ XOR μ„ ν•λ” κ²ƒμ΄λ‹¤ λ³΄λ‹, μ•”νΈλ¬Έκ³Ό ν‰λ¬Έμ„ μ•κ³  μμΌλ©΄ μ¤νΈλ¦Ό ν‚¤λ¥Ό μ• μ μμµλ‹λ‹¤. μ„ κ·Έλ¦Όμ—μ„ μ–‘ μ½μ΄ λ…Έλ€μƒ‰μΈ κ²½μ° μ μ™Έν•κ³  κ³„μ‚°μ΄ κ°€λ¥ν• κ²ƒμ΄μ£ .

- RC4-MD4 λ°©μ‹μ€ 16λ°”μ΄νΈμ ν‚¤λ¥Ό μƒμ„±ν•΄μ„ μ‚¬μ©ν•λ”λ°, μ• 5λ°”μ΄νΈλ§ λλ¤μ΄κ³  11λ°”μ΄νΈλ” 0xABλ΅ κ³ μ •μ…λ‹λ‹¤.

μ΄λ΅μƒ‰ ν‘μ‹λ” ASN.1 κµ¬μ΅°μ΄κΈ°μ— μ•κ³  μκ±°λ‚ κ³„μ‚°ν•  μ μλ” κ°’μ…λ‹λ‹¤. μ΄μ΄ μΆ‹κ²λ„ μ„Έμ…ν‚¤μ 4λ°”μ΄νΈ μ •λ„κ°€ overlap λμ–΄ μκΈ°μ— λ³µνΈν™”κ°€ κ°€λ¥ν•κ³  1λ°”μ΄νΈλ” λΈλ£¨νΈν¬μ¤λ¥Ό ν•΄μ•Όν•©λ‹λ‹¤. λΈλ£¨νΈν¬μ¤λ” KDCμ— μ„λΉ„μ¤ ν‹°μΌ“μ„ 256λ² μ”μ²­ν•μ—¬ μ •μƒ μ„λΉ„μ¤ ν‹°μΌ“μ„ λ°κΈ‰ λ°›λ” κ²ƒμΌλ΅ ν•  μ μμµλ‹λ‹¤.  μ΄λ ‡κ² μ„Έμ…ν‚¤λ¥Ό μ–»μ–΄λ‚΄κ³  ν‹°μΌ“ λ³µνΈν™”κΉμ§€ ν•μ—¬ ν•΄λ‹Ή μ‚¬μ©μμ κ¶ν•μ„ νƒμ·¨ν•  μ μμµλ‹λ‹¤.

CVE-2022-33679μ κ²½μ°λ” Keberos μ μ‚¬μ „ μΈμ¦ (pre-authentication) μ΄ λΉ„ν™μ„±ν™”λ κ²½μ°μ— λ°μƒν•©λ‹λ‹¤. μ‚¬μ „ μΈμ¦μ΄ λΉ„ν™μ„±ν™” λ κ³„μ •μ΄ μμΌλ©΄, κ³µκ²©μκ°€ ν•΄λ‹Ή κ³„μ •μ— λ€ν•΄ μ§μ ‘ KDCμ— AS-REQ μ”μ²­μ„ λ³΄λ‚΄ RC4-MD4 λ°©μ‹μ TGTλ¥Ό μ”μ²­ν•  μ μμµλ‹λ‹¤. μ‚¬μ „ μΈμ¦μ΄ κΊΌμ Έ μκΈ° λ•λ¬Έμ— KDCλ” μ‚¬μ©μκ°€ λΉ„λ°€λ²νΈλ¥Ό μ¦λ…ν•μ§€ μ•μ•λ”λ°λ„ KDCλ” AS-REPλ¥Ό λ¥Ό ν†µν•΄ RC4 μ•”νΈν™”λ TGT μ™€ μ„Έμ…ν‚¤λ¥Ό λ°ν™ν•©λ‹λ‹¤.

μ΄ μ·¨μ•½μ μ„ Exploit ν•  λ•μ—λ” μ„Έμ…ν‚¤λ¥Ό μ•μ•„λ‚΄λ” λ€μ‹ μ— μ¤λΌν΄ ν¨λ”©μ²λΌ νƒ€μ„μ¤νƒ¬ν”„ λ’¤μ½μΌλ΅ λ„ κ°’μ„ λ¶™μ—¬ λ‚κ°€ KDCμ—μ„ μ •μƒ μ‘λ‹µμ„ ν•λ©΄ ν‚¤λ¥Ό μ–»μ–΄λ‚΄λ” λ°©μ‹μ„ μ‚¬μ©ν•©λ‹λ‹¤.

## CVE-2022-37966

CVE-2022-37966 μ€ 2022 λΈ”λ™ν–‡ μ λ½μ—μ„ λ°ν‘λ μ·¨μ•½μ μΌλ΅ μ΄λ• λ‹Ήμ‹ Kerberos μ—μ„ κΈ°λ³Έμ μΌλ΅ μ§€μ›λλ RC4_HMAC_MD5 μ•κ³ λ¦¬μ¦ μ‚¬μ© μ‹ PAC λ³€μ΅° ν›„ MD5 μ½λ¦¬μ Όμ„ ν†µν•΄ κ²€μ¦μ„ μ°νν•λ” μ·¨μ•½μ μ…λ‹λ‹¤.

PAC λ‚΄μ—λ” μ„μμ λ°”μ΄νΈμ—΄μ„ λ„£μ„λ§ν•, μ»¨νΈλ΅¤ κ°€λ¥ν• ν•„λ“κ°€ μ—†μµλ‹λ‹¤. ν•μ§€λ§ LogonScript ν•„λ“λ¥Ό μ“°λ©΄ κΈ΄ κΈΈμ΄μ UTF-16 λ¬Έμμ—΄μ„ λ„£μ„ μ μμ–΄μ„ μ΄λ¥Ό μ΄μ©ν•΄ MD5 μ½λ¦¬μ „μ„ μ λ°μ‹ν‚¬ μ μμµλ‹λ‹¤.

μ΄ μ·¨μ•½μ μ„ Exploit ν•λ ¤λ©΄ λ™μΌν• MD5 hash λ¥Ό κ°€μ§€λ” λ„λ©”μΈ κ΄€λ¦¬μ κ¶ν•μ΄ ν¬ν•¨λ PACλ¥Ό λ§λ“¤μ–΄μ•Ό ν•λ”λ°μ”. μ‹¤μ  μ—°κµ¬μ—μ„λ„ HashClashλ΅ μ•½ 7 μ‹κ°„ λ™μ• μ†μ”λμ—λ‹¤κ³  ν•©λ‹λ‹¤. ν• λ² λ§λ“¤μ–΄λ‚΄λ©΄ λ„λ©”μΈ κ΄€λ¦¬μ κ¶ν•μ„ μ–»μ„ μ μμΌλ‹ μ‹κ°„μ„ ν¬μν• λ§ ν• κ²ƒ κ°™λ„¤μ”. 

## CVE-2024-43639

CVE-2024-43639 λ” ZDI μ— μ λ³΄λ μ·¨μ•½μ μΌλ΅, KDC Proxy (kdcsvc) μ—μ„ λ°μƒν• Integer Overflow μ— μν• Heap Overflow μ·¨μ•½μ μ…λ‹λ‹¤.

Windows KDC Proxy λ” Kerberos ν”„λ΅ν† μ½ λ©”μ‹μ§€λ¥Ό HTTPλ¥Ό ν†µν•΄ ν”„λ΅μ‹ ν•΄μ£Όλ” Windows Server κµ¬μ„±μ”μ† μ…λ‹λ‹¤. kdcsvc λΌλ” μ„λΉ„μ¤λ¥Ό μ‹¤ν–‰μ‹ν‚¤λ” kpssvc.dll μ—μ„ λ°μƒν•©λ‹λ‹¤. 

κ³„μ† Kerberos ν”„λ΅ν† μ½ λ΅μ§€μ»¬ λ²„κ·Έλ§ λ³΄λ‹¤κ°€ λ©”λ¨λ¦¬ μ»¤λ½μ… λ²„κ·Έλ¥Ό λ³΄λ‹ λ°κ°‘κΈ°λ„ ν•κ³  μ‹ κΈ°ν•κΈ°λ„ ν•λ„¤μ”.

# λ§μΉλ©°

Kerberos μ‘λ™ μ›λ¦¬μ™€ Windows κµ¬ν„, κ΄€λ ¨ κ³µκ²©κ³Ό μ·¨μ•½μ λ“¤κΉμ§€ μ‚΄ν΄λ΄¤μµλ‹λ‹¤. Kerberos λ” κ°•ν• μΈμ¦ ν”„λ΅ν† μ½μ΄μ§€λ§ μ„¤μ •μƒμ μ¤λ¥λ‚ κµ¬ν„μƒμ λ―ΈλΉ„λ΅ μΈν•΄ λ‹¤μ–‘ν• κ³µκ²©κ³Ό μ·¨μ•½μ μ— λ…Έμ¶λ  μ μμµλ‹λ‹¤. λ‹¤μ κΈ€μ—μ„μ μ£Όμ λ” μ•„μ§ λ―Έμ •μ΄μ§€λ§ μ¬λ°λ” μ£Όμ λ΅ λ‹¤μ‹ μ°Ύμ•„λµ™κ² μµλ‹λ‹¤. μ½μ–΄μ£Όμ…”μ„ κ°μ‚¬ν•©λ‹λ‹¤ π™‚

# References

- [https://en.wikipedia.org/wiki/Kerberos_(protocol)](https://en.wikipedia.org/wiki/Kerberos_(protocol))

- https://www.ibm.com/docs/ko/db2/11.5?topic=details-kerberos-authentication

- https://www.varonis.com/blog/kerberos-attack-silver-ticket

- https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-apds/1d1f2b0c-8e8a-4d2a-8665-508d04976f84

- https://learn.microsoft.com/ko-kr/openspecs/windows_protocols/ms-apds/a00d0b83-97e3-44ad-ba2d-1221d4f51a35#gt_26456104-0afb-4afe-a92e-ac160a9efdf8

- https://learn.microsoft.com/ko-kr/windows-server/security/credentials-protection-and-management/authentication-policies-and-authentication-policy-silos

- https://blog.sunggwanchoi.com/kor-keobeoroseuting-kerberoasting/

- https://www.hackthebox.com/blog/as-rep-roasting-detection

- https://www.microsoft.com/en-us/security/blog/2024/10/11/microsofts-guidance-to-help-mitigate-kerberoasting/

- https://googleprojectzero.blogspot.com/2022/10/rc4-is-still-considered-harmful.html

- https://syfuhs.net/a-bit-about-kerberos

- https://i.blackhat.com/EU-22/Thursday-Briefings/EU-22-Tervoort-Breaking-Kerberos-RC4-Cipher-and-Spoofing-Windows-PACs-wp.pdf

- https://www.thehacker.recipes/ad/movement/kerberos/

- https://en.hackndo.com/kerberos-silver-golden-tickets/

- https://www.netspi.com/blog/technical-blog/network-pentesting/cve-2020-17049-kerberos-bronze-bit-theory/

- https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-sfu/3bff5864-8135-400e-bdd9-33b552051d94

- https://learn.microsoft.com/en-us/windows-server/security/kerberos/kerberos-constrained-delegation-overview

- https://hackyboiz.github.io/2020/12/11/l0ch/2020-12-11/

- https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-kile/4ce3ddc0-aaaa-4a1b-b48b-62a07e906926

- https://www.zerodayinitiative.com/blog/2025/3/3/cve-2024-43639